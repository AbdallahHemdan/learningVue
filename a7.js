!function(){"use strict";function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}const t="initial_load",s="route_change";class i{constructor(e){this.sdk=e,this.observers=new Map,this.currentContext=t,this.routeChangeStartTime=null,this.clsValueByContext=new Map,this.lastLCPByContext=new Map}setupForInitialLoad(){this.currentContext=t,this.routeChangeStartTime=null,this._setupObservers(t)}setupForRouteChange(e){this._cleanupObservers(t),this.currentContext=s,this.routeChangeStartTime=e,this.clsValueByContext.set(s,0),this.lastLCPByContext.set(s,0),this._setupObservers(s)}_setupObservers(e){if(!window.PerformanceObserver)return;const s=[],i=this._createLCPObserver(e);i&&s.push(i);const n=this._createCLSObserver(e);n&&s.push(n);const o=this._createFIDObserver(e);if(o&&s.push(o),e===t){const t=this._createFCPObserver(e);t&&s.push(t)}const r=this._createINPObserver(e);r&&s.push(r),this.observers.set(e,s)}_createLCPObserver(e){try{let i=this.lastLCPByContext.get(e)||0;const n=new PerformanceObserver((t=>{const n=t.getEntries(),o=n[n.length-1];if(!o)return;let r=o.startTime,a=!0;if(e===s&&null!==this.routeChangeStartTime&&(o.startTime<this.routeChangeStartTime?a=!1:r=o.startTime-this.routeChangeStartTime),a&&r>i){i=r,this.lastLCPByContext.set(e,i);const t=`optima_lcp_${e}`;window.performance.mark(t);const n=this._extractLCPElementInfo(o);this.sdk.sendEvent("core_web_vital",{name:"LCP",value:r,context:e,element:n,routeRelative:e===s});const a=e===s?"LCP_route":"LCP";this.sdk.unifiedDataModel.web_vitals[a]={value:r,timestamp:performance.timeOrigin+o.startTime,context:e,element:n},console.log(`[Optima Debug] ${e} LCP:`,r)}})),o=e===t?{type:"largest-contentful-paint",buffered:!0}:{type:"largest-contentful-paint",buffered:!1};return n.observe(o),n}catch(t){return console.log(`[Optima Debug] LCP observer setup failed for ${e}:`,t),null}}_createCLSObserver(e){try{let i=this.clsValueByContext.get(e)||0;const n=new PerformanceObserver((t=>{if(t.getEntries().forEach((t=>{let n=!0;e===s&&null!==this.routeChangeStartTime&&t.startTime<this.routeChangeStartTime&&(n=!1),n&&!t.hadRecentInput&&(i+=t.value,this.clsValueByContext.set(e,i))})),i>0){this.sdk.sendEvent("core_web_vital",{name:"CLS",value:i,context:e,routeRelative:e===s});const t=e===s?"CLS_route":"CLS";this.sdk.unifiedDataModel.web_vitals[t]={value:i,timestamp:performance.timeOrigin+performance.now(),context:e},console.log(`[Optima Debug] ${e} CLS:`,i)}}));return lcpObserver.observe({type:"layout-shift",buffered:e===t}),n}catch(t){return console.log(`[Optima Debug] CLS observer setup failed for ${e}:`,t),null}}_createFIDObserver(e){try{const i=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{let i=!0,n=t.processingStart-t.startTime;if(e===s&&null!==this.routeChangeStartTime&&t.startTime<this.routeChangeStartTime&&(i=!1),i){this.sdk.sendEvent("core_web_vital",{name:"FID",value:n,context:e,target:t.target?.tagName,routeRelative:e===s});const i=e===s?"FID_route":"FID";this.sdk.unifiedDataModel.web_vitals[i]={value:n,timestamp:performance.timeOrigin+t.startTime,context:e,target:t.target?.tagName},console.log(`[Optima Debug] ${e} FID:`,n)}}))}));return i.observe({type:"first-input",buffered:e===t}),i}catch(t){return console.log(`[Optima Debug] FID observer setup failed for ${e}:`,t),null}}_createFCPObserver(e){try{const t=new PerformanceObserver((t=>{const s=t.getEntries().find((e=>"first-contentful-paint"===e.name));s&&(this.sdk.sendEvent("core_web_vital",{name:"FCP",value:s.startTime,context:e}),this.sdk.unifiedDataModel.web_vitals.FCP={value:s.startTime,timestamp:performance.timeOrigin+s.startTime,context:e},console.log(`[Optima Debug] ${e} FCP:`,s.startTime))}));return t.observe({type:"paint",buffered:!0}),t}catch(t){return console.log(`[Optima Debug] FCP observer setup failed for ${e}:`,t),null}}_createINPObserver(e){try{const i=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{let i=!0;if(e===s&&null!==this.routeChangeStartTime&&t.startTime<this.routeChangeStartTime&&(i=!1),i){this.sdk.sendEvent("core_web_vital",{name:"INP",value:t.duration,context:e,target:t.target?.tagName,routeRelative:e===s});const i=e===s?"INP_route":"INP";this.sdk.unifiedDataModel.web_vitals[i]={value:t.duration,timestamp:performance.timeOrigin+t.startTime,context:e,target:t.target?.tagName},console.log(`[Optima Debug] ${e} INP:`,t.duration)}}))}));return i.observe({type:"event",buffered:e===t}),i}catch(t){return console.log(`[Optima Debug] INP observer setup failed for ${e}:`,t),null}}_extractLCPElementInfo(e){if(e.element){const t=e.element;return{tagName:t.tagName,id:t.id||null,className:t.className||null,cssPath:this._generateCSSPath(t),domPath:this._generateDOMPath(t),size:e.size,url:e.url||null,dimensions:t.getBoundingClientRect?{width:Math.round(t.getBoundingClientRect().width),height:Math.round(t.getBoundingClientRect().height)}:null,textContent:t.textContent?.slice(0,100)||null}}if(e.url){const t=e.url,s=this._findElementByUrl(t);return s?{tagName:s.tagName,id:s.id||null,className:s.className||null,cssPath:this._generateCSSPath(s),size:e.size,url:t,imageType:this._getImageTypeFromUrl(t)}:{tagName:"IMG",url:t,size:e.size,imageType:this._getImageTypeFromUrl(t),note:"Element not found in DOM"}}return{size:e.size,note:"No element or URL information available"}}_findElementByUrl(e){const t=document.querySelectorAll("img");for(const s of t)if(s.src===e||s.currentSrc===e)return s;const s=document.querySelectorAll("*");for(const t of s){const s=window.getComputedStyle(t).backgroundImage;if(s&&s.includes(e))return t}return null}_generateCSSPath(e){if(!e||e.nodeType!==Node.ELEMENT_NODE)return"";const t=[];let s=e;for(;s&&s.nodeType===Node.ELEMENT_NODE&&s!==document.body;){let e=s.tagName.toLowerCase();if(s.id){e+=`#${s.id}`,t.unshift(e);break}if(s.className){e+="."+s.className.trim().split(/\s+/).slice(0,3).join(".")}const i=Array.from(s.parentNode?.children||[]).filter((e=>e.tagName===s.tagName));if(i.length>1){e+=`:nth-child(${i.indexOf(s)+1})`}if(t.unshift(e),s=s.parentElement,t.length>=5)break}return t.join(" > ")}_generateDOMPath(e){if(!e)return"";const t=[];let s=e;for(;s&&s!==document.body;){let e=s.tagName.toLowerCase();if(s.id&&(e+=`#${s.id}`),t.unshift(e),s=s.parentElement,t.length>=5)break}return t.join("/")}_getImageTypeFromUrl(e){try{const t=new URL(e).pathname,s=t.split(".").pop()?.toLowerCase();return{jpg:"JPEG",jpeg:"JPEG",png:"PNG",gif:"GIF",webp:"WebP",svg:"SVG",avif:"AVIF",bmp:"BMP"}[s]||"Unknown"}catch(e){return"Unknown"}}_cleanupObservers(e){const t=this.observers.get(e);t&&(t.forEach((t=>{try{t.disconnect()}catch(t){console.log(`[Optima Debug] Error disconnecting observer for ${e}:`,t)}})),this.observers.delete(e))}cleanup(){for(const e of this.observers.keys())this._cleanupObservers(e)}}function n(e){try{"PerformanceObserver"in window&&(e.webVitalsManager||(e.webVitalsManager=new i(e)),e.webVitalsManager.setupForInitialLoad(),function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)})),window.addEventListener("beforeunload",(function(){e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)}))}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;let t=[];const s=new PerformanceObserver((s=>{s.getEntries().forEach((e=>{t.push({startTime:e.startTime,duration:e.duration,attribution:e.attribution?.length?{name:e.attribution[0].name,containerType:e.attribution[0].containerType,containerName:e.attribution[0].containerName,containerId:e.attribution[0].containerId}:null})})),t.length>=5&&(e.unifiedDataModel.metrics.longTasks=t,t=[])}));try{s.observe({type:"longtask",buffered:!0})}catch(e){}}(e))}catch(e){console.error("[Optima Debug] Error setting up core web vitals:",e)}}function o(e){if(!e.sessionId)return;"complete"===document.readyState?e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e._collectResources(),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3)):window.addEventListener("load",(()=>{e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e._collectResources(),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3))}));let t=null;if(document.addEventListener("click",(s=>{let i=s.target,n="";if("A"===i.tagName||i.closest("a")){const t="A"===i.tagName?i:i.closest("a");n="link",e.sendEvent("user_interaction",{type:"click",element_type:n,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null,element_href:t.href||null})}else if("BUTTON"===i.tagName||i.closest("button")){const t="BUTTON"===i.tagName?i:i.closest("button");n="button",e.sendEvent("user_interaction",{type:"click",element_type:n,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null})}t&&clearTimeout(t),t=setTimeout((()=>{e._collectResources(),t=null}),2e3)})),"requestIdleCallback"in window){let t=!1;window.requestIdleCallback((()=>{t||(t=!0,e._collectResources(),e.sendEvent("page_ready",{url:window.location.href,title:document.title,time_to_idle:performance.now()}))}),{timeout:3e3})}document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?e.sendEvent("visibility_change",{state:"visible",timestamp:Date.now()}):"hidden"===document.visibilityState&&e.sendEvent("visibility_change",{state:"hidden",timestamp:Date.now()},{immediate:!0})}))}function r(e){e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t)return;try{const s=t.error||new Error(t.message||"Unknown error"),i=s.message||t.message||"Unknown error",n=t.filename||t.srcElement?.src||window.location.href,o=s.stack||null,r="error",u={type:r,message:i,source:n,lineno:t.lineno||0,colno:t.colno||0,stack:o,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:a(r,i,n,o)};l(e,u),c(e),e.sendEvent("error",{error_type:"uncaught_error",message:u.message,source:u.source,lineno:u.lineno,colno:u.colno})}catch(e){console.warn("Optima SDK: Failed to process error",e)}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const s=t.reason,i=s instanceof Error?s.message:String(s),n=s instanceof Error?s.stack:null,o="unhandled_rejection",r="Promise",u={type:o,message:i,source:r,stack:n,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:a(o,i,r,n)};l(e,u),c(e),e.sendEvent("error",{error_type:"unhandled_rejection",message:u.message})}catch(e){console.warn("Optima SDK: Failed to process promise rejection",e)}}(e,t)})),function(e){const t=console.error;console.error=(...s)=>{try{const t=(new Error).stack||"",i=s.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),n="console_error",o="console.error",r={type:n,message:i,source:o,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:a(n,i,o,t)};l(e,r)}catch(e){}t.apply(console,s)}}(e)}function a(e,t,s,i){const n=`${e}:${t}:${s}:${i?i.substring(0,150):""}`;let o=0;for(let e=0;e<n.length;e++){o=(o<<5)-o+n.charCodeAt(e),o|=0}return"err_"+Math.abs(o).toString(16)}function l(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const s=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(s)return!1;const i=e.buffer.errors.slice(-5),n=i.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!n})(e,t)&&(e.buffer.errors.push(t),e.buffer.errors.length>=5&&c(e))}function c(e){e.buffer.errors&&0!==e.buffer.errors.length&&(e.unifiedDataModel.errors||(e.unifiedDataModel.errors=[]),e.unifiedDataModel.errors=[...e.unifiedDataModel.errors,...e.buffer.errors],e.buffer.errors=[],e._sendUnifiedData(!1))}function u(e){return{setupBufferManagement:function(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers:function(){const t=e.batchConfig.maxBufferSize;e.buffer.events.length>t&&(e.buffer.events=e.buffer.events.slice(-t)),e.buffer.resources.length>t&&(e.buffer.resources=e.buffer.resources.slice(-t)),e.buffer.webVitals.length>t&&(e.buffer.webVitals=e.buffer.webVitals.slice(-t))},hashResource:function(e){return`${e.type}|${e.name.split("?")[0]}|${e.duration<50?"fast":"slow"}`},shouldCollectResource:function(t){if(e.batchConfig.resourceDedupingEnabled){const s=this.hashResource(t);if(e.collectionState.resourceHashMap[s])return!1;e.collectionState.resourceHashMap[s]=Date.now()}return!0},startBatchProcessing:function(){if(setInterval((()=>{e.buffer.events.length>0&&e._flushEvents(),e.buffer.webVitals.length>0&&e._flushWebVitals(),e.buffer.resources.length>0&&e._flushResources()}),Math.min(e.batchConfig.flushInterval,1e4)),e.batchConfig.visibilityFlushEnabled){const t=()=>{const t=Date.now();e.collectionState.visibilityState;const s=document.visibilityState;e.collectionState.visibilityState=s,t-e.collectionState.lastVisibilityChange>1e3&&(e.collectionState.lastVisibilityChange=t,"hidden"===s?e._flushBuffers("visibilityHidden",!0):"visible"===s&&setTimeout((()=>{e._collectResources()}),1e3))};document.addEventListener("visibilitychange",t)}if(window.addEventListener("beforeunload",(()=>{e._flushBuffers("unload",!0)})),e.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const t=()=>{window.requestIdleCallback((()=>{(e.buffer.events.length>=10||e.buffer.resources.length>=10||Date.now()-e.collectionState.lastResourceFlush>3e4)&&e._flushBuffers("idle"),setTimeout((()=>{t()}),2e4)}),{timeout:1e4})};t()}this.setupBufferManagement()}}}const d="initial_load",m="route_change",h="hash_change",p={REACT:"React",VUE:"Vue",ANGULAR:"Angular",ANGULARJS:"AngularJS",SVELTE:"Svelte",EMBER:"Ember",BACKBONE:"Backbone",detect(){const e=[];try{this.detectReact()&&e.push(this.REACT),this.detectVue()&&e.push(this.VUE),this.detectAngular()&&e.push(this.ANGULAR),this.detectAngularJS()&&e.push(this.ANGULARJS),this.detectSvelte()&&e.push(this.SVELTE),this.detectEmber()&&e.push(this.EMBER),this.detectBackbone()&&e.push(this.BACKBONE)}catch(e){}return e},detectReact(){if(window.React||window.ReactDOM||window.ReactRedux)return!0;if(document.querySelector("[data-reactroot], [data-reactid]"))return!0;const e=document.querySelectorAll("div");for(let t=0;t<Math.min(e.length,10);t++){if(Object.keys(e[t]).some((e=>e.startsWith("_reactInternalFiber")||e.startsWith("__reactInternalInstance"))))return!0}return!1},detectVue:()=>!!window.Vue||(!!window.__VUE__||(!!document.querySelector("[data-v-]")||!(!document.querySelector("#app")||!document.querySelector("#app").__vue__))),detectAngular:()=>!(!window.ng||!window.ng.coreTokens)||(!!document.querySelector("[ng-version]")||!!document.querySelector("app-root")),detectAngularJS:()=>!!window.angular||(!!document.querySelector(".ng-binding, [ng-app], [data-ng-app], [ng-controller], [data-ng-controller]")||!!document.querySelector('script[src*="angular.js"], script[src*="angular.min.js"]')),detectSvelte:()=>!!window.__SVELTE__||!!document.querySelector(".svelte-"),detectEmber:()=>!!(window.Ember||window.Em||document.querySelector(".ember-application")),detectBackbone:()=>!!window.Backbone};class g{constructor(t,s,i=null,n=null){this.sessionId=e(),this.parentSessionId=i,this.type=t,this.route=s,this.trigger=n,this.startTime=performance.now(),this.endTime=null,this.isActive=!0,this.resources=[],this.webVitals={LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null},this.errors=[],this.interactions=[],this.timings={},this.routeMetadata={title:document.title,referrer:document.referrer,timestamp:Date.now(),url:window.location.href,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash}}end(){return this.endTime=performance.now(),this.isActive=!1,this.dataCollectionTimer&&(clearInterval(this.dataCollectionTimer),this.dataCollectionTimer=null),this._observers&&(this._observers.forEach((e=>{try{e.disconnect()}catch(e){}})),this._observers=[]),this.getDuration()}getDuration(){return this.endTime?this.endTime-this.startTime:performance.now()-this.startTime}addResource(e){e&&e.startTime>=this.startTime&&this.resources.push({...e,name:e.name||"",sessionRelativeTime:e.startTime-this.startTime,attributedToRoute:!0,entryType:e.entryType||"resource",transferSize:e.transferSize||e.size||0,encodedBodySize:e.encodedBodySize||e.size||0,decodedBodySize:e.decodedBodySize||e.size||0,initiatorType:e.initiatorType||e.type||"other",protocol:e.protocol||"",responseStart:e.responseStart||e.startTime,responseEnd:e.responseEnd||e.startTime+(e.duration||0)})}updateWebVital(e,t,s={}){this.webVitals[e]={value:t,timestamp:performance.timeOrigin+performance.now(),sessionRelativeTime:performance.now()-this.startTime,...s}}}class f{constructor(e){this.sdk=e,this.isEnabled=!0,this.currentRoute=this.getCurrentRoute(),this.routeStartTime=performance.now(),this.frameworks=[],this.sessions=new Map,this.currentSession=null,this.parentSession=null,this.routeChangeHandlers=[],this.isInitialized=!1,this.init()}init(){if(!this.isInitialized)try{console.log("[Optima Debug] Route detector initializing..."),this.frameworks=p.detect(),console.log("[Optima Debug] Detected frameworks:",this.frameworks),console.log("[Optima Debug] Setting up route monitoring..."),this.setupHistoryMonitoring(),this.setupHashChangeMonitoring(),this.setupFrameworkSpecificMonitoring(),console.log("[Optima Debug] Creating initial route session..."),this.createInitialSession(),console.log("[Optima Debug] Initial route session created"),this.isInitialized=!0,console.log("[Optima Debug] Route detector initialization completed"),this.sdk.sendEvent&&this.sdk.sendEvent("route_detector_initialized",{frameworks:this.frameworks,initialRoute:this.currentRoute})}catch(e){console.warn("[Optima] Route detection setup failed:",e)}}getCurrentRoute(){return{pathname:window.location.pathname,search:window.location.search,hash:window.location.hash,href:window.location.href}}createInitialSession(){if(this.sdk.sessionId){const e={sessionId:this.sdk.sessionId,type:d,route:this.currentRoute,trigger:"page_load",startTime:performance.now(),routeMetadata:{title:document.title,referrer:document.referrer,timestamp:Date.now(),url:window.location.href,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash}};return this.parentSession=e,this.sessions.set(this.sdk.sessionId,e),this.sdk.currentVirtualSession=e,console.log("[Optima Debug] Initial route tracking created for main session:",this.sdk.sessionId),e}return null}setupHistoryMonitoring(){if(!this.historyMonitoringEnabled){console.log("[Optima Debug] Setting up history monitoring...");const e=window.history.pushState,t=window.history.replaceState;window.history.pushState=(...t)=>{console.log("[Optima Debug] pushState intercepted:",t[2]),console.log("[Optima Debug] Route detector enabled state:",this.isEnabled,"initialized:",this.isInitialized),e.apply(window.history,t),this.isEnabled?(console.log("[Optima Debug] Triggering route change handler for pushState"),this.handleRouteChange("pushState",t[2])):console.log("[Optima Debug] Route detector disabled, skipping pushState handling")},window.history.replaceState=(...e)=>{console.log("[Optima Debug] replaceState intercepted:",e[2]),console.log("[Optima Debug] Route detector enabled state:",this.isEnabled,"initialized:",this.isInitialized),t.apply(window.history,e),this.isEnabled?(console.log("[Optima Debug] Triggering route change handler for replaceState"),this.handleRouteChange("replaceState",e[2])):console.log("[Optima Debug] Route detector disabled, skipping replaceState handling")},this.originalPushState=e,this.originalReplaceState=t,window.addEventListener("popstate",(e=>{console.log("[Optima Debug] popstate event detected:",window.location.href),console.log("[Optima Debug] Route detector enabled state:",this.isEnabled,"initialized:",this.isInitialized),this.isEnabled?(console.log("[Optima Debug] Triggering route change handler for popstate"),this.handleRouteChange("popstate",window.location.href)):console.log("[Optima Debug] Route detector disabled, skipping popstate handling")}),{passive:!0}),this.historyMonitoringEnabled=!0,console.log("[Optima Debug] History monitoring setup completed")}}setupHashChangeMonitoring(){this.hashChangeMonitoringEnabled||(console.log("[Optima Debug] Setting up hash change monitoring..."),window.addEventListener("hashchange",(e=>{console.log("[Optima Debug] hashchange event detected:",window.location.href),console.log("[Optima Debug] Route detector enabled state:",this.isEnabled,"initialized:",this.isInitialized),console.log("[Optima Debug] Hash change from:",e.oldURL,"to:",e.newURL),this.isEnabled?(console.log("[Optima Debug] Triggering route change handler for hashchange"),this.handleRouteChange("hashchange",window.location.href)):console.log("[Optima Debug] Route detector disabled, skipping hashchange handling")}),{passive:!0}),this.hashChangeMonitoringEnabled=!0,console.log("[Optima Debug] Hash change monitoring setup completed"))}setupFrameworkSpecificMonitoring(){this.frameworks.includes(p.REACT)&&this.setupReactRouterMonitoring(),this.frameworks.includes(p.VUE)&&this.setupVueRouterMonitoring(),this.frameworks.includes(p.ANGULAR)&&this.setupAngularRouterMonitoring()}setupReactRouterMonitoring(){setTimeout((()=>{window.__REACT_ROUTER__||document.querySelector("[data-reach-router]")}),1e3)}setupVueRouterMonitoring(){setTimeout((()=>{window.$router||window.Vue&&window.Vue.prototype.$router}),1e3)}setupAngularRouterMonitoring(){}isScrollAnchor(e){return e.length<=10&&[/^#$/,/^#top$/i,/^#header$/i,/^#footer$/i,/^#section/i,/^#[a-z0-9\-_]+$/].some((t=>t.test(e)))}handleRouteChange(e,t){try{console.log("[Optima Debug] Route change detected:",e,t),console.log("[Optima Debug] Route detector state - isEnabled:",this.isEnabled,"isInitialized:",this.isInitialized),console.log("[Optima Debug] Current session state:",{hasCurrentSession:!!this.currentSession,currentSessionId:this.currentSession?.sessionId,currentSessionActive:this.currentSession?.isActive,sessionsCount:this.sessions.size});const s=this.getCurrentRoute();console.log("[Optima Debug] New route:",s.pathname),console.log("[Optima Debug] Current route:",this.currentRoute.pathname),console.log("[Optima Debug] Route comparison details:",{oldPathname:this.currentRoute.pathname,newPathname:s.pathname,oldSearch:this.currentRoute.search,newSearch:s.search,oldHash:this.currentRoute.hash,newHash:s.hash,pathChanged:this.currentRoute.pathname!==s.pathname,searchChanged:this.currentRoute.search!==s.search,hashChanged:this.currentRoute.hash!==s.hash});const i=this.isSignificantRouteChange(this.currentRoute,s);if(console.log("[Optima Debug] Route significance check result:",i),!i)return void console.log("[Optima Debug] Route change not significant, ignoring");console.log("[Optima Debug] Significant route change detected, creating new virtual session"),this.currentSession&&this.currentSession.isActive&&this.currentSession instanceof g?(console.log("[Optima Debug] Ending current virtual session:",this.currentSession.sessionId),console.log("[Optima Debug] Virtual session details before ending:",{sessionId:this.currentSession.sessionId,type:this.currentSession.type,resourcesCount:this.currentSession.resources.length,duration:this.currentSession.getDuration(),isActive:this.currentSession.isActive}),this.endSession(this.currentSession)):(console.log("[Optima Debug] No active virtual session to end, or session is not a VirtualSession instance"),this.currentSession&&console.log("[Optima Debug] Current session details:",{sessionId:this.currentSession.sessionId,isActive:this.currentSession.isActive,isVirtualSession:this.currentSession instanceof g,type:typeof this.currentSession}));const n="hashchange"===e?h:m,o=new g(n,s,this.parentSession?.sessionId||this.sdk.sessionId,e);console.log("[Optima Debug] New virtual session created:",o.sessionId,"type:",n,"parent:",o.parentSessionId),console.log("[Optima Debug] New session details:",{sessionId:o.sessionId,type:o.type,route:o.route,trigger:o.trigger,startTime:o.startTime,isActive:o.isActive}),console.log("[Optima Debug] Updating currentRoute from",this.currentRoute.pathname,"to",s.pathname),this.currentRoute=s,this.currentSession=o,this.sessions.set(o.sessionId,o),console.log("[Optima Debug] Route detector state after session creation:",{currentRoutePathname:this.currentRoute.pathname,currentSessionId:this.currentSession.sessionId,totalSessions:this.sessions.size,allSessionIds:Array.from(this.sessions.keys())}),this.updateSDKForRouteChange(o),this.notifyRouteChangeHandlers(o,e),this.resetPerformanceObservers(o),console.log("[Optima Debug] Route change handling completed successfully"),setTimeout((()=>{o.isActive?(console.log("[Optima Debug] Sending virtual session data with collected performance data..."),console.log("[Optima Debug] Virtual session resources collected:",o.resources.length),console.log("[Optima Debug] Virtual session web vitals:",Object.keys(o.webVitals).filter((e=>null!==o.webVitals[e]))),this.sendSessionData(o)):console.log("[Optima Debug] Session became inactive before sending data, skipping send")}),3e3)}catch(e){console.error("[Optima Debug] Route change handling failed:",e),console.error("[Optima Debug] Error stack:",e.stack)}}isSignificantRouteChange(e,t){return e.pathname!==t.pathname||e.hash!==t.hash&&!this.isScrollAnchor(t.hash)}endSession(e){console.log("[Optima Debug] endSession called for session:",e.sessionId),console.log("[Optima Debug] Session details before ending:",{sessionId:e.sessionId,type:e.type,isActive:e.isActive,resourcesCount:e.resources.length,duration:e.getDuration(),route:e.route.pathname}),e.isActive?(e.end(),console.log("[Optima Debug] Session marked as ended:",e.sessionId),console.log("[Optima Debug] Sending session data for ended session:",e.sessionId),this.sendSessionData(e)):console.log("[Optima Debug] Session was already inactive, not sending data:",e.sessionId)}updateSDKForRouteChange(e){console.log("[Optima Debug] Updating SDK for route change - main session:",this.sdk.sessionId,"virtual session:",e.sessionId),this.sdk.currentVirtualSession=e,this.setupVirtualSessionDataCollection(e),this.sdk.unifiedDataModel&&(this.sdk.unifiedDataModel.current_route=e.route,this.sdk.unifiedDataModel.route_session_id=e.sessionId,this.sdk.unifiedDataModel.route_change_trigger=e.trigger,console.log("[Optima Debug] Updated unified model with route context - main session still:",this.sdk.unifiedDataModel.session_id))}setupVirtualSessionDataCollection(e){if(console.log("[Optima Debug] Setting up data collection for virtual session:",e.sessionId),e.dataCollectionTimer=setInterval((()=>{e.isActive?this.collectDataForVirtualSession(e):clearInterval(e.dataCollectionTimer)}),500),"undefined"!=typeof PerformanceObserver){console.log("[Optima Debug] Setting up real-time PerformanceObserver for session:",e.sessionId),e._observers=e._observers||[];try{const t=new PerformanceObserver((t=>{const s=t.getEntries(),i=performance.timeOrigin+e.startTime;s.forEach((t=>{if(!e.isActive)return;const s=performance.timeOrigin+t.startTime;if(s>=i){if(t.name.includes("/api/optima/")||t.name.includes("optima.js")||t.name.startsWith("data:"))return;console.log("[Optima Debug] Real-time resource captured for session:",e.sessionId,{name:t.name.split("/").pop()||t.name.substring(0,50),type:t.initiatorType,startTime:t.startTime,timeDiffFromSession:s-i,transferSize:t.transferSize});const n={name:t.name,type:t.initiatorType||"other",startTime:t.startTime,duration:t.duration,size:t.transferSize||0,transferSize:t.transferSize||0,encodedBodySize:t.encodedBodySize||0,decodedBodySize:t.decodedBodySize||0,initiatorType:t.initiatorType||"other",protocol:this.extractProtocol(t.name)||"",responseStart:t.responseStart||t.startTime,responseEnd:t.responseEnd||t.startTime+(t.duration||0),cached:0===t.transferSize&&t.decodedBodySize>0,nextHopProtocol:t.nextHopProtocol,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,connectEnd:t.connectEnd,secureConnectionStart:t.secureConnectionStart,requestStart:t.requestStart,fetchStart:t.fetchStart,realTimeCapture:!0};e.resources.some((e=>e.name===n.name&&e.startTime===n.startTime))||(e.addResource(n),console.log("[Optima Debug] Added real-time resource. Session total:",e.resources.length))}}))}));t.observe({entryTypes:["resource"]}),e._observers.push(t),console.log("[Optima Debug] Real-time resource observer started for session:",e.sessionId)}catch(e){console.log("[Optima Debug] Failed to set up PerformanceObserver:",e.message)}this.setupWebVitalsForVirtualSession(e)}else console.log("[Optima Debug] PerformanceObserver not supported, falling back to buffer-based collection"),this.setupWebVitalsForVirtualSession(e)}setupWebVitalsForVirtualSession(e){if("undefined"!=typeof PerformanceObserver){e._observers=e._observers||[];try{const t=new PerformanceObserver((t=>{const s=t.getEntries(),i=s[s.length-1];if(i&&e.isActive)if(i.startTime>=e.startTime){const t=i.startTime-e.startTime;e.updateWebVital("LCP",t,{element:i.element?.tagName,url:i.url,originalStartTime:i.startTime,routeStartTime:e.startTime,routeRelativeTime:t}),console.log("[Optima Debug] Virtual session LCP:",t,"ms after route change (original:",i.startTime,")")}else console.log("[Optima Debug] Ignoring LCP from before route change:",i.startTime,"vs route start:",e.startTime)}));t.observe({entryTypes:["largest-contentful-paint"]}),e._observers.push(t)}catch(e){console.log("[Optima Debug] LCP not supported for virtual session")}try{const t=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{if(e.isActive)if(t.startTime>=e.startTime){const s=t.processingStart-t.startTime,i=t.startTime-e.startTime;e.updateWebVital("FID",s,{target:t.target?.tagName,originalStartTime:t.startTime,routeStartTime:e.startTime,routeRelativeStart:i}),console.log("[Optima Debug] Virtual session FID:",s,"ms delay, occurred",i,"ms after route change")}else console.log("[Optima Debug] Ignoring FID from before route change:",t.startTime,"vs route start:",e.startTime)}))}));t.observe({entryTypes:["first-input"]}),e._observers.push(t)}catch(e){console.log("[Optima Debug] FID not supported for virtual session")}try{const t=new PerformanceObserver((t=>{const s=t.getEntries();let i=0,n=0;if(s.forEach((t=>{e.isActive&&t.startTime>=e.startTime&&(i+=t.value,n++)})),i>0){const t=performance.now()-e.startTime;e.updateWebVital("CLS",i,{validShifts:n,routeStartTime:e.startTime,routeRelativeTime:t}),console.log("[Optima Debug] Virtual session CLS:",i,"from",n,"shifts after route change")}}));t.observe({entryTypes:["layout-shift"]}),e._observers.push(t)}catch(e){console.log("[Optima Debug] CLS not supported for virtual session")}try{const t=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{if(e.isActive)if(t.startTime>=e.startTime){const s=t.startTime-e.startTime;e.updateWebVital("INP",t.duration,{routeRelativeStart:s,originalStartTime:t.startTime,routeStartTime:e.startTime,target:t.target?.tagName}),console.log("[Optima Debug] Virtual session INP:",t.duration,"ms, occurred",s,"ms after route change")}else console.log("[Optima Debug] Ignoring INP from before route change:",t.startTime,"vs route start:",e.startTime)}))}));t.observe({entryTypes:["event"]}),e._observers.push(t)}catch(e){}}}collectDataForVirtualSession(e){if(e.isActive){if(console.log("[Optima Debug] PERFORMANCE BUFFER STATUS:"),console.log("[Optima Debug] - Current buffer size limit:",performance.getEntriesByType("resource").length),"function"==typeof performance.setResourceTimingBufferSize)try{const e=performance.getEntriesByType("resource").length,t=Math.max(500,e+100);performance.setResourceTimingBufferSize(t),console.log("[Optima Debug] - Increased buffer size to:",t)}catch(e){console.log("[Optima Debug] - Cannot increase buffer size:",e.message)}else console.log("[Optima Debug] - Browser does not support setResourceTimingBufferSize");if(this.bufferManagementSetup||(this.bufferClearTimer=setInterval((()=>{const e=performance.getEntriesByType("resource");if(e.length>=200){console.log("[Optima Debug] Buffer approaching limit, clearing old entries. Current size:",e.length);const t=e.slice(-50);"function"==typeof performance.clearResourceTimings&&(performance.clearResourceTimings(),console.log("[Optima Debug] Cleared resource timing buffer")),console.log("[Optima Debug] Preserved newest",t.length,"resources")}}),1e4),this.bufferManagementSetup=!0,console.log("[Optima Debug] - Set up periodic buffer management")),this.bufferFullListenerAdded||(window.addEventListener("resourcetimingbufferfull",(e=>{if(console.warn("[Optima Debug] RESOURCE BUFFER FULL! Some resources may be lost."),console.log("[Optima Debug] - Buffer was full, new resources may have been dropped"),"function"==typeof performance.clearResourceTimings){const e=performance.getEntriesByType("resource");console.log("[Optima Debug] - Emergency: clearing buffer with",e.length,"entries"),performance.clearResourceTimings()}if("function"==typeof performance.setResourceTimingBufferSize)try{const e=500;performance.setResourceTimingBufferSize(e),console.log("[Optima Debug] - Emergency buffer size reset to:",e)}catch(e){console.log("[Optima Debug] - Emergency buffer increase failed:",e.message)}})),this.bufferFullListenerAdded=!0,console.log("[Optima Debug] - Added buffer full event listener")),window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("resource"),s=performance.timeOrigin+e.startTime;console.log("[Optima Debug] RESOURCE COLLECTION DEBUG for session:",e.sessionId),console.log("[Optima Debug] - Session start time (perf.now):",e.startTime),console.log("[Optima Debug] - Performance timeOrigin:",performance.timeOrigin),console.log("[Optima Debug] - Session start absolute:",s),console.log("[Optima Debug] - Current time (perf.now):",performance.now()),console.log("[Optima Debug] - Current absolute time:",performance.timeOrigin+performance.now()),console.log("[Optima Debug] - Total resources in Performance API:",t.length),console.log("[Optima Debug] - Session already has resources:",e.resources.length),t.length>=150&&(console.warn("[Optima Debug] - HIGH RESOURCE COUNT! Buffer might be at/near limit"),console.log("[Optima Debug] - This could mean older resources are being evicted"),console.log("[Optima Debug] - New route resources might have been dropped from buffer"),console.log("[Optima Debug] - SOLUTION: Real-time PerformanceObserver should capture missing resources"));const i=t.slice(-10).map((e=>({name:e.name.split("/").pop()||e.name.substring(0,50),startTime:e.startTime,absoluteTime:performance.timeOrigin+e.startTime,duration:e.duration,type:e.initiatorType})));console.log("[Optima Debug] - Sample recent resources:",i);const n=[...t].sort(((e,t)=>e.startTime-t.startTime)),o=n[0],r=n[n.length-1];if(o&&r){console.log("[Optima Debug] - Resource timestamp range:"),console.log("[Optima Debug]   Oldest resource:",{name:o.name.split("/").pop()||o.name.substring(0,30),startTime:o.startTime,absoluteTime:performance.timeOrigin+o.startTime,timeDiffFromSession:performance.timeOrigin+o.startTime-s,type:o.initiatorType}),console.log("[Optima Debug]   Newest resource:",{name:r.name.split("/").pop()||r.name.substring(0,30),startTime:r.startTime,absoluteTime:performance.timeOrigin+r.startTime,timeDiffFromSession:performance.timeOrigin+r.startTime-s,type:r.initiatorType});const e=r.startTime-o.startTime,t=performance.now()-0;console.log("[Optima Debug] - Buffer analysis:"),console.log("[Optima Debug]   Time span in buffer:",(e/1e3).toFixed(2),"seconds"),console.log("[Optima Debug]   Total session age:",(t/1e3).toFixed(2),"seconds"),t>e+1e4&&(console.warn("[Optima Debug]   WARNING: Buffer truncation detected!"),console.log("[Optima Debug]   Some early resources have been evicted from buffer"),console.log("[Optima Debug]   This confirms the 250-item limit issue!"),console.log("[Optima Debug]   PerformanceObserver should capture missing resources in real-time"))}const a=t.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType));if(console.log("[Optima Debug] - AJAX resources found:",a.length),a.length>0){const e=a.slice(-5).map((e=>({name:e.name.split("/").pop()||e.name.substring(0,50),startTime:e.startTime,absoluteTime:performance.timeOrigin+e.startTime,timeDiffFromSession:performance.timeOrigin+e.startTime-s,type:e.initiatorType})));console.log("[Optima Debug] - Recent AJAX resources:",e)}const l=t.filter((t=>{const i=performance.timeOrigin+t.startTime,n=i>=s,o=e.resources.some((e=>e.name===t.name&&e.startTime===t.startTime)),r=i-s;return r>-6e4&&r<12e4&&console.log("[Optima Debug] - Resource timing check:",{name:t.name.split("/").pop()||t.name.substring(0,30),resourceAbsolute:i,sessionAbsolute:s,timeDiff:r,timeDiffMinutes:(r/1e3/60).toFixed(2),isAfterSession:n,isAlreadyTracked:o,type:t.initiatorType}),n&&!o}));if(console.log("[Optima Debug] - Resources that passed filtering:",l.length),l.forEach(((t,s)=>{if(t.name.includes("/api/optima/")||t.name.includes("optima.js")||t.name.startsWith("data:"))return void console.log("[Optima Debug] - Skipping SDK resource:",t.name.split("/").pop());console.log(`[Optima Debug] - Processing new resource ${s}:`,{name:t.name.split("/").pop()||t.name,startTime:t.startTime,duration:t.duration,type:t.initiatorType,transferSize:t.transferSize});const i={name:t.name,type:t.initiatorType||"other",startTime:t.startTime,duration:t.duration,size:t.transferSize||0,transferSize:t.transferSize||0,encodedBodySize:t.encodedBodySize||0,decodedBodySize:t.decodedBodySize||0,initiatorType:t.initiatorType||"other",protocol:this.extractProtocol(t.name)||"",responseStart:t.responseStart||t.startTime,responseEnd:t.responseEnd||t.startTime+(t.duration||0),cached:0===t.transferSize&&t.decodedBodySize>0,nextHopProtocol:t.nextHopProtocol,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,connectEnd:t.connectEnd,secureConnectionStart:t.secureConnectionStart,requestStart:t.requestStart,fetchStart:t.fetchStart};e.addResource(i),console.log("[Optima Debug] - Added resource to session. Session now has:",e.resources.length,"resources")})),l.length>0)console.log("[Optima Debug] Added",l.length,"resources to virtual session. Total:",e.resources.length);else{console.log("[Optima Debug] No new resources found for virtual session. Session start abs:",s),console.log("[Optima Debug] All resources count:",t.length,"existing in session:",e.resources.length),console.log("[Optima Debug] BUFFER LIMIT ANALYSIS:"),console.log("[Optima Debug] - Static resources (JS/CSS/images) loaded during initial page load"),console.log("[Optima Debug] - Route changes typically only trigger AJAX requests for data"),console.log("[Optima Debug] - Performance API buffer limited to ~250 resources"),console.log("[Optima Debug] - Old resources get evicted, new route resources may be missed in buffer"),console.log("[Optima Debug] - BUT: PerformanceObserver should capture new resources in real-time!");const i=t.filter((e=>{const t=performance.timeOrigin+e.startTime-s;return("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)&&t>-5e3&&t<3e4}));i.length>0?console.log("[Optima Debug] - Found AJAX requests around session time:",i.map((e=>({name:e.name.split("/").pop()||e.name.substring(0,50),timeDiff:performance.timeOrigin+e.startTime-s,afterSession:performance.timeOrigin+e.startTime>=s})))):(console.log("[Optima Debug] - No AJAX requests found around session time in buffer"),console.log("[Optima Debug] - This could be due to buffer limits (confirmed) or normal SPA behavior"),console.log("[Optima Debug] - Check if PerformanceObserver captured any real-time resources"))}}if(window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("navigation");if(t.length>0){const s=t[0];e.timings={domContentLoaded:s.domContentLoadedEventEnd-s.navigationStart,loadComplete:s.loadEventEnd-s.navigationStart,firstByte:s.responseStart-s.navigationStart}}}}}resetPerformanceObservers(e){this.sdk.setupRouteSpecificObservers&&this.sdk.setupRouteSpecificObservers(e)}notifyRouteChangeHandlers(e,t){this.sdk.sendEvent&&this.sdk.sendEvent("route_change",{sessionId:e.sessionId,route:e.route,trigger:t,frameworks:this.frameworks,timestamp:e.routeMetadata.timestamp}),this.routeChangeHandlers.forEach((s=>{try{s(e,t)}catch(e){}}))}sendSessionData(e){if(this.sdk._sendToServer){const t=this.getDeviceInformation(),s={...e.routeMetadata,userAgent:navigator.userAgent,user_agent:navigator.userAgent,device_type:t.device_type,connection_type:t.connection_type,browser:t.browser,os:t.os,screen_width:window.screen.width,screen_height:window.screen.height,viewport_width:window.innerWidth,viewport_height:window.innerHeight,device_memory:navigator.deviceMemory,page_visibility:document.visibilityState,sdk_version:this.sdk.version||"1.0.0"};console.log("[Optima Debug] PRE-FORMAT session.resources count:",e.resources.length),console.log("[Optima Debug] PRE-FORMAT session.resources first 3:",e.resources.slice(0,3).map((e=>({name:e.name.split("/").pop()||e.name,startTime:e.startTime,duration:e.duration,transferSize:e.transferSize,protocol:e.protocol}))));const i=e.resources.map(((e,t)=>{const s={name:e.name,type:this.getResourceType(e),entryType:"resource",startTime:Math.round(e.startTime||0),duration:Math.round(e.duration||0),transferSize:e.transferSize||e.size||0,encodedBodySize:e.encodedBodySize||e.size||0,decodedBodySize:e.decodedBodySize||e.size||0,initiatorType:e.initiatorType||e.type||"other",protocol:e.protocol||"",is_ajax:this.isAjaxResource(e)};return t<3&&(console.log(`[Optima Debug] FORMATTING Resource ${t}:`),console.log("[Optima Debug]   INPUT:",{name:e.name.split("/").pop()||e.name,startTime:e.startTime,duration:e.duration,transferSize:e.transferSize,protocol:e.protocol}),console.log("[Optima Debug]   OUTPUT:",{name:s.name.split("/").pop()||s.name,startTime:s.startTime,duration:s.duration,transferSize:s.transferSize,protocol:s.protocol})),s})),n=this.formatWebVitalsForServer(e.webVitals),o={session_id:e.sessionId,parent_session_id:e.parentSessionId,session_type:e.type,route:e.route,trigger:e.trigger,duration:e.getDuration(),resources:i,web_vitals:n,errors:e.errors,interactions:e.interactions,ajax_requests:[],metadata:s,frameworks:this.frameworks};console.log("[Optima Debug] Sending enhanced virtual session data:"),console.log("[Optima Debug] - Resources:",i.length,"items"),console.log("[Optima Debug] - Resources with AJAX flag:",i.filter((e=>e.is_ajax)).length,"items"),console.log("[Optima Debug] - Web Vitals:",Object.keys(n)),console.log("[Optima Debug] - Device Type:",s.device_type),console.log("[Optima Debug] - Browser:",s.browser),console.log("[Optima Debug] - OS:",s.os),console.log("[Optima Debug] - Sample formatted resource data:"),i.slice(0,3).forEach(((e,t)=>{console.log(`[Optima Debug]   Resource ${t}:`,{name:e.name.split("/").pop(),startTime:e.startTime,duration:e.duration,protocol:e.protocol,transferSize:e.transferSize,is_ajax:e.is_ajax,initiatorType:e.initiatorType})})),this.sdk._sendToServer("/api/optima/route-session",o)}}getDeviceInformation(){return this.sdk._detectOS&&this.sdk._detectBrowser?{device_type:this.sdk._getDeviceType?this.sdk._getDeviceType():this.detectDeviceType(),connection_type:this.getConnectionType(),browser:this.sdk._detectBrowser(),os:this.sdk._detectOS()}:{device_type:this.detectDeviceType(),connection_type:this.getConnectionType(),browser:this.detectBrowser(),os:this.detectOS()}}extractProtocol(e){try{return new URL(e).protocol.replace(":","")}catch(t){return e.startsWith("//")?"http":e.startsWith("https:")?"https":(e.startsWith("http:"),"http")}}detectDeviceType(){const e=navigator.userAgent.toLowerCase();return/mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(e)?"mobile":/tablet|ipad/i.test(e)?"tablet":"desktop"}getConnectionType(){return navigator.connection&&navigator.connection.effectiveType||"unknown"}detectBrowser(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("Safari")>-1?"Safari":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1?"Opera":"Unknown"}detectOS(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"}getResourceType(e){const t=e.name||"",s=e.type||e.initiatorType;return"xmlhttprequest"===s||"fetch"===s?"xhr":t?t.match(/\.(css)$/i)?"stylesheet":t.match(/\.(js)$/i)?"script":t.match(/\.(png|jpg|jpeg|gif|svg|webp|ico)$/i)?"image":t.match(/\.(woff|woff2|ttf|eot)$/i)?"font":t.match(/\.(mp4|webm|ogg|avi)$/i)?"video":t.match(/\.(mp3|wav|ogg)$/i)?"audio":s||"other":s||"other"}isAjaxResource(e){const t=e.type||e.initiatorType,s=e.name||"";return"xmlhttprequest"===t||"fetch"===t||s&&!s.match(/\.(css|js|png|jpg|jpeg|gif|svg|webp|ico|woff|woff2|ttf|eot|mp4|webm|ogg|avi|mp3|wav)$/i)}formatWebVitalsForServer(e){const t={};return Object.keys(e).forEach((s=>{const i=e[s];i&&null!==i.value&&void 0!==i.value&&(t[s]={value:i.value,timestamp:i.timestamp||Date.now(),...i})})),t}getCurrentSession(){return this.currentSession}getSessionById(e){return this.sessions.get(e)}getAllSessions(){return Array.from(this.sessions.values())}addRouteChangeHandler(e){this.routeChangeHandlers.push(e)}removeRouteChangeHandler(e){const t=this.routeChangeHandlers.indexOf(e);t>-1&&this.routeChangeHandlers.splice(t,1)}destroy(){console.log("[Optima Debug] RouteDetector.destroy() called - cleaning up"),this.isEnabled=!1,this.bufferClearTimer&&(clearInterval(this.bufferClearTimer),this.bufferClearTimer=null,console.log("[Optima Debug] Cleaned up buffer management timer")),this.currentSession&&this.currentSession.isActive&&this.endSession(this.currentSession),this.sessions.clear(),this.routeChangeHandlers=[],console.log("[Optima Debug] RouteDetector cleanup completed")}enable(){console.log("[Optima Debug] RouteDetector.enable() called - current state:",this.isEnabled),this.isEnabled=!0,console.log("[Optima Debug] RouteDetector enabled successfully")}disable(){console.log("[Optima Debug] RouteDetector.disable() called - current state:",this.isEnabled),this.isEnabled=!1,console.log("[Optima Debug] RouteDetector disabled successfully")}}!function(t){function s(e){var t;e=e||{},this.apiKey=e.apiKey,this.endpoint=e.endpoint||"http://localhost:3000",this.sampleRate="number"==typeof e.sampleRate?Math.min(Math.max(e.sampleRate,1),100):100,this.sessionId=null,this.sessionStartTime=null,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null,layoutShiftSource:null},resources:[],ajax_requests:[],errors:[],events:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,flushInterval:e.flushInterval||5e3,webVitalsBatchDelay:e.webVitalsBatchDelay||2e3,batchBeforeSend:e.batchBeforeSend||!0,payloadCompressionThreshold:10240},this.collectionState={isFirstLoad:!0,resourcesCollected:!1,lastResourceFlush:null,lastEventFlush:null,lastAjaxCallFlush:null,isPerformanceObserverSet:!1,isBatchProcessingStarted:!1,unloadSent:!1,visibilityChangeCount:0},this.routeDetector=null,this.currentVirtualSession=null,this.parentVirtualSession=null,this.isRouteChangeEnabled=!1!==e.enableRouteTracking,this.bufferManager=u(this),this.flushManager=(t=this,{flushBuffers:function(e,s=!1){t.buffer.events.length>0&&this.flushEvents(s),t.buffer.resources.length>0&&this.flushResources(s),t.buffer.webVitals.length>0&&this.flushWebVitals(s),t.buffer.ajaxCalls&&t.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(s)},flushEvents:function(e=!1){if(0===t.buffer.events.length)return;const s=t.buffer.events.slice(0,t.batchConfig.maxEventsPerBatch);t.buffer.events=t.buffer.events.slice(t.batchConfig.maxEventsPerBatch);const i={session_id:t.sessionId,events:s,timestamp:Date.now(),count:s.length};t.collectionState.lastEventFlush=Date.now(),t._sendToServer("/api/optima/events",i,{sync:e})},flushResources:function(e=!1){if(0===t.buffer.resources.length)return;const s=t.buffer.resources.slice(0,t.batchConfig.maxResourcesPerBatch);t.buffer.resources=t.buffer.resources.slice(t.batchConfig.maxResourcesPerBatch);const i={session_id:t.sessionId,resources:s,timestamp:Date.now(),count:s.length};t.collectionState.lastResourceFlush=Date.now(),t._sendToServer("/api/optima/resources",i,{sync:e})},flushWebVitals:function(e=!1){if(0===t.buffer.webVitals.length)return;const s={LCP:[],FID:[],CLS:[],INP:[],TTFB:[],FCP:[]};t.buffer.webVitals.forEach((e=>{if(e&&e.event_data&&e.event_data.name){const t=e.event_data.name;s[t]&&s[t].push(e)}}));const i=t.buffer.webVitals.slice(0,t.batchConfig.maxWebVitalsPerBatch);t.buffer.webVitals=t.buffer.webVitals.slice(t.batchConfig.maxWebVitalsPerBatch);const n={session_id:t.sessionId,web_vitals:i,processed_vitals:s,timestamp:Date.now(),count:i.length};t._sendToServer("/api/optima/web-vitals",n,{sync:e})},flushAjaxCalls:function(e=!1){if(!t.buffer.ajaxCalls||0===t.buffer.ajaxCalls.length)return;const s=t.buffer.ajaxCalls.slice(0,t.batchConfig.maxAjaxCallsPerBatch);t.buffer.ajaxCalls=t.buffer.ajaxCalls.slice(t.batchConfig.maxAjaxCallsPerBatch);const i={session_id:t.sessionId,ajax_calls:s,timestamp:Date.now(),count:s.length};t.collectionState.lastAjaxCallFlush=Date.now(),t._sendToServer("/api/optima/ajax-calls",i,{sync:e})}}),this._webVitalsBatchTimer=null,this._init()}t.__optima_early_xhr_queue=t.__optima_early_xhr_queue||[],s.prototype={_init:function(){console.log("[Optima Debug] Initializing Optima SDK..."),console.log("[Optima Debug] Endpoint:",this.endpoint),console.log("[Optima Debug] API Key:",this.apiKey?this.apiKey.substring(0,8)+"...":"NOT PROVIDED"),console.log("[Optima Debug] Sample Rate:",this.sampleRate),this.apiKey?(this._initPerformanceMetrics(),r(this),this.createSession()):console.warn("[Optima Debug] No API key provided, SDK will not be fully initialized")},_initPerformanceMetrics:function(){if(t.performance&&t.performance.mark){t.performance.mark("optima_init");try{t.performance.getEntriesByType("mark").concat(t.performance.getEntriesByType("measure")).filter((e=>e.name.startsWith("optima_"))).forEach((e=>{t.performance.clearMarks(e.name),"measure"===e.entryType&&t.performance.clearMeasures(e.name)}))}catch(e){}this._setupCoreWebVitals(),this._captureNavigationTiming()}},_captureNavigationTiming:function(){try{const e=performance.getEntriesByType("navigation")[0];e?(this.unifiedDataModel.timings={navigationStart:0,fetchStart:e.fetchStart,domainLookupStart:e.domainLookupStart,domainLookupEnd:e.domainLookupEnd,connectStart:e.connectStart,connectEnd:e.connectEnd,requestStart:e.requestStart,responseStart:e.responseStart,responseEnd:e.responseEnd,domInteractive:e.domInteractive,domContentLoadedEventStart:e.domContentLoadedEventStart,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domComplete:e.domComplete,loadEventStart:e.loadEventStart,loadEventEnd:e.loadEventEnd,duration:e.duration,type:e.type,redirectCount:e.redirectCount,nextHopProtocol:e.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:e.responseStart,timestamp:performance.timeOrigin+e.responseStart},this.sendEvent("core_web_vital",{name:"TTFB",value:e.responseStart},{immediate:!0})):console.warn("[Optima Debug] No navigation timing entries available")}catch(e){console.error("[Optima Debug] Error capturing navigation timing:",e)}},_setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{this.collectionState.visibilityChangeCount++,"hidden"===document.visibilityState?this._prepareFinalDataAndSend(!0):"visible"===document.visibilityState&&this._refreshVisibleState()})),t.addEventListener("beforeunload",(()=>{this.collectionState.unloadSent||(this._prepareFinalDataAndSend(!0),this.collectionState.unloadSent=!0)})),this._setupPeriodicFlush()},_prepareFinalDataAndSend:function(e=!1){if(console.log("[Optima Debug] _prepareFinalDataAndSend called, useBeacon:",e),console.log("[Optima Debug] Main sessionId:",this.sessionId),console.log("[Optima Debug] Unified model sessionId:",this.unifiedDataModel.session_id),!this.sessionId||!this.unifiedDataModel.session_id)return console.warn("[Optima Debug] Skipping data send - missing session ID"),console.warn("[Optima Debug] Main sessionId exists:",!!this.sessionId),void console.warn("[Optima Debug] Unified sessionId exists:",!!this.unifiedDataModel.session_id);console.log("[Optima Debug] Consolidating buffered data..."),this._consolidateBufferedData(),console.log("[Optima Debug] Updating web vitals..."),this._updateWebVitalsInUnifiedModel(),console.log("[Optima Debug] Consolidating errors..."),this._consolidateErrors(),console.log("[Optima Debug] Updating metadata..."),this._updateMetadata(),console.log("[Optima Debug] About to call _sendUnifiedData..."),this._sendUnifiedData(e),console.log("[Optima Debug] _sendUnifiedData call completed")},_updateWebVitalsInUnifiedModel:function(){this.buffer.webVitals.forEach((e=>{if(!e.event_data||!e.event_data.name)return;const{name:t,value:s}=e.event_data,i=e.timestamp;if("LCP"===t)(!this.unifiedDataModel.web_vitals.LCP||s>this.unifiedDataModel.web_vitals.LCP.value)&&(this.unifiedDataModel.web_vitals.LCP={value:s,timestamp:i,element:e.event_data.element||"unknown"});else if("FID"===t)this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:s,timestamp:i,inputType:e.event_data.inputType||"unknown"});else if("CLS"===t){if(this.unifiedDataModel.web_vitals.CLS={value:s,timestamp:i,entries:e.event_data.entries||0,sessionValue:e.event_data.sessionValue||s,sessionEntries:e.event_data.sessionEntries||0},e.event_data.largestShift&&e.event_data.largestShift.source)try{const t=e.event_data.largestShift.source;t&&(this.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:e.event_data.largestShift.value,timestamp:e.event_data.largestShift.timestamp,source:t,loadState:document.readyState})}catch(e){console.warn("[Optima Debug] Error updating layout shift source:",e.message)}}else"FCP"===t?this.unifiedDataModel.web_vitals.FCP||(this.unifiedDataModel.web_vitals.FCP={value:s,timestamp:i}):"INP"===t&&(!this.unifiedDataModel.web_vitals.INP||s>this.unifiedDataModel.web_vitals.INP.value)&&(this.unifiedDataModel.web_vitals.INP={value:s,timestamp:i,interaction:e.event_data.interaction||"unknown"})})),this.buffer.webVitals=[]},_consolidateBufferedData:function(){return this.buffer.events||(this.buffer.events=[]),this.unifiedDataModel.events||(this.unifiedDataModel.events=[]),this.buffer.events.length>0&&(this.unifiedDataModel.events=[...this.unifiedDataModel.events,...this.buffer.events],this.buffer.events=[]),this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.errors.length>0&&this._consolidateErrors(),this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel},_consolidateErrors:function(){this.buffer.errors&&0!==this.buffer.errors.length&&(this.unifiedDataModel.errors=[...this.unifiedDataModel.errors,...this.buffer.errors],this.buffer.errors=[])},_updateMetadata:function(){this.unifiedDataModel.meta={url:t.location.href,path:t.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:t.screen.width,screen_height:t.screen.height,viewport_width:t.innerWidth,viewport_height:t.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:performance.getEntriesByType("navigation")[0]?.type||null,sdk_version:this.version,lastUpdated:Date.now()}},_sendUnifiedData:function(e=!1){if(console.log("[Optima Debug] _sendUnifiedData called, useBeacon:",e),console.log("[Optima Debug] Session ID in unified model:",this.unifiedDataModel.session_id),console.log("[Optima Debug] Main session ID:",this.sessionId),!this.unifiedDataModel.session_id)return void console.warn("[Optima Debug] Not sending data - no session ID in unified model");if(!this.sessionId)return void console.warn("[Optima Debug] Not sending data - no main session ID");console.log("[Optima Debug] Updating metadata..."),this._updateMetadata(),console.log("[Optima Debug] Setting timestamp..."),this.unifiedDataModel.timestamp=Date.now(),console.log("[Optima Debug] Creating data copy...");const t=JSON.parse(JSON.stringify(this.unifiedDataModel));console.log("[Optima Debug] Data to send - resources:",t.resources?.length,"events:",t.events?.length),console.log("[Optima Debug] Calling _sendToServer..."),this._sendToServer("/api/optima/collect",t,{sync:e}),console.log("[Optima Debug] Resetting volatile data..."),this._resetVolatileDataInUnifiedModel()},_resetVolatileDataInUnifiedModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},_setupBatchedCollection:function(){this.disabled||this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this._startBatchedCollection())},_startBatchedCollection:function(){console.log("[Optima Debug] Setting up resource collection interval..."),setInterval((()=>{console.log("[Optima Debug] Collecting resources..."),this._collectResources()}),3e3),console.log("[Optima Debug] Setting up performance observers..."),this._setupPerformanceObservers(),console.log("[Optima Debug] Setting up event listeners..."),this._setupEventListeners(),this._setupPeriodicFlush()},_setupPeriodicFlush:function(){setInterval((()=>{console.log("[Optima Debug] Periodic flush check..."),console.log("[Optima Debug] Resources in unified model:",this.unifiedDataModel.resources.length),console.log("[Optima Debug] Buffer resources:",this.buffer.resources.length);const e=this._hasSignificantData();console.log("[Optima Debug] Has significant data:",e),e?(console.log("[Optima Debug] Sending unified data via periodic flush..."),this._prepareFinalDataAndSend(!1)):console.log("[Optima Debug] No significant data to send")}),this.batchConfig.flushInterval)},_hasSignificantData:function(){const e={resources:this.unifiedDataModel.resources.length>0,ajax_requests:this.unifiedDataModel.ajax_requests.length>0,webVitals_buffer:this.buffer.webVitals.length>0,errors_buffer:this.buffer.errors.length>0,errors_unified:this.unifiedDataModel.errors.length>0,LCP:this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value,FID:this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value,CLS:this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value,FCP:this.unifiedDataModel.web_vitals.FCP&&this.unifiedDataModel.web_vitals.FCP.value};return console.log("[Optima Debug] Significant data checks:",e),e.resources||e.ajax_requests||e.webVitals_buffer||e.errors_buffer||e.errors_unified||e.LCP||e.FID||e.CLS||e.FCP},_collectResources:function(){if(!this.disabled&&this.sessionId){console.log("[Optima Debug] _collectResources called");try{const e=performance.getEntriesByType("resource");if(!e||0===e.length)return void console.log("[Optima Debug] No new resources found");let t=0;e.forEach((e=>{if(this._isResourceProcessed(e.name))return;const s={name:e.name,type:this._getResourceType(e),startTime:Math.round(e.startTime),duration:Math.round(e.duration),size:e.transferSize||0,protocol:e.nextHopProtocol,encodedSize:e.encodedBodySize||0,decodedSize:e.decodedBodySize||0,initiatorType:e.initiatorType};this.unifiedDataModel.resources.push(s),t++})),console.log(`[Optima Debug] Collected ${t} new resources, total: ${this.unifiedDataModel.resources.length}`),this.collectionState.resourcesCollected=!0}catch(e){console.error("[Optima Debug] Error collecting resources:",e)}}},_isResourceProcessed:function(e){return this.unifiedDataModel.resources.some((t=>t.name===e))},_getResourceType:function(e){const t=e.initiatorType,s=e.name;return"img"===t||"image"===t?"image":"script"===t?"script":"css"===t?"stylesheet":"fetch"===t||"xmlhttprequest"===t?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(s)?"image":/\.(?:js)(?:\?|$)/i.test(s)?"script":/\.(?:css)(?:\?|$)/i.test(s)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(s)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(s)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(s)?"audio":"other"},_detectBrowser:function(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("MSIE")>-1||e.indexOf("Trident/")>-1?"IE":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1||e.indexOf("OPR/")>-1?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"},_refreshVisibleState:function(){this.collectionState.visibilityChangeCount>1&&this._collectResources()},_setupCoreWebVitals:function(){this.disabled||n(this)},_setupBufferManagement:function(){this.bufferManager.setupBufferManagement()},_shouldCollectResource:function(e){return this.bufferManager.shouldCollectResource(e)},_startBatchProcessing:function(){this.bufferManager.startBatchProcessing()},_flushBuffers:function(e,t=!1){this._prepareFinalDataAndSend(t)},_flushEvents:function(e=!1){const t=this.buffer.events.slice();if(this.buffer.events=[],0===t.length)return;const s={session_id:this.sessionId,events:t,timestamp:Date.now()};this._sendToServer("/api/optima/events",s,{sync:e})},_flushResources:function(e=!1){const t=this.buffer.resources.slice();if(this.buffer.resources=[],0===t.length)return;const s={session_id:this.sessionId,resources:t,timestamp:Date.now()};this._sendToServer("/api/optima/resources",s,{sync:e})},_flushWebVitals:function(e=!1){const t=this.buffer.webVitals.slice();if(this.buffer.webVitals=[],0===t.length)return;const s={session_id:this.sessionId,web_vitals:t,timestamp:Date.now()};this._sendToServer("/api/optima/web-vitals",s,{sync:e})},_setupEventListeners:function(){this.disabled||o(this)},_setupPerformanceObservers:function(){this.disabled||(this._setupCoreWebVitals(),this._collectResources())},captureResourceData:function(e="auto"){return!this.disabled&&(this._collectResources(),!0)},_sendResourceBatch:function(e){return e&&e.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...e]),!0},createSession:function(){const e=t.location.href,s=document.referrer||"";return this._createSession(e,s)},_sendToServer:function(e,t,s={}){if(!this.apiKey)return console.error("[Optima Debug] API key not set. Cannot send data to server."),Promise.reject(new Error("API key not set"));const i=this.endpoint+e;if(console.log("[Optima Debug] Sending data to:",i),console.log("[Optima Debug] Payload size:",JSON.stringify(t).length,"bytes"),console.log("[Optima Debug] API key:",this.apiKey?this.apiKey.substring(0,8)+"...":"NOT PROVIDED"),console.log("[Optima Debug] Session ID:",t.session_id||"NOT SET"),s.sync&&navigator.sendBeacon){console.log("[Optima Debug] Using sendBeacon for sync send");const e=new Blob([JSON.stringify(t)],{type:"application/json"}),s=navigator.sendBeacon(i,e);return console.log("[Optima Debug] SendBeacon result:",s),Promise.resolve(s)}if(e.includes("ajax-calls")&&(console.log("[Optima Debug] Sending AJAX calls data"),t.ajax_calls&&t.ajax_calls.length>0)){const e=t.ajax_calls.reduce(((e,t)=>(e[t.type]=(e[t.type]||0)+1,e)),{});console.log("[Optima Debug] AJAX call types:",e)}return console.log("[Optima Debug] Using fetch to send data"),fetch(i,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),credentials:"include"}).then((e=>{if(console.log("[Optima Debug] Server response status:",e.status),console.log("[Optima Debug] Server response headers:",Object.fromEntries(e.headers)),!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()})).then((e=>(console.log("[Optima Debug] Data sent successfully, server response:",e),!0))).catch((t=>(console.error(`[Optima Debug] Error sending data to ${e}:`,t),console.error("[Optima Debug] Full error details:",{message:t.message,stack:t.stack,name:t.name}),!1)))},sendEvent:function(e,t,s={}){if(this.disabled)return!1;if(!this.sessionId)return!1;const i={session_id:this.sessionId,event_type:e,event_data:t||{},timestamp:Date.now()};return"core_web_vital"===e?(this.buffer.webVitals.push(i),!0===s.immediate&&this._updateWebVitalsInUnifiedModel()):this.buffer.events.push(i),!0},collectPerformanceMetrics:function(){return this._collectResources(),this._updateWebVitalsInUnifiedModel(),!0},sendCollectedData:function(e=!1){return!this.disabled&&(this._prepareFinalDataAndSend(e),!0)},debug:function(){return{sessionId:this.sessionId,apiKey:this.apiKey?`${this.apiKey.substring(0,4)}...`:"None",endpoint:this.endpoint,bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs.size},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},_captureEarlyAjaxRequests:function(){if(!t.performance||!t.performance.getEntriesByType)return;const e=t.performance.getEntriesByType("resource"),s=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)),i=e.filter((e=>{if(s.includes(e))return!1;const t=e.name;if(t.includes("/api/")||t.includes("/graphql")||t.match(/\/(v1|v2|v3)\//)||t.includes("/rest/")||t.includes("/data/"))return!0;try{const e=new URL(t).pathname.split(".").pop();if(["json","xml","graphql"].includes(e))return!0}catch{}return!1})),n=[...new Set([...s,...i])];if(!n.length)return;const o=n.map((e=>{let t="GET";(e.name.includes("graphql")||e.transferSize>1e3)&&(t="POST");return{type:"fetch"===e.initiatorType?"fetch":"xhr",method:t,url:e.name,status:200,statusText:"OK",startTime:Math.round(e.startTime+performance.timeOrigin),duration:Math.round(e.duration),requestPayloadSize:-1,responseSize:Math.round(e.transferSize)||-1,decodedBodySize:Math.round(e.decodedBodySize)||-1,encodedBodySize:Math.round(e.encodedBodySize)||-1,aborted:!1,errored:!1,timestamp:Math.round(e.startTime+performance.timeOrigin),captureSource:"performance-timeline",resourceTiming:{startTime:Math.round(e.startTime),duration:Math.round(e.duration),domainLookupTime:Math.round(e.domainLookupEnd-e.domainLookupStart),connectTime:Math.round(e.connectEnd-e.connectStart),tlsTime:e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,requestStartTime:Math.round(e.requestStart),ttfb:Math.round(e.responseStart-e.requestStart),downloadTime:Math.round(e.responseEnd-e.responseStart),entryType:e.entryType,initiatorType:e.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transferSize>0?e.transferSize.toString():"unknown","cache-control":"unknown"}}})).filter((e=>!this._isOptimaApiCall(e.url)));0!==o.length&&(this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...o))},_isOptimaApiCall:function(e){return e.includes("/api/optima/sessions")||e.includes("/api/optima/events")||e.includes("/api/optima/resources")||e.includes("/api/optima/web-vitals")||e.includes("/api/optima/ajax-calls")||e.includes("/api/optima/collect")||e.includes("/api/sessions")||e.includes("/api/events")||e.includes("/api/resources")||e.includes("/api/web-vitals")||e.includes("/api/ajax-calls")||e.includes("/api/collect")||e.includes("optima.js")||e.includes("optima.min.js")},_processEarlyInterceptedRequests:function(){if(!t.__optima_early_xhr_queue||!t.__optima_early_xhr_queue.length)return;const e=t.__optima_early_xhr_queue;let s=[];t.performance&&t.performance.getEntriesByType&&(s=t.performance.getEntriesByType("resource"));const i=e.map((e=>{if(this._isOptimaApiCall(e.url)||e.responseURL&&this._isOptimaApiCall(e.responseURL))return null;let t=null;if(s.length>0){const i=e.url||"",n=s.filter((t=>t.name===i||e.responseURL&&t.name===e.responseURL||t.name.includes(new URL(i).pathname)||e.responseURL&&t.name.includes(new URL(e.responseURL).pathname)));if(n.length>0){const s=n.sort(((t,s)=>Math.abs(t.startTime+performance.timeOrigin-e.startTime)-Math.abs(s.startTime+performance.timeOrigin-e.startTime)))[0];s&&(t={startTime:Math.round(s.startTime),duration:Math.round(s.duration),domainLookupTime:Math.round(s.domainLookupEnd-s.domainLookupStart),connectTime:Math.round(s.connectEnd-s.connectStart),tlsTime:s.secureConnectionStart?Math.round(s.connectEnd-s.secureConnectionStart):0,requestStartTime:Math.round(s.requestStart),ttfb:Math.round(s.responseStart-s.requestStart),downloadTime:Math.round(s.responseEnd-s.responseStart),entryType:s.entryType,initiatorType:s.initiatorType,transferSize:s.transferSize||0,decodedBodySize:s.decodedBodySize||0})}}let i=e.responseSize;return(void 0===i||i<0)&&(i=t&&t.transferSize>0?t.transferSize:t&&t.decodedBodySize>0?t.decodedBodySize:-1),{type:e.type||"xhr",method:e.method||"GET",url:e.responseURL||e.url,originalUrl:e.url,status:e.status||0,statusText:e.statusText||"",startTime:e.startTime,endTime:e.endTime||e.startTime+(e.duration||0),duration:e.duration||0,async:!0,requestPayloadSize:e.requestSize||-1,responseSize:i,aborted:!!e.aborted,errored:!!e.error||!!e.errored,timestamp:e.timestamp||e.startTime,resourceTiming:t,captureSource:e.captureMethod||"early-intercept",requestHeaders:e.requestHeaders||{"content-type":"unknown","content-length":"unknown"},responseHeaders:e.responseHeaders||{"content-type":"unknown","content-length":i>0?i.toString():"unknown","cache-control":"unknown"}}})).filter(Boolean);0!==i.length&&(i.sort(((e,t)=>e.startTime-t.startTime)),this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...i),t.__optima_early_xhr_queue=[])},_createSession:function(s,i,n={}){if(console.log("[Optima Debug] Creating new session..."),!this.apiKey)return void console.error("[Optima Debug] API key not set. Cannot create session.");if(this.sessionId&&this.unifiedDataModel.session_id)return console.log("[Optima Debug] Session already exists, skipping creation:",this.sessionId),Promise.resolve(!0);const o=t.navigator.userAgent,r=this._detectDeviceType(),a=this._detectConnectionType(),l=Date.now(),c=performance?.timing?.navigationStart||l;this.sessionId?(console.log("[Optima Debug] Using existing session ID:",this.sessionId),this.unifiedDataModel.session_id=this.sessionId):(this.sessionId=e(),this.sessionStartTime=l,console.log("[Optima Debug] Generated new session ID:",this.sessionId),this.unifiedDataModel.session_id=this.sessionId,console.log("[Optima Debug] Set unified model session ID:",this.unifiedDataModel.session_id)),this._updateMetadata();const u={session_id:this.sessionId,page_url:s||t.location.href,referrer:i||document.referrer,user_agent:o,device_type:r,connection_type:a,timestamp:l,navigation_start:c,web_vitals:{},errors:[],resources:[],ajax_requests:[],meta:this.unifiedDataModel.meta};this._sendToServer("/api/optima/sessions",u).then((e=>{var t;console.log("[Optima Debug] Session creation promise resolved, success:",e),e?(console.log("[Optima Debug] Starting post-session setup..."),console.log("[Optima Debug] Calling _setupBatchedCollection..."),"function"==typeof this._setupBatchedCollection?(this._setupBatchedCollection(),console.log("[Optima Debug] _setupBatchedCollection completed")):console.error("[Optima Debug] _setupBatchedCollection method not found!"),console.log("[Optima Debug] Calling _setupPageLifecycleEvents..."),"function"==typeof this._setupPageLifecycleEvents?(this._setupPageLifecycleEvents(),console.log("[Optima Debug] _setupPageLifecycleEvents completed")):console.error("[Optima Debug] _setupPageLifecycleEvents method not found!"),this.isRouteChangeEnabled&&!this.routeDetector&&(console.log("[Optima Debug] Setting up route change detection..."),this.routeDetector=((t=this).routeDetector||(t.routeDetector=new f(t)),t.routeDetector),console.log("[Optima Debug] Route detector initialized:",!!this.routeDetector)),console.log("[Optima Debug] Post-session setup completed")):console.error("[Optima Debug] Session: Failed to create session")})).catch((e=>{console.error("[Optima Debug] Session: Error creating session",e)}))},_detectDeviceType:function(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&!t.MSStream||/android/i.test(e)?"mobile":/Tablet|iPad/i.test(e)?"tablet":"desktop"},_detectConnectionType:function(){return navigator.connection?navigator.connection.effectiveType:"unknown"},_flushAjaxCalls:function(e=!1){},setupRouteSpecificObservers:function(e){this._setupCoreWebVitals&&this._setupCoreWebVitals(e),this._resetResourceMonitoring(e),this.currentVirtualSession=e},_resetResourceMonitoring:function(e){if(this.buffer.resources=[],e&&e.type&&"initial_load"!==e.type)console.log("[Optima Debug] Skipping resource observer setup for virtual session - it handles its own collection");else if("PerformanceObserver"in t)try{this.routeResourceObserver&&this.routeResourceObserver.disconnect(),this.routeResourceObserver=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{t.startTime>=e.startTime&&this.buffer.resources.push(t)}))})),this.routeResourceObserver.observe({type:"resource",buffered:!1})}catch(e){console.warn("[Optima] Failed to set up route-specific resource monitoring:",e)}},getCurrentRoute:function(){return this.routeDetector?this.routeDetector.getCurrentSession():null},getAllRouteSessions:function(){return this.routeDetector?this.routeDetector.getAllSessions():[]},sendEventWithRoute:function(e,t,s={}){const i=this.getCurrentRoute(),n={...t,route_session_id:i?.sessionId,route_type:i?.type,route_path:i?.route?.pathname};return this.sendEvent(e,n,s)},triggerRouteChange:function(e,t="manual"){this.routeDetector&&this.routeDetector.handleRouteChange(t,e)}};var i=function(){var e=Array.prototype.slice.call(arguments),i=e[0];if("init"===i){var n=e[1]||null,o=e[2]||{};return o.apiKey=n,t.optimaInstance=new s(o),t.optimaInstance}if(!t.optimaInstance)return console.warn("[Optima Debug] Command executed before initialization:",i),!1;switch(i){case"event":return t.optimaInstance.sendEvent(e[1],e[2],e[3]);case"captureResources":return t.optimaInstance.captureResourceData("manual");case"flushBuffers":return t.optimaInstance.sendCollectedData(!0===e[1]);case"debug":return t.optimaInstance.debug();default:return console.warn("[Optima Debug] Unknown command:",i),!1}};t.Optima=s;var a=null;if("function"==typeof t.optima)if((a=t.optima).q&&a.q.length){t.optima=i;for(var l=0;l<a.q.length;l++)i.apply(t,a.q[l])}else t.optima=i;else t.optima=i}(window)}();
