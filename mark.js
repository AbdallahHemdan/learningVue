var optima=function(e){"use strict";function t(e,t,n=null){if(window.OptimaDebug){const s=`[Optima Debug] [${(new Date).toISOString()}] [${e}] ${t}`;n?console.log(s,n):console.log(s)}}function n(e){try{"PerformanceObserver"in window&&(function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("paint"))return void console.log("[Optima Debug] Paint timing not supported by browser");console.log("[Optima Debug] Setting up FCP observer");try{new PerformanceObserver((t=>{const n=t.getEntries();console.log("[Optima Debug] Paint entries received:",n.length,n);const s=n.find((e=>"first-contentful-paint"===e.name));if(!s)return void console.log("[Optima Debug] No FCP entry found in paint entries");console.log("[Optima Debug] FCP entry found:",s),window.performance.mark("optima_fcp");const i=s.startTime;e.sendEvent("core_web_vital",{name:"FCP",value:i},{immediate:!0}),e.unifiedDataModel.web_vitals.FCP={value:i,timestamp:performance.timeOrigin+s.startTime},console.log("[Optima Debug] FCP recorded:",i,"ms"),setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),500)})).observe({type:"paint",buffered:!0}),console.log("[Optima Debug] FCP observer started"),setTimeout((()=>{if(!e.unifiedDataModel.web_vitals.FCP){console.log("[Optima Debug] Trying fallback method for FCP");const t=performance.getEntriesByType("paint").find((e=>"first-contentful-paint"===e.name));t&&(console.log("[Optima Debug] Found FCP via direct performance entries:",t),e.unifiedDataModel.web_vitals.FCP={value:t.startTime,timestamp:performance.timeOrigin+t.startTime},e.sendEvent("core_web_vital",{name:"FCP",value:t.startTime},{immediate:!0}))}}),3e3)}catch(e){console.error("[Optima Debug] Error setting up FCP observer:",e)}}(e),function(e){let t=0;const n=new PerformanceObserver((n=>{const s=n.getEntries(),i=s[s.length-1];if(window.performance.mark("optima_lcp"),window.performance.measure("optima_lcp_time","navigationStart","optima_lcp"),i.startTime>t){t=i.startTime;const n=i.element?{tagName:i.element.tagName,id:i.element.id||null,className:i.element.className||null,size:i.size,dimensions:i.element.getBoundingClientRect?{width:Math.round(i.element.getBoundingClientRect().width),height:Math.round(i.element.getBoundingClientRect().height)}:null}:"unknown";e.sendEvent("core_web_vital",{name:"LCP",value:i.startTime,element:n}),e.unifiedDataModel.web_vitals.LCP={value:i.startTime,timestamp:performance.timeOrigin+i.startTime,element:n},s.length<=1&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3)}}));n.observe({type:"largest-contentful-paint",buffered:!0})}(e),function(e){const t=new PerformanceObserver((t=>{const n=t.getEntries()[0];window.performance.mark("optima_fid");const s={type:n.name,targetElement:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null,timing:{processingStart:n.processingStart,processingEnd:n.processingEnd,startTime:n.startTime}},i=n.processingStart-n.startTime;e.sendEvent("core_web_vital",{name:"FID",value:i,inputType:n.name,details:s},{immediate:!0}),e.unifiedDataModel.web_vitals.FID={value:i,timestamp:performance.timeOrigin+n.startTime,inputType:n.name,details:s}}));t.observe({type:"first-input",buffered:!0})}(e),function(e){let t=0,n=[],s=[],i=0,a=performance.now(),o=0;document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?o>0&&(e.unifiedDataModel.web_vitals.CLS={value:o,timestamp:Date.now(),entries:s.length}):"visible"===document.visibilityState&&performance.now()-a>1e3&&(a=performance.now(),o=0,s=[])}));const r=new PerformanceObserver((a=>{a.getEntries().forEach((e=>{e.hadRecentInput||(t+=e.value,n.push(e),o+=e.value,s.push({value:e.value,startTime:e.startTime}))}));const r=Date.now();(r-i>5e3||n.length%10==0)&&n.length>0&&(i=r,e.sendEvent("core_web_vital",{name:"CLS",value:t,entries:n.length,sessionValue:o,sessionEntries:s.length}),e.unifiedDataModel.web_vitals.CLS={value:t,timestamp:r,entries:n.length,sessionValue:o,sessionEntries:s.length},n.length%30==0&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3))}));r.observe({type:"layout-shift",buffered:!0})}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("event"))return;let t=0;const n=new PerformanceObserver((n=>{n.getEntries().forEach((n=>{if(!["pointerdown","keydown","click","mousedown","touchstart"].includes(n.name))return;const s=n.processingEnd-n.startTime,i={name:n.name,startTime:n.startTime,processingStart:n.processingStart,processingEnd:n.processingEnd,duration:s,renderTime:n.renderTime||null,interactionId:n.interactionId||null,targetElement:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null};s>t&&(t=s,e.sendEvent("core_web_vital",{name:"INP",value:s,interaction:i}),e.unifiedDataModel.web_vitals.INP={value:s,timestamp:performance.timeOrigin+n.startTime,interaction:i})}))}));try{n.observe({type:"event",buffered:!0,durationThreshold:16})}catch(e){}}(e),function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)})),window.addEventListener("beforeunload",(function(){e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)}))}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;let t=[];const n=new PerformanceObserver((n=>{n.getEntries().forEach((e=>{t.push({startTime:e.startTime,duration:e.duration,attribution:e.attribution?.length?{name:e.attribution[0].name,containerType:e.attribution[0].containerType,containerName:e.attribution[0].containerName,containerId:e.attribution[0].containerId}:null})})),t.length>=5&&(e.unifiedDataModel.metrics.longTasks=t,t=[])}));try{n.observe({type:"longtask",buffered:!0})}catch(e){}}(e))}catch(e){}}function s(e){e.buffer.ajaxCalls||(e.buffer.ajaxCalls=[]),e.buffer.preSessionAjaxCalls||(e.buffer.preSessionAjaxCalls=[]),function(e){const t=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;function s(e,t){if(!e._optimaData)return;if(l(e._optimaData.url))return;e._optimaData.duration=Date.now()-e._optimaData.startTime,e._optimaData.errored||e._optimaData.aborted||(e._optimaData.status=e.status,e._optimaData.statusText=e.statusText),e.responseURL&&!e._optimaData.responseURL&&(e._optimaData.responseURL=e.responseURL);try{const t=e.getAllResponseHeaders();if(t){t.trim().split(/[\r\n]+/).forEach((t=>{const n=t.split(": "),s=n.shift(),i=n.join(": ");e._optimaData.responseHeaders[s.toLowerCase()]=i}))}}catch(e){}if(""===e.responseType||"text"===e.responseType)e._optimaData.responseSize=e.responseText?e.responseText.length:0;else if("blob"===e.responseType)e._optimaData.responseSize=e.response?e.response.size:0;else if("arraybuffer"===e.responseType)e._optimaData.responseSize=e.response?e.response.byteLength:0;else if("json"===e.responseType)try{e._optimaData.responseSize=e.response?JSON.stringify(e.response).length:0}catch(t){e._optimaData.responseSize=-1}else e._optimaData.responseSize=-1;if(window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("resource"),n=e._optimaData.responseURL||e._optimaData.url;let s=o(t,n);s||(s=r(t,n,e._optimaData.startTime)),s&&(e._optimaData.resourceTiming={startTime:Math.round(s.startTime),duration:Math.round(s.duration),domainLookupTime:Math.round(s.domainLookupEnd-s.domainLookupStart),connectTime:Math.round(s.connectEnd-s.connectStart),tlsTime:s.secureConnectionStart?Math.round(s.connectEnd-s.secureConnectionStart):0,requestStartTime:Math.round(s.requestStart),ttfb:Math.round(s.responseStart-s.requestStart),downloadTime:Math.round(s.responseEnd-s.responseStart),entryType:s.entryType,initiatorType:s.initiatorType})}i(t,{type:"xhr",method:e._optimaData.method,url:e._optimaData.url,status:e._optimaData.status,statusText:e._optimaData.statusText,startTime:e._optimaData.startTime,duration:e._optimaData.duration,async:e._optimaData.async,requestPayloadSize:e._optimaData.requestPayloadSize,responseSize:e._optimaData.responseSize,aborted:e._optimaData.aborted,errored:e._optimaData.errored,timedOut:e._optimaData.timedOut,timestamp:Date.now(),resourceTiming:e._optimaData.resourceTiming||null,requestHeaders:{"content-type":e._optimaData.sentHeaders["content-type"]||"unknown","content-length":e._optimaData.sentHeaders["content-length"]||"unknown"},responseHeaders:{"content-type":e._optimaData.responseHeaders["content-type"]||"unknown","content-length":e._optimaData.responseHeaders["content-length"]||"unknown","cache-control":e._optimaData.responseHeaders["cache-control"]||"unknown"}})}XMLHttpRequest.prototype.open=function(e,n,s,i,a){return this._optimaData={method:e,url:n,startTime:Date.now(),async:!1!==s,status:0,statusText:"",sentHeaders:{},responseHeaders:{},responseSize:0,duration:0,aborted:!1,errored:!1},t.apply(this,arguments)},XMLHttpRequest.prototype.send=function(t){if(this._optimaData||(this._optimaData={method:"unknown",url:"unknown",startTime:Date.now(),async:!0,status:0,statusText:"",sentHeaders:{},responseHeaders:{},responseSize:0,duration:0,aborted:!1,errored:!1}),this.responseURL&&(this._optimaData.responseURL=this.responseURL),t)try{this._optimaData.requestPayloadSize="string"==typeof t?t.length:t instanceof FormData?-1:t instanceof Blob?t.size:t instanceof ArrayBuffer?t.byteLength:JSON.stringify(t).length}catch(e){this._optimaData.requestPayloadSize=-1}else this._optimaData.requestPayloadSize=0;try{if(this.getAllRequestHeaders){const e=this.getAllRequestHeaders();if(e){e.trim().split(/[\r\n]+/).forEach((e=>{const t=e.split(": "),n=t.shift(),s=t.join(": ");this._optimaData.sentHeaders[n.toLowerCase()]=s}))}}}catch(e){}const i=this;return i.addEventListener("load",(function(){s(i,e)})),i.addEventListener("error",(function(){i._optimaData.errored=!0,i._optimaData.status=0,i._optimaData.statusText="Network Error",s(i,e)})),i.addEventListener("abort",(function(){i._optimaData.aborted=!0,s(i,e)})),i.addEventListener("timeout",(function(){i._optimaData.timedOut=!0,s(i,e)})),n.apply(this,arguments)}}(e),function(e){if("function"!=typeof window.fetch)return;const t=window.fetch;window.fetch=function(n,s){const a=Date.now()+Math.random().toString(36).substring(2,9);let u,c,d={};if("string"==typeof n?u=n:n instanceof Request&&(u=n.url,c=n.method),s&&(c=s.method||"GET",s.headers))if(s.headers instanceof Headers)try{for(let e of s.headers.entries())d[e[0].toLowerCase()]=e[1]}catch(e){}else"object"==typeof s.headers&&Object.keys(s.headers).forEach((e=>{d[e.toLowerCase()]=s.headers[e]}));if(c=c||"GET",l(u))return t.apply(this,arguments);const p=Date.now(),f={type:"fetch",id:a,method:c,url:u,status:0,statusText:"",startTime:p,duration:0,requestPayloadSize:-1,responseSize:-1,aborted:!1,errored:!1,timestamp:p,resourceTiming:null,requestHeaders:{"content-type":d["content-type"]||"unknown","content-length":d["content-length"]||"unknown"},responseHeaders:{}};if(s&&s.body)try{f.requestPayloadSize="string"==typeof s.body?s.body.length:s.body instanceof FormData?-1:s.body instanceof Blob?s.body.size:s.body instanceof ArrayBuffer?s.body.byteLength:JSON.stringify(s.body).length}catch(e){f.requestPayloadSize=-1}const m=t.apply(this,arguments);return m.then((t=>{const n=Date.now();f.duration=n-p,f.status=t.status,f.statusText=t.statusText,f.responseURL=t.url;try{t.headers&&(f.responseHeaders={"content-type":t.headers.get("content-type")||"unknown","content-length":t.headers.get("content-length")||"unknown","cache-control":t.headers.get("cache-control")||"unknown"})}catch(e){}const s=t.headers.get("content-length");return s&&(f.responseSize=parseInt(s,10)),t.clone().text().then((t=>{if(f.responseSize<0&&(f.responseSize=t.length),window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource"),t=f.responseURL||f.url;let n=o(e,t);n||(n=r(e,t,p)),n&&(f.resourceTiming={startTime:Math.round(n.startTime),duration:Math.round(n.duration),domainLookupTime:Math.round(n.domainLookupEnd-n.domainLookupStart),connectTime:Math.round(n.connectEnd-n.connectStart),tlsTime:n.secureConnectionStart?Math.round(n.connectEnd-n.secureConnectionStart):0,requestStartTime:Math.round(n.requestStart),ttfb:Math.round(n.responseStart-n.requestStart),downloadTime:Math.round(n.responseEnd-n.responseStart),entryType:n.entryType,initiatorType:n.initiatorType})}i(e,f)})).catch((t=>{i(e,f)}))})).catch((t=>{const n=Date.now();f.duration=n-p,f.errored=!0,f.errorMessage=t.message||"Network error",i(e,f)})),m}}(e)}function i(e,n){const s=function(e,t){const n=e.sessionId?e.buffer.ajaxCalls:e.buffer.preSessionAjaxCalls;if(!n||0===n.length)return!1;return n.slice(-5).some((e=>e.url===t.url&&e.method===t.method&&(Math.abs(e.timestamp-t.timestamp)<50&&e.status===t.status)))}(e,n);s?t("AJAX","Skipping duplicate AJAX call",n):e.sessionId?(e.buffer.ajaxCalls.push(n),m(),t("AJAX","Stored AJAX call with session",n),e.buffer.ajaxCalls.length>=e.batchConfig.maxAjaxCallsPerBatch&&(t("AJAX","Buffer full, flushing AJAX calls"),e._flushAjaxCalls())):(e.buffer.preSessionAjaxCalls.push(n),t("AJAX","Stored pre-session AJAX call",n))}function a(e){if(!e.buffer.preSessionAjaxCalls||!e.buffer.preSessionAjaxCalls.length)return void t("AJAX","No pre-session AJAX calls to merge");t("AJAX","Merging pre-session AJAX calls",{count:e.buffer.preSessionAjaxCalls.length});const n=e.buffer.preSessionAjaxCalls.sort(((e,t)=>e.startTime-t.startTime));if(window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource");t("AJAX","Found resource timing entries",{count:e.length}),n.forEach((n=>{if(n.resourceTiming)return;const s=n.responseURL||n.url;let i=e.find((e=>e.name===s));if(!i)try{const t=new URL(s).pathname;i=e.find((e=>{try{return new URL(e.name).pathname===t}catch{return!1}}))}catch{}if(!i){const t=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType));if(t.length>0){let e=null,s=1/0;t.forEach((t=>{const i=Math.abs(t.startTime-n.startTime);i<s&&(s=i,e=t)})),e&&s<100&&(i=e)}}i&&(n.resourceTiming={startTime:Math.round(i.startTime),duration:Math.round(i.duration),domainLookupTime:Math.round(i.domainLookupEnd-i.domainLookupStart),connectTime:Math.round(i.connectEnd-i.connectStart),tlsTime:i.secureConnectionStart?Math.round(i.connectEnd-i.secureConnectionStart):0,requestStartTime:Math.round(i.requestStart),ttfb:Math.round(i.responseStart-i.requestStart),downloadTime:Math.round(i.responseEnd-i.responseStart),entryType:i.entryType,initiatorType:i.initiatorType},t("AJAX","Found matching resource timing entry",{url:s.substring(0,50)}))}))}const s=new Set(e.buffer.ajaxCalls.map((e=>e.url))),i=n.filter((t=>!s.has(t.url)||!e.buffer.ajaxCalls.some((e=>e.url===t.url&&Math.abs(e.startTime-t.startTime)<50))));t("AJAX","Filtered pre-session AJAX calls",{original:n.length,filtered:i.length}),e.buffer.ajaxCalls=[...i,...e.buffer.ajaxCalls],e.buffer.preSessionAjaxCalls=[],t("AJAX","Pre-session AJAX calls merged successfully")}function o(e,t){let n=e.find((e=>e.name===t));if(!n){const s=t.split("?")[0];n=e.find((e=>e.name===s))}if(!n)try{const s=new URL(t).pathname;n=e.find((e=>new URL(e.name).pathname===s))}catch(e){}return n}function r(e,t,n){let s="",i="";try{const e=new URL(t);s=e.hostname,i=e.pathname}catch(e){const n=t.split("/");n.length>2&&(s=n[2],i="/"+n.slice(3).join("/").split("?")[0])}if(!s)return null;const a=e.filter((e=>{try{return new URL(e.name).hostname===s}catch{return!1}}));return 0===a.length?null:a.reduce(((e,t)=>{const s=new URL(t.name).pathname,a=i.length>0&&s.includes(i),o=Math.abs(t.startTime-n);return a||e&&o<Math.abs(e.startTime-n)?t:e}),null)}function l(e){return e.includes("/api/optima/sessions")||e.includes("/api/optima/events")||e.includes("/api/optima/resources")||e.includes("/api/optima/web-vitals")||e.includes("/api/optima/ajax-calls")||e.includes("/api/optima/collect")||e.includes("/api/sessions")||e.includes("/api/events")||e.includes("/api/resources")||e.includes("/api/web-vitals")||e.includes("/api/ajax-calls")||e.includes("/api/collect")||e.includes("optima.js")||e.includes("optima.min.js")}const u="optima_session_id",c="optima_session_last_activity";function d(){try{const e=localStorage.getItem(u),n=parseInt(localStorage.getItem(c),10);if(e&&n&&!function(e){const n=Date.now(),s=n-e>18e5;s&&t("Session","Session expired",{lastActivity:e,now:n,age:n-e});return s}(n))return t("Session","Retrieved existing session from storage",{sessionId:e,lastActivity:n}),{sessionId:e,lastActivity:n}}catch(e){t("Session","Failed to access localStorage",e)}return null}function p(){try{const e=Date.now();localStorage.setItem(c,e.toString()),t("Session","Updated session activity timestamp",{timestamp:e})}catch(e){t("Session","Failed to update session activity",e)}}function f(e){t("Session","Creating new session");let n=d();n?(e.sessionId=n.sessionId,e.sessionStartTime=n.lastActivity,p(),t("Session","Reusing existing session",{sessionId:e.sessionId})):(e.sessionId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),e.sessionStartTime=Date.now(),function(e){try{localStorage.setItem(u,e),localStorage.setItem(c,Date.now().toString()),t("Session","Stored session in localStorage",{sessionId:e})}catch(e){t("Session","Failed to store session in localStorage",e)}}(e.sessionId),t("Session","Generated new session",{sessionId:e.sessionId}));var s;if(!((s=e.sampleRate)>=100||(s<=1?Math.random()<.01:100*Math.random()<s)))return t("Session","Session not tracked due to sample rate",{sampleRate:e.sampleRate}),e.disabled=!0,null;const i=window.location.href,o=document.referrer||"";t("Session","Page context",{pageUrl:i,referrer:o});let r=null;window.performance&&window.performance.timing&&(r=window.performance.timing.navigationStart,t("Session","Navigation timing",{navigationStartTime:r}));const l=function(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"mobile":"desktop"}(),f=navigator.connection&&navigator.connection.effectiveType||"unknown";t("Session","Device info",{deviceType:l,connectionType:f});const m={session_id:e.sessionId,page_url:i,referrer:o,user_agent:navigator.userAgent,device_type:l,connection_type:f,timestamp:Date.now(),navigation_start:r||Date.now(),meta:{sdk_version:"1.0.0"}};return t("Session","Session data prepared",m),a(e),t("Session","Sending session data to server"),e._sendToServer("/api/optima/sessions",m).then((n=>{n?(t("Session","Session created successfully"),e._setupEventListeners(),e._setupPerformanceObservers(),e._startBatchProcessing(),e.sessionStartTime=Date.now(),e.unifiedDataModel.session_id=e.sessionId,e.unifiedDataModel.timestamp=e.sessionStartTime,t("Session","Unified data model updated")):t("Session","Failed to create session, monitoring disabled")})),p(),e.sessionId}function m(){p()}function h(e){if(!e.sessionId)return;"complete"===document.readyState?e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e.captureResourceData("load"),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer}),m()}),1e3)):window.addEventListener("load",(()=>{e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e.captureResourceData("load"),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer}),m()}),1e3))}));let t=null;if(document.addEventListener("click",(n=>{let s=n.target,i="";if("A"===s.tagName||s.closest("a")){const t="A"===s.tagName?s:s.closest("a");i="link",e.sendEvent("user_interaction",{type:"click",element_type:i,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null,element_href:t.href||null}),m()}else if("BUTTON"===s.tagName||s.closest("button")){const t="BUTTON"===s.tagName?s:s.closest("button");i="button",e.sendEvent("user_interaction",{type:"click",element_type:i,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null}),m()}t&&clearTimeout(t),t=setTimeout((()=>{e.captureResourceData("interaction"),t=null,m()}),2e3)})),"requestIdleCallback"in window){let t=!1;window.requestIdleCallback((()=>{t||(t=!0,e.captureResourceData("idle"),e.sendEvent("page_ready",{url:window.location.href,title:document.title,time_to_idle:performance.now()}),m())}),{timeout:3e3})}document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?(e.sendEvent("visibility_change",{state:"visible",timestamp:Date.now()}),m()):"hidden"===document.visibilityState&&(e.sendEvent("visibility_change",{state:"hidden",timestamp:Date.now()},{immediate:!0}),m())}))}function g(e){e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t||!t.error)return;try{const n=t.message||"Unknown error",s=t.filename||t.srcElement?.src||"unknown",i=t.error.stack||null,a="error",o={type:a,message:n,source:s,lineno:t.lineno||0,colno:t.colno||0,stack:i,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:b(a,n,s,i)};y(e,o),e.sendEvent("error",{error_type:"uncaught_error",message:o.message,source:o.source,lineno:o.lineno,colno:o.colno})}catch(e){console.warn("Optima SDK: Failed to process error",e)}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const n=t.reason,s=n instanceof Error?n.message:String(n),i=n instanceof Error?n.stack:null,a="unhandled_rejection",o="Promise",r={type:a,message:s,source:o,stack:i,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:b(a,s,o,i)};y(e,r),e.sendEvent("error",{error_type:"unhandled_rejection",message:r.message})}catch(e){console.warn("Optima SDK: Failed to process promise rejection",e)}}(e,t)})),function(e){const t=console.error;console.error=(...n)=>{try{const t=(new Error).stack||"",s=n.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),i="console_error",a="console.error",o={type:i,message:s,source:a,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:b(i,s,a,t)};y(e,o)}catch(e){}t.apply(console,n)}}(e)}function b(e,t,n,s){const i=`${e}:${t}:${n}:${s?s.substring(0,150):""}`;let a=0;for(let e=0;e<i.length;e++){a=(a<<5)-a+i.charCodeAt(e),a|=0}return"err_"+Math.abs(a).toString(16)}function y(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const n=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(n)return!1;const s=e.buffer.errors.slice(-5),i=s.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!i})(e,t)&&(e.buffer.errors.push(t),m(),e.buffer.errors.length>=10&&e._consolidateErrors())}function _(e){return{setupBufferManagement:function(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers:function(){const t=e.batchConfig.maxBufferSize;e.buffer.events.length>t&&(e.buffer.events=e.buffer.events.slice(-t)),e.buffer.resources.length>t&&(e.buffer.resources=e.buffer.resources.slice(-t)),e.buffer.webVitals.length>t&&(e.buffer.webVitals=e.buffer.webVitals.slice(-t))},hashResource:function(e){return`${e.type}|${e.name.split("?")[0]}|${e.duration<50?"fast":"slow"}`},shouldCollectResource:function(t){if(e.batchConfig.resourceDedupingEnabled){const n=this.hashResource(t);if(e.collectionState.resourceHashMap[n])return!1;e.collectionState.resourceHashMap[n]=Date.now()}return!0},startBatchProcessing:function(){if(setInterval((()=>{e.buffer.events.length>0&&e._flushEvents(),e.buffer.webVitals.length>0&&e._flushWebVitals(),e.buffer.resources.length>0&&e._flushResources()}),Math.min(e.batchConfig.flushInterval,1e4)),e.batchConfig.visibilityFlushEnabled){const t=()=>{const t=Date.now();e.collectionState.visibilityState;const n=document.visibilityState;e.collectionState.visibilityState=n,t-e.collectionState.lastVisibilityChange>1e3&&(e.collectionState.lastVisibilityChange=t,"hidden"===n?e._flushBuffers("visibilityHidden",!0):"visible"===n&&setTimeout((()=>{e.captureResourceData("visibilityVisible")}),1e3))};document.addEventListener("visibilitychange",t)}if(window.addEventListener("beforeunload",(()=>{e._flushBuffers("unload",!0)})),e.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const t=()=>{window.requestIdleCallback((()=>{(e.buffer.events.length>=10||e.buffer.resources.length>=10||Date.now()-e.collectionState.lastResourceFlush>3e4)&&e._flushBuffers("idle"),setTimeout((()=>{t()}),2e4)}),{timeout:1e4})};t()}this.setupBufferManagement()}}}return function(e){const t=XMLHttpRequest.prototype.open,i=XMLHttpRequest.prototype.send,o=e.fetch;function r(e){var t;console.log("[Optima Debug] Constructor called with options:",e),e=e||{},this.apiKey=e.apiKey,this.endpoint=e.endpoint||"http://localhost:3000",this.sampleRate="number"==typeof e.sampleRate?Math.min(Math.max(e.sampleRate,1),100):100,this.sessionId=null,this.sessionStartTime=null,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null},resources:[],ajax_requests:[],errors:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,flushInterval:e.flushInterval||5e3,webVitalsBatchDelay:e.webVitalsBatchDelay||2e3,batchBeforeSend:e.batchBeforeSend||!0,payloadCompressionThreshold:10240},this.collectionState={isFirstLoad:!0,resourcesCollected:!1,lastResourceFlush:null,lastEventFlush:null,lastAjaxCallFlush:null,isPerformanceObserverSet:!1,isBatchProcessingStarted:!1,unloadSent:!1,visibilityChangeCount:0},this.bufferManager=_(this),this.flushManager=(t=this,{flushBuffers:function(e,n=!1){t.buffer.events.length>0&&this.flushEvents(n),t.buffer.resources.length>0&&this.flushResources(n),t.buffer.webVitals.length>0&&this.flushWebVitals(n),t.buffer.ajaxCalls&&t.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(n)},flushEvents:function(e=!1){if(0===t.buffer.events.length)return;const n=t.buffer.events.slice(0,t.batchConfig.maxEventsPerBatch);t.buffer.events=t.buffer.events.slice(t.batchConfig.maxEventsPerBatch);const s={session_id:t.sessionId,events:n,timestamp:Date.now(),count:n.length};t.collectionState.lastEventFlush=Date.now(),t._sendToServer("/api/optima/events",s,{sync:e})},flushResources:function(e=!1){if(0===t.buffer.resources.length)return;const n=t.buffer.resources.slice(0,t.batchConfig.maxResourcesPerBatch);t.buffer.resources=t.buffer.resources.slice(t.batchConfig.maxResourcesPerBatch);const s={session_id:t.sessionId,resources:n,timestamp:Date.now(),count:n.length};t.collectionState.lastResourceFlush=Date.now(),t._sendToServer("/api/optima/resources",s,{sync:e})},flushWebVitals:function(e=!1){if(0===t.buffer.webVitals.length)return;const n={LCP:[],FID:[],CLS:[],INP:[],TTFB:[],FCP:[]};t.buffer.webVitals.forEach((e=>{if(e&&e.event_data&&e.event_data.name){const t=e.event_data.name;n[t]&&n[t].push(e)}}));const s=t.buffer.webVitals.slice(0,t.batchConfig.maxWebVitalsPerBatch);t.buffer.webVitals=t.buffer.webVitals.slice(t.batchConfig.maxWebVitalsPerBatch);const i={session_id:t.sessionId,web_vitals:s,processed_vitals:n,timestamp:Date.now(),count:s.length};t._sendToServer("/api/optima/web-vitals",i,{sync:e})},flushAjaxCalls:function(e=!1){if(!t.buffer.ajaxCalls||0===t.buffer.ajaxCalls.length)return;const n=t.buffer.ajaxCalls.slice(0,t.batchConfig.maxAjaxCallsPerBatch);t.buffer.ajaxCalls=t.buffer.ajaxCalls.slice(t.batchConfig.maxAjaxCallsPerBatch);const s={session_id:t.sessionId,ajax_calls:n,timestamp:Date.now(),count:n.length};t.collectionState.lastAjaxCallFlush=Date.now(),t._sendToServer("/api/optima/ajax-calls",s,{sync:e})}}),this._setupBatchedCollection(),this._webVitalsBatchTimer=null,this._init(),console.log("[Optima Debug] Constructor completed, instance created")}e.__optima_early_xhr_queue=e.__optima_early_xhr_queue||[],console.log("[Optima Debug] Installing early interception"),XMLHttpRequest.prototype.open=function(e,n,s,i,a){return this.__optima_req_data={method:e,url:n,async:!1!==s,user:i,password:a,startTime:Date.now(),perfStartTime:performance.now()},t.apply(this,arguments)},XMLHttpRequest.prototype.send=function(t){if(this.__optima_req_data){try{this.__optima_req_data.requestSize=t?"string"==typeof t?t.length:t instanceof Blob?t.size:t instanceof ArrayBuffer?t.byteLength:JSON.stringify(t).length:0}catch(e){this.__optima_req_data.requestSize=-1}const n=this,s=Object.assign({},this.__optima_req_data);this.addEventListener("load",(function(){try{const t=Date.now(),i=performance.now(),a={type:"xhr",method:s.method,url:n.responseURL||s.url,status:n.status,statusText:n.statusText,startTime:s.startTime,endTime:t,duration:t-s.startTime,perfDuration:i-s.perfStartTime,timestamp:t,captureMethod:"early-intercept-xhr",responseSize:n.responseText?n.responseText.length:-1,initiatorType:"xhr"};e.__optima_early_xhr_queue.push(a),console.log(`[Optima Debug] Early XHR capture: ${s.method} ${s.url} - Status: ${n.status}`)}catch(e){console.error("[Optima Debug] Error in XHR load listener:",e)}}),!1),this.addEventListener("error",(function(){try{const t=Date.now(),n=performance.now(),i={type:"xhr",method:s.method,url:s.url,status:0,statusText:"Network Error",startTime:s.startTime,endTime:t,duration:t-s.startTime,perfDuration:n-s.perfStartTime,timestamp:t,captureMethod:"early-intercept-xhr-error",initiatorType:"xhr",error:!0};e.__optima_early_xhr_queue.push(i),console.log(`[Optima Debug] Early XHR error: ${s.method} ${s.url}`)}catch(e){console.error("[Optima Debug] Error in XHR error listener:",e)}}),!1),this.addEventListener("abort",(function(){try{const t=Date.now(),n={type:"xhr",method:s.method,url:s.url,status:0,statusText:"Aborted",startTime:s.startTime,endTime:t,duration:t-s.startTime,timestamp:t,captureMethod:"early-intercept-xhr-abort",initiatorType:"xhr",aborted:!0};e.__optima_early_xhr_queue.push(n),console.log(`[Optima Debug] Early XHR aborted: ${s.method} ${s.url}`)}catch(e){console.error("[Optima Debug] Error in XHR abort listener:",e)}}),!1)}return i.apply(this,arguments)},e.fetch=function(){const t=Array.prototype.slice.call(arguments),n=Date.now(),s=performance.now();let i,a;"string"==typeof t[0]?(i=t[0],a=t[1]&&t[1].method||"GET",t[1]&&t[1].body):t[0]&&"object"==typeof t[0]&&t[0].url&&(i=t[0].url,a=t[0].method||"GET",t[0].body);return o.apply(this,t).then((function(t){try{const o=Date.now(),r=performance.now(),l=t.clone(),u={type:"fetch",method:a,url:t.url||i,status:t.status,statusText:t.statusText,startTime:n,endTime:o,duration:o-n,perfDuration:r-s,timestamp:o,captureMethod:"early-intercept-fetch",initiatorType:"fetch"};t.bodyUsed||l.text().then((function(e){u.responseSize=e?e.length:0})).catch((function(){u.responseSize=-1})),e.__optima_early_xhr_queue.push(u),console.log(`[Optima Debug] Early fetch capture: ${a} ${i} - Status: ${t.status}`)}catch(e){console.error("[Optima Debug] Error in fetch response handler:",e)}return t})).catch((function(t){try{const t=Date.now(),o=performance.now(),r={type:"fetch",method:a,url:i,status:0,statusText:"Network Error",startTime:n,endTime:t,duration:t-n,perfDuration:o-s,timestamp:t,captureMethod:"early-intercept-fetch-error",initiatorType:"fetch",error:!0};e.__optima_early_xhr_queue.push(r),console.log(`[Optima Debug] Early fetch error: ${a} ${i}`)}catch(e){console.error("[Optima Debug] Error in fetch error handler:",e)}throw t}))},r.prototype={_init:function(){console.log("[Optima Debug] Initializing SDK, apiKey present:",!!this.apiKey),this.apiKey?(this._setupAjaxMonitoring(),this._processEarlyInterceptedRequests(),this._captureEarlyAjaxRequests(),this._setupErrorMonitoring(),this._initPerformanceMetrics(),console.log("[Optima Debug] Creating session"),this.createSession(),this._setupPageLifecycleEvents(),console.log("[Optima Debug] SDK initialization completed")):console.warn("[Optima Debug] No API key not provided, SDK will not be fully initialized")},_initPerformanceMetrics:function(){if(e.performance&&e.performance.mark){e.performance.mark("optima_init");try{e.performance.getEntriesByType("mark").concat(e.performance.getEntriesByType("measure")).filter((e=>e.name.startsWith("optima_"))).forEach((t=>{e.performance.clearMarks(t.name),"measure"===t.entryType&&e.performance.clearMeasures(t.name)}))}catch(e){}this._setupCoreWebVitals(),this._captureNavigationTiming()}},_captureNavigationTiming:function(){try{console.log("[Optima Debug] Capturing navigation timing");const e=performance.getEntriesByType("navigation")[0];e?(this.unifiedDataModel.timings={navigationStart:0,fetchStart:e.fetchStart,domainLookupStart:e.domainLookupStart,domainLookupEnd:e.domainLookupEnd,connectStart:e.connectStart,connectEnd:e.connectEnd,requestStart:e.requestStart,responseStart:e.responseStart,responseEnd:e.responseEnd,domInteractive:e.domInteractive,domContentLoadedEventStart:e.domContentLoadedEventStart,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domComplete:e.domComplete,loadEventStart:e.loadEventStart,loadEventEnd:e.loadEventEnd,duration:e.duration,type:e.type,redirectCount:e.redirectCount,nextHopProtocol:e.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:e.responseStart,timestamp:performance.timeOrigin+e.responseStart},console.log("[Optima Debug] TTFB captured:",this.unifiedDataModel.web_vitals.TTFB),this.sendEvent("core_web_vital",{name:"TTFB",value:e.responseStart},{immediate:!0})):console.warn("[Optima Debug] No navigation timing entries available")}catch(e){console.error("[Optima Debug] Error capturing navigation timing:",e)}},_setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{this.collectionState.visibilityChangeCount++,"hidden"===document.visibilityState?this._prepareFinalDataAndSend(!0):"visible"===document.visibilityState&&this._refreshVisibleState()})),e.addEventListener("beforeunload",(()=>{this.collectionState.unloadSent||(this._prepareFinalDataAndSend(!0),this.collectionState.unloadSent=!0)})),this._setupPeriodicFlush()},_prepareFinalDataAndSend:function(e=!1){console.log("[Optima Debug] Preparing final data for sending, useBeacon:",e),this._consolidateBufferedData(),this._updateWebVitalsInUnifiedModel(),this._sendUnifiedData(e)},_updateWebVitalsInUnifiedModel:function(){this.buffer.webVitals.forEach((e=>{if(!e.event_data||!e.event_data.name)return;const{name:t,value:n}=e.event_data,s=e.timestamp;"LCP"===t?(!this.unifiedDataModel.web_vitals.LCP||n>this.unifiedDataModel.web_vitals.LCP.value)&&(this.unifiedDataModel.web_vitals.LCP={value:n,timestamp:s,element:e.event_data.element||"unknown"}):"FID"===t?this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:n,timestamp:s,inputType:e.event_data.inputType}):"CLS"===t?(!this.unifiedDataModel.web_vitals.CLS||n>this.unifiedDataModel.web_vitals.CLS.value)&&(this.unifiedDataModel.web_vitals.CLS={value:n,timestamp:s,entries:e.event_data.entries}):"FCP"===t?this.unifiedDataModel.web_vitals.FCP||(this.unifiedDataModel.web_vitals.FCP={value:n,timestamp:s}):"INP"===t&&(!this.unifiedDataModel.web_vitals.INP||n>this.unifiedDataModel.web_vitals.INP.value)&&(this.unifiedDataModel.web_vitals.INP={value:n,timestamp:s,event:e.event_data.event})})),this.buffer.webVitals=[]},_consolidateBufferedData:function(){this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.ajaxCalls.length>0&&(this.unifiedDataModel.ajax_requests=[...this.unifiedDataModel.ajax_requests,...this.buffer.ajaxCalls],this.buffer.ajaxCalls=[]),this.buffer.errors.length>0&&this._consolidateErrors(),this.buffer.events=[],this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel.timestamp=Date.now(),this._updateMetadata()},_consolidateErrors:function(){if(!this.buffer.errors||0===this.buffer.errors.length)return;this.unifiedDataModel.errors||(this.unifiedDataModel.errors=[]);const e=this.buffer.errors.filter((e=>!this.unifiedDataModel.errors.some((t=>t.error_id&&e.error_id?t.error_id===e.error_id:t.type===e.type&&t.message===e.message&&t.source===e.source&&t.stack===e.stack))));this.unifiedDataModel.errors=[...this.unifiedDataModel.errors,...e],this.buffer.errors=[],console.log("[Optima Debug] Consolidated errors into unified model:",this.unifiedDataModel.errors.length)},_updateMetadata:function(){this.unifiedDataModel.meta={url:e.location.href,path:e.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:e.screen.width,screen_height:e.screen.height,viewport_width:e.innerWidth,viewport_height:e.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:performance.getEntriesByType("navigation")[0]?.type||null}},_sendUnifiedData:function(e=!1){if(!this.unifiedDataModel.session_id)return void console.warn("[Optima Debug] Not sending data - no session ID");const t=JSON.parse(JSON.stringify(this.unifiedDataModel));console.log("[Optima Debug] Sending unified data model:","session:",t.session_id,"resources:",t.resources.length,"ajax_requests:",t.ajax_requests.length,"web_vitals:",t.web_vitals),this._sendToServer("/api/optima/collect",t,{sync:e}),this._resetVolatileDataInUnifiedModel()},_resetVolatileDataInUnifiedModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},_setupBatchedCollection:function(){this.disabled||this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this._startBatchedCollection())},_startBatchedCollection:function(){setInterval((()=>{this._collectResources()}),3e3),this._setupPeriodicFlush()},_setupPeriodicFlush:function(){setInterval((()=>{this._hasSignificantData()&&this._prepareFinalDataAndSend(!1)}),this.batchConfig.flushInterval)},_hasSignificantData:function(){return this.unifiedDataModel.resources.length>0||this.unifiedDataModel.ajax_requests.length>0||this.buffer.webVitals.length>0||this.buffer.errors.length>0||this.unifiedDataModel.errors.length>0||this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value||this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value||this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value||this.unifiedDataModel.web_vitals.FCP&&this.unifiedDataModel.web_vitals.FCP.value},_collectResources:function(){try{performance.getEntriesByType("resource").forEach((e=>{if(this._isResourceProcessed(e.name))return;const t={name:e.name,type:this._getResourceType(e),startTime:Math.round(e.startTime),duration:Math.round(e.duration),size:e.transferSize||0,protocol:e.nextHopProtocol,encodedSize:e.encodedBodySize||0,decodedSize:e.decodedBodySize||0,initiatorType:e.initiatorType};this.unifiedDataModel.resources.push(t)})),this.collectionState.resourcesCollected=!0}catch(e){}},_isResourceProcessed:function(e){return this.unifiedDataModel.resources.some((t=>t.name===e))},_getResourceType:function(e){const t=e.initiatorType,n=e.name;return"img"===t||"image"===t?"image":"script"===t?"script":"link"===t&&e.nextHopProtocol||"css"===t?"stylesheet":"fetch"===t||"xmlhttprequest"===t?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(n)?"image":/\.(?:js)(?:\?|$)/i.test(n)?"script":/\.(?:css)(?:\?|$)/i.test(n)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(n)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(n)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(n)?"audio":"other"},_detectBrowser:function(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("MSIE")>-1||e.indexOf("Trident/")>-1?"IE":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1||e.indexOf("OPR/")>-1?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"},_refreshVisibleState:function(){this.collectionState.visibilityChangeCount>1&&this._collectResources()},_setupCoreWebVitals:function(){this.disabled||n(this)},_setupBufferManagement:function(){this.bufferManager.setupBufferManagement()},_shouldCollectResource:function(e){return this.bufferManager.shouldCollectResource(e)},_startBatchProcessing:function(){this.bufferManager.startBatchProcessing()},_flushBuffers:function(e,t=!1){this._prepareFinalDataAndSend(t)},_flushEvents:function(e=!1){const t=this.buffer.events.slice();if(this.buffer.events=[],0===t.length)return;const n={session_id:this.sessionId,events:t,timestamp:Date.now()};this._sendToServer("/api/optima/events",n,{sync:e})},_flushResources:function(e=!1){const t=this.buffer.resources.slice();if(this.buffer.resources=[],0===t.length)return;const n={session_id:this.sessionId,resources:t,timestamp:Date.now()};this._sendToServer("/api/optima/resources",n,{sync:e})},_flushWebVitals:function(e=!1){const t=this.buffer.webVitals.slice();if(this.buffer.webVitals=[],0===t.length)return;const n={session_id:this.sessionId,web_vitals:t,timestamp:Date.now()};this._sendToServer("/api/optima/web-vitals",n,{sync:e})},_setupEventListeners:function(){this.disabled||h(this)},_setupPerformanceObservers:function(){this.disabled||(this._setupCoreWebVitals(),this._setupAjaxMonitoring(),this.captureResourceData("setup"))},captureResourceData:function(e="auto"){return this.disabled?(console.log("[Optima Debug] Resources not captured - SDK disabled due to sample rate"),!1):(this._collectResources(),!0)},_sendResourceBatch:function(e){return e&&e.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...e]),!0},createSession:function(){return console.log("[Optima Debug] Creating a new session"),f(this)},_sendToServer:function(e,t,n={}){if(!this.apiKey)return console.error("Optima SDK: API key not set. Cannot send data to server."),Promise.reject(new Error("API key not set"));const s=this.endpoint+e;if(n.sync&&navigator.sendBeacon){const n=new Blob([JSON.stringify(t)],{type:"application/json"}),i=navigator.sendBeacon(s,n);return console.log(`[Optima Debug] Sent data to ${e} using sendBeacon. Status: ${i?"success":"failed"}`),Promise.resolve(i)}if(e.includes("ajax-calls")&&(console.log(`[Optima Debug] Sending ${t.ajax_calls?.length||0} AJAX calls to server at ${s}`),t.ajax_calls&&t.ajax_calls.length>0)){console.log("[Optima Debug] Sample AJAX calls:",t.ajax_calls.slice(0,3).map((e=>({url:e.url,method:e.method,type:e.type,status:e.status,startTime:new Date(e.startTime).toISOString()}))));const e=t.ajax_calls.reduce(((e,t)=>(e[t.type]=(e[t.type]||0)+1,e)),{});console.log("[Optima Debug] AJAX call types:",e)}return fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t)}).then((e=>{if(!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()})).then((t=>(console.log(`[Optima Debug] Data sent to ${e} successfully`),!0))).catch((t=>(console.error(`[Optima Debug] Error sending data to ${e}:`,t),!1)))},sendEvent:function(e,t,n={}){if(this.disabled)return console.log("[Optima Debug] Event not sent - SDK disabled due to sample rate"),!1;if(!this.sessionId)return!1;const s={session_id:this.sessionId,event_type:e,event_data:t||{},timestamp:Date.now()};return"core_web_vital"===e?(this.buffer.webVitals.push(s),!0===n.immediate&&this._updateWebVitalsInUnifiedModel()):this.buffer.events.push(s),!0},collectPerformanceMetrics:function(){return this._collectResources(),this._updateWebVitalsInUnifiedModel(),!0},sendCollectedData:function(e=!1){return this.disabled?(console.log("[Optima Debug] Data not sent - SDK disabled due to sample rate"),!1):(this._prepareFinalDataAndSend(e),!0)},debug:function(){return{sessionId:this.sessionId,apiKey:this.apiKey?`${this.apiKey.substring(0,4)}...`:"None",endpoint:this.endpoint,bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs.size},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},_setupAjaxMonitoring:function(){s(this)},_flushAjaxCalls:function(e=!1){if(!this.buffer.ajaxCalls||0===this.buffer.ajaxCalls.length)return;const t=this.buffer.ajaxCalls.slice();this.buffer.ajaxCalls=[];const n={session_id:this.sessionId,ajax_calls:t,timestamp:Date.now()};this._sendToServer("/api/optima/ajax-calls",n,{sync:e})},_createSession:function(t,n,s={}){if(!this.apiKey)return void console.error("Optima SDK: API key not set. Cannot create session.");const i=e.navigator.userAgent,o=this._getDeviceType(),r=this._getConnectionType(),l=Date.now(),u=performance?.timing?.navigationStart||l,c={session_id:this.sessionId,page_url:t,referrer:n,user_agent:i,device_type:o,connection_type:r,timestamp:l,navigation_start:u,web_vitals:{},errors:[],resources:[],ajax_requests:[],meta:{...s,sdk_version:this.version}};this._sendToServer("/api/optima/sessions",c).then((e=>{e?(console.log("[Optima Debug] Session: Session created successfully"),console.log("[Optima Debug] Session: Merging any pre-session AJAX calls"),a(this),this._startMonitoringInterval()):console.error("[Optima Debug] Session: Failed to create session")})).catch((e=>{console.error("[Optima Debug] Session: Error creating session",e)}))},_flushAll:function(e=!1){this._consolidateBufferedData();const t={session_id:this.sessionId,...this.unifiedDataModel,timestamp:Date.now()};this._sendToServer("/api/optima/collect",t,{sync:e}),this.buffer.events=[],this.buffer.resources=[],this.buffer.webVitals=[],this.buffer.ajaxCalls=[],this._resetUnifiedDataModel()},_resetUnifiedDataModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[],this.unifiedDataModel.web_vitals={LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null},this.unifiedDataModel.timings=null,this.unifiedDataModel.errors=[],this.unifiedDataModel.metrics={},this.unifiedDataModel.meta={}},_setupErrorMonitoring:function(){g(this)},_flushErrors:function(e=!1){return!(!(t=this).buffer.errors||0===t.buffer.errors.length||(t._consolidateErrors(),0));var t},_captureEarlyAjaxRequests:function(){if(!e.performance||!e.performance.getEntriesByType)return void console.log("[Optima Debug] Performance API not available, cannot capture early AJAX requests");console.log("[Optima Debug] Checking for early AJAX requests via Performance API");const t=e.performance.getEntriesByType("resource"),n=t.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)),s=t.filter((e=>{if(n.includes(e))return!1;const t=e.name;if(t.includes("/api/")||t.includes("/graphql")||t.match(/\/(v1|v2|v3)\//)||t.includes("/rest/")||t.includes("/data/"))return!0;try{const e=new URL(t).pathname.split(".").pop();if(["json","xml","graphql"].includes(e))return!0}catch{}return!1})),i=[...new Set([...n,...s])];if(!i.length)return void console.log("[Optima Debug] No early AJAX requests found in Performance timeline");console.log(`[Optima Debug] Found ${i.length} early AJAX requests in Performance timeline`);const a=i.map((e=>{let t="GET";(e.name.includes("graphql")||e.transferSize>1e3)&&(t="POST");return{type:"fetch"===e.initiatorType?"fetch":"xhr",method:t,url:e.name,status:200,statusText:"OK",startTime:Math.round(e.startTime+performance.timeOrigin),duration:Math.round(e.duration),requestPayloadSize:-1,responseSize:Math.round(e.transferSize)||-1,decodedBodySize:Math.round(e.decodedBodySize)||-1,encodedBodySize:Math.round(e.encodedBodySize)||-1,aborted:!1,errored:!1,timestamp:Math.round(e.startTime+performance.timeOrigin),captureSource:"performance-timeline",resourceTiming:{startTime:Math.round(e.startTime),duration:Math.round(e.duration),domainLookupTime:Math.round(e.domainLookupEnd-e.domainLookupStart),connectTime:Math.round(e.connectEnd-e.connectStart),tlsTime:e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,requestStartTime:Math.round(e.requestStart),ttfb:Math.round(e.responseStart-e.requestStart),downloadTime:Math.round(e.responseEnd-e.responseStart),entryType:e.entryType,initiatorType:e.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transferSize>0?e.transferSize.toString():"unknown","cache-control":"unknown"}}})).filter((e=>!this._isOptimaApiCall(e.url)));0!==a.length?(console.log(`[Optima Debug] Adding ${a.length} early AJAX requests to pre-session buffer`),this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...a)):console.log("[Optima Debug] No relevant early AJAX requests found after filtering")},_isOptimaApiCall:function(e){return e.includes("/api/optima/sessions")||e.includes("/api/optima/events")||e.includes("/api/optima/resources")||e.includes("/api/optima/web-vitals")||e.includes("/api/optima/ajax-calls")||e.includes("/api/optima/collect")||e.includes("/api/sessions")||e.includes("/api/events")||e.includes("/api/resources")||e.includes("/api/web-vitals")||e.includes("/api/ajax-calls")||e.includes("/api/collect")||e.includes("optima.js")||e.includes("optima.min.js")},_processEarlyInterceptedRequests:function(){if(!e.__optima_early_xhr_queue||!e.__optima_early_xhr_queue.length)return void console.log("[Optima Debug] No early intercepted requests found");const t=e.__optima_early_xhr_queue;console.log(`[Optima Debug] Processing ${t.length} early intercepted requests`);let n=[];e.performance&&e.performance.getEntriesByType&&(n=e.performance.getEntriesByType("resource"),console.log(`[Optima Debug] Found ${n.length} resource timing entries to correlate with`));const s=t.map((e=>{if(this._isOptimaApiCall(e.url)||e.responseURL&&this._isOptimaApiCall(e.responseURL))return null;let t=null;if(n.length>0){const s=e.url||"",i=n.filter((t=>t.name===s||e.responseURL&&t.name===e.responseURL||t.name.includes(new URL(s).pathname)||e.responseURL&&t.name.includes(new URL(e.responseURL).pathname)));if(i.length>0){const n=i.sort(((t,n)=>Math.abs(t.startTime+performance.timeOrigin-e.startTime)-Math.abs(n.startTime+performance.timeOrigin-e.startTime)))[0];n&&(t={startTime:Math.round(n.startTime),duration:Math.round(n.duration),domainLookupTime:Math.round(n.domainLookupEnd-n.domainLookupStart),connectTime:Math.round(n.connectEnd-n.connectStart),tlsTime:n.secureConnectionStart?Math.round(n.connectEnd-n.secureConnectionStart):0,requestStartTime:Math.round(n.requestStart),ttfb:Math.round(n.responseStart-n.requestStart),downloadTime:Math.round(n.responseEnd-n.responseStart),entryType:n.entryType,initiatorType:n.initiatorType,transferSize:n.transferSize||0,decodedBodySize:n.decodedBodySize||0},console.log(`[Optima Debug] Found matching resource timing for ${e.url&&e.url.substring(0,50)}...`))}}let s=e.responseSize;return(void 0===s||s<0)&&(s=t&&t.transferSize>0?t.transferSize:t&&t.decodedBodySize>0?t.decodedBodySize:-1),{type:e.type||"xhr",method:e.method||"GET",url:e.responseURL||e.url,originalUrl:e.url,status:e.status||0,statusText:e.statusText||"",startTime:e.startTime,endTime:e.endTime||e.startTime+(e.duration||0),duration:e.duration||0,async:!0,requestPayloadSize:e.requestSize||-1,responseSize:s,aborted:!!e.aborted,errored:!!e.error||!!e.errored,timestamp:e.timestamp||e.startTime,resourceTiming:t,captureSource:e.captureMethod||"early-intercept",requestHeaders:e.requestHeaders||{"content-type":"unknown","content-length":"unknown"},responseHeaders:e.responseHeaders||{"content-type":"unknown","content-length":s>0?s.toString():"unknown","cache-control":"unknown"}}})).filter(Boolean);0!==s.length?(s.sort(((e,t)=>e.startTime-t.startTime)),console.log(`[Optima Debug] Adding ${s.length} early intercepted requests to pre-session buffer`),this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...s),e.__optima_early_xhr_queue=[]):console.log("[Optima Debug] No valid early requests to process after filtering")}};var l=function(){var t=Array.prototype.slice.call(arguments),n=t[0];if(console.log("[Optima Debug] Command received:",n,t.slice(1)),"init"===n){var s=t[1]||null,i=t[2]||{};return i.apiKey=s,console.log("[Optima Debug] Initializing SDK with apiKey:",s?s.substring(0,4)+"***":"null","and config:",i),e.optimaInstance=new r(i),e.optimaInstance}if(!e.optimaInstance)return console.warn("[Optima Debug] Command executed before initialization:",n),!1;switch(n){case"event":return console.log("[Optima Debug] Sending event:",t[1],t[2]),e.optimaInstance.sendEvent(t[1],t[2],t[3]);case"captureResources":return console.log("[Optima Debug] Capturing resources manually"),e.optimaInstance.captureResourceData("manual");case"flushBuffers":return console.log("[Optima Debug] Flushing buffers, useBeacon:",!0===t[1]),e.optimaInstance.sendCollectedData(!0===t[1]);case"debug":return console.log("[Optima Debug] Debug info requested"),e.optimaInstance.debug();default:return console.warn("[Optima Debug] Unknown command:",n),!1}};e.Optima=r;var u=null;if("function"==typeof e.optima)if(console.log("[Optima Debug] Processing queued commands"),(u=e.optima).q&&u.q.length){console.log("[Optima Debug] Found",u.q.length,"queued commands"),e.optima=l;for(var c=0;c<u.q.length;c++)console.log("[Optima Debug] Processing queued command:",u.q[c][0]),l.apply(e,u.q[c])}else e.optima=l;else console.log("[Optima Debug] No queued commands found, setting up optima handler"),e.optima=l}(window),e.init=function(e={}){if(!window._optimaEarlyCapture){window._optimaEarlyCapture={xhrCalls:[],fetchCalls:[]};const e=window.XMLHttpRequest;if(window.XMLHttpRequest=function(){const t=new e,n=t.open,s=t.send;return t.open=function(){return this._optimaUrl=arguments[1],this._optimaMethod=arguments[0],n.apply(this,arguments)},t.send=function(){const e=Date.now();return this.addEventListener("load",(function(){window._optimaEarlyCapture.xhrCalls.push({type:"xhr",url:this._optimaUrl,method:this._optimaMethod,status:this.status,startTime:e,duration:Date.now()-e})})),s.apply(this,arguments)},t},window.fetch){const e=window.fetch;window.fetch=function(t,n){const s=Date.now(),i="string"==typeof t?t:t.url,a=n?.method||"GET";return e.apply(this,arguments).then((e=>(window._optimaEarlyCapture.fetchCalls.push({type:"fetch",url:i,method:a,status:e.status,startTime:s,duration:Date.now()-s}),e)))}}}const t=createSDKInstance(e);if(window._optimaEarlyCapture){const e=[...window._optimaEarlyCapture.xhrCalls,...window._optimaEarlyCapture.fetchCalls];e.length>0&&(debugLog("SDK","Processing early captured requests",{count:e.length}),e.forEach((e=>{storeAjaxCallData(t,e)}))),window._optimaEarlyCapture=null}return t},e}({});
