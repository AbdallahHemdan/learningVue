!function(){"use strict";function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function t(e){if(!e||!e.previousRect||!e.currentRect)return 0;const t=e.previousRect,n=e.currentRect,i=Math.abs(t.x-n.x),r=Math.abs(t.y-n.y);return Math.sqrt(i*i+r*r)*(Math.max(t.width*t.height,n.width*n.height)/(window.innerWidth*window.innerHeight))}function n(e){return e?{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(e.width),height:Math.round(e.height),top:Math.round(e.top),right:Math.round(e.right),bottom:Math.round(e.bottom),left:Math.round(e.left)}:null}function i(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id){e+=`#${n.id}`,t.unshift(e);break}if(n.className&&"string"==typeof n.className){const t=n.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let i=n,r=1;for(;i=i.previousElementSibling;)r++;if(r>1&&(e+=`:nth-child(${r})`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function r(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id&&(e=`${e}#${n.id}`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function s(e){if(!e||!e.textContent)return null;const t=e.textContent.trim().replace(/\s+/g," ");return t.length>60?t.substring(0,60)+"...":t}function o(e){if(!e||!e.attributes)return{};const t={},n=["src","href","alt","title","aria-label","role","data-testid"];n.forEach((n=>{e.hasAttribute(n)&&(t[n]=e.getAttribute(n))}));for(let i=0;i<e.attributes.length;i++){const r=e.attributes[i];r.name.startsWith("data-")&&!n.includes(r.name)&&(t[r.name]=r.value)}return t}function a(e){if(!e||!e.previousRect||!e.currentRect)return"unknown";const t=e.previousRect,n=e.currentRect;if(0===t.width&&0===t.height&&(n.width>0||n.height>0))return"appeared";if(0===n.width&&0===n.height&&(t.width>0||t.height>0))return"disappeared";const i=Math.abs(t.width-n.width)>1||Math.abs(t.height-n.height)>1,r=Math.abs(t.x-n.x)>1||Math.abs(t.y-n.y)>1;return i&&r?"resize-and-move":i?"resize":r?"move":"unknown"}function c(e){if(!e||!window.getComputedStyle)return!1;try{const t=window.getComputedStyle(e);return"0s"!==t.transitionDuration||"none"!==t.animationName||e.classList.contains("animate")||e.classList.contains("fade")||e.classList.contains("slide")}catch(e){return!1}}function u(e,t,n,i={}){if(e._routeVitalHandlers&&e._routeVitalHandlers.size>0){const r={name:t,value:n,timestamp:i.timestamp||performance.timeOrigin+performance.now(),vitalCaptureTime:performance.timeOrigin+performance.now(),...i};console.log("[WebVitals Debug] Notifying route handlers:",r),e._routeVitalHandlers.forEach((e=>{try{e(r)}catch(e){console.log("[WebVitals Debug] Error in route handler:",e.message)}}))}}function l(e){try{"PerformanceObserver"in window&&(function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("paint"))return;try{new PerformanceObserver((t=>{const n=t.getEntries().find((e=>"first-contentful-paint"===e.name));if(!n)return;window.performance.mark("optima_fcp");const i=n.startTime;e.sendEvent("core_web_vital",{name:"FCP",value:i},{immediate:!0}),e.unifiedDataModel.web_vitals.FCP={value:i,timestamp:performance.timeOrigin+n.startTime},u(e,"FCP",i,{timestamp:performance.timeOrigin+n.startTime,vitalCaptureTime:performance.timeOrigin+performance.now()}),setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),500)})).observe({type:"paint",buffered:!0}),setTimeout((()=>{if(!e.unifiedDataModel.web_vitals.FCP){const t=performance.getEntriesByType("paint").find((e=>"first-contentful-paint"===e.name));t&&(e.unifiedDataModel.web_vitals.FCP={value:t.startTime,timestamp:performance.timeOrigin+t.startTime},e.sendEvent("core_web_vital",{name:"FCP",value:t.startTime},{immediate:!0}),u(e,"FCP",t.startTime,{timestamp:performance.timeOrigin+t.startTime,vitalCaptureTime:performance.timeOrigin+performance.now(),source:"fallback"}))}}),3e3)}catch(e){}}(e),function(e){let t=0;const n=new PerformanceObserver((n=>{const i=n.getEntries(),r=i[i.length-1];if(window.performance.mark("optima_lcp"),window.performance.measure("optima_lcp_time","navigationStart","optima_lcp"),r.startTime>t){t=r.startTime;const n=function(e){if(e.element){const t=e.element,n=d(t),i=h(t);return{tagName:t.tagName,id:t.id||null,className:t.className||null,cssPath:n,domPath:i,size:e.size,url:e.url||null,dimensions:t.getBoundingClientRect?{width:Math.round(t.getBoundingClientRect().width),height:Math.round(t.getBoundingClientRect().height)}:null,nodeType:t.nodeType,textContent:t.textContent?.slice(0,100)||null}}if(e.url){const t=e.url,n=function(e){try{const t=e.split("?")[0],n=t.split("#")[0].split("/").pop(),i=Array.from(document.querySelectorAll("img[src]"));for(const t of i)if(t.src===e||t.src.includes(n))return t;try{const t=Array.from(document.querySelectorAll("image[href]")),i=Array.from(document.querySelectorAll("image[*|href]")),r=[...t,...i];for(const t of r){const i=t.getAttribute("href")||t.getAttribute("xlink:href");if(i===e||i?.includes(n))return t}}catch(e){}const r=Array.from(document.querySelectorAll("*"));for(const t of r){const i=window.getComputedStyle(t).backgroundImage;if(i&&"none"!==i){const r=i.match(/url\(['"]?(.*?)['"]?\)/)?.[1];if(r===e||r?.includes(n))return t}}const s=performance.getEntriesByType("resource").find((t=>t.name===e));if(s&&"img"===s.initiatorType){return Array.from(document.querySelectorAll("div, section, header, main, article")).sort(((e,t)=>{const n=e.getBoundingClientRect(),i=t.getBoundingClientRect();return i.width*i.height-n.width*n.height}))[0]||null}}catch(e){}return null}(t);return n?{tagName:n.tagName,id:n.id||null,className:n.className||null,cssPath:d(n),domPath:h(n),size:e.size,url:t,elementFoundBy:"url-matching",dimensions:n.getBoundingClientRect?{width:Math.round(n.getBoundingClientRect().width),height:Math.round(n.getBoundingClientRect().height)}:null}:{tagName:null,url:t,size:e.size,elementFoundBy:"url-only",imageType:f(t),resourceType:m(t)}}return{detail:"No element or URL available",size:e.size||0,startTime:e.startTime}}(r);e.sendEvent("core_web_vital",{name:"LCP",value:r.startTime,element:n}),e.unifiedDataModel.web_vitals.LCP={value:r.startTime,timestamp:performance.timeOrigin+r.startTime,element:n},u(e,"LCP",r.startTime,{element:n,timestamp:performance.timeOrigin+r.startTime,vitalCaptureTime:performance.timeOrigin+performance.now()}),i.length<=1&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3)}}));n.observe({type:"largest-contentful-paint",buffered:!0})}(e),function(e){const t=new PerformanceObserver((t=>{const n=t.getEntries()[0];window.performance.mark("optima_fid");const i={type:n.name,targetElement:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null,timing:{processingStart:n.processingStart,processingEnd:n.processingEnd,startTime:n.startTime}},r=n.processingStart-n.startTime;e.sendEvent("core_web_vital",{name:"FID",value:r,inputType:n.name,details:i},{immediate:!0}),e.unifiedDataModel.web_vitals.FID={value:r,timestamp:performance.timeOrigin+n.startTime,inputType:n.name,details:i},u(e,"FID",r,{inputType:n.name,details:i,timestamp:performance.timeOrigin+n.startTime,vitalCaptureTime:performance.timeOrigin+performance.now()})}));t.observe({type:"first-input",buffered:!0})}(e),function(e){let u=0,l=[],d=[],h=performance.now(),f=0,m=0,p={value:0,entry:null,sourceInfo:null};if(document.addEventListener("visibilitychange",(()=>{if("hidden"===document.visibilityState)f>0&&(e.unifiedDataModel.web_vitals.CLS={value:f,timestamp:Date.now(),entries:d.length,largestShiftSource:p.sourceInfo});else if("visible"===document.visibilityState){performance.now()-h>1e3&&(h=performance.now(),f=0,d=[])}})),!window.PerformanceObserver)return;if(!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("layout-shift"))return;const g=new PerformanceObserver((h=>{try{const g=h.getEntries();if(0===g.length)return;g.forEach(((h,m)=>{try{if(!h.hadRecentInput&&(u+=h.value,l.push(h),f+=h.value,d.push({value:h.value,startTime:h.startTime}),h.value>p.value)){let u=null;try{u=function(e){if(!e||!e.sources||0===e.sources.length)return null;try{const u=e.sources.reduce(((e,n)=>{try{return(n.impactValue||t(n))>(e.impactValue||t(e))?n:e}catch(t){return e}}),e.sources[0]);if(!u)return null;const l=u.node;return l?{tagName:l.tagName||"UNKNOWN",id:l.id||null,className:"string"==typeof l.className?l.className:null,cssPath:i(l),domPath:r(l),textContent:s(l),attributes:o(l),previousRect:n(u.previousRect),currentRect:n(u.currentRect),impactValue:u.impactValue||t(u),shiftType:a(u),isAnimating:c(l),isImage:"IMG"===l.tagName,isIframe:"IFRAME"===l.tagName,isVideo:"VIDEO"===l.tagName}:{previousRect:n(u.previousRect),currentRect:n(u.currentRect),impactValue:u.impactValue||t(u),nodeLost:!0,shiftType:a(u)}}catch(e){return null}}(h)}catch(e){}u&&(p={value:h.value,entry:h,sourceInfo:u,timestamp:performance.timeOrigin+h.startTime},e.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:h.value,timestamp:performance.timeOrigin+h.startTime,source:u,loadState:document.readyState})}}catch(e){}}));const b=Date.now();if((b-m>5e3||l.length%10==0)&&l.length>0){m=b;const t={name:"CLS",value:u,entries:l.length,sessionValue:f,sessionEntries:d.length,largestShift:p.value>0?{value:p.value,timestamp:p.timestamp,source:p.sourceInfo}:null};e.sendEvent("core_web_vital",t),e.unifiedDataModel.web_vitals.CLS={value:u,timestamp:b,entries:l.length,sessionValue:f,sessionEntries:d.length,largestShiftSource:p.sourceInfo},l.length%30==0&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3)}}catch(e){}}));try{g.observe({type:"layout-shift",buffered:!0})}catch(e){}}(e),function(e){e._inpObserver&&(console.log("[INP Debug] Disconnecting existing INP observer before creating new one"),e._inpObserver.disconnect(),e._inpObserver=null);if(e._inpSetup=!1,e._inpSetup)return void console.log("[INP Debug] INP already set up, skipping duplicate setup");e._inpSetup=!0,e._isRouteSpecificSetup?(e._inpMaxDelay=0,e._inpInteractions=[],e._inpSignificantInteraction=null,console.log("[INP Debug] Starting route-specific INP tracking with FRESH baseline (maxDelay = 0)"),console.log("[INP Debug] ROUTE SETUP - State after reset:",{maxDelay:e._inpMaxDelay,interactionsCount:e._inpInteractions.length,hasSignificantInteraction:!!e._inpSignificantInteraction})):(e._inpMaxDelay=0,e._inpInteractions=[],e._inpSignificantInteraction=null,e._routeTriggeringInteractions=new Set,console.log("[INP Debug] Initializing INP tracking for initial page load (fresh baseline)"),console.log("[INP Debug] INITIAL SETUP - State after init:",{maxDelay:e._inpMaxDelay,interactionsCount:e._inpInteractions.length,hasSignificantInteraction:!!e._inpSignificantInteraction}));e._inpLongAnimationFrames||(e._inpLongAnimationFrames=[]);const t=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{e._inpLongAnimationFrames.push({startTime:t.startTime,duration:t.duration,endTime:t.startTime+t.duration,culprits:t.attribution&&t.attribution.map((e=>({sourceFile:e.source||"unknown",type:e.type||"script",duration:e.duration||0})))}),e._inpLongAnimationFrames.length>20&&e._inpLongAnimationFrames.shift()}))}));try{window.PerformanceObserver.supportedEntryTypes.includes("long-animation-frame")&&t.observe({type:"long-animation-frame",buffered:!0})}catch(e){}const n=Math.random().toString(36).substr(2,9);console.log("[INP Debug] Creating new INP observer with ID:",n,"for",e._isRouteSpecificSetup?"ROUTE":"INITIAL");const i=new PerformanceObserver((t=>{const i=t.getEntries();console.log("[INP Debug] Observer",n,"triggered with",i.length,"entries, current maxDelay:",e._inpMaxDelay),0!==i.length&&i.forEach(((t,n)=>{const i=function(e){if(!e.target)return{tagName:"unknown",interactionType:e.name};const t=e.target;let n=t.textContent;n&&(n=n.trim().replace(/\s+/g," "),n.length>60&&(n=n.substring(0,57)+"..."));const i={};if(t.attributes)for(let e=0;e<t.attributes.length;e++){const n=t.attributes[e];n.name.startsWith("data-")||n.name.startsWith("on")||"style"===n.name||"class"===n.name||(i[n.name]=n.value)}return{tagName:t.tagName||"unknown",id:t.id||null,className:t.className||null,textContent:n||null,attributes:Object.keys(i).length>0?i:null,cssPath:d(t),domPath:h(t),isButton:"BUTTON"===t.tagName||"button"===t.getAttribute("role")||"INPUT"===t.tagName&&["button","submit"].includes(t.type),isInput:"INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName,isLink:"A"===t.tagName,interactionType:e.name}}(t);if(console.log("[INP Debug] Processing entry:",{name:t.name,startTime:t.startTime,duration:t.duration,target:t.target?.tagName||"unknown",targetText:i.textContent||"no text",targetId:i.id||"no id",targetClass:i.className||"no class"}),!["pointerdown","keydown","click","mousedown","touchstart"].includes(t.name))return void console.log("[INP Debug] Skipping non-user interaction:",t.name);const r=t.processingStart-t.startTime,s=t.processingEnd-t.processingStart,o=t.processingEnd,a=t.startTime;let c;if(t.renderTime)c=t.renderTime-t.processingEnd;else{const e=t.duration?t.duration-(o-a):0;c=e>0?e:Math.max(.5*s,8)}const l=r+s+c,f=function(e,t){if(!t||0===t.length)return[];return t.filter((t=>t.startTime<=e.processingEnd&&t.endTime>=e.processingStart)).map((e=>({duration:e.duration,startTime:e.startTime,culprits:e.culprits||[]})))}(t,e._inpLongAnimationFrames),m={name:t.name,startTime:t.startTime,processingStart:t.processingStart,processingEnd:t.processingEnd,duration:l,renderTime:t.renderTime||null,interactionId:t.interactionId||null,timing:{inputDelay:r,processingDuration:s,presentationDelay:c,totalDuration:l},target:i,longAnimationFrames:f};e._inpInteractions.push(m),console.log("[INP Debug] Interaction processed:",{totalDuration:l,currentMaxDelay:e._inpMaxDelay,willUpdateINP:l>e._inpMaxDelay});const p=e._checkIfRouteTriggering&&e._checkIfRouteTriggering(m);if(l>e._inpMaxDelay){if(console.log("[INP Debug] Updating max INP from",e._inpMaxDelay,"to",l),e._inpMaxDelay=l,e._inpSignificantInteraction=m,!e._isRouteSpecificSetup&&p){console.log("[INP Debug] ROUTE-TRIGGERING interaction detected - marking for exclusion from initial session");const n=`${t.startTime}-${t.interactionId||"no-id"}-${i.textContent||"no-text"}`;e._routeTriggeringInteractions.add(n),console.log("[INP Debug] Skipping INP event for route-triggering interaction (will be handled by route session)"),e.unifiedDataModel.web_vitals.INP={value:l,timestamp:performance.timeOrigin+t.startTime,interaction:m,isRouteTriggering:!0,excluded:!0}}else{const n={name:"INP",value:l,interaction:m};e.sendEvent("core_web_vital",n),e.unifiedDataModel.web_vitals.INP={value:l,timestamp:performance.timeOrigin+t.startTime,interaction:m}}console.log("[INP Debug] New INP detected:",{value:l,interactionType:t.name,targetElement:t.target?.tagName||"unknown",targetText:i.textContent||"no text",targetId:i.id||"no id",targetClass:i.className||"no class",startTime:t.startTime,absoluteTime:performance.timeOrigin+t.startTime,processingDuration:s,inputDelay:r,presentationDelay:c,isRouteTriggering:p||!1,sessionType:e._isRouteSpecificSetup?"route":"initial"}),u(e,"INP",l,{interaction:m,timestamp:performance.timeOrigin+t.startTime,vitalCaptureTime:performance.timeOrigin+performance.now()})}}))}));try{console.log("[INP Debug] Setting up INP observer with 16ms threshold");const t=!e._isRouteSpecificSetup;i.observe({type:"event",buffered:t,durationThreshold:16}),console.log("[INP Debug] INP observer setup successful (buffered:",t+")"),document.addEventListener("click",(e=>{const t=e.target.textContent?e.target.textContent.trim().replace(/\s+/g," ").substring(0,50):"no text";console.log("[INP Debug] Click detected on:",{element:e.target.tagName,text:t,id:e.target.id||"no id",className:e.target.className||"no class",timestamp:performance.now(),absoluteTime:performance.timeOrigin+performance.now()})}),{passive:!0})}catch(e){console.log("[INP Debug] INP observer setup failed:",e.message)}e._inpObserver=i,e._resetINPForRoute=function(){console.log("[INP Debug] Resetting INP tracking for new route (was:",e._inpMaxDelay,"ms)"),e._inpObserver&&(e._inpObserver.disconnect(),console.log("[INP Debug] Disconnected old INP observer"),e._inpObserver=null),e._inpSetup=!1,e._inpMaxDelay=0,e._inpInteractions=[],e._inpSignificantInteraction=null,console.log("[INP Debug] INP tracking reset complete - ready for route-specific interactions")},e._getCurrentRouteINP=function(){return e._inpMaxDelay>0&&e._inpSignificantInteraction?{value:e._inpMaxDelay,metadata:{interactionType:e._inpSignificantInteraction.name,targetElement:e._inpSignificantInteraction.target?.tagName||"unknown",startTime:e._inpSignificantInteraction.startTime,duration:e._inpSignificantInteraction.duration,absoluteTime:performance.timeOrigin+e._inpSignificantInteraction.startTime}}:null}}(e),function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)})),window.addEventListener("beforeunload",(function(){e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)}))}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;let t=[];const n=new PerformanceObserver((n=>{n.getEntries().forEach((e=>{t.push({startTime:e.startTime,duration:e.duration,attribution:e.attribution?.length?{name:e.attribution[0].name,containerType:e.attribution[0].containerType,containerName:e.attribution[0].containerName,containerId:e.attribution[0].containerId}:null})})),t.length>=5&&(e.unifiedDataModel.metrics.longTasks=t,t=[])}));try{n.observe({type:"longtask",buffered:!0})}catch(e){}}(e))}catch(e){}}function d(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id){e+=`#${n.id}`,t.unshift(e);break}if(n.className&&"string"==typeof n.className){const t=n.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let i=n,r=1;for(;i=i.previousElementSibling;)r++;if(r>1&&(e+=`:nth-child(${r})`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function h(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id&&(e=`${e}#${n.id}`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function f(e){if(!e)return"unknown";const t=e.split(".").pop().toLowerCase();switch(t){case"jpg":case"jpeg":return"jpeg";case"png":return"png";case"svg":return"svg";case"webp":return"webp";case"gif":return"gif";case"avif":return"avif";default:return t||"unknown"}}function m(e){try{const t=performance.getEntriesByType("resource").find((t=>t.name===e));if(t)return t.initiatorType||"unknown"}catch(e){}return"unknown"}function p(e){if(!e.sessionId)return;"complete"===document.readyState?e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e._collectResources(),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3)):window.addEventListener("load",(()=>{e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e._collectResources(),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3))}));let t=null;if(document.addEventListener("click",(n=>{let i=n.target,r="";if("A"===i.tagName||i.closest("a")){const t="A"===i.tagName?i:i.closest("a");r="link",e.sendEvent("user_interaction",{type:"click",element_type:r,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null,element_href:t.href||null})}else if("BUTTON"===i.tagName||i.closest("button")){const t="BUTTON"===i.tagName?i:i.closest("button");r="button",e.sendEvent("user_interaction",{type:"click",element_type:r,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null})}t&&clearTimeout(t),t=setTimeout((()=>{e._collectResources(),t=null}),2e3)})),"requestIdleCallback"in window){let t=!1;window.requestIdleCallback((()=>{t||(t=!0,e._collectResources(),e.sendEvent("page_ready",{url:window.location.href,title:document.title,time_to_idle:performance.now()}))}),{timeout:3e3})}document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?e.sendEvent("visibility_change",{state:"visible",timestamp:Date.now()}):"hidden"===document.visibilityState&&e.sendEvent("visibility_change",{state:"hidden",timestamp:Date.now()},{immediate:!0})}))}function g(e){e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t)return;try{const n=t.error||new Error(t.message||"Unknown error"),i=n.message||t.message||"Unknown error",r=t.filename||t.srcElement?.src||window.location.href,s=n.stack||null,o="error",a={type:o,message:i,source:r,lineno:t.lineno||0,colno:t.colno||0,stack:s,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:b(o,i,r,s)};v(e,a),y(e),e.sendEvent("error",{error_type:"uncaught_error",message:a.message,source:a.source,lineno:a.lineno,colno:a.colno})}catch(e){}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const n=t.reason,i=n instanceof Error?n.message:String(n),r=n instanceof Error?n.stack:null,s="unhandled_rejection",o="Promise",a={type:s,message:i,source:o,stack:r,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:b(s,i,o,r)};v(e,a),y(e),e.sendEvent("error",{error_type:"unhandled_rejection",message:a.message})}catch(e){}}(e,t)})),function(e){const t=console.error;console.error=function(...n){const i="console.error";try{const t=(new Error).stack||"",r=n.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),s="console_error",o={type:s,message:r,source:i,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:b(s,r,i,t)};v(e,o)}catch(e){}t.apply(console,n)}}(e)}function b(e,t,n,i){const r=`${e}:${t}:${n}:${i?i.substring(0,150):""}`;let s=0;for(let e=0;e<r.length;e++){s=(s<<5)-s+r.charCodeAt(e),s|=0}return"err_"+Math.abs(s).toString(16)}function v(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const n=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(n)return!1;const i=e.buffer.errors.slice(-5),r=i.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!r})(e,t)&&(e.buffer.errors.push(t),e.buffer.errors.length>=5&&y(e))}function y(e){e.buffer.errors&&0!==e.buffer.errors.length&&(e.unifiedDataModel.errors||(e.unifiedDataModel.errors=[]),e.unifiedDataModel.errors=[...e.unifiedDataModel.errors,...e.buffer.errors],e.buffer.errors=[],e._sendUnifiedData(!1))}function _(e){return{setupBufferManagement:function(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers:function(){const t=e.batchConfig.maxBufferSize;e.buffer.events.length>t&&(e.buffer.events=e.buffer.events.slice(-t)),e.buffer.resources.length>t&&(e.buffer.resources=e.buffer.resources.slice(-t)),e.buffer.webVitals.length>t&&(e.buffer.webVitals=e.buffer.webVitals.slice(-t))},hashResource:function(e){return`${e.type}|${e.name.split("?")[0]}|${e.duration<50?"fast":"slow"}`},shouldCollectResource:function(t){if(e.batchConfig.resourceDedupingEnabled){const n=this.hashResource(t);if(e.collectionState.resourceHashMap[n])return!1;e.collectionState.resourceHashMap[n]=Date.now()}return!0},startBatchProcessing:function(){if(setInterval((()=>{e.buffer.events.length>0&&e._flushEvents(),e.buffer.webVitals.length>0&&e._flushWebVitals(),e.buffer.resources.length>0&&e._flushResources()}),Math.min(e.batchConfig.flushInterval,1e4)),e.batchConfig.visibilityFlushEnabled){const t=()=>{const t=Date.now();e.collectionState.visibilityState;const n=document.visibilityState;e.collectionState.visibilityState=n,t-e.collectionState.lastVisibilityChange>1e3&&(e.collectionState.lastVisibilityChange=t,"hidden"===n?e._flushBuffers("visibilityHidden",!0):"visible"===n&&setTimeout((()=>{e._collectResources()}),1e3))};document.addEventListener("visibilitychange",t)}if(window.addEventListener("beforeunload",(()=>{e._flushBuffers("unload",!0)})),e.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const t=()=>{window.requestIdleCallback((()=>{(e.buffer.events.length>=10||e.buffer.resources.length>=10||Date.now()-e.collectionState.lastResourceFlush>3e4)&&e._flushBuffers("idle"),setTimeout((()=>{t()}),2e4)}),{timeout:1e4})};t()}this.setupBufferManagement()}}}const w="initial_load",S="route_change",T="hash_change",C={REACT:"React",VUE:"Vue",ANGULAR:"Angular",ANGULARJS:"AngularJS",SVELTE:"Svelte",EMBER:"Ember",BACKBONE:"Backbone",detect(){const e=[];try{this.detectReact()&&e.push(this.REACT),this.detectVue()&&e.push(this.VUE),this.detectAngular()&&e.push(this.ANGULAR),this.detectAngularJS()&&e.push(this.ANGULARJS),this.detectSvelte()&&e.push(this.SVELTE),this.detectEmber()&&e.push(this.EMBER),this.detectBackbone()&&e.push(this.BACKBONE)}catch(e){}return e},detectReact(){if(window.React||window.ReactDOM||window.ReactRedux)return!0;if(document.querySelector("[data-reactroot], [data-reactid]"))return!0;const e=document.querySelectorAll("div");for(let t=0;t<Math.min(e.length,10);t++){if(Object.keys(e[t]).some((e=>e.startsWith("_reactInternalFiber")||e.startsWith("__reactInternalInstance"))))return!0}return!1},detectVue:()=>!!window.Vue||(!!window.__VUE__||(!!document.querySelector("[data-v-]")||!(!document.querySelector("#app")||!document.querySelector("#app").__vue__))),detectAngular:()=>!(!window.ng||!window.ng.coreTokens)||(!!document.querySelector("[ng-version]")||!!document.querySelector("app-root")),detectAngularJS:()=>!!window.angular||(!!document.querySelector(".ng-binding, [ng-app], [data-ng-app], [ng-controller], [data-ng-controller]")||!!document.querySelector('script[src*="angular.js"], script[src*="angular.min.js"]')),detectSvelte:()=>!!window.__SVELTE__||!!document.querySelector(".svelte-"),detectEmber:()=>!!(window.Ember||window.Em||document.querySelector(".ember-application")),detectBackbone:()=>!!window.Backbone};class E{constructor(t,n,i=null,r=null,s=null){this.sessionId=e(),this.parentSessionId=i,this.type=t,this.route=n,this.trigger=r,this.startTime=null!==s?s:performance.now(),this.startTimeAbsolute=performance.timeOrigin+this.startTime,this.endTime=null,this.isActive=!0,this.resources=[],this.webVitals={LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null},this.errors=[],this.interactions=[],this.timings={},this.routeMetadata={title:document.title,referrer:document.referrer,timestamp:Date.now(),url:window.location.href,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash}}end(){return this.endTime=performance.now(),this.isActive=!1,console.log("[Route Debug] Ending virtual session:",this.sessionId),this.dataCollectionTimer&&(clearInterval(this.dataCollectionTimer),this.dataCollectionTimer=null),this._observers&&(this._observers.forEach((e=>{try{e.disconnect()}catch(e){}})),this._observers=[]),this._mainSDK&&this._mainSDK._routeVitalHandlers&&this._webVitalHandler&&(this._mainSDK._routeVitalHandlers.delete(this._webVitalHandler),console.log("[Route Debug] Removed route vital handler for session:",this.sessionId)),this.getDuration()}getDuration(){return this.endTime?this.endTime-this.startTime:performance.now()-this.startTime}addResource(e){e&&e.startTime>=this.startTime&&this.resources.push({...e,name:e.name||"",sessionRelativeTime:e.startTime-this.startTime,attributedToRoute:!0,entryType:e.entryType||"resource",transferSize:e.transferSize||e.size||0,encodedBodySize:e.encodedBodySize||e.size||0,decodedBodySize:e.decodedBodySize||e.size||0,initiatorType:e.initiatorType||e.type||"other",protocol:e.protocol||"",responseStart:e.responseStart||e.startTime,responseEnd:e.responseEnd||e.startTime+(e.duration||0)})}updateWebVital(e,t,n={}){this.webVitals[e]={value:t,timestamp:performance.timeOrigin+performance.now(),sessionRelativeTime:performance.now()-this.startTime,...n}}}class D{constructor(e){this.sdk=e,this.isEnabled=!0,this.currentRoute=this.getCurrentRoute(),this.routeStartTime=performance.now(),this.frameworks=[],this.sessions=new Map,this.currentSession=null,this.parentSession=null,this.routeChangeHandlers=[],this.isInitialized=!1,this.init()}init(){if(!this.isInitialized)try{this.frameworks=C.detect(),this.setupHistoryMonitoring(),this.setupHashChangeMonitoring(),this.setupFrameworkSpecificMonitoring(),this.createInitialSession(),this.isInitialized=!0,this.sdk.sendEvent&&this.sdk.sendEvent("route_detector_initialized",{frameworks:this.frameworks,initialRoute:this.currentRoute})}catch(e){}}getCurrentRoute(){return{pathname:window.location.pathname,search:window.location.search,hash:window.location.hash,href:window.location.href}}createInitialSession(){if(this.sdk.sessionId){const e={sessionId:this.sdk.sessionId,type:w,route:this.currentRoute,trigger:"page_load",startTime:performance.now(),routeMetadata:{title:document.title,referrer:document.referrer,timestamp:Date.now(),url:window.location.href,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash}};return this.parentSession=e,this.sessions.set(this.sdk.sessionId,e),this.sdk.currentVirtualSession=e,console.log("[Route Debug] Created initial session (no web vitals setup):",this.sdk.sessionId),e}return null}setupHistoryMonitoring(){if(!this.historyMonitoringEnabled){const e=window.history.pushState,t=window.history.replaceState;window.history.pushState=(...t)=>{const n=performance.now();e.apply(window.history,t),this.isEnabled&&this.handleRouteChange("pushState",t[2],n)},window.history.replaceState=(...e)=>{const n=performance.now();t.apply(window.history,e),this.isEnabled&&this.handleRouteChange("replaceState",e[2],n)},this.originalPushState=e,this.originalReplaceState=t,window.addEventListener("popstate",(e=>{if(this.isEnabled){const e=performance.now();this.handleRouteChange("popstate",window.location.href,e)}}),{passive:!0}),this.historyMonitoringEnabled=!0}}setupHashChangeMonitoring(){this.hashChangeMonitoringEnabled||(window.addEventListener("hashchange",(e=>{if(this.isEnabled){const e=performance.now();this.handleRouteChange("hashchange",window.location.href,e)}}),{passive:!0}),this.hashChangeMonitoringEnabled=!0)}setupFrameworkSpecificMonitoring(){this.frameworks.includes(C.REACT)&&this.setupReactRouterMonitoring(),this.frameworks.includes(C.VUE)&&this.setupVueRouterMonitoring(),this.frameworks.includes(C.ANGULAR)&&this.setupAngularRouterMonitoring()}setupReactRouterMonitoring(){setTimeout((()=>{window.__REACT_ROUTER__||document.querySelector("[data-reach-router]")}),1e3)}setupVueRouterMonitoring(){setTimeout((()=>{window.$router||window.Vue&&window.Vue.prototype.$router}),1e3)}setupAngularRouterMonitoring(){}isScrollAnchor(e){return e.length<=10&&[/^#$/,/^#top$/i,/^#header$/i,/^#footer$/i,/^#section/i,/^#[a-z0-9\-_]+$/].some((t=>t.test(e)))}handleRouteChange(e,t,n=null){try{const t=this.getCurrentRoute();if(!this.isSignificantRouteChange(this.currentRoute,t))return;this.currentSession&&this.currentSession.isActive&&this.currentSession instanceof E&&this.endSession(this.currentSession);const i=new E("hashchange"===e?T:S,t,this.parentSession?.sessionId||this.sdk.sessionId,e,n);console.log("[Route Debug] Created new virtual session for route change:",{sessionId:i.sessionId,trigger:e,newPath:t.pathname,startTimeAbsolute:i.startTimeAbsolute}),this.currentRoute=t,this.currentSession=i,this.sessions.set(i.sessionId,i),this.updateSDKForRouteChange(i),this.resetPerformanceObservers(i),this.captureCurrentRouteINP(i),this.notifyRouteChangeHandlers(i,e),setTimeout((()=>{i.isActive&&this.sendSessionData(i)}),3e3)}catch(e){}}isSignificantRouteChange(e,t){return e.pathname!==t.pathname||e.hash!==t.hash&&!this.isScrollAnchor(t.hash)}endSession(e){e.isActive&&(e.end(),this.sendSessionData(e))}updateSDKForRouteChange(e){this.sdk.currentVirtualSession=e,this.setupVirtualSessionDataCollection(e),this.sdk.unifiedDataModel&&(this.sdk.unifiedDataModel.current_route=e.route,this.sdk.unifiedDataModel.route_session_id=e.sessionId,this.sdk.unifiedDataModel.route_change_trigger=e.trigger)}setupVirtualSessionDataCollection(e){if(e.dataCollectionTimer=setInterval((()=>{e.isActive?this.collectDataForVirtualSession(e):clearInterval(e.dataCollectionTimer)}),500),"undefined"!=typeof PerformanceObserver){e._observers=e._observers||[];try{const t=new PerformanceObserver((t=>{const n=t.getEntries(),i=performance.timeOrigin+e.startTime;n.forEach((t=>{if(!e.isActive)return;if(performance.timeOrigin+t.startTime>=i){if(t.name.includes("/api/optima/")||t.name.includes("optima.js")||t.name.startsWith("data:"))return;const n={name:t.name,type:t.initiatorType||"other",startTime:t.startTime,duration:t.duration,size:t.transferSize||0,transferSize:t.transferSize||0,encodedBodySize:t.encodedBodySize||0,decodedBodySize:t.decodedBodySize||0,initiatorType:t.initiatorType||"other",protocol:this.extractProtocol(t.name)||"",responseStart:t.responseStart||t.startTime,responseEnd:t.responseEnd||t.startTime+(t.duration||0),cached:0===t.transferSize&&t.decodedBodySize>0,nextHopProtocol:t.nextHopProtocol,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,connectEnd:t.connectEnd,secureConnectionStart:t.secureConnectionStart,requestStart:t.requestStart,fetchStart:t.fetchStart,realTimeCapture:!0};e.resources.some((e=>e.name===n.name&&e.startTime===n.startTime))||e.addResource(n)}}))}));t.observe({entryTypes:["resource"]}),e._observers.push(t)}catch(e){}e.type!==w&&this.setupWebVitalsRouteHandlers(e)}}setupWebVitalsRouteHandlers(e){"undefined"!=typeof PerformanceObserver&&(console.log("[Route Debug] Setting up web vitals route handlers for virtual session:",e.sessionId),e._observers=e._observers||[],e._mainSDK=this.sdk,e._webVitalHandler=t=>{if(!e.isActive)return;const{name:n,value:i,timestamp:r,vitalCaptureTime:s,...o}=t,a=s||r||Date.now(),c=e.startTimeAbsolute;console.log("[Route Debug] Web vital received:",{name:n,value:i,vitalTime:r,captureTime:a,sessionStartAbsolute:c,isCapturedAfterRouteChange:a>=c,isVitalAfterRouteChange:r>=c,timeSinceRouteStart:(a-c)/1e3,timeSinceVitalOccurred:(a-r)/1e3,elementInfo:o.element||o.interaction?.target||"no-element"});const u=r>=c,l=a>=c,d="INP"===n&&l&&c-r<=100,h=u&&l||d;if(console.log("[Route Debug] Vital timing analysis:",{name:n,vitalOccurredAfterRoute:u,vitalCapturedAfterRoute:l,isRouteTriggeredINP:d,timeDiffMs:c-r,shouldInclude:h}),h){const t=(r-c)/1e3;console.log("[Route Debug] Adding vital to virtual session:",{name:n,value:i,sessionRelativeTime:t}),e.updateWebVital(n,i,{...o,sessionRelativeTime:t,routeSpecific:!0}),this.sdk.sendEvent("core_web_vital",{name:n,value:i,route_session_id:e.sessionId,route_type:e.type,route_path:e.route.pathname,session_relative_time:t,...o})}else console.log("[Route Debug] REJECTING vital (occurred before route change):",{name:n,value:i,vitalOccurredAfterRoute:u,vitalCapturedAfterRoute:l,reason:u?"vital-captured-before-route":"vital-occurred-before-route"})},this.sdk._routeVitalHandlers||(this.sdk._routeVitalHandlers=new Set),this.sdk._routeVitalHandlers.add(e._webVitalHandler),this.setupRouteSpecificCLS(e),console.log("[Route Debug] Web vitals route handlers setup complete for session:",e.sessionId))}captureCurrentRouteINP(e){if(this.sdk._getCurrentRouteINP){const t=this.sdk._getCurrentRouteINP();t&&t.value>0?(console.log("[Route Debug] Capturing current route INP baseline:",{value:t.value,sessionId:e.sessionId,routePath:e.route.pathname}),e.updateWebVital("INP",t.value,{...t.metadata,routeSpecific:!0,isBaseline:!0,sessionRelativeTime:0}),this.sdk.sendEvent("core_web_vital",{name:"INP",value:t.value,route_session_id:e.sessionId,route_type:e.type,route_path:e.route.pathname,is_baseline:!0,session_relative_time:0,...t.metadata})):console.log("[Route Debug] No current INP baseline to capture for route session")}}setupRouteSpecificCLS(e){let t=0,n=[];try{const i=new PerformanceObserver((i=>{i.getEntries().forEach((i=>{if(!e.isActive)return;const r=performance.timeOrigin+i.startTime,s=e.startTimeAbsolute;r>=s&&(i.hadRecentInput||(t+=i.value,n.push(i),console.log("[Route Debug] CLS shift detected:",{value:i.value,totalCLS:t,sessionRelativeTime:(r-s)/1e3}),e.updateWebVital("CLS",t,{entries:n.length,sessionValue:t,sessionRelativeTime:(r-s)/1e3,routeSpecific:!0}),this.sdk.sendEvent("core_web_vital",{name:"CLS",value:t,route_session_id:e.sessionId,route_type:e.type,route_path:e.route.pathname,entries:n.length,sessionValue:t})))}))}));i.observe({type:"layout-shift",buffered:!1}),e._observers.push(i)}catch(e){console.log("[Route Debug] Error setting up CLS observer:",e.message)}}collectDataForVirtualSession(e){if(e.isActive){if("function"==typeof performance.setResourceTimingBufferSize)try{const e=performance.getEntriesByType("resource").length,t=Math.max(500,e+100);performance.setResourceTimingBufferSize(t)}catch(e){}if(this.bufferManagementSetup||(this.bufferClearTimer=setInterval((()=>{const e=performance.getEntriesByType("resource");e.length>=200&&(e.slice(-50),"function"==typeof performance.clearResourceTimings&&performance.clearResourceTimings())}),1e4),this.bufferManagementSetup=!0),this.bufferFullListenerAdded||(window.addEventListener("resourcetimingbufferfull",(e=>{if("function"==typeof performance.clearResourceTimings&&(performance.getEntriesByType("resource"),performance.clearResourceTimings()),"function"==typeof performance.setResourceTimingBufferSize)try{const e=500;performance.setResourceTimingBufferSize(e)}catch(e){}})),this.bufferFullListenerAdded=!0),window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("resource"),n=performance.timeOrigin+e.startTime;t.slice(-10).map((e=>({name:e.name.split("/").pop()||e.name.substring(0,50),startTime:e.startTime,absoluteTime:performance.timeOrigin+e.startTime,duration:e.duration,type:e.initiatorType})));const i=[...t].sort(((e,t)=>e.startTime-t.startTime)),r=i[0],s=i[i.length-1];r&&s&&(s.startTime,r.startTime,performance.now());const o=t.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType));o.length>0&&o.slice(-5).map((e=>({name:e.name.split("/").pop()||e.name.substring(0,50),startTime:e.startTime,absoluteTime:performance.timeOrigin+e.startTime,timeDiffFromSession:performance.timeOrigin+e.startTime-n,type:e.initiatorType})));const a=t.filter((t=>{const i=performance.timeOrigin+t.startTime>=n,r=e.resources.some((e=>e.name===t.name&&e.startTime===t.startTime));return i&&!r}));a.forEach(((t,n)=>{if(t.name.includes("/api/optima/")||t.name.includes("optima.js")||t.name.startsWith("data:"))return;const i={name:t.name,type:t.initiatorType||"other",startTime:t.startTime,duration:t.duration,size:t.transferSize||0,transferSize:t.transferSize||0,encodedBodySize:t.encodedBodySize||0,decodedBodySize:t.decodedBodySize||0,initiatorType:t.initiatorType||"other",protocol:this.extractProtocol(t.name)||"",responseStart:t.responseStart||t.startTime,responseEnd:t.responseEnd||t.startTime+(t.duration||0),cached:0===t.transferSize&&t.decodedBodySize>0,nextHopProtocol:t.nextHopProtocol,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,connectEnd:t.connectEnd,secureConnectionStart:t.secureConnectionStart,requestStart:t.requestStart,fetchStart:t.fetchStart};e.addResource(i)})),a.length>0||t.filter((e=>{const t=performance.timeOrigin+e.startTime-n;return("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)&&t>-5e3&&t<3e4}))}if(window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("navigation");if(t.length>0){const n=t[0];e.timings={domContentLoaded:n.domContentLoadedEventEnd-n.navigationStart,loadComplete:n.loadEventEnd-n.navigationStart,firstByte:n.responseStart-n.navigationStart}}}}}resetPerformanceObservers(e){this.sdk.setupRouteSpecificObservers&&this.sdk.setupRouteSpecificObservers(e)}notifyRouteChangeHandlers(e,t){this.sdk.sendEvent&&this.sdk.sendEvent("route_change",{sessionId:e.sessionId,route:e.route,trigger:t,frameworks:this.frameworks,timestamp:e.routeMetadata.timestamp}),this.routeChangeHandlers.forEach((n=>{try{n(e,t)}catch(e){}}))}sendSessionData(e){if(this.sdk._sendToServer){const t=this.getDeviceInformation(),n={...e.routeMetadata,userAgent:navigator.userAgent,user_agent:navigator.userAgent,device_type:t.device_type,connection_type:t.connection_type,browser:t.browser,os:t.os,screen_width:window.screen.width,screen_height:window.screen.height,viewport_width:window.innerWidth,viewport_height:window.innerHeight,device_memory:navigator.deviceMemory,page_visibility:document.visibilityState,sdk_version:this.sdk.version||"1.0.0"},i=e.resources.map(((e,t)=>({name:e.name,type:this.getResourceType(e),entryType:"resource",startTime:Math.round(e.startTime||0),duration:Math.round(e.duration||0),transferSize:e.transferSize||e.size||0,encodedBodySize:e.encodedBodySize||e.size||0,decodedBodySize:e.decodedBodySize||e.size||0,initiatorType:e.initiatorType||e.type||"other",protocol:e.protocol||"",is_ajax:this.isAjaxResource(e)}))),r=this.formatWebVitalsForServer(e.webVitals);console.log("[Route Debug] Sending route session data:",{sessionId:e.sessionId,sessionType:e.type,webVitals:r,rawWebVitals:e.webVitals});const s={session_id:e.sessionId,parent_session_id:e.parentSessionId,session_type:e.type,route:e.route,trigger:e.trigger,duration:e.getDuration(),resources:i,web_vitals:r,errors:e.errors,interactions:e.interactions,ajax_requests:[],metadata:n,frameworks:this.frameworks};console.log("[Route Debug] Complete payload being sent to server:",JSON.stringify(s,null,2)),this.sdk._sendToServer("/api/optima/route-session",s)}}getDeviceInformation(){return this.sdk._detectOS&&this.sdk._detectBrowser?{device_type:this.sdk._getDeviceType?this.sdk._getDeviceType():this.detectDeviceType(),connection_type:this.getConnectionType(),browser:this.sdk._detectBrowser(),os:this.sdk._detectOS()}:{device_type:this.detectDeviceType(),connection_type:this.getConnectionType(),browser:this.detectBrowser(),os:this.detectOS()}}extractProtocol(e){try{return new URL(e).protocol.replace(":","")}catch(t){return e.startsWith("//")?"http":e.startsWith("https:")?"https":(e.startsWith("http:"),"http")}}detectDeviceType(){const e=navigator.userAgent.toLowerCase();return/mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(e)?"mobile":/tablet|ipad/i.test(e)?"tablet":"desktop"}getConnectionType(){return navigator.connection&&navigator.connection.effectiveType||"unknown"}detectBrowser(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("Safari")>-1?"Safari":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1?"Opera":"Unknown"}detectOS(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"}getResourceType(e){const t=e.name||"",n=e.type||e.initiatorType;return"xmlhttprequest"===n||"fetch"===n?"xhr":t?t.match(/\.(css)$/i)?"stylesheet":t.match(/\.(js)$/i)?"script":t.match(/\.(png|jpg|jpeg|gif|svg|webp|ico)$/i)?"image":t.match(/\.(woff|woff2|ttf|eot)$/i)?"font":t.match(/\.(mp4|webm|ogg|avi)$/i)?"video":t.match(/\.(mp3|wav|ogg)$/i)?"audio":n||"other":n||"other"}isAjaxResource(e){const t=e.type||e.initiatorType,n=e.name||"";return"xmlhttprequest"===t||"fetch"===t||n&&!n.match(/\.(css|js|png|jpg|jpeg|gif|svg|webp|ico|woff|woff2|ttf|eot|mp4|webm|ogg|avi|mp3|wav)$/i)}formatWebVitalsForServer(e){const t={};return Object.keys(e).forEach((n=>{const i=e[n];i&&null!==i.value&&void 0!==i.value&&(!0===i.routeSpecific?(console.log("[Route Debug] Including route-specific vital:",{name:n,value:i.value,routeSpecific:i.routeSpecific,elementText:i.element?.textContent||i.interaction?.target?.textContent||"no-text"}),t[n]={value:i.value,timestamp:i.timestamp||Date.now(),...i}):console.log("[Route Debug] EXCLUDING non-route-specific vital:",{name:n,value:i.value,routeSpecific:i.routeSpecific,reason:"not-marked-as-route-specific"}))})),console.log("[Route Debug] Final formatted web vitals for server:",t),t}getCurrentSession(){return this.currentSession}getSessionById(e){return this.sessions.get(e)}getAllSessions(){return Array.from(this.sessions.values())}addRouteChangeHandler(e){this.routeChangeHandlers.push(e)}removeRouteChangeHandler(e){const t=this.routeChangeHandlers.indexOf(e);t>-1&&this.routeChangeHandlers.splice(t,1)}destroy(){this.isEnabled=!1,this.bufferClearTimer&&(clearInterval(this.bufferClearTimer),this.bufferClearTimer=null),this.currentSession&&this.currentSession.isActive&&this.endSession(this.currentSession),this.sessions.clear(),this.routeChangeHandlers=[]}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}}!function(t){function n(e){var t;e=e||{},this.apiKey=e.apiKey,this.endpoint=e.endpoint||"http://localhost:3000",this.sampleRate="number"==typeof e.sampleRate?Math.min(Math.max(e.sampleRate,1),100):100,this.sessionId=null,this.sessionStartTime=null,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null,layoutShiftSource:null},resources:[],ajax_requests:[],errors:[],events:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,flushInterval:e.flushInterval||5e3,webVitalsBatchDelay:e.webVitalsBatchDelay||2e3,batchBeforeSend:e.batchBeforeSend||!0,payloadCompressionThreshold:10240},this.collectionState={isFirstLoad:!0,resourcesCollected:!1,lastResourceFlush:null,lastEventFlush:null,lastAjaxCallFlush:null,isPerformanceObserverSet:!1,isBatchProcessingStarted:!1,unloadSent:!1,visibilityChangeCount:0},this.routeDetector=null,this.currentVirtualSession=null,this.parentVirtualSession=null,this.isRouteChangeEnabled=!1!==e.enableRouteTracking,this.bufferManager=_(this),this.flushManager=(t=this,{flushBuffers:function(e,n=!1){t.buffer.events.length>0&&this.flushEvents(n),t.buffer.resources.length>0&&this.flushResources(n),t.buffer.webVitals.length>0&&this.flushWebVitals(n),t.buffer.ajaxCalls&&t.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(n)},flushEvents:function(e=!1){if(0===t.buffer.events.length)return;const n=t.buffer.events.slice(0,t.batchConfig.maxEventsPerBatch);t.buffer.events=t.buffer.events.slice(t.batchConfig.maxEventsPerBatch);const i={session_id:t.sessionId,events:n,timestamp:Date.now(),count:n.length};t.collectionState.lastEventFlush=Date.now(),t._sendToServer("/api/optima/events",i,{sync:e})},flushResources:function(e=!1){if(0===t.buffer.resources.length)return;const n=t.buffer.resources.slice(0,t.batchConfig.maxResourcesPerBatch);t.buffer.resources=t.buffer.resources.slice(t.batchConfig.maxResourcesPerBatch);const i={session_id:t.sessionId,resources:n,timestamp:Date.now(),count:n.length};t.collectionState.lastResourceFlush=Date.now(),t._sendToServer("/api/optima/resources",i,{sync:e})},flushWebVitals:function(e=!1){if(0===t.buffer.webVitals.length)return;const n={LCP:[],FID:[],CLS:[],INP:[],TTFB:[],FCP:[]};t.buffer.webVitals.forEach((e=>{if(e&&e.event_data&&e.event_data.name){const t=e.event_data.name;n[t]&&n[t].push(e)}}));const i=t.buffer.webVitals.slice(0,t.batchConfig.maxWebVitalsPerBatch);t.buffer.webVitals=t.buffer.webVitals.slice(t.batchConfig.maxWebVitalsPerBatch);const r={session_id:t.sessionId,web_vitals:i,processed_vitals:n,timestamp:Date.now(),count:i.length};t._sendToServer("/api/optima/web-vitals",r,{sync:e})},flushAjaxCalls:function(e=!1){if(!t.buffer.ajaxCalls||0===t.buffer.ajaxCalls.length)return;const n=t.buffer.ajaxCalls.slice(0,t.batchConfig.maxAjaxCallsPerBatch);t.buffer.ajaxCalls=t.buffer.ajaxCalls.slice(t.batchConfig.maxAjaxCallsPerBatch);const i={session_id:t.sessionId,ajax_calls:n,timestamp:Date.now(),count:n.length};t.collectionState.lastAjaxCallFlush=Date.now(),t._sendToServer("/api/optima/ajax-calls",i,{sync:e})}}),this._webVitalsBatchTimer=null,this._init()}t.__optima_early_xhr_queue=t.__optima_early_xhr_queue||[],n.prototype={_init:function(){this.apiKey&&(this._initPerformanceMetrics(),g(this),this.createSession())},_initPerformanceMetrics:function(){if(t.performance&&t.performance.mark){t.performance.mark("optima_init");try{t.performance.getEntriesByType("mark").concat(t.performance.getEntriesByType("measure")).filter((e=>e.name.startsWith("optima_"))).forEach((e=>{t.performance.clearMarks(e.name),"measure"===e.entryType&&t.performance.clearMeasures(e.name)}))}catch(e){}this._setupCoreWebVitals(),this._captureNavigationTiming()}},_captureNavigationTiming:function(){try{const e=performance.getEntriesByType("navigation")[0];e&&(this.unifiedDataModel.timings={navigationStart:0,fetchStart:e.fetchStart,domainLookupStart:e.domainLookupStart,domainLookupEnd:e.domainLookupEnd,connectStart:e.connectStart,connectEnd:e.connectEnd,requestStart:e.requestStart,responseStart:e.responseStart,responseEnd:e.responseEnd,domInteractive:e.domInteractive,domContentLoadedEventStart:e.domContentLoadedEventStart,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domComplete:e.domComplete,loadEventStart:e.loadEventStart,loadEventEnd:e.loadEventEnd,duration:e.duration,type:e.type,redirectCount:e.redirectCount,nextHopProtocol:e.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:e.responseStart,timestamp:performance.timeOrigin+e.responseStart},this.sendEvent("core_web_vital",{name:"TTFB",value:e.responseStart},{immediate:!0}))}catch(e){}},_setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{this.collectionState.visibilityChangeCount++,"hidden"===document.visibilityState?this._prepareFinalDataAndSend(!0):"visible"===document.visibilityState&&this._refreshVisibleState()})),t.addEventListener("beforeunload",(()=>{this.collectionState.unloadSent||(this._prepareFinalDataAndSend(!0),this.collectionState.unloadSent=!0)})),this._setupPeriodicFlush()},_prepareFinalDataAndSend:function(e=!1){this.sessionId&&this.unifiedDataModel.session_id&&(this._consolidateBufferedData(),this._updateWebVitalsInUnifiedModel(),this._consolidateErrors(),this._updateMetadata(),this._sendUnifiedData(e))},_updateWebVitalsInUnifiedModel:function(){this.buffer.webVitals.forEach(((e,t)=>{if(!e.event_data||!e.event_data.name)return;const{name:n,value:i}=e.event_data,r=e.timestamp;if("LCP"===n)(!this.unifiedDataModel.web_vitals.LCP||i>this.unifiedDataModel.web_vitals.LCP.value)&&(this.unifiedDataModel.web_vitals.LCP={value:i,timestamp:r,element:e.event_data.element||"unknown"});else if("FID"===n)this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:i,timestamp:r,inputType:e.event_data.inputType||"unknown"});else if("CLS"===n){if(this.unifiedDataModel.web_vitals.CLS={value:i,timestamp:r,entries:e.event_data.entries||0,sessionValue:e.event_data.sessionValue||i,sessionEntries:e.event_data.sessionEntries||0},e.event_data.largestShift&&e.event_data.largestShift.source)try{const t=e.event_data.largestShift.source;t&&(this.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:e.event_data.largestShift.value,timestamp:e.event_data.largestShift.timestamp,source:t,loadState:document.readyState})}catch(e){}}else if("FCP"===n)this.unifiedDataModel.web_vitals.FCP||(this.unifiedDataModel.web_vitals.FCP={value:i,timestamp:r});else if("INP"===n){const t=e.event_data.interaction;if(this._checkIfRouteTriggering&&this._checkIfRouteTriggering(t)&&!this._isRouteSpecificSetup)return void console.log("[INP Debug] Excluding route-triggering INP from initial session:",{value:i,interactionText:t?.target?.textContent||"no-text",reason:"route-triggering-interaction"});(!this.unifiedDataModel.web_vitals.INP||i>this.unifiedDataModel.web_vitals.INP.value)&&(this.unifiedDataModel.web_vitals.INP={value:i,timestamp:r,interaction:t||"unknown"},console.log("[INP Debug] Updated unified model INP:",{value:i,sessionType:this._isRouteSpecificSetup?"route":"initial",interactionText:t?.target?.textContent||"no-text"}))}})),this.buffer.webVitals.length,this.buffer.webVitals=[]},_consolidateBufferedData:function(){return this.buffer.events||(this.buffer.events=[]),this.unifiedDataModel.events||(this.unifiedDataModel.events=[]),this.buffer.events.length>0&&(this.unifiedDataModel.events=[...this.unifiedDataModel.events,...this.buffer.events],this.buffer.events=[]),this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.errors.length>0&&this._consolidateErrors(),this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel},_consolidateErrors:function(){this.buffer.errors&&0!==this.buffer.errors.length&&(this.unifiedDataModel.errors=[...this.unifiedDataModel.errors,...this.buffer.errors],this.buffer.errors=[])},_updateMetadata:function(){this.unifiedDataModel.meta={url:t.location.href,path:t.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:t.screen.width,screen_height:t.screen.height,viewport_width:t.innerWidth,viewport_height:t.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:performance.getEntriesByType("navigation")[0]?.type||null,sdk_version:this.version,lastUpdated:Date.now()}},_sendUnifiedData:function(e=!1){if(!this.unifiedDataModel.session_id)return;if(!this.sessionId)return;this._updateMetadata(),this.unifiedDataModel.timestamp=Date.now();const t=JSON.parse(JSON.stringify(this.unifiedDataModel));this._sendToServer("/api/optima/collect",t,{sync:e}),this._resetVolatileDataInUnifiedModel()},_resetVolatileDataInUnifiedModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},_setupBatchedCollection:function(){this.disabled||this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this._startBatchedCollection())},_startBatchedCollection:function(){setInterval((()=>{this._collectResources()}),3e3),this._setupPerformanceObservers(),this._setupEventListeners(),this._setupPeriodicFlush()},_setupPeriodicFlush:function(){setInterval((()=>{this._hasSignificantData()&&this._prepareFinalDataAndSend(!1)}),this.batchConfig.flushInterval)},_hasSignificantData:function(){const e={resources:this.unifiedDataModel.resources.length>0,ajax_requests:this.unifiedDataModel.ajax_requests.length>0,webVitals_buffer:this.buffer.webVitals.length>0,errors_buffer:this.buffer.errors.length>0,errors_unified:this.unifiedDataModel.errors.length>0,LCP:this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value,FID:this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value,CLS:this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value,FCP:this.unifiedDataModel.web_vitals.FCP&&this.unifiedDataModel.web_vitals.FCP.value};return e.resources||e.ajax_requests||e.webVitals_buffer||e.errors_buffer||e.errors_unified||e.LCP||e.FID||e.CLS||e.FCP},_collectResources:function(){if(!this.disabled&&this.sessionId)try{const e=performance.getEntriesByType("resource");if(!e||0===e.length)return;let t=0;e.forEach((e=>{if(this._isResourceProcessed(e.name))return;const n={name:e.name,type:this._getResourceType(e),startTime:Math.round(e.startTime),duration:Math.round(e.duration),size:e.transferSize||0,protocol:e.nextHopProtocol,encodedSize:e.encodedBodySize||0,decodedSize:e.decodedBodySize||0,initiatorType:e.initiatorType};this.unifiedDataModel.resources.push(n),t++})),this.collectionState.resourcesCollected=!0}catch(e){}},_isResourceProcessed:function(e){return this.unifiedDataModel.resources.some((t=>t.name===e))},_getResourceType:function(e){const t=e.initiatorType,n=e.name;return"img"===t||"image"===t?"image":"script"===t?"script":"css"===t?"stylesheet":"fetch"===t||"xmlhttprequest"===t?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(n)?"image":/\.(?:js)(?:\?|$)/i.test(n)?"script":/\.(?:css)(?:\?|$)/i.test(n)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(n)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(n)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(n)?"audio":"other"},_detectBrowser:function(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("MSIE")>-1||e.indexOf("Trident/")>-1?"IE":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1||e.indexOf("OPR/")>-1?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"},_refreshVisibleState:function(){this.collectionState.visibilityChangeCount>1&&this._collectResources()},_setupCoreWebVitals:function(){this.disabled||l(this)},_setupBufferManagement:function(){this.bufferManager.setupBufferManagement()},_shouldCollectResource:function(e){return this.bufferManager.shouldCollectResource(e)},_startBatchProcessing:function(){this.bufferManager.startBatchProcessing()},_flushBuffers:function(e,t=!1){this._prepareFinalDataAndSend(t)},_flushEvents:function(e=!1){const t=this.buffer.events.slice();if(this.buffer.events=[],0===t.length)return;const n={session_id:this.sessionId,events:t,timestamp:Date.now()};this._sendToServer("/api/optima/events",n,{sync:e})},_flushResources:function(e=!1){const t=this.buffer.resources.slice();if(this.buffer.resources=[],0===t.length)return;const n={session_id:this.sessionId,resources:t,timestamp:Date.now()};this._sendToServer("/api/optima/resources",n,{sync:e})},_flushWebVitals:function(e=!1){const t=this.buffer.webVitals.slice();if(this.buffer.webVitals=[],0===t.length)return;const n={session_id:this.sessionId,web_vitals:t,timestamp:Date.now()};this._sendToServer("/api/optima/web-vitals",n,{sync:e})},_setupEventListeners:function(){this.disabled||p(this)},_setupPerformanceObservers:function(){this.disabled||(this._setupCoreWebVitals(),this._collectResources())},captureResourceData:function(e="auto"){return!this.disabled&&(this._collectResources(),!0)},_sendResourceBatch:function(e){return e&&e.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...e]),!0},createSession:function(){const e=t.location.href,n=document.referrer||"";return this._createSession(e,n)},_sendToServer:function(e,t,n={}){if(!this.apiKey)return Promise.reject(new Error("API key not set"));const i=this.endpoint+e;if(n.sync&&navigator.sendBeacon){const e=new Blob([JSON.stringify(t)],{type:"application/json"}),n=navigator.sendBeacon(i,e);return Promise.resolve(n)}return e.includes("ajax-calls")&&t.ajax_calls&&t.ajax_calls.length>0&&t.ajax_calls.reduce(((e,t)=>(e[t.type]=(e[t.type]||0)+1,e)),{}),fetch(i,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),credentials:"include"}).then((e=>{if(!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()})).then((e=>!0)).catch((e=>!1))},sendEvent:function(e,t,n={}){if(this.disabled)return!1;if(!this.sessionId)return!1;const i={session_id:this.sessionId,event_type:e,event_data:t||{},timestamp:Date.now()};return"core_web_vital"===e?(this.buffer.webVitals.push(i),!0===n.immediate&&this._updateWebVitalsInUnifiedModel()):this.buffer.events.push(i),!0},collectPerformanceMetrics:function(){return this._collectResources(),this._updateWebVitalsInUnifiedModel(),!0},sendCollectedData:function(e=!1){return!this.disabled&&(this._prepareFinalDataAndSend(e),!0)},debug:function(){return{sessionId:this.sessionId,apiKey:this.apiKey?`${this.apiKey.substring(0,4)}...`:"None",endpoint:this.endpoint,bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs.size},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},_captureEarlyAjaxRequests:function(){if(!t.performance||!t.performance.getEntriesByType)return;const e=t.performance.getEntriesByType("resource"),n=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)),i=e.filter((e=>{if(n.includes(e))return!1;const t=e.name;if(t.includes("/api/")||t.includes("/graphql")||t.match(/\/(v1|v2|v3)\//)||t.includes("/rest/")||t.includes("/data/"))return!0;try{const e=new URL(t).pathname.split(".").pop();if(["json","xml","graphql"].includes(e))return!0}catch{}return!1})),r=[...new Set([...n,...i])];if(!r.length)return;const s=r.map((e=>{let t="GET";(e.name.includes("graphql")||e.transferSize>1e3)&&(t="POST");return{type:"fetch"===e.initiatorType?"fetch":"xhr",method:t,url:e.name,status:200,statusText:"OK",startTime:Math.round(e.startTime+performance.timeOrigin),duration:Math.round(e.duration),requestPayloadSize:-1,responseSize:Math.round(e.transferSize)||-1,decodedBodySize:Math.round(e.decodedBodySize)||-1,encodedBodySize:Math.round(e.encodedBodySize)||-1,aborted:!1,errored:!1,timestamp:Math.round(e.startTime+performance.timeOrigin),captureSource:"performance-timeline",resourceTiming:{startTime:Math.round(e.startTime),duration:Math.round(e.duration),domainLookupTime:Math.round(e.domainLookupEnd-e.domainLookupStart),connectTime:Math.round(e.connectEnd-e.connectStart),tlsTime:e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,requestStartTime:Math.round(e.requestStart),ttfb:Math.round(e.responseStart-e.requestStart),downloadTime:Math.round(e.responseEnd-e.responseStart),entryType:e.entryType,initiatorType:e.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transferSize>0?e.transferSize.toString():"unknown","cache-control":"unknown"}}})).filter((e=>!this._isOptimaApiCall(e.url)));0!==s.length&&(this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...s))},_isOptimaApiCall:function(e){return e.includes("/api/optima/sessions")||e.includes("/api/optima/events")||e.includes("/api/optima/resources")||e.includes("/api/optima/web-vitals")||e.includes("/api/optima/ajax-calls")||e.includes("/api/optima/collect")||e.includes("/api/sessions")||e.includes("/api/events")||e.includes("/api/resources")||e.includes("/api/web-vitals")||e.includes("/api/ajax-calls")||e.includes("/api/collect")||e.includes("optima.js")||e.includes("optima.min.js")},_processEarlyInterceptedRequests:function(){if(!t.__optima_early_xhr_queue||!t.__optima_early_xhr_queue.length)return;const e=t.__optima_early_xhr_queue;let n=[];t.performance&&t.performance.getEntriesByType&&(n=t.performance.getEntriesByType("resource"));const i=e.map((e=>{if(this._isOptimaApiCall(e.url)||e.responseURL&&this._isOptimaApiCall(e.responseURL))return null;let t=null;if(n.length>0){const i=e.url||"",r=n.filter((t=>t.name===i||e.responseURL&&t.name===e.responseURL||t.name.includes(new URL(i).pathname)||e.responseURL&&t.name.includes(new URL(e.responseURL).pathname)));if(r.length>0){const n=r.sort(((t,n)=>Math.abs(t.startTime+performance.timeOrigin-e.startTime)-Math.abs(n.startTime+performance.timeOrigin-e.startTime)))[0];n&&(t={startTime:Math.round(n.startTime),duration:Math.round(n.duration),domainLookupTime:Math.round(n.domainLookupEnd-n.domainLookupStart),connectTime:Math.round(n.connectEnd-n.connectStart),tlsTime:n.secureConnectionStart?Math.round(n.connectEnd-n.secureConnectionStart):0,requestStartTime:Math.round(n.requestStart),ttfb:Math.round(n.responseStart-n.requestStart),downloadTime:Math.round(n.responseEnd-n.responseStart),entryType:n.entryType,initiatorType:n.initiatorType,transferSize:n.transferSize||0,decodedBodySize:n.decodedBodySize||0})}}let i=e.responseSize;return(void 0===i||i<0)&&(i=t&&t.transferSize>0?t.transferSize:t&&t.decodedBodySize>0?t.decodedBodySize:-1),{type:e.type||"xhr",method:e.method||"GET",url:e.responseURL||e.url,originalUrl:e.url,status:e.status||0,statusText:e.statusText||"",startTime:e.startTime,endTime:e.endTime||e.startTime+(e.duration||0),duration:e.duration||0,async:!0,requestPayloadSize:e.requestSize||-1,responseSize:i,aborted:!!e.aborted,errored:!!e.error||!!e.errored,timestamp:e.timestamp||e.startTime,resourceTiming:t,captureSource:e.captureMethod||"early-intercept",requestHeaders:e.requestHeaders||{"content-type":"unknown","content-length":"unknown"},responseHeaders:e.responseHeaders||{"content-type":"unknown","content-length":i>0?i.toString():"unknown","cache-control":"unknown"}}})).filter(Boolean);0!==i.length&&(i.sort(((e,t)=>e.startTime-t.startTime)),this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...i),t.__optima_early_xhr_queue=[])},_createSession:function(n,i,r={}){if(!this.apiKey)return;if(this.sessionId&&this.unifiedDataModel.session_id)return Promise.resolve(!0);const s=t.navigator.userAgent,o=this._detectDeviceType(),a=this._detectConnectionType(),c=Date.now(),u=performance?.timing?.navigationStart||c;this.sessionId||(this.sessionId=e(),this.sessionStartTime=c),this.unifiedDataModel.session_id=this.sessionId,this._updateMetadata();const l={session_id:this.sessionId,page_url:n||t.location.href,referrer:i||document.referrer,user_agent:s,device_type:o,connection_type:a,timestamp:c,navigation_start:u,web_vitals:{},errors:[],resources:[],ajax_requests:[],meta:this.unifiedDataModel.meta};this._sendToServer("/api/optima/sessions",l).then((e=>{var t;e&&("function"==typeof this._setupBatchedCollection&&this._setupBatchedCollection(),"function"==typeof this._setupPageLifecycleEvents&&this._setupPageLifecycleEvents(),this.isRouteChangeEnabled&&!this.routeDetector&&(this.routeDetector=((t=this).routeDetector||(t.routeDetector=new D(t)),t.routeDetector)),this._setupRouteTriggeringDetection())})).catch((e=>{}))},_detectDeviceType:function(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&!t.MSStream||/android/i.test(e)?"mobile":/Tablet|iPad/i.test(e)?"tablet":"desktop"},_detectConnectionType:function(){return navigator.connection?navigator.connection.effectiveType:"unknown"},_flushAjaxCalls:function(e=!1){},setupRouteSpecificObservers:function(e){this._resetINPForRoute&&this._resetINPForRoute(),this._isRouteSpecificSetup=!0,this._setupCoreWebVitals&&this._setupCoreWebVitals(e),this._isRouteSpecificSetup=!1,this._resetResourceMonitoring(e),this.currentVirtualSession=e},_resetResourceMonitoring:function(e){if(this.buffer.resources=[],(!e||!e.type||"initial_load"===e.type)&&"PerformanceObserver"in t)try{this.routeResourceObserver&&this.routeResourceObserver.disconnect(),this.routeResourceObserver=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{t.startTime>=e.startTime&&this.buffer.resources.push(t)}))})),this.routeResourceObserver.observe({type:"resource",buffered:!1})}catch(e){}},getCurrentRoute:function(){return this.routeDetector?this.routeDetector.getCurrentSession():null},getAllRouteSessions:function(){return this.routeDetector?this.routeDetector.getAllSessions():[]},sendEventWithRoute:function(e,t,n={}){const i=this.getCurrentRoute(),r={...t,route_session_id:i?.sessionId,route_type:i?.type,route_path:i?.route?.pathname};return this.sendEvent(e,r,n)},triggerRouteChange:function(e,t="manual"){this.routeDetector&&this.routeDetector.handleRouteChange(t,e)},_setupRouteTriggeringDetection:function(){this._checkIfRouteTriggering=function(e){if(!e||!e.target)return!1;const t=e.target,n=t.textContent?t.textContent.trim():"",i="A"===t.tagName||t.isLink||t.closest("nav")||t.closest('[role="navigation"]')||t.closest(".sidebar")||t.closest(".nav")||t.closest(".menu")||t.className&&(t.className.includes("nav")||t.className.includes("menu")||t.className.includes("sidebar")||t.className.includes("tab")||t.className.includes("link"))||n&&(n.match(/^(Home|Dashboard|Profile|Settings|About|Contact|Login|Logout|Sign|Register|Crashes|Releases|Analytics|Reports|Users|Admin)$/i)||n.match(/^(View|Go to|Navigate to|Open|Show)/i));return console.log("[Route Trigger Debug] Checking interaction:",{tagName:t.tagName,textContent:n,className:t.className,isNavigationElement:i,hasNavParent:!!t.closest("nav"),hasSidebarParent:!!t.closest(".sidebar")}),i};let e=null;const t=history.pushState,n=history.replaceState;history.pushState=function(){e={type:"pushState",timestamp:performance.now(),url:arguments[2]};const n=t.apply(this,arguments);return setTimeout((()=>{e=null}),100),n},history.replaceState=function(){e={type:"replaceState",timestamp:performance.now(),url:arguments[2]};const t=n.apply(this,arguments);return setTimeout((()=>{e=null}),100),t};const i=this._checkIfRouteTriggering;this._checkIfRouteTriggering=function(t){const n=i(t),r=e&&performance.now()-e.timestamp<50,s=n||r;return console.log("[Route Trigger Debug] Final decision:",{basicCheck:n,isPendingRouteChange:r,pendingRouteChange:e,result:s,interactionText:t.target?.textContent?.trim()||"no text"}),s}}};var i=function(){var e=Array.prototype.slice.call(arguments),i=e[0];if("init"===i){var r=e[1]||null,s=e[2]||{};return s.apiKey=r,t.optimaInstance=new n(s),t.optimaInstance}if(!t.optimaInstance)return!1;switch(i){case"event":return t.optimaInstance.sendEvent(e[1],e[2],e[3]);case"captureResources":return t.optimaInstance.captureResourceData("manual");case"flushBuffers":return t.optimaInstance.sendCollectedData(!0===e[1]);case"debug":return t.optimaInstance.debug();default:return!1}};t.Optima=n;var r=null;if("function"==typeof t.optima)if((r=t.optima).q&&r.q.length){t.optima=i;for(var s=0;s<r.q.length;s++)i.apply(t,r.q[s])}else t.optima=i;else t.optima=i}(window)}();
