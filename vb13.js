var optima=function(e){"use strict";class t{constructor(e,t){this.sdk=e,this.dataSender=t,this.currentView=null,this.viewHistory=[],this.maxHistorySize=10,console.log("[Optima ViewManager] 🎯 Initialized with event-driven architecture")}generateSessionId(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}generateViewId(){return"view_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}startNewView(e="initial",t={}){const i=Date.now();this.currentView&&this.currentView.isActive&&this.completeView("new_view_started");const n={id:this.generateViewId(),sessionId:this.generateSessionId(),type:e,startTime:i,timestamp:i,duration:0,lastActivityTime:i,url:window.location.href,referrer:document.referrer,webVitals:{},resources:[],ajaxRequests:[],errors:[],events:[],isCompleted:!1,isActive:!0,completionReason:null,initialDataSent:!1};return this.currentView=n,this.addToHistory(n),this.updateActivity(),console.log(`[Optima ViewManager] ✅ Started new ${e} view: ${n.id.substring(0,8)}... with session: ${n.sessionId.substring(0,8)}...`),this.sendInitialViewData(),this.currentView}sendInitialViewData(){if(!this.currentView||!this.dataSender)return;const e=this.prepareViewData();"initial"===this.currentView.type?this.dataSender.sendInitialViewData(e):"route_change"===this.currentView.type&&this.dataSender.sendRouteChangeData(e)}prepareViewData(){return this.currentView?{view_id:this.currentView.id,session_id:this.currentView.sessionId,session_type:this.currentView.type,url:this.currentView.url,web_vitals:this.currentView.webVitals,resources:this.currentView.resources,timing:{start_time:this.currentView.startTime,duration:this.currentView.duration,last_activity:this.currentView.lastActivityTime},errors:this.currentView.errors}:null}addWebVital(e,t){this.currentView&&this.currentView.isActive&&(this.currentView.webVitals[e]={...t,timestamp:Date.now(),viewRelativeTime:Date.now()-this.currentView.startTime},this.updateActivity(),console.log(`[Optima ViewManager] 📊 Added ${e} to view: ${this.currentView.id.substring(0,8)}...`))}addResource(e){this.currentView&&this.currentView.isActive&&(this.currentView.resources.push({...e,timestamp:Date.now(),viewRelativeTime:Date.now()-this.currentView.startTime}),this.updateActivity(),this.dataSender&&this.dataSender.sendResource(e))}addAjaxRequest(e){this.currentView&&this.currentView.isActive&&(this.currentView.ajaxRequests.push({...e,timestamp:Date.now(),viewRelativeTime:Date.now()-this.currentView.startTime}),this.updateActivity())}addError(e){if(!this.currentView||!this.currentView.isActive)return;const t={...e,timestamp:Date.now(),viewRelativeTime:Date.now()-this.currentView.startTime};this.currentView.errors.push(t),this.updateActivity(),this.dataSender&&this.dataSender.sendError(t)}addEvent(e){this.currentView&&this.currentView.isActive&&(this.currentView.events.push({...e,timestamp:Date.now(),viewRelativeTime:Date.now()-this.currentView.startTime}),this.updateActivity())}updateActivity(){this.currentView&&this.currentView.isActive&&(this.currentView.lastActivityTime=Date.now())}markInitialDataSent(){this.currentView&&(this.currentView.initialDataSent=!0,console.log(`[Optima ViewManager] ✅ Initial data sent for view: ${this.currentView.id.substring(0,8)}...`))}completeView(e="manual"){if(!this.currentView||this.currentView.isCompleted)return;const t=Date.now();this.currentView.duration=t-this.currentView.startTime,this.currentView.isCompleted=!0,this.currentView.isActive=!1,this.currentView.completionReason=e,console.log(`[Optima ViewManager] 🏁 Completed view: ${this.currentView.id.substring(0,8)}... (reason: ${e}, duration: ${this.currentView.duration}ms)`)}getCurrentView(){return this.currentView}getViewById(e){return this.viewHistory.find((t=>t.id===e))||null}addToHistory(e){this.viewHistory.unshift(e),this.viewHistory.length>this.maxHistorySize&&(this.viewHistory=this.viewHistory.slice(0,this.maxHistorySize))}getViewHistory(){return[...this.viewHistory]}getViewStats(){const e=this.currentView;return e?{viewId:e.id,sessionId:e.sessionId,type:e.type,isActive:e.isActive,duration:e.isActive?Date.now()-e.startTime:e.duration,webVitalsCount:Object.keys(e.webVitals).length,resourceCount:e.resources.length,ajaxCount:e.ajaxRequests.length,errorCount:e.errors.length,eventCount:e.events.length,initialDataSent:e.initialDataSent}:null}cleanup(){console.log("[Optima ViewManager] 🧹 Cleaning up view manager"),this.currentView&&this.currentView.isActive&&this.completeView("cleanup"),this.currentView=null}}class i{constructor(e){this.viewManager=e,this.currentUrl=window.location.href,this.isSetup=!1,console.log("[Optima RouteDetector] 🛣️ Route detector initialized")}setupRouteDetection(){this.isSetup?console.warn("[Optima RouteDetector] ⚠️ Route detection already setup"):(console.log("[Optima RouteDetector] 🔧 Setting up route change detection"),this.patchHistoryAPI(),this.setupPopstateListener(),this.setupHashchangeListener(),this.setupMutationObserver(),this.isSetup=!0,console.log("[Optima RouteDetector] ✅ Route detection setup complete"))}patchHistoryAPI(){const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{console.log("[Optima RouteDetector] 📍 pushState detected:",t),e.apply(history,t),setTimeout((()=>{this.handleRouteChange("pushstate",window.location.href)}),10)},history.replaceState=(...e)=>{console.log("[Optima RouteDetector] 📍 replaceState detected:",e),t.apply(history,e),setTimeout((()=>{this.handleRouteChange("replacestate",window.location.href)}),10)},console.log("[Optima RouteDetector] 🔧 History API patched")}setupPopstateListener(){window.addEventListener("popstate",(e=>{console.log("[Optima RouteDetector] ⬅️ popstate event:",e),setTimeout((()=>{this.handleRouteChange("popstate",window.location.href)}),10)})),console.log("[Optima RouteDetector] 🔧 Popstate listener setup")}setupHashchangeListener(){window.addEventListener("hashchange",(e=>{console.log("[Optima RouteDetector] #️⃣ hashchange event:",e),this.handleRouteChange("hashchange",window.location.href)})),console.log("[Optima RouteDetector] 🔧 Hashchange listener setup")}setupMutationObserver(){if(!("MutationObserver"in window))return void console.warn("[Optima RouteDetector] ⚠️ MutationObserver not supported");new MutationObserver((e=>{let t=!1;e.forEach((e=>{if("childList"===e.type&&e.addedNodes.length>0){Array.from(e.addedNodes).some((e=>e.nodeType===Node.ELEMENT_NODE&&("MAIN"===e.tagName||"SECTION"===e.tagName||"ARTICLE"===e.tagName||e.classList.contains("page")||e.classList.contains("view")||e.classList.contains("route"))))&&(t=!0)}})),t&&window.location.href!==this.currentUrl&&(console.log("[Optima RouteDetector] 🔄 Potential route change detected via DOM mutation"),setTimeout((()=>{this.handleRouteChange("mutation_observer",window.location.href)}),100))})).observe(document.body,{childList:!0,subtree:!0,attributes:!1}),console.log("[Optima RouteDetector] 🔧 Mutation observer setup")}handleRouteChange(e,t){if(t===this.currentUrl)return void console.log("[Optima RouteDetector] ℹ️ URL unchanged, ignoring route change");if(!this.isMeaningfulRouteChange(this.currentUrl,t))return console.log("[Optima RouteDetector] ℹ️ Non-meaningful route change, ignoring"),void(this.currentUrl=t);console.log(`[Optima RouteDetector] 🔄 Route change confirmed: ${e}`),console.log(`[Optima RouteDetector] 📍 From: ${this.currentUrl}`),console.log(`[Optima RouteDetector] 📍 To: ${t}`);const i=this.currentUrl;this.currentUrl=t;try{this.viewManager.startNewView("route_change",t,e),console.log("[Optima RouteDetector] ✅ Route change processed successfully")}catch(e){console.error("[Optima RouteDetector] ❌ Error processing route change:",e),this.currentUrl=i}}isMeaningfulRouteChange(e,t){try{const i=new URL(e),n=new URL(t);if(i.origin!==n.origin)return!0;if(i.pathname!==n.pathname)return!0;if(i.hash!==n.hash&&(i.hash.length>1||n.hash.length>1))return!0;if(i.search!==n.search){const e=["page","view","tab","section","route","path"],t=new URLSearchParams(i.search),r=new URLSearchParams(n.search);for(const i of e)if(t.get(i)!==r.get(i))return!0}return!1}catch(e){return console.error("[Optima RouteDetector] ❌ Error parsing URLs for comparison:",e),!0}}triggerRouteChange(e,t="manual"){console.log(`[Optima RouteDetector] 🔧 Manual route change triggered: ${e}`),this.handleRouteChange(t,e)}getCurrentUrl(){return this.currentUrl}isRouteDetectionSetup(){return this.isSetup}syncUrl(){const e=window.location.href;e!==this.currentUrl&&(console.log("[Optima RouteDetector] 🔄 Syncing URL:",e),this.currentUrl=e)}cleanup(){console.log("[Optima RouteDetector] 🧹 Cleaning up route detection"),this.isSetup=!1}}class n{constructor(e,t,i){this.sdk=e,this.viewManager=t,this.config=i,this.eventQueue=[],this.isProcessing=!1,console.log("[Optima EventDrivenDataSender] 🚀 Initialized")}sendEvent(e,t="event"){const i=this.viewManager.currentView;if(!i)return void console.warn("[Optima EventDrivenDataSender] ⚠️ No current view, skipping event");const n={session_id:i.sessionId,view_id:i.id,session_type:i.type,url:i.url,trigger:t,timestamp:Date.now(),send_timestamp:Date.now(),user_agent:navigator.userAgent,api_key:this.sdk.apiKey,...e};this.performSend(n,{immediate:!0})}sendInitialViewData(e){console.log(`[Optima EventDrivenDataSender] 📤 Sending initial view data: ${e.view_id.substring(0,8)}...`),this.sendEvent({type:"initial_view",web_vitals:e.web_vitals,resources:e.resources,timing:e.timing,errors:e.errors||[]},"initial_view"),this.viewManager.markInitialDataSent()}sendRouteChangeData(e){console.log(`[Optima EventDrivenDataSender] 🔄 Sending route change data: ${e.view_id.substring(0,8)}...`),this.sendEvent({type:"route_change",web_vitals:e.web_vitals,resources:e.resources,timing:e.timing,errors:e.errors||[]},"route_change"),this.viewManager.markInitialDataSent()}sendContinuousUpdate(e){console.log("[Optima EventDrivenDataSender] 📊 Sending continuous update"),this.sendEvent({type:"continuous_update",web_vitals:e},"continuous_update")}sendError(e){console.log("[Optima EventDrivenDataSender] ❌ Sending error data"),this.sendEvent({type:"error",error:e},"error")}sendResource(e){console.log("[Optima EventDrivenDataSender] 📦 Sending resource data"),this.sendEvent({type:"resource",resource:e},"resource")}performSend(e,t={}){try{e.send_options={immediate:t.immediate||!0,sync:t.sync||!1,event_driven:!0},this.sdk._sendToServer("/api/collect",e,{sync:t.sync,immediate:!0},(t=>{t?console.log(`[Optima EventDrivenDataSender] ✅ Event sent successfully: ${e.trigger}`):console.error(`[Optima EventDrivenDataSender] ❌ Failed to send event: ${e.trigger}`)}))}catch(e){console.error("[Optima EventDrivenDataSender] ❌ Error sending event:",e)}}stop(){console.log("[Optima EventDrivenDataSender] 🛑 Stopped")}}class r{constructor(e,t,i){this.sdk=e,this.viewManager=t,this.dataSender=i,this.isActive=!1,this.lastCLS=0,this.lastINP=0,this.updateThreshold=.001,console.log("[Optima ContinuousMetrics] 🔄 Initialized for event-driven architecture")}start(){this.isActive||(this.isActive=!0,console.log("[Optima ContinuousMetrics] ▶️ Started monitoring"),this.setupCLSMonitoring(),this.setupINPMonitoring())}setupCLSMonitoring(){if(window.PerformanceObserver)try{new PerformanceObserver((e=>{for(const t of e.getEntries())"layout-shift"!==t.entryType||t.hadRecentInput||this.handleCLSChange(t)})).observe({entryTypes:["layout-shift"]}),console.log("[Optima ContinuousMetrics] 👀 CLS monitoring active")}catch(e){console.warn("[Optima ContinuousMetrics] ⚠️ CLS monitoring not supported:",e)}}setupINPMonitoring(){if(window.PerformanceObserver)try{new PerformanceObserver((e=>{for(const t of e.getEntries())"event"===t.entryType&&t.duration>40&&this.handleINPChange(t)})).observe({entryTypes:["event"],durationThreshold:40}),console.log("[Optima ContinuousMetrics] 👀 INP monitoring active")}catch(e){console.warn("[Optima ContinuousMetrics] ⚠️ INP monitoring not supported:",e)}}handleCLSChange(e){if(!this.viewManager.currentView?.isActive)return;const t=this.lastCLS+e.value;Math.abs(t-this.lastCLS)>=this.updateThreshold&&(this.lastCLS=t,this.viewManager.addWebVital("CLS",{value:t,timestamp:Date.now(),last_shift_time:e.startTime,last_shift_value:e.value}),this.sendContinuousUpdate({CLS:{value:t,timestamp:Date.now(),view_relative_time:Date.now()-this.viewManager.currentView.startTime,last_shift_time:e.startTime,last_shift_value:e.value}}))}handleINPChange(e){if(!this.viewManager.currentView?.isActive)return;const t=e.duration;Math.abs(t-this.lastINP)>=10&&(this.lastINP=t,this.viewManager.addWebVital("INP",{value:t,timestamp:Date.now(),interaction_type:e.name,target:e.target?.tagName||"unknown"}),this.sendContinuousUpdate({INP:{value:t,timestamp:Date.now(),view_relative_time:Date.now()-this.viewManager.currentView.startTime,interaction_type:e.name,target:e.target?.tagName||"unknown"}}))}sendContinuousUpdate(e){this.viewManager.currentView?.isActive&&(console.log("[Optima ContinuousMetrics] 📊 Sending continuous update"),this.dataSender&&this.dataSender.sendContinuousUpdate(e))}getCurrentContinuousMetrics(){return{CLS:this.lastCLS,INP:this.lastINP,timestamp:Date.now()}}resetForNewView(){console.log("[Optima ContinuousMetrics] 🔄 Resetting for new view"),this.lastCLS=0,this.lastINP=0}stop(){this.isActive=!1,console.log("[Optima ContinuousMetrics] ⏹️ Stopped monitoring")}}function s(e){e.buffer||(e.buffer={}),e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t)return;try{const i=t.error||new Error(t.message||"Unknown error"),n=i.message||t.message||"Unknown error",r=t.filename||t.srcElement?.src||window.location.href,s=i.stack||null,u="error",l={type:u,message:n,source:r,lineno:t.lineno||0,colno:t.colno||0,stack:s,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:o(u,n,r,s)};a(e,l),c(e),e.sendEvent("error",{error_type:"uncaught_error",message:l.message,source:l.source,lineno:l.lineno,colno:l.colno})}catch(e){}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const i=t.reason,n=i instanceof Error?i.message:String(i),r=i instanceof Error?i.stack:null,s="unhandled_rejection",u="Promise",l={type:s,message:n,source:u,stack:r,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:o(s,n,u,r)};a(e,l),c(e),e.sendEvent("error",{error_type:"unhandled_rejection",message:l.message})}catch(e){}}(e,t)})),function(e){const t=console.error;console.error=function(...i){const n="console.error";try{const t=(new Error).stack||"",r=i.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),s="console_error",c={type:s,message:r,source:n,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:o(s,r,n,t)};a(e,c)}catch(e){}t.apply(console,i)}}(e)}function o(e,t,i,n){const r=`${e}:${t}:${i}:${n?n.substring(0,150):""}`;let s=0;for(let e=0;e<r.length;e++){s=(s<<5)-s+r.charCodeAt(e),s|=0}return"err_"+Math.abs(s).toString(16)}function a(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const i=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(i)return!1;const n=e.buffer.errors.slice(-5),r=n.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!r})(e,t)&&(e.buffer.errors.push(t),e.buffer.errors.length>=5&&c(e))}function c(e){e.buffer.errors&&0!==e.buffer.errors.length&&(e.viewManager&&e.viewManager.currentView?e.buffer.errors.forEach((t=>{e.viewManager.addError(t)})):e.unifiedDataModel&&(e.unifiedDataModel.errors||(e.unifiedDataModel.errors=[]),e.unifiedDataModel.errors=[...e.unifiedDataModel.errors,...e.buffer.errors],e._sendUnifiedData(!1)),e.buffer.errors=[])}const u={sessionId:null,apiKey:null,disabled:!1,version:"2.0.0-view-based",viewManager:null,routeDetector:null,dataSender:null,continuousMetrics:null,resourceCollector:null,webVitalsCollector:null,isInitialized:!1,initializationTime:null,config:{apiKey:null,endpoint:null,sampleRate:100,flushInterval:5e3,webVitalsBatchDelay:2e3,batchBeforeSend:!0,maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,payloadCompressionThreshold:10240,enableRouteChangeTracking:!0,enableContinuousMetrics:!0,batchSize:3,batchTimeout:5e3,continuousMetricsInterval:1e4,debug:!1,disabled:!1},init:function(e,s={}){if(this.isInitialized)console.warn("[ViewBasedOptima] ⚠️ SDK already initialized");else{console.log("[ViewBasedOptima] 🚀 Initializing View-Based Optima SDK v2.0.0-view-based with event-driven architecture"),this.apiKey=e,this.config={sampleRate:100,endpoint:"http://localhost:3000",debug:!1,enableRouteChangeTracking:!0,enableContinuousMetrics:!0,batchSize:10,flushInterval:5e3,...s},this.config.debug&&(this.debug=!0,console.log("[ViewBasedOptima] 🐛 Debug mode enabled"));try{this.dataSender=new n(this,null,this.config),this.viewManager=new t(this,this.dataSender),this.dataSender.viewManager=this.viewManager,this.routeDetector=new i(this.config),this.continuousMetrics=new r(this,this.viewManager,this.dataSender),console.log("[ViewBasedOptima] ✅ Event-driven architecture initialized")}catch(e){return void console.error("[ViewBasedOptima] ❌ Error initializing architecture:",e)}this.config.enableRouteChangeTracking&&(this.routeDetector.onRouteChange(((e,t)=>{console.log(`[ViewBasedOptima] 🔄 Route change detected: ${t} → ${e}`),this.viewManager.startNewView("route_change",{previousRoute:t,newRoute:e}),this.config.enableContinuousMetrics&&this.continuousMetrics.resetForNewView()})),this.routeDetector.start(),console.log("[ViewBasedOptima] 🗺️ Route change detection started")),this.setupWebVitalsCollection(),this.setupResourceMonitoring(),this.setupErrorMonitoring(),this.viewManager.startNewView("initial",{url:window.location.href,referrer:document.referrer,timestamp:Date.now()}),this.config.enableContinuousMetrics&&this.continuousMetrics.start(),this.setupPageLifecycleHandlers(),this.isInitialized=!0,console.log("[ViewBasedOptima] ✅ View-Based Optima SDK initialized successfully")}},setupWebVitalsCollection:function(){console.log("[ViewBasedOptima] 📊 Setting up web vitals collection");["LCP","FID","CLS","FCP","TTFB","INP"].forEach((e=>{this.collectWebVital(e)}))},collectWebVital:function(e){try{"LCP"===e?this.collectLCP():"FID"===e?this.collectFID():"CLS"===e?this.collectCLS():"FCP"===e?this.collectFCP():"TTFB"===e?this.collectTTFB():"INP"===e&&this.collectINP()}catch(t){console.error(`[ViewBasedOptima] ❌ Error collecting ${e}:`,t)}},collectLCP:function(){if(window.PerformanceObserver)try{new PerformanceObserver((e=>{const t=e.getEntries(),i=t[t.length-1];i&&this.viewManager.currentView?.isActive&&this.viewManager.addWebVital("LCP",{value:i.startTime,element:i.element?.tagName||"unknown",url:i.url||""})})).observe({entryTypes:["largest-contentful-paint"]})}catch(e){console.warn("[ViewBasedOptima] ⚠️ LCP collection not supported")}},collectFID:function(){if(window.PerformanceObserver)try{new PerformanceObserver((e=>{e.getEntries().forEach((e=>{this.viewManager.currentView?.isActive&&this.viewManager.addWebVital("FID",{value:e.processingStart-e.startTime,target:e.target?.tagName||"unknown"})}))})).observe({entryTypes:["first-input"]})}catch(e){console.warn("[ViewBasedOptima] ⚠️ FID collection not supported")}},collectCLS:function(){if(window.PerformanceObserver)try{let e=0;new PerformanceObserver((t=>{t.getEntries().forEach((t=>{!t.hadRecentInput&&this.viewManager.currentView?.isActive&&(e+=t.value,this.viewManager.addWebVital("CLS",{value:e,last_shift_time:t.startTime,last_shift_value:t.value}))}))})).observe({entryTypes:["layout-shift"]})}catch(e){console.warn("[ViewBasedOptima] ⚠️ CLS collection not supported")}},collectFCP:function(){if(window.PerformanceObserver)try{new PerformanceObserver((e=>{e.getEntries().forEach((e=>{"first-contentful-paint"===e.name&&this.viewManager.currentView?.isActive&&this.viewManager.addWebVital("FCP",{value:e.startTime})}))})).observe({entryTypes:["paint"]})}catch(e){console.warn("[ViewBasedOptima] ⚠️ FCP collection not supported")}},collectTTFB:function(){try{if(window.performance&&window.performance.timing){const e=window.performance.timing,t=e.responseStart-e.navigationStart;t>0&&this.viewManager.currentView?.isActive&&this.viewManager.addWebVital("TTFB",{value:t})}}catch(e){console.warn("[ViewBasedOptima] ⚠️ TTFB collection not supported")}},collectINP:function(){if(window.PerformanceObserver)try{new PerformanceObserver((e=>{e.getEntries().forEach((e=>{e.duration>40&&this.viewManager.currentView?.isActive&&this.viewManager.addWebVital("INP",{value:e.duration,interaction_type:e.name,target:e.target?.tagName||"unknown"})}))})).observe({entryTypes:["event"],durationThreshold:40})}catch(e){console.warn("[ViewBasedOptima] ⚠️ INP collection not supported")}},setupErrorMonitoring:function(){try{s(this)}catch(e){console.error("[ViewBasedOptima] ❌ Error setting up error monitoring:",e)}},setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this.handlePageHidden():"visible"===document.visibilityState&&this.handlePageVisible()})),window.addEventListener("beforeunload",(()=>{this.handlePageUnload()})),window.addEventListener("blur",(()=>{this.sendEvent("page_blur",{timestamp:Date.now()})})),window.addEventListener("focus",(()=>{this.sendEvent("page_focus",{timestamp:Date.now()})}))},startInitialView:function(){console.log("[ViewBasedOptima] 🎬 Starting initial view"),this.viewManager.startNewView("initial",window.location.href,"page_load"),this.startCollectorsForView("initial"),this.continuousMetrics&&this.continuousMetrics.startContinuousTracking(),this._onViewCompleted=(e,t)=>{this.handleViewCompleted(e,t)}},startCollectorsForView:function(e){console.log(`[ViewBasedOptima] 🔧 Starting collectors for ${e} view`),this.resourceCollector.startCollecting(),this.webVitalsCollector.startCollecting(e)},handleViewCompleted:function(e,t){console.log(`[ViewBasedOptima] 🏁 View completed: ${e.id.substring(0,8)}... (${t})`),this.dataSender.sendViewData(e,t),"new_view_started"===t&&this.viewManager.currentView&&(this.startCollectorsForView(this.viewManager.currentView.type),this.continuousMetrics&&this.continuousMetrics.reset())},handlePageHidden:function(){console.log("[ViewBasedOptima] 👁️ Page hidden"),this.sendEvent("page_hidden",{timestamp:Date.now()},{immediate:!0}),this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_hidden"),this.dataSender&&this.dataSender.forceFlush()},handlePageVisible:function(){console.log("[ViewBasedOptima] 👁️ Page visible"),this.sendEvent("page_visible",{timestamp:Date.now()})},handlePageUnload:function(){console.log("[ViewBasedOptima] 📤 Page unloading"),this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_unload"),this.dataSender&&this.dataSender.forceFlush(),this.continuousMetrics&&this.continuousMetrics.stopContinuousTracking()},sendEvent:function(e,t={},i={}){if(this.disabled||!this.sessionId)return;const n={name:e,data:t,timestamp:Date.now(),session_id:this.sessionId,url:window.location.href};this.viewManager?.currentView&&this.viewManager.addEvent(n),i.immediate&&this._sendToServer("/api/events",n,{sync:!0})},triggerRouteChange:function(e){this.routeDetector&&this.routeDetector.triggerRouteChange(e,"manual")},getCurrentView:function(){return this.viewManager?.getCurrentViewData()||null},getViewHistory:function(){return this.viewManager?.getViewHistory()||[]},getStatus:function(){return{isInitialized:this.isInitialized,sessionId:this.sessionId,version:this.version,disabled:this.disabled,currentView:this.getCurrentView(),viewHistory:this.getViewHistory(),config:this.config,components:{viewManager:!!this.viewManager,routeDetector:!!this.routeDetector,dataSender:!!this.dataSender,continuousMetrics:!!this.continuousMetrics,resourceCollector:!!this.resourceCollector,webVitalsCollector:!!this.webVitalsCollector}}},updateConfig:function(e){this.config={...this.config,...e},this.dataSender&&(e.batchSize||e.batchTimeout)&&this.dataSender.updateConfig({maxBatchSize:e.batchSize,batchTimeout:e.batchTimeout}),this.continuousMetrics&&e.continuousMetricsInterval&&this.continuousMetrics.updateInterval(e.continuousMetricsInterval),console.log("[ViewBasedOptima] ⚙️ Configuration updated:",this.config)},_sendToServer:function(e,t,i={}){if(!this.disabled){t.api_key=this.apiKey,t.timestamp=t.timestamp||Date.now(),t.user_agent=navigator.userAgent;try{const n=`${this.endpoint||this.config.endpoint||"https://api.optima.com"}${e}`;if(i.sync&&navigator.sendBeacon){const r=new URL(n);r.searchParams.set("api_key",this.apiKey);const s=navigator.sendBeacon(r.toString(),JSON.stringify(t));this.config.debug&&console.log(`[ViewBasedOptima] 🚨 BeaconAPI send ${s?"SUCCESS":"FAILED"} to ${e}`),s||this._sendViaFetch(n,t,{...i,sync:!0})}else this._sendViaFetch(n,t,i)}catch(e){this.config.debug&&console.error("[ViewBasedOptima] ❌ Send error:",e)}}},_sendViaFetch:function(e,t,i={}){fetch(e,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),keepalive:i.sync}).then((n=>(this.config.debug&&console.log(`[ViewBasedOptima] ✅ Fetch ${n.ok?"SUCCESS":"ERROR"} to ${e}`),n.ok&&i.onSuccess?i.onSuccess(t,n):!n.ok&&i.onError&&i.onError(t,n),n))).catch((e=>{this.config.debug&&console.error("[ViewBasedOptima] ❌ Fetch failed:",e),i.onError&&i.onError(t,e)}))},cleanup:function(){console.log("[ViewBasedOptima] 🧹 Cleaning up SDK"),this.viewManager?.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("sdk_cleanup"),this.dataSender&&this.dataSender.cleanup(),this.continuousMetrics&&this.continuousMetrics.cleanup(),this.resourceCollector&&this.resourceCollector.reset(),this.webVitalsCollector&&this.webVitalsCollector.reset(),this.routeDetector&&this.routeDetector.cleanup(),this.isInitialized=!1,this.sessionId=null}};if("undefined"!=typeof window&&window.OptimaConfig&&u.init(window.OptimaConfig),"undefined"!=typeof window){const e=window.optima&&window.optima.q?[...window.optima.q]:[];window.optima=function(){const e=Array.prototype.slice.call(arguments),t=e[0];if(console.log("[ViewBasedOptima] 🔧 Processing command:",t,e),"init"===t)if("string"==typeof e[1]){const t=e[1],i=e[2]||{};i.apiKey=t,console.log("[ViewBasedOptima] 🔧 Initializing with old format"),u.init(t,i)}else console.log("[ViewBasedOptima] 🔧 Initializing with new format"),u.init(e[1]||{});else if("track"===t)u.sendEvent(e[1],e[2],e[3]);else{if("getStatus"===t)return u.getStatus();"updateConfig"===t?u.updateConfig(e[1]):console.warn("[ViewBasedOptima] Unknown command:",t)}},window.ViewBasedOptima=u,e.length>0?(console.log("[ViewBasedOptima] 🔄 Processing queued calls:",e.length),e.forEach((e=>{try{console.log("[ViewBasedOptima] 🔄 Processing queued call:",e[0]),window.optima.apply(window,e)}catch(t){console.error("[ViewBasedOptima] ❌ Error processing queued call:",t,e)}}))):console.log("[ViewBasedOptima] 📭 No queued calls to process")}return e.ViewBasedOptima=u,e.default=u,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
