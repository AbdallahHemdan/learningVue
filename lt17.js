var optima=function(t){"use strict";function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}class i{constructor(t){this.sdk=t,this.currentView=null,this.viewHistory=[],this.viewStartTime=null,this.maxViewHistory=10}createView(t,i,s,n=null,r=null){return{id:e(),type:t,url:i,trigger:s,startTime:performance.now(),timestamp:Date.now(),duration:null,routeTriggerTime:r,interactionBaseline:n,webVitals:{LCP:null,FID:null,CLS:null,FCP:null,INP:null,TTFB:null,loading_time:null},resources:[],ajaxRequests:[],errors:[],events:[],isCompleted:!1,isActive:!0,lastActivityTime:Date.now(),completionReason:null,collectorState:{resourcesCollected:!1,webVitalsSetup:!1,errorsSetup:!1,eventsSetup:!1}}}startNewView(t,e,i=null,s=null){const n="initial"===t?"page_load":"pushstate";return this.sdk&&"function"==typeof this.sdk.t&&this.sdk.t(),this.currentView&&!this.currentView.isCompleted&&this.completeView("new_view_started"),this.currentView=this.createView(t,e,n,i,s),this.viewStartTime=this.currentView.startTime,this.resetCollectors(),this.updateActivity(),this.sdk&&"function"==typeof this.sdk.startCollectorsForView&&(this.sdk.startCollectorsForView(this.currentView.type),this.sdk.continuousMetrics&&this.sdk.continuousMetrics.reset()),this.currentView}completeView(t="manual"){this.currentView&&!this.currentView.isCompleted&&(this.currentView.isCompleted=!0,this.currentView.isActive=!1,this.currentView.completionReason=t,this.currentView.duration=Date.now()-this.currentView.timestamp,this.archiveView(this.currentView),this.sdk&&"function"==typeof this.sdk.i&&this.sdk.i(this.currentView,t))}archiveView(t){this.viewHistory.push({...t,resources:t.resources.length,ajaxRequests:t.ajaxRequests.length,errors:t.errors.length,events:t.events.length}),this.viewHistory.length>this.maxViewHistory&&this.viewHistory.shift()}resetCollectors(){this.currentView&&(this.currentView.collectorState={resourcesCollected:!1,webVitalsSetup:!1,errorsSetup:!1,eventsSetup:!1},this.sdk&&this.sdk.collectionState&&(this.sdk.collectionState.sentResourceURLs=new Set))}updateActivity(){this.currentView&&this.currentView.isActive&&(this.currentView.lastActivityTime=Date.now())}addResource(t){return!(!this.currentView||!this.currentView.isActive||(t.viewId=this.currentView.id,t.viewType=this.currentView.type,this.currentView.resources.push(t),this.updateActivity(),0))}addAjaxRequest(t){return!(!this.currentView||!this.currentView.isActive||(t.viewId=this.currentView.id,t.viewType=this.currentView.type,this.currentView.ajaxRequests.push(t),this.updateActivity(),0))}addError(t){return!(!this.currentView||!this.currentView.isActive||(t.viewId=this.currentView.id,t.viewType=this.currentView.type,this.currentView.errors.push(t),this.updateActivity(),0))}addEvent(t){return!(!this.currentView||!this.currentView.isActive||(t.viewId=this.currentView.id,t.viewType=this.currentView.type,this.currentView.events.push(t),this.updateActivity(),0))}updateWebVital(t,e,i={}){return!(!this.currentView||!this.currentView.isActive||(this.currentView.webVitals[t]={value:e,timestamp:Date.now(),viewRelativeTime:performance.now()-this.currentView.startTime,...i},this.updateActivity(),this.sdk&&this.sdk.continuousMetrics&&this.sdk.continuousMetrics.onWebVitalDetected(t,e),0))}getCurrentViewData(){return this.currentView?{...this.currentView,resourceCount:this.currentView.resources.length,ajaxCount:this.currentView.ajaxRequests.length,errorCount:this.currentView.errors.length,eventCount:this.currentView.events.length}:null}getViewHistory(){return this.viewHistory}isViewStale(t=3e4){return!(!this.currentView||!this.currentView.isActive)&&Date.now()-this.currentView.lastActivityTime>t}completeStaleView(){this.isViewStale()&&this.completeView("stale_timeout")}getResourceCollectionDebug(){return this.sdk&&this.sdk.resourceCollector?this.sdk.resourceCollector.getDebugInfo():null}}class s{constructor(t){this.viewManager=t,this.currentUrl=window.location.href,this.isSetup=!1,this.lastUserInteractionTime=null,this.lastUserInteractionType=null,this.userInteractionTimeout=5e3}setupRouteDetection(){this.isSetup||(this.setupUserInteractionTracking(),this.patchHistoryAPI(),this.setupPopstateListener(),this.setupHashchangeListener(),this.setupMutationObserver(),this.isSetup=!0)}setupUserInteractionTracking(){document.addEventListener("click",(t=>{this.recordUserInteraction("click",t)}),{capture:!0,passive:!0}),document.addEventListener("touchstart",(t=>{this.recordUserInteraction("touchstart",t)}),{capture:!0,passive:!0}),document.addEventListener("keydown",(t=>{"Enter"!==t.key&&" "!==t.key||!this.isNavigationElement(t.target)||this.recordUserInteraction("keydown",t)}),{capture:!0,passive:!0})}recordUserInteraction(t,e){const i=performance.now();this.isNavigationElement(e.target)&&(this.lastUserInteractionTime=i,this.lastUserInteractionType=t)}isNavigationElement(t){if(!t||!t.tagName)return!1;const e=t.tagName.toLowerCase();if("a"===e||"button"===e)return!0;if(t.hasAttribute("href")||t.hasAttribute("onclick")||t.hasAttribute("data-href")||t.hasAttribute("data-route"))return!0;const i=t.className||"";if("string"==typeof i&&(i.includes("nav")||i.includes("link")||i.includes("button")||i.includes("menu")||i.includes("tab")))return!0;let s=t.parentElement,n=0;for(;s&&n<3;){if(this.isNavigationElement(s))return!0;s=s.parentElement,n++}return!1}getRecentUserInteractionTime(t){return this.lastUserInteractionTime&&t-this.lastUserInteractionTime<=this.userInteractionTimeout?this.lastUserInteractionTime:null}patchHistoryAPI(){const t=history.pushState,e=history.replaceState;history.pushState=(...e)=>{const i=performance.now();t.apply(history,e),this.handleRouteChange("pushstate",window.location.href,i)},history.replaceState=(...t)=>{const i=performance.now();e.apply(history,t),this.handleRouteChange("replacestate",window.location.href,i)}}setupPopstateListener(){window.addEventListener("popstate",(t=>{const e=performance.now();this.handleRouteChange("popstate",window.location.href,e)}))}setupHashchangeListener(){window.addEventListener("hashchange",(t=>{const e=performance.now();this.handleRouteChange("hashchange",window.location.href,e)}))}setupMutationObserver(){"MutationObserver"in window&&new MutationObserver((t=>{let e=!1;const i=performance.now();t.forEach((t=>{"childList"===t.type&&t.addedNodes.length>0&&Array.from(t.addedNodes).some((t=>t.nodeType===Node.ELEMENT_NODE&&("MAIN"===t.tagName||"SECTION"===t.tagName||"ARTICLE"===t.tagName||t.classList.contains("page")||t.classList.contains("view")||t.classList.contains("route"))))&&(e=!0)})),e&&window.location.href!==this.currentUrl&&setTimeout((()=>{this.handleRouteChange("mutation_observer",window.location.href,i)}),50)})).observe(document.body,{childList:!0,subtree:!0,attributes:!1})}handleRouteChange(t,e,i=null){const s=i||performance.now();if(e!==this.currentUrl)if(this.isMeaningfulRouteChange(this.currentUrl,e))try{this.getRecentUserInteractionTime(s);const t=this.canUseInteractionTimeAsBaseline()?this.lastUserInteractionTime:null;this.currentUrl=e,this.viewManager.startNewView("route_change",e,t,s)}catch(t){}else this.currentUrl=e}analyzeInteractionTiming(t,e){this.getRecentUserInteractionTime(e)}canUseInteractionTimeAsBaseline(){return!!this.lastUserInteractionTime&&performance.now()-this.lastUserInteractionTime<=this.userInteractionTimeout}isMeaningfulRouteChange(t,e){try{const i=new URL(t),s=new URL(e);return i.origin!==s.origin||i.pathname!==s.pathname||i.hash!==s.hash&&(i.hash.length>1||s.hash.length>1)}catch(t){return!0}}triggerRouteChange(t,e="manual"){const i=performance.now();this.handleRouteChange(e,t,i)}getCurrentUrl(){return this.currentUrl}isRouteDetectionSetup(){return this.isSetup}syncUrl(){const t=window.location.href;t!==this.currentUrl&&(this.currentUrl=t)}cleanup(){this.isSetup=!1}}class n{constructor(t){this.sdk=t,this.sendQueue=[],this.batchTimer=null,this.maxBatchSize=3,this.batchTimeout=5e3,this.isProcessing=!1,this.createdViewSessions=new Set}sendViewData(t,e="completed"){if(!t||!this.sdk.sessionId)return;this.createdViewSessions.add(t.id);const i=this.formatViewPayload(t,e);this.shouldSendImmediately(e,t.type)?this.sendImmediate(i):this.queueForBatch(i)}formatViewPayload(t,e){return{session_id:this.sdk.sessionId,session_type:t.type,view_id:t.id,trigger:e,timestamp:t.timestamp,url:t.url,duration:t.duration,completion_reason:t.completionReason,web_vitals:this.formatWebVitals(t.webVitals,t.type),resources:t.resources||[],ajax_requests:t.ajaxRequests||[],errors:t.errors||[],events:t.events||[],meta:this.sdk.generateMetadata(),view_metadata:{start_time:t.startTime,last_activity:t.lastActivityTime,resource_count:t.resources?.length||0,ajax_count:t.ajaxRequests?.length||0,error_count:t.errors?.length||0,event_count:t.events?.length||0,web_vitals_count:Object.keys(t.webVitals).filter((e=>t.webVitals[e]?.value)).length},send_timestamp:Date.now(),send_strategy:this.shouldSendImmediately(e,t.type)?"immediate":"batch"}}formatWebVitals(t,e){const i={},s=["LCP","FCP","FID","TTFB"];return Object.keys(t).forEach((n=>{if(null!=t[n]?.value){if("route_change"===e&&s.includes(n))return;i[n]={value:t[n].value,timestamp:t[n].timestamp,view_relative_time:t[n].viewRelativeTime,...t[n]}}})),i}shouldSendImmediately(t,e){return"new_view_started"===t&&"route_change"===e||"route_change_trigger"===t||"page_unload"===t||"page_hidden"===t||"error"===t||"critical_error"===t}sendImmediate(t){this.performSend(t,{immediate:!0,sync:"page_unload"===t.trigger||"page_hidden"===t.trigger})}queueForBatch(t){this.sendQueue.push(t),this.sendQueue.length>=this.maxBatchSize?this.processBatchQueue():this.setBatchTimer()}setBatchTimer(){this.batchTimer&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout((()=>{this.processBatchQueue()}),this.batchTimeout)}processBatchQueue(){if(0===this.sendQueue.length||this.isProcessing)return;this.isProcessing=!0,this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);const t=[...this.sendQueue];this.sendQueue=[],t.forEach(((e,i)=>{setTimeout((()=>{this.performSend(e,{batch:!0,batchIndex:i,batchSize:t.length})}),100*i)})),setTimeout((()=>{this.isProcessing=!1}),100*t.length+500)}performSend(t,e={}){try{t.send_options={immediate:e.immediate||!1,sync:e.sync||!1,batch:e.batch||!1,batch_index:e.batchIndex,batch_size:e.batchSize},this.sdk.o("/api/optima/collect",t,{sync:e.sync,immediate:e.immediate})}catch(i){if(e.immediate&&!e.sync)try{this.sdk.o("/api/optima/collect",t,{sync:!0})}catch(t){}}}sendContinuousUpdate(t){if(!t||!this.sdk.sessionId)return;const e=this.sdk.viewManager?.currentView,i=this.createdViewSessions.has(t.view_id),s=e?.type||"initial",n={session_id:this.sdk.sessionId,session_type:s,view_id:t.view_id,type:"continuous_update",web_vitals:this.formatWebVitals(t.web_vitals||{},s),resources:t.resources||[],ajax_requests:t.ajax_requests||[],errors:t.errors||[],timestamp:t.timestamp,send_timestamp:Date.now(),is_update_only:i,meta:this.sdk.generateMetadata()};i||this.createdViewSessions.add(t.view_id),this.performSend(n,{immediate:!0,sync:!1})}forceFlush(){this.sendQueue.length>0&&(this.sendQueue.forEach((t=>{t.trigger="force_flush",this.performSend(t,{immediate:!0,sync:!0})})),this.sendQueue=[]),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null)}getQueueStatus(){return{queueLength:this.sendQueue.length,isProcessing:this.isProcessing,hasBatchTimer:!!this.batchTimer,maxBatchSize:this.maxBatchSize,batchTimeout:this.batchTimeout}}updateConfig(t){t.maxBatchSize&&(this.maxBatchSize=t.maxBatchSize),t.batchTimeout&&(this.batchTimeout=t.batchTimeout)}markViewCompleted(t){this.createdViewSessions.has(t)&&setTimeout((()=>{this.createdViewSessions.delete(t)}),3e4)}cleanup(){this.forceFlush(),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.createdViewSessions.clear(),this.isProcessing=!1}}class r{constructor(t,e){this.viewManager=t,this.dataSender=e,this.updateInterval=null,this.lastSentMetrics={},this.updateIntervalMs=1e4,this.isTracking=!1,this.significantChangeThresholds={CLS:.01,INP:50}}startContinuousTracking(){this.isTracking||(this.isTracking=!0,this.lastSentMetrics={},this.updateInterval=setInterval((()=>{this.checkAndSendUpdates()}),this.updateIntervalMs),this.setupChangeDetection())}stopContinuousTracking(){this.isTracking&&(this.isTracking=!1,this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this.lastSentMetrics={})}setupChangeDetection(){this.setupCLSChangeDetection(),this.setupINPChangeDetection()}setupCLSChangeDetection(){if("PerformanceObserver"in window)try{new PerformanceObserver((t=>{if(!this.isTracking||!this.viewManager.currentView?.isActive)return;const e=t.getEntries();let i=!1;e.forEach((t=>{t.hadRecentInput||(i=!0)})),i&&setTimeout((()=>{this.checkAndSendUpdates()}),1e3)})).observe({type:"layout-shift",buffered:!1})}catch(t){}}setupINPChangeDetection(){["click","keydown","pointerdown"].forEach((t=>{document.addEventListener(t,(()=>{this.isTracking&&this.viewManager.currentView?.isActive&&setTimeout((()=>{this.checkForINPUpdate()}),500)}),{passive:!0})}))}checkForINPUpdate(){if(!this.viewManager.currentView?.isActive)return;const t=this.viewManager.currentView.webVitals.INP?.value;t&&this.hasSignificantINPChange(t,this.lastSentMetrics.INP)&&this.sendContinuousUpdate()}checkAndSendUpdates(){if(!this.isTracking||!this.viewManager.currentView?.isActive)return;const t=this.getCurrentContinuousMetrics();this.hasSignificantChanges(t)&&this.sendContinuousUpdate()}getCurrentContinuousMetrics(){if(!this.viewManager.currentView)return{};const t=this.viewManager.currentView,e=t.webVitals,i="initial"===t.type,s={webVitals:{},resourceCount:t.resources?.length||0,ajaxCount:t.ajaxRequests?.length||0,errorCount:t.errors?.length||0};return["CLS","INP","loading_time"].forEach((t=>{s.webVitals[t]=e[t]?.value||null})),["LCP","FCP","FID","TTFB"].forEach(i?t=>{s.webVitals[t]=e[t]?.value||null}:t=>{s.webVitals[t]=null}),s}hasSignificantChanges(t){const e=this.lastSentMetrics;return!!this.hasSignificantWebVitalsChange(t.webVitals,e.webVitals)||!!this.hasSignificantDataChange(t,e)||!(0!==Object.keys(e).length||!this.hasAnyData(t))}hasSignificantWebVitalsChange(t,e={}){if(this.hasSignificantCLSChange(t.CLS,e.CLS))return!0;if(this.hasSignificantINPChange(t.INP,e.INP))return!0;const i=["LCP","FCP","FID","TTFB","loading_time"];for(const s of i)if(null!==t[s]&&null==e[s])return!0;return!1}hasSignificantDataChange(t,e={}){return t.resourceCount>(e.resourceCount||0)&&t.resourceCount-(e.resourceCount||0)>=5||t.ajaxCount>(e.ajaxCount||0)&&t.ajaxCount-(e.ajaxCount||0)>=3||t.errorCount>(e.errorCount||0)}hasAnyData(t){return Object.values(t.webVitals||{}).some((t=>null!==t))||t.resourceCount>0||t.ajaxCount>0||t.errorCount>0}hasSignificantCLSChange(t,e){return null!=t&&(null==e?t>0:Math.abs(t-e)>=this.significantChangeThresholds.CLS)}hasSignificantINPChange(t,e){return null!=t&&(null==e?t>0:Math.abs(t-e)>=this.significantChangeThresholds.INP)}sendContinuousUpdate(){if(!this.viewManager.currentView?.isActive)return;const t=this.getCurrentContinuousMetrics(),e=this.viewManager.currentView,i={view_id:e.id,web_vitals:{},resources:[],ajax_requests:[],errors:[],timestamp:Date.now()},s=["CLS","INP","loading_time"],n="initial"===e.type?[...s,"LCP","FCP","FID","TTFB"]:s;Object.entries({LCP:"LCP",FCP:"FCP",FID:"FID",CLS:"CLS",INP:"INP",TTFB:"TTFB",loading_time:"loading_time"}).forEach((([s,r])=>{n.includes(s)&&null!==t.webVitals[s]&&e.webVitals[s]&&(i.web_vitals[r]={value:t.webVitals[s],timestamp:e.webVitals[s].timestamp,view_relative_time:e.webVitals[s].viewRelativeTime,..."CLS"===s&&{lastShiftTime:e.webVitals[s].lastShiftTime,lastShiftValue:e.webVitals[s].lastShiftValue,shiftSource:e.webVitals[s].shiftSource,hadRecentInput:e.webVitals[s].hadRecentInput},..."INP"===s&&{interaction_type:e.webVitals[s].interactionType,target:e.webVitals[s].target,processing_time:e.webVitals[s].processingTime,input_delay:e.webVitals[s].inputDelay,manual:e.webVitals[s].manual},..."LCP"===s&&{element:e.webVitals[s].element,url:e.webVitals[s].url,absolute_time:e.webVitals[s].absoluteTime,attribution:e.webVitals[s].attribution,entry:e.webVitals[s].entry,source:e.webVitals[s].source},..."FID"===s&&{absolute_time:e.webVitals[s].absoluteTime,processing_time:e.webVitals[s].processingTime,interaction_type:e.webVitals[s].interactionType,target:e.webVitals[s].target,source:e.webVitals[s].source},..."FCP"===s&&{absolute_time:e.webVitals[s].absoluteTime,source:e.webVitals[s].source},..."TTFB"===s&&{domain_lookup:e.webVitals[s].domainLookup,connection:e.webVitals[s].connection,request:e.webVitals[s].request,tls:e.webVitals[s].tls}})}));const r=this.lastSentMetrics.resourceCount||0;e.resources&&e.resources.length>r&&(i.resources=e.resources.slice(r),i.resources.find((t=>t.name&&t.name.includes("releases.bundle.js")))||e.resources.find((t=>t.name&&t.name.includes("releases.bundle.js"))));const o=this.lastSentMetrics.ajaxCount||0;e.ajaxRequests&&e.ajaxRequests.length>o&&(i.ajax_requests=e.ajaxRequests.slice(o));const h=this.lastSentMetrics.errorCount||0;e.errors&&e.errors.length>h&&(i.errors=e.errors.slice(h)),this.dataSender.sendContinuousUpdate(i),this.lastSentMetrics={...t}}updateThresholds(t){void 0!==t.CLS&&(this.significantChangeThresholds.CLS=t.CLS),void 0!==t.INP&&(this.significantChangeThresholds.INP=t.INP)}updateInterval(t){this.updateIntervalMs=t,this.isTracking&&(this.stopContinuousTracking(),this.startContinuousTracking())}onWebVitalDetected(t,e){if(!this.isTracking||!this.viewManager.currentView?.isActive)return;const i="initial"===this.viewManager.currentView.type;["LCP","FCP","FID","TTFB"].includes(t)?i&&setTimeout((()=>{this.checkAndSendUpdates()}),100):["CLS","INP","loading_time"].includes(t)&&setTimeout((()=>{this.checkAndSendUpdates()}),100)}forceSendUpdate(){this.sendContinuousUpdate()}getStatus(){return{isTracking:this.isTracking,updateInterval:this.updateIntervalMs,lastSentMetrics:{...this.lastSentMetrics},thresholds:{...this.significantChangeThresholds},hasActiveView:!!this.viewManager.currentView?.isActive}}reset(){this.lastSentMetrics={}}cleanup(){this.stopContinuousTracking()}}class o{constructor(t){this.viewManager=t,this.processedUrls=new Set,this.resourceObserver=null,this.isObserving=!1,this.allDetectedResources=new Set,this.setupGlobalResourceTracking()}safeToFixed(t,e=2){return"number"!=typeof t||isNaN(t)?"0.00":t.toFixed(e)}setupGlobalResourceTracking(){}startCollecting(){this.viewManager.currentView&&(this.processedUrls.clear(),this.setupResourceObserver(),this.collectExistingResources())}stopCollecting(){this.resourceObserver&&this.isObserving&&(this.resourceObserver.disconnect(),this.isObserving=!1)}clearObservers(){this.stopCollecting()}setupResourceObserver(){if("PerformanceObserver"in window){this.resourceObserver&&this.isObserving&&this.resourceObserver.disconnect();try{this.resourceObserver=new PerformanceObserver((t=>{const e=t.getEntries();this.notifyLoadingTimeTracker(e),this.processResourceEntries(e)})),this.resourceObserver.observe({entryTypes:["resource"]}),this.isObserving=!0}catch(t){}}}notifyLoadingTimeTracker(t){const e=this.viewManager.webVitalsCollector;if(!e)return;if(!e.loadingTimeTracker)return;const i=e.loadingTimeTracker;i.isTracking&&!i.isComplete&&t.forEach((t=>{performance.timeOrigin+t.startTime>=i.baselineTime&&(i.pendingResources.add(t.name),i.recordActivity("resource"),setTimeout((()=>{i.pendingResources.delete(t.name)}),50))}))}collectExistingResources(){if(!this.viewManager.currentView)return;const t=this.viewManager.currentView,e="initial"===t.type,i=performance.getEntriesByType("resource");this.notifyLoadingTimeTrackerAboutExistingResources(i,e);const s=e?0:this.calculateRouteChangeFilterTime(t),n=[],r=[];i.forEach((i=>{if(e||i.startTime>=s){const e=this.processResourceEntry(i,t);e&&this.viewManager.addResource(e)&&n.push({name:this.truncateUrl(i.name,50),startTime:i.startTime.toFixed(2),type:i.initiatorType||"unknown",size:i.transferSize||0})}else r.push({name:this.truncateUrl(i.name,50),startTime:i.startTime.toFixed(2),timeDiff:(i.startTime-s).toFixed(2),type:i.initiatorType||"unknown"})}))}notifyLoadingTimeTrackerAboutExistingResources(t,e){const i=this.viewManager.webVitalsCollector;if(!i)return;if(!i.loadingTimeTracker)return;const s=i.loadingTimeTracker;s.isTracking&&!s.isComplete&&t.forEach((t=>{performance.timeOrigin+t.startTime>=s.baselineTime&&(s.pendingResources.add(t.name),s.recordActivity("resource"),setTimeout((()=>{s.pendingResources.delete(t.name)}),50))}))}truncateUrl(t,e=50){return!t||t.length<=e?t:t.substring(0,e-3)+"..."}calculateRouteChangeFilterTime(t){const e=t.routeTriggerTime,i=t.interactionBaseline;return e&&"number"==typeof e?e:i&&"number"==typeof i?i:t.startTime}processResourceEntry(t,e){try{if(this.processedUrls.has(t.name))return null;if(!this.shouldCollectResource(t))return null;const i="initial"===e.type;let s=0;i||(s=this.calculateRouteChangeFilterTime(e));const n=this.extractFullResourceData(t,s,i);return this.processedUrls.add(t.name),n}catch(t){return null}}processResourceEntries(t){if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const e=this.viewManager.currentView,i="initial"===e.type;let s=0;i||(s=e.interactionBaseline?e.interactionBaseline:e.routeTriggerTime||e.startTime),t.forEach(((t,e)=>{const n=t.name;if(n.toLowerCase().includes(".js"),n.includes("bundle")||n.includes("chunk"),!this.processedUrls.has(t.name)&&(i||!(t.startTime<s))&&this.shouldCollectResource(t))try{const e=this.extractFullResourceData(t,s,i);if(this.viewManager.addResource(e),this.isAjaxRequest(t)){const i=this.convertToAjaxData(e,t);this.viewManager.addAjaxRequest(i)}this.processedUrls.add(t.name)}catch(t){}}))}extractFullResourceData(t,e,i){let s;s=i?t.startTime:t.startTime-e;const n=Math.round(t.domainLookupEnd-t.domainLookupStart),r=t.secureConnectionStart?Math.round(t.connectEnd-t.secureConnectionStart):0,o=Math.round(t.connectEnd-t.connectStart),h=Math.round(t.responseStart-t.requestStart),a=Math.round(t.responseEnd-t.responseStart),c=Math.round(t.duration),u=this.getResourceType(t),l=this.getCacheStatus(t);return{name:t.name,size:t.transferSize||0,ttfb:h,type:u,timing:{dns:n,tls:r,request:h,response:a,connection:o},dnsTime:n,tlsTime:r,dns_time:n,tls_time:r,duration:c,downloadTime:a,download_time:a,connectionTime:o,connection_time:o,start_time:Math.round(s),cacheStatus:l,cache_status:l,decoded_size:t.decodedBodySize||0,encoded_size:t.encodedBodySize||0,transfer_size:t.transferSize||0,connect_end:Math.round(t.connectEnd),connect_start:Math.round(t.connectStart),fetch_start:Math.round(t.fetchStart),response_end:Math.round(t.responseEnd),response_start:Math.round(t.responseStart),request_start:Math.round(t.requestStart),domain_lookup_end:Math.round(t.domainLookupEnd),domain_lookup_start:Math.round(t.domainLookupStart),secure_connection_start:Math.round(t.secureConnectionStart||0),next_hop_protocol:t.nextHopProtocol||"unknown",initiator_type:t.initiatorType||"other",viewId:this.viewManager.currentView.id,viewType:this.viewManager.currentView.type,view_relative_timing:!0,debug_info:{original_start_time:t.startTime,filter_time:e,is_initial_load:i,calculation_method:i?"absolute_from_navigation":"relative_from_filter"}}}isAjaxRequest(t){if("xmlhttprequest"===t.initiatorType||"fetch"===t.initiatorType)return!0;if(!0===t.is_ajax)return!0;const e=t.name.toLowerCase();return!(e.endsWith(".js")||e.endsWith(".css")||e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif")||e.endsWith(".svg")||e.endsWith(".woff")||e.endsWith(".woff2")||e.endsWith(".ttf")||e.endsWith(".ico")||!(e.includes("/api/")||e.includes("/ajax/")||e.includes("/graphql")))}convertToAjaxData(t,e){return{type:"xmlhttprequest"===e.initiatorType?"xhr":"fetch",method:"GET",method_inferred:!0,url:t.name,status:200,statusText:"OK",startTime:t.start_time,duration:t.duration,async:!0,requestPayloadSize:0,responseSize:t.transfer_size,aborted:!1,errored:!1,timedOut:!1,timestamp:Date.now(),resourceTiming:{startTime:t.start_time,duration:t.duration,domainLookupTime:t.dnsTime,connectTime:t.connectionTime,tlsTime:t.tlsTime,requestStartTime:t.request_start,ttfb:t.ttfb,downloadTime:t.downloadTime,entryType:"resource",initiatorType:e.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":""+t.transfer_size,"cache-control":"unknown"},viewId:this.viewManager.currentView.id,viewType:this.viewManager.currentView.type}}getResourceType(t){const e=t.name.toLowerCase();return"img"===t.initiatorType?"image":"script"===t.initiatorType?"script":"link"===t.initiatorType?"stylesheet":"xmlhttprequest"===t.initiatorType?"xhr":"fetch"===t.initiatorType?"fetch":e.endsWith(".js")?"script":e.endsWith(".css")?"stylesheet":e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif")||e.endsWith(".svg")||e.endsWith(".webp")?"image":e.endsWith(".woff")||e.endsWith(".woff2")||e.endsWith(".ttf")?"font":e.endsWith(".mp4")||e.endsWith(".webm")||e.endsWith(".ogg")?"media":"other"}getCacheStatus(t){return 0===t.transferSize&&t.encodedBodySize>0?"cache":t.transferSize>0?"network":0===t.transferSize&&0===t.encodedBodySize?"unknown":"network"}shouldCollectResource(t){const e=t.name;return!["/api/optima/","analytics.google.com","analytics.twitter.com","api.cr-relay.com","api.getkoala.com","api.segment.io","api.vector.co","app.clearbit.com","bam-cell.nr-data.net","browser-intake-us5-datadoghq.com","browser.sentry-cdn.com","c.6sc.co","cdn.cr-relay.com","cdn.debugbear.com","cdn.getkoala.com","cdn.heapanalytics.com","cdn.jsdelivr.net","cdn.segment.com","cdn.vector.co","d-code.liadm.com","data.debugbear.com","googleads.g.doubleclick.net","i.liadm.com","idx.liadm.com","ipv6.6sc.co","j.6sc.co","js-agent.newrelic.com","pro.ip-api.com","px.ads.linkedin.com","rp.liadm.com","secure.gravatar.com","snap.licdn.com","stats.g.doubleclick.net","tag.clearbitscripts.com","unpkg.com","widget.intercom.io","www.datadoghq-browser-agent.com","www.google-analytics.com","www.google.com","www.googleadservices.com","www.googletagmanager.com","x.clearbitjs.com"].find((t=>e.includes(t)))&&!e.startsWith("data:")&&!e.startsWith("blob:")}getProcessedCount(){return this.processedUrls.size}reset(){this.processedUrls.clear(),this.resourceObserver&&this.isObserving&&(this.resourceObserver.disconnect(),this.isObserving=!1)}getDebugInfo(){const t=performance.getEntriesByType("resource");return{totalDetected:t.length,totalProcessed:this.processedUrls.size,jsFiles:t.filter((t=>t.name.toLowerCase().includes(".js"))).length,bundleFiles:t.filter((t=>t.name.includes("bundle")||t.name.includes("chunk"))).length,processedUrls:Array.from(this.processedUrls)}}}function h(t){if(!t||!t.previousRect||!t.currentRect)return 0;const e=t.previousRect,i=t.currentRect,s=Math.abs(e.x-i.x),n=Math.abs(e.y-i.y);return Math.sqrt(s*s+n*n)*(Math.max(e.width*e.height,i.width*i.height)/(window.innerWidth*window.innerHeight))}function a(t){return t?{x:Math.round(t.x),y:Math.round(t.y),width:Math.round(t.width),height:Math.round(t.height),top:Math.round(t.top),right:Math.round(t.right),bottom:Math.round(t.bottom),left:Math.round(t.left)}:null}function c(t){if(!t)return null;const e=[];let i=t;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let t=i.tagName.toLowerCase();if(i.id){t+="#"+i.id,e.unshift(t);break}if(i.className&&"string"==typeof i.className){const e=i.className.trim().split(/\s+/);e.length>0&&""!==e[0]&&(t+="."+e.join("."))}let s=i,n=1;for(;s=s.previousElementSibling;)n++;if(n>1&&(t+=`:nth-child(${n})`),e.unshift(t),"body"===i.tagName.toLowerCase()||e.length>=5)break;i=i.parentNode}return e.join(" > ")}function u(t){if(!t)return null;const e=[];let i=t;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let t=i.tagName.toLowerCase();if(i.id&&(t=`${t}#${i.id}`),e.unshift(t),"body"===i.tagName.toLowerCase()||e.length>=5)break;i=i.parentNode}return e.join(" > ")}function l(t){if(!t||!t.textContent)return null;const e=t.textContent.trim().replace(/\s+/g," ");return e.length>60?e.substring(0,60)+"...":e}function d(t){if(!t||!t.attributes)return{};const e={},i=["src","href","alt","title","aria-label","role","data-testid"];i.forEach((i=>{t.hasAttribute(i)&&(e[i]=t.getAttribute(i))}));for(let s=0;s<t.attributes.length;s++){const n=t.attributes[s];n.name.startsWith("data-")&&!i.includes(n.name)&&(e[n.name]=n.value)}return e}function m(t){if(!t||!t.previousRect||!t.currentRect)return"unknown";const e=t.previousRect,i=t.currentRect;if(0===e.width&&0===e.height&&(i.width>0||i.height>0))return"appeared";if(0===i.width&&0===i.height&&(e.width>0||e.height>0))return"disappeared";const s=Math.abs(e.width-i.width)>1||Math.abs(e.height-i.height)>1,n=Math.abs(e.x-i.x)>1||Math.abs(e.y-i.y)>1;return s&&n?"resize-and-move":s?"resize":n?"move":"unknown"}function f(t){if(!t||!window.getComputedStyle)return!1;try{const e=window.getComputedStyle(t);return"0s"!==e.transitionDuration||"none"!==e.animationName||t.classList.contains("animate")||t.classList.contains("fade")||t.classList.contains("slide")}catch(t){return!1}}class p{constructor(t){this.viewManager=t,this.observers=new Map,this.continuousMetrics=["CLS","INP"],this.initialOnlyMetrics=["LCP","FID","FCP","TTFB"],this.isSetup=!1,this.loadingTimeTracker=null}startCollecting(t){this.viewManager.currentView&&(this.clearObservers(),"initial"===t?this.setupAllMetrics():this.setupRouteChangeMetrics(),this.isSetup=!0)}setupAllMetrics(){this.setupLCP(),this.setupFID(),this.setupFCP(),this.setupTTFB(),this.setupCLS(),this.setupINP(),this.setupLoadingTime()}setupRouteChangeMetrics(){this.setupCLS(),this.setupINP(),this.setupLoadingTime()}setupLCP(){if("PerformanceObserver"in window&&"initial"===this.viewManager.currentView.type)try{const t=this.viewManager.currentView.startTime,e=this.viewManager.currentView;let i=0;const s=new PerformanceObserver((s=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const n=s.getEntries();if(0===n.length)return;const r=n[n.length-1],o="initial"===e.type;if(!o&&r.startTime<t)return;let h;if(h=o?r.startTime:r.startTime-t,r.startTime>i){i=r.startTime;const e=this.extractLCPElementInfo(r),s=this.calculateLCPAttribution(r,t);this.viewManager.updateWebVital("LCP",h,{absoluteTime:r.startTime,element:e,attribution:s,entry:{id:r.id,size:r.size,loadTime:r.loadTime,renderTime:r.renderTime}})}}));s.observe({type:"largest-contentful-paint",buffered:"initial"===e.type}),this.observers.set("LCP",s),setTimeout((()=>{if(0===i){const i=performance.getEntriesByType("largest-contentful-paint");if(i.length>0){const s=i[i.length-1];let n;if(n="initial"===e.type?s.startTime:Math.max(0,s.startTime-t),n>=0){const e=this.extractLCPElementInfo(s),i=this.calculateLCPAttribution(s,t);this.viewManager.updateWebVital("LCP",n,{absoluteTime:s.startTime,element:e,attribution:i,entry:{id:s.id,size:s.size,loadTime:s.loadTime,renderTime:s.renderTime},source:"fallback"})}}}}),100)}catch(t){}}setupFID(){if(!("PerformanceObserver"in window))return;const t=this.viewManager.currentView;if("initial"===t.type)try{let e=!1;const i=new PerformanceObserver((t=>{this.viewManager.currentView&&this.viewManager.currentView.isActive&&t.getEntries().forEach((t=>{e||(this.viewManager.updateWebVital("FID",t.processingStart-t.startTime,{absoluteTime:t.startTime,viewRelativeTime:t.startTime,processingTime:t.processingEnd-t.processingStart,interactionType:t.name,target:t.target?this.getElementInfo(t.target):null}),e=!0)}))}));i.observe({type:"first-input",buffered:"initial"===t.type}),this.observers.set("FID",i),setTimeout((()=>{if(!e){const t=performance.getEntriesByType("first-input");if(t.length>0){const i=t[0];this.viewManager.updateWebVital("FID",i.processingStart-i.startTime,{absoluteTime:i.startTime,viewRelativeTime:i.startTime,processingTime:i.processingEnd-i.processingStart,interactionType:i.name,target:i.target?this.getElementInfo(i.target):null,source:"fallback"}),e=!0}}}),1e3)}catch(t){}}setupFCP(){if(!("PerformanceObserver"in window))return;const t=this.viewManager.currentView;if("initial"===t.type)try{let e=!1;const i=new PerformanceObserver((t=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const i=t.getEntries().find((t=>"first-contentful-paint"===t.name));i&&!e&&(this.viewManager.updateWebVital("FCP",i.startTime,{absoluteTime:i.startTime}),e=!0)}));i.observe({type:"paint",buffered:"initial"===t.type}),this.observers.set("FCP",i),setTimeout((()=>{if(!e){const t=performance.getEntriesByType("paint").find((t=>"first-contentful-paint"===t.name));t&&(this.viewManager.updateWebVital("FCP",t.startTime,{absoluteTime:t.startTime,source:"fallback"}),e=!0)}}),1e3)}catch(t){}}setupTTFB(){if("initial"===this.viewManager.currentView.type)try{const t=performance.getEntriesByType("navigation")[0];if(!t)return;this.viewManager.updateWebVital("TTFB",t.responseStart-t.requestStart,{domainLookup:t.domainLookupEnd-t.domainLookupStart,connection:t.connectEnd-t.connectStart,request:t.responseStart-t.requestStart,tls:t.secureConnectionStart?t.connectEnd-t.secureConnectionStart:0})}catch(t){}}setupCLS(){if("PerformanceObserver"in window)try{const t=this.viewManager.currentView.startTime;let e=0;const i=new PerformanceObserver((i=>{this.viewManager.currentView&&this.viewManager.currentView.isActive&&i.getEntries().forEach((i=>{if(i.startTime>=t&&!i.hadRecentInput){e+=i.value;const s=function(t){if(!t||!t.sources||0===t.sources.length)return null;try{const e=t.sources.reduce(((t,e)=>{try{return(e.impactValue||h(e))>(t.impactValue||h(t))?e:t}catch(e){return t}}),t.sources[0]);if(!e)return null;const i=e.node;return i?{tagName:i.tagName||"UNKNOWN",id:i.id||null,className:"string"==typeof i.className?i.className:null,cssPath:c(i),domPath:u(i),textContent:l(i),attributes:d(i),previousRect:a(e.previousRect),currentRect:a(e.currentRect),impactValue:e.impactValue||h(e),shiftType:m(e),isAnimating:f(i),isImage:"IMG"===i.tagName,isIframe:"IFRAME"===i.tagName,isVideo:"VIDEO"===i.tagName}:{previousRect:a(e.previousRect),currentRect:a(e.currentRect),impactValue:e.impactValue||h(e),nodeLost:!0,shiftType:m(e)}}catch(t){return null}}(i);this.viewManager.updateWebVital("CLS",e,{lastShiftTime:i.startTime-t,lastShiftValue:i.value,shiftSource:s,hadRecentInput:i.hadRecentInput})}}))}));i.observe({type:"layout-shift",buffered:"initial"===this.viewManager.currentView.type}),this.observers.set("CLS",i)}catch(t){}}setupINP(){try{const t=this.viewManager.currentView.startTime;let e=0;if(["click","keydown","pointerdown"].forEach((e=>{document.addEventListener(e,(e=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const i=performance.now();i<t||this.measureInteraction(e,i-t)}),{passive:!0,capture:!0})})),"PerformanceObserver"in window&&PerformanceObserver.supportedEntryTypes?.includes("event")){const i=new PerformanceObserver((i=>{this.viewManager.currentView&&this.viewManager.currentView.isActive&&i.getEntries().forEach((i=>{if(i.startTime>=t){const s=i.processingEnd-i.startTime,n=i.target?this.getElementInfo(i.target):null;s>e&&(e=s,this.viewManager.updateWebVital("INP",s,{viewRelativeTime:i.startTime-t,interactionType:i.name,target:n,processingTime:i.processingEnd-i.processingStart,inputDelay:i.processingStart-i.startTime}))}}))}));i.observe({type:"event",buffered:"initial"===this.viewManager.currentView.type}),this.observers.set("INP",i)}}catch(t){}}setupLoadingTime(){try{this.loadingTimeTracker&&this.loadingTimeTracker.cleanup(),this.loadingTimeTracker=new w(this.viewManager),this.loadingTimeTracker.start()}catch(t){}}measureInteraction(t,e){const i=performance.now(),s=this.getElementInfo(t.target);requestAnimationFrame((()=>{const n=performance.now()-i;n>(this.viewManager.currentView?.webVitals?.INP?.value||0)&&this.viewManager.updateWebVital("INP",n,{viewRelativeTime:e,interactionType:t.type,target:s,manual:!0})}))}extractLCPElementInfo(t){try{return t.element?{tagName:t.element.tagName,id:t.element.id||null,className:t.element.className||null,src:t.element.src||t.element.currentSrc||null,url:t.url||null,size:t.size||0}:null}catch(t){return null}}calculateLCPAttribution(t,e){try{const i=performance.getEntriesByType("navigation")[0];return i?{ttfb:Math.round(i.responseStart-i.requestStart),resourceLoadDelay:Math.round(Math.max(0,t.loadTime-i.responseStart)),resourceLoadDuration:Math.round(Math.max(0,t.loadTime-t.startTime)),elementRenderDelay:Math.round(t.startTime-e)}:null}catch(t){return null}}getElementInfo(t){if(!t)return null;try{const e={tagName:t.tagName,id:t.id||null,className:t.className||null,textContent:t.textContent?.substring(0,100)||null,type:t.type||null,name:t.name||null,href:t.href||null,role:t.getAttribute("role")||null};if(t.closest){const i=t.closest("button"),s=t.closest("a"),n=t.closest("form");i&&i!==t&&(e.parentButton={id:i.id||null,className:i.className||null,textContent:i.textContent?.substring(0,50)||null}),s&&s!==t&&(e.parentLink={href:s.href||null,textContent:s.textContent?.substring(0,50)||null}),n&&n!==t&&(e.parentForm={id:n.id||null,name:n.name||null,action:n.action||null})}return e}catch(t){return{error:t.message}}}clearObservers(){this.observers.forEach(((t,e)=>{try{t.disconnect()}catch(t){}})),this.observers.clear()}stopCollecting(){this.clearObservers(),this.loadingTimeTracker&&(this.loadingTimeTracker.cleanup(),this.loadingTimeTracker=null),this.isSetup=!1}reset(){this.stopCollecting()}}class w{constructor(t){this.viewManager=t,this.startTime=null,this.lastActivityTime=null,this.isComplete=!1,this.isTracking=!1,this.activitySources=new Set,this.quietPeriod=100,this.maxWaitTime=1e4,this.checkInterval=null,this.observers=[],this.pendingRequests=new Set,this.pendingResources=new Set,this.viewType=null,this.baselineTime=null,this.originalXHROpen=null,this.originalXHRSend=null,this.originalFetch=null}start(){if(!this.viewManager.currentView)return;const t=this.viewManager.currentView;if(this.viewType=t.type,this.isTracking=!0,"initial"===this.viewType)try{const t=performance.getEntriesByType("navigation")[0];this.baselineTime=t?performance.timeOrigin+t.fetchStart:performance.timeOrigin}catch(t){this.baselineTime=performance.timeOrigin}else{const e=t.routeTriggerTime;this.baselineTime=e&&"number"==typeof e?performance.timeOrigin+e:performance.timeOrigin+performance.now()}this.startTime=this.baselineTime,this.lastActivityTime=this.baselineTime,this.setupResourceObserver(),this.setupXHRMonitoring(),this.setupFetchMonitoring(),this.setupMutationObserver(),this.startCompletionCheck(),setTimeout((()=>{this.isComplete||this.complete("timeout")}),"initial"===this.viewType?this.maxWaitTime:1e4)}recordActivity(t){if(this.isComplete||!this.isTracking)return;const e=performance.timeOrigin+performance.now();this.lastActivityTime=e,this.activitySources.add(t),this.checkInterval&&clearTimeout(this.checkInterval),this.startCompletionCheck()}setupResourceObserver(){if(window.PerformanceObserver&&window.PerformanceObserver.supportedEntryTypes&&window.PerformanceObserver.supportedEntryTypes.includes("resource"))try{const t=new PerformanceObserver((t=>{!this.isComplete&&this.isTracking&&t.getEntries().forEach((t=>{performance.timeOrigin+t.startTime>=this.baselineTime&&(this.pendingResources.add(t.name),this.recordActivity("resource"),setTimeout((()=>{this.pendingResources.delete(t.name)}),50))}))}));t.observe({type:"resource",buffered:!1}),this.observers.push(t)}catch(t){}}setupXHRMonitoring(){if(!window.XMLHttpRequest)return;this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send;const t=this;XMLHttpRequest.prototype.open=function(e,i,s){return this.h=i,this.u=performance.now(),t.originalXHROpen.apply(this,arguments)},XMLHttpRequest.prototype.send=function(e){if(t.isComplete||!t.isTracking)return t.originalXHRSend.apply(this,arguments);const i=`xhr_${this.h}_${this.u}`;t.pendingRequests.add(i),t.recordActivity("xhr");const s=()=>{t.pendingRequests.delete(i)};return this.addEventListener("loadend",s),this.addEventListener("error",s),this.addEventListener("abort",s),t.originalXHRSend.apply(this,arguments)}}setupFetchMonitoring(){if(!window.fetch)return;this.originalFetch=window.fetch;const t=this;window.fetch=function(e,i){if(t.isComplete||!t.isTracking)return t.originalFetch.apply(this,arguments);const s=`fetch_${"string"==typeof e?e:e.url}_${performance.now()}`;return t.pendingRequests.add(s),t.recordActivity("fetch"),t.originalFetch.apply(this,arguments).finally((()=>{t.pendingRequests.delete(s)}))}}setupMutationObserver(){if(window.MutationObserver)try{const t=new MutationObserver((t=>{!this.isComplete&&this.isTracking&&t.filter((t=>("attributes"!==t.type||!["style","class"].includes(t.attributeName))&&"childList"===t.type&&(t.addedNodes.length>0||t.removedNodes.length>0))).length>0&&this.recordActivity("dom_mutation")}));t.observe(document.body||document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href","data-src"]}),this.observers.push(t)}catch(t){}}setupLoadEventFallback(){"initial"===this.viewType&&("complete"===document.readyState?setTimeout((()=>{this.isComplete||this.complete("load_event_already_complete")}),100):window.addEventListener("load",(()=>{setTimeout((()=>{this.isComplete||this.complete("load_event")}),200)})))}startCompletionCheck(){this.checkInterval=setTimeout((()=>{this.checkForCompletion()}),this.quietPeriod)}checkForCompletion(){if(this.isComplete||!this.isTracking)return;const t=performance.timeOrigin+performance.now(),e=t-this.lastActivityTime,i=t-this.baselineTime,s=this.pendingRequests.size>0||this.pendingResources.size>0;if("initial"===this.viewType){const t=i>=8e3;if(e>=this.quietPeriod&&!s||t)return void this.complete(t?"max_time_reached":"activity_quiet")}else{const t=i>=1e4;if(e>=this.quietPeriod&&!s)return void this.complete("activity_quiet");if(t)return void this.complete("route_change_timeout")}this.startCompletionCheck()}complete(t){if(this.isComplete)return;this.isComplete=!0,this.isTracking=!1;const e=this.lastActivityTime,i=Math.round(e-this.baselineTime);Array.from(this.activitySources).join(", ");const s=Array.from(this.activitySources);this.cleanup(),this.viewManager.updateWebVital("loading_time",i,{reason:t,activitySources:s,viewType:this.viewType,baselineTime:this.baselineTime,endTime:e,pendingRequestsCount:this.pendingRequests.size,pendingResourcesCount:this.pendingResources.size})}cleanup(){this.checkInterval&&(clearTimeout(this.checkInterval),this.checkInterval=null),this.observers.forEach((t=>{t.disconnect&&t.disconnect()})),this.observers=[],this.originalXHROpen&&(XMLHttpRequest.prototype.open=this.originalXHROpen),this.originalXHRSend&&(XMLHttpRequest.prototype.send=this.originalXHRSend),this.originalFetch&&(window.fetch=this.originalFetch),this.pendingRequests.clear(),this.pendingResources.clear(),this.activitySources.clear()}}function g(t,e,i,s){const n=`${t}:${e}:${i}:${s?s.substring(0,150):""}`;let r=0;for(let t=0;t<n.length;t++)r=(r<<5)-r+n.charCodeAt(t),r|=0;return"err_"+Math.abs(r).toString(16)}function y(t,e){(function(t,e){return t.buffer.errors.length<5||!t.buffer.errors.some((t=>t.error_id&&e.error_id?t.error_id===e.error_id:t.type===e.type&&t.message===e.message&&t.source===e.source&&t.stack===e.stack))&&!t.buffer.errors.slice(-5).some((t=>t.message===e.message&&t.source===e.source&&e.timestamp-t.timestamp<100))})(t,e)&&(t.buffer.errors.push(e),t.viewManager&&t.viewManager.currentView&&t.viewManager.addError(e),t.buffer.errors.length>=5&&v(t))}function v(t){t.buffer.errors&&0!==t.buffer.errors.length&&(t.viewManager&&t.dataSender?t.buffer.errors=[]:t.unifiedDataModel?(t.unifiedDataModel.errors||(t.unifiedDataModel.errors=[]),t.unifiedDataModel.errors=[...t.unifiedDataModel.errors,...t.buffer.errors],t.buffer.errors=[],t.l&&t.l(!1)):t.buffer.errors=[])}const _={sessionId:null,apiKey:null,disabled:!1,version:"2.0.0-view-based",viewManager:null,routeDetector:null,dataSender:null,continuousMetrics:null,resourceCollector:null,webVitalsCollector:null,isInitialized:!1,initializationTime:null,visibilityChangeCount:0,config:{apiKey:null,endpoint:null,sampleRate:100,flushInterval:5e3,webVitalsBatchDelay:2e3,batchBeforeSend:!0,maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,payloadCompressionThreshold:10240,enableRouteChangeTracking:!0,enableContinuousMetrics:!0,batchSize:3,batchTimeout:5e3,continuousMetricsInterval:1e4,debug:!1,disabled:!1},init:function(t={}){this.isInitialized||(this.initializationTime=Date.now(),this.applyConfiguration(t),this.config.apiKey?this.config.disabled?this.disabled=!0:(this.initializeSession(),this.initializeViewBasedArchitecture(),this.setupErrorMonitoring(),this.setupPageLifecycleEvents(),this.startInitialView(),this.isInitialized=!0,this.sendEvent("sdk_initialized",{version:this.version,architecture:"view_based",config:this.config})):this.disabled=!0)},applyConfiguration:function(t){this.config={...this.config,...t},"number"==typeof this.config.sampleRate&&(this.config.sampleRate=Math.min(Math.max(this.config.sampleRate,1),100)),this.apiKey=this.config.apiKey,this.endpoint=this.config.endpoint,this.sampleRate=this.config.sampleRate,this.shouldTrackSession(this.config.sampleRate)||(this.config.disabled=!0)},initializeSession:function(){this.sessionId=e()},initializeViewBasedArchitecture:function(){this.viewManager=new i(this),this.config.enableRouteChangeTracking&&(this.routeDetector=new s(this.viewManager),this.routeDetector.setupRouteDetection()),this.dataSender=new n(this),this.dataSender.updateConfig({maxBatchSize:this.config.batchSize,batchTimeout:this.config.batchTimeout,flushInterval:this.config.flushInterval,webVitalsBatchDelay:this.config.webVitalsBatchDelay,batchBeforeSend:this.config.batchBeforeSend,maxEventsPerBatch:this.config.maxEventsPerBatch,maxResourcesPerBatch:this.config.maxResourcesPerBatch,maxWebVitalsPerBatch:this.config.maxWebVitalsPerBatch,maxAjaxCallsPerBatch:this.config.maxAjaxCallsPerBatch,payloadCompressionThreshold:this.config.payloadCompressionThreshold}),this.config.enableContinuousMetrics&&(this.continuousMetrics=new r(this.viewManager,this.dataSender),this.config.continuousMetricsInterval&&this.continuousMetrics.updateInterval&&this.continuousMetrics.updateInterval(this.config.continuousMetricsInterval)),this.resourceCollector=new o(this.viewManager),this.webVitalsCollector=new p(this.viewManager),this.viewManager.webVitalsCollector=this.webVitalsCollector},shouldTrackSession:function(t){return t>=100||(t<=1?Math.random()<.01:100*Math.random()<t)},setupErrorMonitoring:function(){try{(t=this).buffer||(t.buffer={}),t.buffer.errors||(t.buffer.errors=[]),window.addEventListener("error",(e=>{!function(t,e){if(e)try{const i=e.error||Error(e.message||"Unknown error"),s=i.message||e.message||"Unknown error",n=e.filename||e.srcElement?.src||window.location.href,r=i.stack||null,o="error",h={type:o,message:s,source:n,lineno:e.lineno||0,colno:e.colno||0,stack:r,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:g(o,s,n,r)};y(t,h),v(t),t.sendEvent("error",{error_type:"uncaught_error",message:h.message,source:h.source,lineno:h.lineno,colno:h.colno})}catch(t){}}(t,e)}),!0),window.addEventListener("unhandledrejection",(e=>{!function(t,e){if(e&&e.reason)try{const i=e.reason,s=i instanceof Error?i.message:i+"",n=i instanceof Error?i.stack:null,r="unhandled_rejection",o="Promise",h={type:r,message:s,source:o,stack:n,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:g(r,s,o,n)};y(t,h),v(t),t.sendEvent("error",{error_type:"unhandled_rejection",message:h.message})}catch(t){}}(t,e)})),function(t){const e=console.error;console.error=function(...i){const s="console.error";try{const e=Error().stack||"",n=i.map((t=>{if(t instanceof Error)return t.message;if("object"!=typeof t)return t+"";try{return JSON.stringify(t)}catch(e){return t+""}})).join(" "),r="console_error",o={type:r,message:n,source:s,stack:e,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:g(r,n,s,e)};y(t,o)}catch(t){}e.apply(console,i)}}(t)}catch(t){}var t},setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{this.visibilityChangeCount++,"hidden"===document.visibilityState?this.handlePageHidden():"visible"===document.visibilityState&&this.handlePageVisible()})),window.addEventListener("beforeunload",(()=>{this.handlePageUnload()})),window.addEventListener("blur",(()=>{this.sendEvent("page_blur",{timestamp:Date.now()})})),window.addEventListener("focus",(()=>{this.sendEvent("page_focus",{timestamp:Date.now()})}))},startInitialView:function(){this.viewManager.startNewView("initial",window.location.href),this.continuousMetrics&&this.continuousMetrics.startContinuousTracking(),this.i=(t,e)=>{this.handleViewCompleted(t,e)}},startCollectorsForView:function(t){this.resourceCollector.startCollecting(),this.webVitalsCollector.startCollecting(t)},handleViewCompleted:function(t,e){this.dataSender.sendViewData(t,e),this.dataSender.markViewCompleted(t.id)},handlePageHidden:function(){this.sendEvent("page_hidden",{timestamp:Date.now()},{immediate:!0}),this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_hidden"),this.dataSender&&this.dataSender.forceFlush()},handlePageVisible:function(){this.sendEvent("page_visible",{timestamp:Date.now()})},handlePageUnload:function(){this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_unload"),this.dataSender&&this.dataSender.forceFlush(),this.continuousMetrics&&this.continuousMetrics.stopContinuousTracking()},sendEvent:function(t,e={},i={}){if(this.disabled||!this.sessionId)return;const s={name:t,data:e,timestamp:Date.now(),session_id:this.sessionId,url:window.location.href};this.viewManager?.currentView&&this.viewManager.addEvent(s),i.immediate&&this.o("/api/optima/events",s,{sync:!0})},triggerRouteChange:function(t){this.routeDetector&&this.routeDetector.triggerRouteChange(t,"manual")},getCurrentView:function(){return this.viewManager?.getCurrentViewData()||null},getViewHistory:function(){return this.viewManager?.getViewHistory()||[]},getStatus:function(){return{isInitialized:this.isInitialized,sessionId:this.sessionId,version:this.version,disabled:this.disabled,currentView:this.getCurrentView(),viewHistory:this.getViewHistory(),config:this.config,components:{viewManager:!!this.viewManager,routeDetector:!!this.routeDetector,dataSender:!!this.dataSender,continuousMetrics:!!this.continuousMetrics,resourceCollector:!!this.resourceCollector,webVitalsCollector:!!this.webVitalsCollector}}},updateConfig:function(t){this.config={...this.config,...t},this.dataSender&&(t.batchSize||t.batchTimeout)&&this.dataSender.updateConfig({maxBatchSize:t.batchSize,batchTimeout:t.batchTimeout}),this.continuousMetrics&&t.continuousMetricsInterval&&this.continuousMetrics.updateInterval(t.continuousMetricsInterval)},t:function(){this.webVitalsCollector&&this.webVitalsCollector.clearObservers(),this.resourceCollector&&"function"==typeof this.resourceCollector.clearObservers&&this.resourceCollector.clearObservers()},o:function(t,e,i={}){if(!this.disabled){e.api_key=this.apiKey,e.timestamp=e.timestamp||Date.now(),e.user_agent=navigator.userAgent;try{const s=`${this.endpoint||this.config.endpoint||"https://api.optima.com"}${t}`;if(i.sync&&navigator.sendBeacon){const t=new URL(s);t.searchParams.set("api_key",this.apiKey),navigator.sendBeacon(""+t,JSON.stringify(e))||this.m(s,e,{...i,sync:!0})}else this.m(s,e,i)}catch(t){}}},m:function(t,e,i={}){fetch(t,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(e),keepalive:i.sync}).then((t=>t)).catch((t=>{}))},cleanup:function(){this.viewManager?.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("sdk_cleanup"),this.dataSender&&this.dataSender.cleanup(),this.continuousMetrics&&this.continuousMetrics.cleanup(),this.resourceCollector&&this.resourceCollector.reset(),this.webVitalsCollector&&this.webVitalsCollector.reset(),this.routeDetector&&this.routeDetector.cleanup(),this.isInitialized=!1,this.sessionId=null},generateMetadata:function(){const t=performance.getEntriesByType("navigation")[0];return{url:window.location.href,path:window.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:window.screen.width,screen_height:window.screen.height,viewport_width:window.innerWidth,viewport_height:window.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,device_type:this.p(),page_visibility:document.visibilityState,visibility_changes:this.visibilityChangeCount||0,timestamp:Date.now(),browser:this.v(),os:this._(),navigation_type:t?.type||null,http_version:t?.nextHopProtocol||null,sdk_version:this.version,lastUpdated:Date.now(),city:"Unknown",region:"Unknown",country:"Unknown",countryCode:"XX",clientIP:null,isLocalIP:null}},v:function(){const t=navigator.userAgent;return t.includes("Chrome")&&!t.includes("Edg")?"Chrome":t.includes("Firefox")?"Firefox":t.includes("Safari")&&!t.includes("Chrome")?"Safari":t.includes("Edg")?"Edge":t.includes("Opera")||t.includes("OPR")?"Opera":"Unknown"},p:function(){const t=navigator.userAgent;return/iPad|iPhone|iPod/.test(t)&&!window.MSStream||/android/i.test(t)?"mobile":/Tablet|iPad/i.test(t)?"tablet":"desktop"},_:function(){const t=navigator.userAgent;return t.includes("Windows")?"Windows":t.includes("Mac OS")||t.includes("Macintosh")?"Mac OS":t.includes("Linux")?"Linux":t.includes("Android")?"Android":t.includes("iOS")||t.includes("iPhone")||t.includes("iPad")?"iOS":"Unknown"}};if("undefined"!=typeof window&&window.OptimaConfig&&_.init(window.OptimaConfig),"undefined"!=typeof window){const t=window.optima&&window.optima.q?[...window.optima.q]:[];window.optima=function(){const t=Array.prototype.slice.call(arguments),e=t[0];if("init"===e)if("string"==typeof t[1]){const e=t[2]||{};e.apiKey=t[1],_.init(e)}else _.init(t[1]||{});else if("track"===e)_.sendEvent(t[1],t[2],t[3]);else{if("getStatus"===e)return _.getStatus();"updateConfig"===e&&_.updateConfig(t[1])}},window.ViewBasedOptima=_,t.length>0&&t.forEach((t=>{try{window.optima.apply(window,t)}catch(t){}}))}return t.ViewBasedOptima=_,t.default=_,Object.defineProperty(t,"T",{value:!0}),t}({});
