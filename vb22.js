var optima=function(e){"use strict";function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}class i{constructor(e){this.sdk=e,this.currentView=null,this.viewHistory=[],this.viewStartTime=null,this.maxViewHistory=10,console.log("[Optima ViewManager] üèóÔ∏è ViewManager initialized")}createView(e,i,s){const n={id:t(),type:e,url:i,trigger:s,startTime:performance.now(),timestamp:Date.now(),duration:null,webVitals:{LCP:null,FID:null,CLS:null,FCP:null,INP:null,TTFB:null,loading_time:null},resources:[],ajaxRequests:[],errors:[],events:[],isCompleted:!1,isActive:!0,lastActivityTime:Date.now(),completionReason:null,collectorState:{resourcesCollected:!1,webVitalsSetup:!1,errorsSetup:!1,eventsSetup:!1}};return console.log(`[Optima ViewManager] üìã Created ${e} view: ${n.id.substring(0,8)}... for ${i}`),n}startNewView(e,t,i="unknown"){return console.log(`[Optima ViewManager] üîÑ Starting new ${e} view: ${t} (trigger: ${i})`),this.currentView&&!this.currentView.isCompleted&&this.completeView("new_view_started"),this.currentView=this.createView(e,t,i),this.viewStartTime=this.currentView.startTime,this.resetCollectors(),this.updateActivity(),console.log(`[Optima ViewManager] ‚úÖ Started new view: ${this.currentView.id.substring(0,8)}...`),this.currentView}completeView(e="manual"){this.currentView&&!this.currentView.isCompleted?(console.log(`[Optima ViewManager] üèÅ Completing view: ${this.currentView.id.substring(0,8)}... (reason: ${e})`),this.currentView.isCompleted=!0,this.currentView.isActive=!1,this.currentView.completionReason=e,this.currentView.duration=Date.now()-this.currentView.timestamp,this.logViewSummary(this.currentView),this.archiveView(this.currentView),this.sdk&&"function"==typeof this.sdk._onViewCompleted&&this.sdk._onViewCompleted(this.currentView,e),console.log(`[Optima ViewManager] ‚úÖ View completed: ${this.currentView.id.substring(0,8)}...`)):console.log("[Optima ViewManager] ‚ö†Ô∏è No active view to complete or already completed")}archiveView(e){this.viewHistory.push({...e,resources:e.resources.length,ajaxRequests:e.ajaxRequests.length,errors:e.errors.length,events:e.events.length}),this.viewHistory.length>this.maxViewHistory&&this.viewHistory.shift(),console.log(`[Optima ViewManager] üìö Archived view to history. Total views: ${this.viewHistory.length}`)}resetCollectors(){this.currentView&&(console.log("[Optima ViewManager] üîÑ Resetting collectors for new view"),this.currentView.collectorState={resourcesCollected:!1,webVitalsSetup:!1,errorsSetup:!1,eventsSetup:!1},this.sdk&&"function"==typeof this.sdk._resetPerformanceObservers&&this.sdk._resetPerformanceObservers(),this.sdk&&this.sdk.collectionState&&(this.sdk.collectionState.sentResourceURLs=new Set))}updateActivity(){this.currentView&&this.currentView.isActive&&(this.currentView.lastActivityTime=Date.now())}addResource(e){return this.currentView&&this.currentView.isActive?(e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.resources.push(e),this.updateActivity(),!0):(console.warn("[Optima ViewManager] ‚ö†Ô∏è No active view to add resource to"),!1)}addAjaxRequest(e){return this.currentView&&this.currentView.isActive?(e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.ajaxRequests.push(e),this.updateActivity(),!0):(console.warn("[Optima ViewManager] ‚ö†Ô∏è No active view to add AJAX request to"),!1)}addError(e){return this.currentView&&this.currentView.isActive?(e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.errors.push(e),this.updateActivity(),!0):(console.warn("[Optima ViewManager] ‚ö†Ô∏è No active view to add error to"),!1)}addEvent(e){return this.currentView&&this.currentView.isActive?(e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.events.push(e),this.updateActivity(),!0):(console.warn("[Optima ViewManager] ‚ö†Ô∏è No active view to add event to"),!1)}updateWebVital(e,t,i={}){return this.currentView&&this.currentView.isActive?(this.currentView.webVitals[e]={value:t,timestamp:Date.now(),viewRelativeTime:performance.now()-this.currentView.startTime,...i},this.updateActivity(),console.log(`[Optima ViewManager] üìä Updated ${e}: ${t} for view ${this.currentView.id.substring(0,8)}...`),!0):(console.warn("[Optima ViewManager] ‚ö†Ô∏è No active view to update web vital"),!1)}getCurrentViewData(){return this.currentView?{...this.currentView,resourceCount:this.currentView.resources.length,ajaxCount:this.currentView.ajaxRequests.length,errorCount:this.currentView.errors.length,eventCount:this.currentView.events.length}:null}logViewSummary(e){const t={id:e.id.substring(0,8)+"...",type:e.type,url:e.url,duration:e.duration,resources:e.resources.length,ajaxRequests:e.ajaxRequests.length,errors:e.errors.length,events:e.events.length,webVitals:Object.keys(e.webVitals).filter((t=>e.webVitals[t]?.value)).length};console.log("[Optima ViewManager] üìä View Summary:",t)}getViewHistory(){return this.viewHistory}isViewStale(e=3e4){if(!this.currentView||!this.currentView.isActive)return!1;return Date.now()-this.currentView.lastActivityTime>e}completeStaleView(){this.isViewStale()&&(console.log("[Optima ViewManager] ‚è∞ Completing stale view"),this.completeView("stale_timeout"))}}class s{constructor(e){this.viewManager=e,this.currentUrl=window.location.href,this.isSetup=!1,console.log("[Optima RouteDetector] üõ£Ô∏è Route detector initialized")}setupRouteDetection(){this.isSetup?console.warn("[Optima RouteDetector] ‚ö†Ô∏è Route detection already setup"):(console.log("[Optima RouteDetector] üîß Setting up route change detection"),this.patchHistoryAPI(),this.setupPopstateListener(),this.setupHashchangeListener(),this.setupMutationObserver(),this.isSetup=!0,console.log("[Optima RouteDetector] ‚úÖ Route detection setup complete"))}patchHistoryAPI(){const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{console.log("[Optima RouteDetector] üìç pushState detected:",t),e.apply(history,t),setTimeout((()=>{this.handleRouteChange("pushstate",window.location.href)}),10)},history.replaceState=(...e)=>{console.log("[Optima RouteDetector] üìç replaceState detected:",e),t.apply(history,e),setTimeout((()=>{this.handleRouteChange("replacestate",window.location.href)}),10)},console.log("[Optima RouteDetector] üîß History API patched")}setupPopstateListener(){window.addEventListener("popstate",(e=>{console.log("[Optima RouteDetector] ‚¨ÖÔ∏è popstate event:",e),setTimeout((()=>{this.handleRouteChange("popstate",window.location.href)}),10)})),console.log("[Optima RouteDetector] üîß Popstate listener setup")}setupHashchangeListener(){window.addEventListener("hashchange",(e=>{console.log("[Optima RouteDetector] #Ô∏è‚É£ hashchange event:",e),this.handleRouteChange("hashchange",window.location.href)})),console.log("[Optima RouteDetector] üîß Hashchange listener setup")}setupMutationObserver(){if(!("MutationObserver"in window))return void console.warn("[Optima RouteDetector] ‚ö†Ô∏è MutationObserver not supported");new MutationObserver((e=>{let t=!1;e.forEach((e=>{if("childList"===e.type&&e.addedNodes.length>0){Array.from(e.addedNodes).some((e=>e.nodeType===Node.ELEMENT_NODE&&("MAIN"===e.tagName||"SECTION"===e.tagName||"ARTICLE"===e.tagName||e.classList.contains("page")||e.classList.contains("view")||e.classList.contains("route"))))&&(t=!0)}})),t&&window.location.href!==this.currentUrl&&(console.log("[Optima RouteDetector] üîÑ Potential route change detected via DOM mutation"),setTimeout((()=>{this.handleRouteChange("mutation_observer",window.location.href)}),100))})).observe(document.body,{childList:!0,subtree:!0,attributes:!1}),console.log("[Optima RouteDetector] üîß Mutation observer setup")}handleRouteChange(e,t){if(t===this.currentUrl)return void console.log("[Optima RouteDetector] ‚ÑπÔ∏è URL unchanged, ignoring route change");if(!this.isMeaningfulRouteChange(this.currentUrl,t))return console.log("[Optima RouteDetector] ‚ÑπÔ∏è Non-meaningful route change, ignoring"),void(this.currentUrl=t);console.log(`[Optima RouteDetector] üîÑ Route change confirmed: ${e}`),console.log(`[Optima RouteDetector] üìç From: ${this.currentUrl}`),console.log(`[Optima RouteDetector] üìç To: ${t}`);const i=this.currentUrl;this.currentUrl=t;try{this.viewManager.startNewView("route_change",t,e),console.log("[Optima RouteDetector] ‚úÖ Route change processed successfully")}catch(e){console.error("[Optima RouteDetector] ‚ùå Error processing route change:",e),this.currentUrl=i}}isMeaningfulRouteChange(e,t){try{const i=new URL(e),s=new URL(t);if(i.origin!==s.origin)return!0;if(i.pathname!==s.pathname)return!0;if(i.hash!==s.hash&&(i.hash.length>1||s.hash.length>1))return!0;if(i.search!==s.search){const e=["page","view","tab","section","route","path"],t=new URLSearchParams(i.search),n=new URLSearchParams(s.search);for(const i of e)if(t.get(i)!==n.get(i))return!0}return!1}catch(e){return console.error("[Optima RouteDetector] ‚ùå Error parsing URLs for comparison:",e),!0}}triggerRouteChange(e,t="manual"){console.log(`[Optima RouteDetector] üîß Manual route change triggered: ${e}`),this.handleRouteChange(t,e)}getCurrentUrl(){return this.currentUrl}isRouteDetectionSetup(){return this.isSetup}syncUrl(){const e=window.location.href;e!==this.currentUrl&&(console.log("[Optima RouteDetector] üîÑ Syncing URL:",e),this.currentUrl=e)}cleanup(){console.log("[Optima RouteDetector] üßπ Cleaning up route detection"),this.isSetup=!1}}class n{constructor(e){this.sdk=e,this.sendQueue=[],this.batchTimer=null,this.maxBatchSize=3,this.batchTimeout=5e3,this.isProcessing=!1,this.createdViewSessions=new Set,console.log("[Optima DataSender] üì§ Data sender initialized")}sendViewData(e,t="completed"){if(!e||!this.sdk.sessionId)return void console.warn("[Optima DataSender] ‚ö†Ô∏è Cannot send view data: missing view or session");console.log(`[Optima DataSender] üì¶ Preparing to send view data: ${e.id.substring(0,8)}... (trigger: ${t})`),this.createdViewSessions.add(e.id);const i=this.formatViewPayload(e,t);this.shouldSendImmediately(t,e.type)?this.sendImmediate(i):this.queueForBatch(i)}formatViewPayload(e,t){return{session_id:this.sdk.sessionId,session_type:e.type,view_id:e.id,trigger:t,timestamp:e.timestamp,url:e.url,duration:e.duration,completion_reason:e.completionReason,web_vitals:this.formatWebVitals(e.webVitals),resources:e.resources||[],ajax_requests:e.ajaxRequests||[],errors:e.errors||[],events:e.events||[],view_metadata:{start_time:e.startTime,last_activity:e.lastActivityTime,resource_count:e.resources?.length||0,ajax_count:e.ajaxRequests?.length||0,error_count:e.errors?.length||0,event_count:e.events?.length||0,web_vitals_count:Object.keys(e.webVitals).filter((t=>e.webVitals[t]?.value)).length},sdk_version:this.sdk.version||"1.0.0",user_agent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},send_timestamp:Date.now(),send_strategy:this.shouldSendImmediately(t,e.type)?"immediate":"batch"}}formatWebVitals(e){const t={};return Object.keys(e).forEach((i=>{null!==e[i]?.value&&void 0!==e[i]?.value&&(t[i]={value:e[i].value,timestamp:e[i].timestamp,view_relative_time:e[i].viewRelativeTime,...e[i]})})),t}shouldSendImmediately(e,t){return"new_view_started"===e&&"route_change"===t||("route_change_trigger"===e||("page_unload"===e||"page_hidden"===e||("error"===e||"critical_error"===e)))}sendImmediate(e){console.log(`[Optima DataSender] üöÄ Sending immediately: ${e.view_id.substring(0,8)}...`),this.performSend(e,{immediate:!0,sync:"page_unload"===e.trigger||"page_hidden"===e.trigger})}queueForBatch(e){console.log(`[Optima DataSender] üìã Queuing for batch: ${e.view_id.substring(0,8)}...`),this.sendQueue.push(e),this.sendQueue.length>=this.maxBatchSize?this.processBatchQueue():this.setBatchTimer()}setBatchTimer(){this.batchTimer&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout((()=>{this.processBatchQueue()}),this.batchTimeout)}processBatchQueue(){if(0===this.sendQueue.length||this.isProcessing)return;console.log(`[Optima DataSender] üì¶ Processing batch queue: ${this.sendQueue.length} items`),this.isProcessing=!0,this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);const e=[...this.sendQueue];this.sendQueue=[],e.forEach(((t,i)=>{setTimeout((()=>{this.performSend(t,{batch:!0,batchIndex:i,batchSize:e.length})}),100*i)})),setTimeout((()=>{this.isProcessing=!1}),100*e.length+500)}performSend(e,t={}){try{e.send_options={immediate:t.immediate||!1,sync:t.sync||!1,batch:t.batch||!1,batch_index:t.batchIndex,batch_size:t.batchSize};const i=e.type||"view_completion",s=e.session_type||"unknown",n=t.immediate?"immediate":"batch";console.log(`[Optima DataSender] üì§ SENDING ${i.toUpperCase()}: view=${e.view_id.substring(0,8)}..., session_type=${s}, method=${n}`),e.trigger&&console.log(`[Optima DataSender] üîç Trigger: ${e.trigger}`),this.sdk._sendToServer("/api/optima/collect",e,{sync:t.sync,immediate:t.immediate}),console.log(`[Optima DataSender] ‚úÖ SENT ${i.toUpperCase()}: view=${e.view_id.substring(0,8)}..., session_type=${s}`)}catch(i){if(console.error("[Optima DataSender] ‚ùå Error sending view data:",i),t.immediate&&!t.sync){console.log("[Optima DataSender] üîÑ Retrying with sync send");try{this.sdk._sendToServer("/api/optima/collect",e,{sync:!0})}catch(e){console.error("[Optima DataSender] ‚ùå Fallback send also failed:",e)}}}}sendContinuousUpdate(e){if(!e||!this.sdk.sessionId)return void console.warn("[Optima DataSender] ‚ö†Ô∏è Cannot send continuous update: missing data or session");console.log(`[Optima DataSender] üìä Preparing continuous update for view: ${e.view_id.substring(0,8)}...`);const t=this.sdk.viewManager?.currentView,i=this.createdViewSessions.has(e.view_id),s={session_id:this.sdk.sessionId,session_type:t?.type||"initial",view_id:e.view_id,type:"continuous_update",web_vitals:e.web_vitals,timestamp:e.timestamp,send_timestamp:Date.now(),is_update_only:i};console.log(`[Optima DataSender] üîç View session exists: ${i}, is_update_only: ${i}`),i||this.createdViewSessions.add(e.view_id),this.performSend(s,{immediate:!0,sync:!1})}forceFlush(){console.log("[Optima DataSender] üö® Force flushing all queued data"),this.sendQueue.length>0&&(this.sendQueue.forEach((e=>{e.trigger="force_flush",this.performSend(e,{immediate:!0,sync:!0})})),this.sendQueue=[]),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null)}getQueueStatus(){return{queueLength:this.sendQueue.length,isProcessing:this.isProcessing,hasBatchTimer:!!this.batchTimer,maxBatchSize:this.maxBatchSize,batchTimeout:this.batchTimeout}}updateConfig(e){e.maxBatchSize&&(this.maxBatchSize=e.maxBatchSize),e.batchTimeout&&(this.batchTimeout=e.batchTimeout),console.log("[Optima DataSender] ‚öôÔ∏è Configuration updated:",{maxBatchSize:this.maxBatchSize,batchTimeout:this.batchTimeout})}markViewCompleted(e){this.createdViewSessions.has(e)&&(console.log(`[Optima DataSender] ‚úÖ Marking view as completed: ${e.substring(0,8)}...`),setTimeout((()=>{this.createdViewSessions.delete(e),console.log(`[Optima DataSender] üßπ Cleaned up view tracking: ${e.substring(0,8)}...`)}),3e4))}cleanup(){console.log("[Optima DataSender] üßπ Cleaning up data sender"),this.forceFlush(),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.createdViewSessions.clear(),this.isProcessing=!1}}class r{constructor(e,t){this.viewManager=e,this.dataSender=t,this.updateInterval=null,this.lastSentMetrics={},this.updateIntervalMs=1e4,this.isTracking=!1,this.significantChangeThresholds={CLS:.01,INP:50},console.log("[Optima ContinuousMetrics] üìä Continuous metrics manager initialized")}startContinuousTracking(){this.isTracking?console.warn("[Optima ContinuousMetrics] ‚ö†Ô∏è Continuous tracking already started"):(console.log("[Optima ContinuousMetrics] üöÄ Starting continuous metrics tracking"),this.isTracking=!0,this.lastSentMetrics={},this.updateInterval=setInterval((()=>{this.checkAndSendUpdates()}),this.updateIntervalMs),this.setupChangeDetection())}stopContinuousTracking(){this.isTracking&&(console.log("[Optima ContinuousMetrics] üõë Stopping continuous metrics tracking"),this.isTracking=!1,this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this.lastSentMetrics={})}setupChangeDetection(){this.setupCLSChangeDetection(),this.setupINPChangeDetection()}setupCLSChangeDetection(){if("PerformanceObserver"in window)try{new PerformanceObserver((e=>{if(!this.isTracking||!this.viewManager.currentView?.isActive)return;const t=e.getEntries();let i=!1;t.forEach((e=>{e.hadRecentInput||(i=!0)})),i&&setTimeout((()=>{this.checkAndSendUpdates()}),1e3)})).observe({type:"layout-shift",buffered:!1})}catch(e){console.error("[Optima ContinuousMetrics] ‚ùå Error setting up CLS change detection:",e)}}setupINPChangeDetection(){["click","keydown","pointerdown"].forEach((e=>{document.addEventListener(e,(()=>{this.isTracking&&this.viewManager.currentView?.isActive&&setTimeout((()=>{this.checkForINPUpdate()}),500)}),{passive:!0})}))}checkForINPUpdate(){if(!this.viewManager.currentView?.isActive)return;const e=this.viewManager.currentView.webVitals.INP?.value,t=this.lastSentMetrics.INP;e&&this.hasSignificantINPChange(e,t)&&(console.log("[Optima ContinuousMetrics] üñ±Ô∏è Significant INP change detected, sending update"),this.sendContinuousUpdate())}checkAndSendUpdates(){if(!this.isTracking||!this.viewManager.currentView?.isActive)return;const e=this.getCurrentContinuousMetrics();this.hasSignificantChanges(e)&&(console.log("[Optima ContinuousMetrics] üìä Significant changes detected, sending update"),this.sendContinuousUpdate())}getCurrentContinuousMetrics(){if(!this.viewManager.currentView)return{};const e=this.viewManager.currentView.webVitals;return{CLS:e.CLS?.value||null,INP:e.INP?.value||null}}hasSignificantChanges(e){return!!this.hasSignificantCLSChange(e.CLS,this.lastSentMetrics.CLS)||(!!this.hasSignificantINPChange(e.INP,this.lastSentMetrics.INP)||0===Object.keys(this.lastSentMetrics).length&&(null!==e.CLS||null!==e.INP))}hasSignificantCLSChange(e,t){if(null==e)return!1;if(null==t)return e>0;return Math.abs(e-t)>=this.significantChangeThresholds.CLS}hasSignificantINPChange(e,t){if(null==e)return!1;if(null==t)return e>0;return Math.abs(e-t)>=this.significantChangeThresholds.INP}sendContinuousUpdate(){if(!this.viewManager.currentView?.isActive)return;const e=this.getCurrentContinuousMetrics(),t=this.viewManager.currentView,i={view_id:t.id,web_vitals:{},timestamp:Date.now()};null!==e.CLS&&(i.web_vitals.CLS={value:e.CLS,timestamp:t.webVitals.CLS?.timestamp,view_relative_time:t.webVitals.CLS?.viewRelativeTime,last_shift_time:t.webVitals.CLS?.lastShiftTime,last_shift_value:t.webVitals.CLS?.lastShiftValue}),null!==e.INP&&(i.web_vitals.INP={value:e.INP,timestamp:t.webVitals.INP?.timestamp,view_relative_time:t.webVitals.INP?.viewRelativeTime,interaction_type:t.webVitals.INP?.interactionType}),this.dataSender.sendContinuousUpdate(i),this.lastSentMetrics={...e},console.log("[Optima ContinuousMetrics] ‚úÖ Sent continuous update:",e)}updateThresholds(e){void 0!==e.CLS&&(this.significantChangeThresholds.CLS=e.CLS),void 0!==e.INP&&(this.significantChangeThresholds.INP=e.INP),console.log("[Optima ContinuousMetrics] ‚öôÔ∏è Updated thresholds:",this.significantChangeThresholds)}updateInterval(e){this.updateIntervalMs=e,this.isTracking&&(this.stopContinuousTracking(),this.startContinuousTracking()),console.log("[Optima ContinuousMetrics] ‚öôÔ∏è Updated interval:",e)}forceSendUpdate(){console.log("[Optima ContinuousMetrics] üîß Force sending continuous update"),this.sendContinuousUpdate()}getStatus(){return{isTracking:this.isTracking,updateInterval:this.updateIntervalMs,lastSentMetrics:{...this.lastSentMetrics},thresholds:{...this.significantChangeThresholds},hasActiveView:!!this.viewManager.currentView?.isActive}}reset(){console.log("[Optima ContinuousMetrics] üîÑ Resetting continuous metrics tracking"),this.lastSentMetrics={},this.isTracking&&console.log("[Optima ContinuousMetrics] üîÑ Continuing tracking with reset baseline")}cleanup(){console.log("[Optima ContinuousMetrics] üßπ Cleaning up continuous metrics manager"),this.stopContinuousTracking()}}class o{constructor(e){this.viewManager=e,this.processedUrls=new Set,this.resourceObserver=null,this.isObserving=!1,console.log("[Optima ViewScopedCollector] üîç Resource collector initialized")}startCollecting(){this.viewManager.currentView?(console.log(`[Optima ViewScopedCollector] üöÄ Starting resource collection for view: ${this.viewManager.currentView.id.substring(0,8)}...`),this.processedUrls.clear(),this.setupResourceObserver(),this.collectExistingResources()):console.warn("[Optima ViewScopedCollector] ‚ö†Ô∏è No active view to collect resources for")}stopCollecting(){console.log("[Optima ViewScopedCollector] üõë Stopping resource collection"),this.resourceObserver&&this.isObserving&&(this.resourceObserver.disconnect(),this.isObserving=!1),this.processedUrls.clear()}setupResourceObserver(){if("PerformanceObserver"in window){this.resourceObserver&&this.isObserving&&this.resourceObserver.disconnect();try{this.resourceObserver=new PerformanceObserver((e=>{const t=e.getEntries();this.processResourceEntries(t)})),this.resourceObserver.observe({entryTypes:["resource"]}),this.isObserving=!0,console.log("[Optima ViewScopedCollector] üëÅÔ∏è Resource observer setup complete")}catch(e){console.error("[Optima ViewScopedCollector] ‚ùå Failed to setup resource observer:",e)}}else console.warn("[Optima ViewScopedCollector] ‚ö†Ô∏è PerformanceObserver not supported")}collectExistingResources(){if(this.viewManager.currentView)try{const e=performance.getEntriesByType("resource"),t=this.viewManager.currentView.startTime,i=e.filter((e=>e.startTime>=t&&!this.processedUrls.has(e.name)&&this.shouldCollectResource(e)));console.log(`[Optima ViewScopedCollector] üìä Found ${i.length} existing resources for current view`),this.processResourceEntries(i)}catch(e){console.error("[Optima ViewScopedCollector] ‚ùå Error collecting existing resources:",e)}}processResourceEntries(e){if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const t=this.viewManager.currentView.startTime;let i=0;e.forEach((e=>{if(!this.processedUrls.has(e.name)&&!(e.startTime<t)&&this.shouldCollectResource(e))try{const s=this.extractFullResourceData(e,t);if(this.viewManager.addResource(s),this.isAjaxRequest(e)){const t=this.convertToAjaxData(s,e);this.viewManager.addAjaxRequest(t)}this.processedUrls.add(e.name),i++}catch(t){console.error("[Optima ViewScopedCollector] ‚ùå Error processing resource:",e.name,t)}})),i>0&&console.log(`[Optima ViewScopedCollector] ‚úÖ Processed ${i} new resources`)}extractFullResourceData(e,t){const i=e.startTime-t,s=Math.round(e.domainLookupEnd-e.domainLookupStart),n=e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,r=Math.round(e.connectEnd-e.connectStart),o=Math.round(e.responseStart-e.requestStart),a=Math.round(e.responseEnd-e.responseStart),c=Math.round(e.duration),l=this.getResourceType(e),u=this.getCacheStatus(e);return{name:e.name,size:e.transferSize||0,ttfb:o,type:l,timing:{dns:s,tls:n,request:o,response:a,connection:r},dnsTime:s,tlsTime:n,dns_time:s,tls_time:n,duration:c,downloadTime:a,download_time:a,connectionTime:r,connection_time:r,start_time:Math.round(i),cacheStatus:u,cache_status:u,decoded_size:e.decodedBodySize||0,encoded_size:e.encodedBodySize||0,transfer_size:e.transferSize||0,connect_end:Math.round(e.connectEnd),connect_start:Math.round(e.connectStart),fetch_start:Math.round(e.fetchStart),response_end:Math.round(e.responseEnd),response_start:Math.round(e.responseStart),request_start:Math.round(e.requestStart),domain_lookup_end:Math.round(e.domainLookupEnd),domain_lookup_start:Math.round(e.domainLookupStart),secure_connection_start:Math.round(e.secureConnectionStart||0),next_hop_protocol:e.nextHopProtocol||"unknown",initiator_type:e.initiatorType||"other",viewId:this.viewManager.currentView.id,viewType:this.viewManager.currentView.type,view_relative_timing:!0}}isAjaxRequest(e){if("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)return!0;if(!0===e.is_ajax)return!0;const t=e.name.toLowerCase();return!(t.endsWith(".js")||t.endsWith(".css")||t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".gif")||t.endsWith(".svg")||t.endsWith(".woff")||t.endsWith(".woff2")||t.endsWith(".ttf")||t.endsWith(".ico"))&&!!(t.includes("/api/")||t.includes("/ajax/")||t.includes("/graphql"))}convertToAjaxData(e,t){return{type:"xmlhttprequest"===t.initiatorType?"xhr":"fetch",method:"GET",method_inferred:!0,url:e.name,status:200,statusText:"OK",startTime:e.start_time,duration:e.duration,async:!0,requestPayloadSize:0,responseSize:e.transfer_size,aborted:!1,errored:!1,timedOut:!1,timestamp:Date.now(),resourceTiming:{startTime:e.start_time,duration:e.duration,domainLookupTime:e.dnsTime,connectTime:e.connectionTime,tlsTime:e.tlsTime,requestStartTime:e.request_start,ttfb:e.ttfb,downloadTime:e.downloadTime,entryType:"resource",initiatorType:t.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transfer_size.toString(),"cache-control":"unknown"},viewId:this.viewManager.currentView.id,viewType:this.viewManager.currentView.type}}getResourceType(e){const t=e.name.toLowerCase();return"img"===e.initiatorType?"image":"script"===e.initiatorType?"script":"link"===e.initiatorType?"stylesheet":"xmlhttprequest"===e.initiatorType?"xhr":"fetch"===e.initiatorType?"fetch":t.endsWith(".js")?"script":t.endsWith(".css")?"stylesheet":t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".gif")||t.endsWith(".svg")||t.endsWith(".webp")?"image":t.endsWith(".woff")||t.endsWith(".woff2")||t.endsWith(".ttf")?"font":t.endsWith(".mp4")||t.endsWith(".webm")||t.endsWith(".ogg")?"media":"other"}getCacheStatus(e){return 0===e.transferSize&&e.encodedBodySize>0?"cache":e.transferSize>0?"network":0===e.transferSize&&0===e.encodedBodySize?"unknown":"network"}shouldCollectResource(e){const t=e.name;return!(t.includes("/api/optima/")||t.includes("/api/sessions")||t.includes("/api/events")||t.includes("/api/resources")||t.includes("/api/web-vitals")||t.includes("/api/ajax-calls")||t.includes("/api/optima/collect")||t.includes("optima.js")||t.includes("optima.min.js"))&&(!t.startsWith("data:")&&!t.startsWith("blob:"))}getProcessedCount(){return this.processedUrls.size}reset(){console.log("[Optima ViewScopedCollector] üîÑ Resetting collector state"),this.processedUrls.clear(),this.resourceObserver&&this.isObserving&&(this.resourceObserver.disconnect(),this.isObserving=!1)}}function a(e){if(!e||!e.previousRect||!e.currentRect)return 0;const t=e.previousRect,i=e.currentRect,s=Math.abs(t.x-i.x),n=Math.abs(t.y-i.y);return Math.sqrt(s*s+n*n)*(Math.max(t.width*t.height,i.width*i.height)/(window.innerWidth*window.innerHeight))}function c(e){return e?{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(e.width),height:Math.round(e.height),top:Math.round(e.top),right:Math.round(e.right),bottom:Math.round(e.bottom),left:Math.round(e.left)}:null}function l(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id){e+=`#${i.id}`,t.unshift(e);break}if(i.className&&"string"==typeof i.className){const t=i.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let s=i,n=1;for(;s=s.previousElementSibling;)n++;if(n>1&&(e+=`:nth-child(${n})`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function u(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id&&(e=`${e}#${i.id}`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function h(e){if(!e||!e.textContent)return null;const t=e.textContent.trim().replace(/\s+/g," ");return t.length>60?t.substring(0,60)+"...":t}function d(e){if(!e||!e.attributes)return{};const t={},i=["src","href","alt","title","aria-label","role","data-testid"];i.forEach((i=>{e.hasAttribute(i)&&(t[i]=e.getAttribute(i))}));for(let s=0;s<e.attributes.length;s++){const n=e.attributes[s];n.name.startsWith("data-")&&!i.includes(n.name)&&(t[n.name]=n.value)}return t}function p(e){if(!e||!e.previousRect||!e.currentRect)return"unknown";const t=e.previousRect,i=e.currentRect;if(0===t.width&&0===t.height&&(i.width>0||i.height>0))return"appeared";if(0===i.width&&0===i.height&&(t.width>0||t.height>0))return"disappeared";const s=Math.abs(t.width-i.width)>1||Math.abs(t.height-i.height)>1,n=Math.abs(t.x-i.x)>1||Math.abs(t.y-i.y)>1;return s&&n?"resize-and-move":s?"resize":n?"move":"unknown"}function g(e){if(!e||!window.getComputedStyle)return!1;try{const t=window.getComputedStyle(e);return"0s"!==t.transitionDuration||"none"!==t.animationName||e.classList.contains("animate")||e.classList.contains("fade")||e.classList.contains("slide")}catch(e){return!1}}class m{constructor(e){this.viewManager=e,this.observers=new Map,this.continuousMetrics=["CLS","INP"],this.initialOnlyMetrics=["LCP","FID","FCP","TTFB"],this.isSetup=!1,console.log("[Optima ViewScopedWebVitals] üìä Web vitals collector initialized")}startCollecting(e){this.viewManager.currentView?(console.log(`[Optima ViewScopedWebVitals] üöÄ Starting web vitals collection for ${e} view`),this.clearObservers(),"initial"===e?this.setupAllMetrics():this.setupRouteChangeMetrics(),this.isSetup=!0):console.warn("[Optima ViewScopedWebVitals] ‚ö†Ô∏è No active view to collect web vitals for")}setupAllMetrics(){console.log("[Optima ViewScopedWebVitals] üîß Setting up all metrics for initial load"),this.setupLCP(),this.setupFID(),this.setupFCP(),this.setupTTFB(),this.setupCLS(),this.setupINP(),this.setupLoadingTime()}setupRouteChangeMetrics(){console.log("[Optima ViewScopedWebVitals] üîß Setting up continuous metrics for route change"),this.setupCLS(),this.setupINP()}setupLCP(){if("PerformanceObserver"in window){console.log("[Optima ViewScopedWebVitals] üéØ Setting up LCP tracking");try{const e=this.viewManager.currentView.startTime;let t=0;const i=new PerformanceObserver((i=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const s=i.getEntries(),n=s[s.length-1];if(n.startTime<e)return;const r=n.startTime-e;if(n.startTime>t){t=n.startTime;const i=this.extractLCPElementInfo(n),s=this.calculateLCPAttribution(n,e);this.viewManager.updateWebVital("LCP",r,{absoluteTime:n.startTime,element:i,attribution:s,entry:{id:n.id,size:n.size,loadTime:n.loadTime,renderTime:n.renderTime}}),console.log(`[Optima ViewScopedWebVitals] üéØ LCP updated: ${r}ms`)}}));i.observe({type:"largest-contentful-paint",buffered:!0}),this.observers.set("LCP",i)}catch(e){console.error("[Optima ViewScopedWebVitals] ‚ùå Error setting up LCP:",e)}}}setupFID(){if("PerformanceObserver"in window){console.log("[Optima ViewScopedWebVitals] ‚ö° Setting up FID tracking");try{const e=this.viewManager.currentView.startTime,t=new PerformanceObserver((t=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;t.getEntries().forEach((t=>{if(t.startTime<e)return;const i=t.startTime-e,s=t.processingEnd-t.processingStart;this.viewManager.updateWebVital("FID",t.processingStart-t.startTime,{absoluteTime:t.startTime,viewRelativeTime:i,processingTime:s,interactionType:t.name,target:t.target?this.getElementInfo(t.target):null}),console.log(`[Optima ViewScopedWebVitals] ‚ö° FID recorded: ${t.processingStart-t.startTime}ms`)}))}));t.observe({type:"first-input",buffered:!0}),this.observers.set("FID",t)}catch(e){console.error("[Optima ViewScopedWebVitals] ‚ùå Error setting up FID:",e)}}}setupFCP(){if("PerformanceObserver"in window){console.log("[Optima ViewScopedWebVitals] üé® Setting up FCP tracking");try{const e=this.viewManager.currentView.startTime,t=new PerformanceObserver((t=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const i=t.getEntries().find((e=>"first-contentful-paint"===e.name));if(i&&i.startTime>=e){const t=i.startTime-e;this.viewManager.updateWebVital("FCP",t,{absoluteTime:i.startTime}),console.log(`[Optima ViewScopedWebVitals] üé® FCP recorded: ${t}ms`)}}));t.observe({type:"paint",buffered:!0}),this.observers.set("FCP",t)}catch(e){console.error("[Optima ViewScopedWebVitals] ‚ùå Error setting up FCP:",e)}}}setupTTFB(){try{const e=performance.getEntriesByType("navigation")[0];if(!e)return;const t=e.responseStart-e.requestStart;this.viewManager.updateWebVital("TTFB",t,{domainLookup:e.domainLookupEnd-e.domainLookupStart,connection:e.connectEnd-e.connectStart,request:e.responseStart-e.requestStart,tls:e.secureConnectionStart?e.connectEnd-e.secureConnectionStart:0}),console.log(`[Optima ViewScopedWebVitals] üåê TTFB recorded: ${t}ms`)}catch(e){console.error("[Optima ViewScopedWebVitals] ‚ùå Error setting up TTFB:",e)}}setupCLS(){if("PerformanceObserver"in window){console.log("[Optima ViewScopedWebVitals] üìê Setting up CLS tracking");try{const e=this.viewManager.currentView.startTime;let t=0;const i=new PerformanceObserver((i=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;i.getEntries().forEach((i=>{if(i.startTime>=e&&!i.hadRecentInput){t+=i.value;const s=function(e){if(!e||!e.sources||0===e.sources.length)return null;try{const t=e.sources.reduce(((e,t)=>{try{return(t.impactValue||a(t))>(e.impactValue||a(e))?t:e}catch(t){return e}}),e.sources[0]);if(!t)return null;const i=t.node;return i?{tagName:i.tagName||"UNKNOWN",id:i.id||null,className:"string"==typeof i.className?i.className:null,cssPath:l(i),domPath:u(i),textContent:h(i),attributes:d(i),previousRect:c(t.previousRect),currentRect:c(t.currentRect),impactValue:t.impactValue||a(t),shiftType:p(t),isAnimating:g(i),isImage:"IMG"===i.tagName,isIframe:"IFRAME"===i.tagName,isVideo:"VIDEO"===i.tagName}:{previousRect:c(t.previousRect),currentRect:c(t.currentRect),impactValue:t.impactValue||a(t),nodeLost:!0,shiftType:p(t)}}catch(e){return null}}(i);this.viewManager.updateWebVital("CLS",t,{lastShiftTime:i.startTime-e,lastShiftValue:i.value,shiftSource:s,hadRecentInput:i.hadRecentInput})}}))}));i.observe({type:"layout-shift",buffered:!0}),this.observers.set("CLS",i)}catch(e){console.error("[Optima ViewScopedWebVitals] ‚ùå Error setting up CLS:",e)}}}setupINP(){console.log("[Optima ViewScopedWebVitals] üñ±Ô∏è Setting up INP tracking");try{const e=this.viewManager.currentView.startTime;let t=0;if(["click","keydown","pointerdown"].forEach((t=>{document.addEventListener(t,(t=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const i=performance.now();i<e||this.measureInteraction(t,i-e)}),{passive:!0,capture:!0})})),"PerformanceObserver"in window&&PerformanceObserver.supportedEntryTypes?.includes("event")){const i=new PerformanceObserver((i=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;i.getEntries().forEach((i=>{if(i.startTime>=e){const s=i.processingEnd-i.startTime;s>t&&(t=s,this.viewManager.updateWebVital("INP",s,{viewRelativeTime:i.startTime-e,interactionType:i.name,target:i.target?this.getElementInfo(i.target):null,processingTime:i.processingEnd-i.processingStart,inputDelay:i.processingStart-i.startTime}),console.log(`[Optima ViewScopedWebVitals] üñ±Ô∏è INP updated: ${s}ms`))}}))}));i.observe({type:"event",buffered:!0}),this.observers.set("INP",i)}}catch(e){console.error("[Optima ViewScopedWebVitals] ‚ùå Error setting up INP:",e)}}setupLoadingTime(){console.log("[Optima ViewScopedWebVitals] ‚è±Ô∏è Setting up loading time tracking");try{new w(this.viewManager).start()}catch(e){console.error("[Optima ViewScopedWebVitals] ‚ùå Error setting up loading time:",e)}}measureInteraction(e,t){const i=performance.now();requestAnimationFrame((()=>{const s=performance.now()-i;s>(this.viewManager.currentView?.webVitals?.INP?.value||0)&&(this.viewManager.updateWebVital("INP",s,{viewRelativeTime:t,interactionType:e.type,target:this.getElementInfo(e.target),manual:!0}),console.log(`[Optima ViewScopedWebVitals] üñ±Ô∏è Manual INP recorded: ${s}ms`))}))}extractLCPElementInfo(e){try{return e.element?{tagName:e.element.tagName,id:e.element.id||null,className:e.element.className||null,src:e.element.src||e.element.currentSrc||null,url:e.url||null,size:e.size||0}:null}catch(e){return null}}calculateLCPAttribution(e,t){try{const i=performance.getEntriesByType("navigation")[0];return i?{ttfb:Math.round(i.responseStart-i.requestStart),resourceLoadDelay:Math.round(Math.max(0,e.loadTime-i.responseStart)),resourceLoadDuration:Math.round(Math.max(0,e.loadTime-e.startTime)),elementRenderDelay:Math.round(e.startTime-t)}:null}catch(e){return null}}getElementInfo(e){if(!e)return null;try{return{tagName:e.tagName,id:e.id||null,className:e.className||null,textContent:e.textContent?.substring(0,100)||null}}catch(e){return null}}clearObservers(){console.log("[Optima ViewScopedWebVitals] üßπ Clearing web vitals observers"),this.observers.forEach(((e,t)=>{try{e.disconnect()}catch(e){console.error(`[Optima ViewScopedWebVitals] ‚ùå Error disconnecting ${t} observer:`,e)}})),this.observers.clear()}stopCollecting(){console.log("[Optima ViewScopedWebVitals] üõë Stopping web vitals collection"),this.clearObservers(),this.isSetup=!1}reset(){console.log("[Optima ViewScopedWebVitals] üîÑ Resetting web vitals collector"),this.stopCollecting()}}class w{constructor(e){this.viewManager=e,this.startTime=null,this.isTracking=!1,this.activityCount=0,this.completionTimer=null}start(){this.viewManager.currentView&&(this.startTime=this.viewManager.currentView.startTime,this.isTracking=!0,console.log("[Optima LoadingTimeTracker] ‚è±Ô∏è Started loading time tracking"),this.startCompletionCheck())}startCompletionCheck(){this.completionTimer=setInterval((()=>{this.checkForCompletion()}),100)}checkForCompletion(){if(!this.isTracking||!this.viewManager.currentView?.isActive)return void this.complete("view_inactive");const e="complete"===document.readyState,t=this.hasRecentNetworkActivity();e&&!t&&this.complete("document_complete")}hasRecentNetworkActivity(){const e=performance.now();return performance.getEntriesByType("resource").filter((t=>e-t.responseEnd<500)).length>0}complete(e){if(!this.isTracking)return;this.isTracking=!1,this.completionTimer&&(clearInterval(this.completionTimer),this.completionTimer=null);const t=performance.now()-this.startTime;this.viewManager.updateWebVital("loading_time",t,{reason:e,activityCount:this.activityCount}),console.log(`[Optima LoadingTimeTracker] ‚úÖ Loading time recorded: ${t}ms (${e})`)}}function v(e){e.buffer||(e.buffer={}),e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t)return;try{const i=t.error||new Error(t.message||"Unknown error"),s=i.message||t.message||"Unknown error",n=t.filename||t.srcElement?.src||window.location.href,r=i.stack||null,o="error",a={type:o,message:s,source:n,lineno:t.lineno||0,colno:t.colno||0,stack:r,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:f(o,s,n,r)};V(e,a),b(e),e.sendEvent("error",{error_type:"uncaught_error",message:a.message,source:a.source,lineno:a.lineno,colno:a.colno})}catch(e){}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const i=t.reason,s=i instanceof Error?i.message:String(i),n=i instanceof Error?i.stack:null,r="unhandled_rejection",o="Promise",a={type:r,message:s,source:o,stack:n,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:f(r,s,o,n)};V(e,a),b(e),e.sendEvent("error",{error_type:"unhandled_rejection",message:a.message})}catch(e){}}(e,t)})),function(e){const t=console.error;console.error=function(...i){const s="console.error";try{const t=(new Error).stack||"",n=i.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),r="console_error",o={type:r,message:n,source:s,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:f(r,n,s,t)};V(e,o)}catch(e){}t.apply(console,i)}}(e)}function f(e,t,i,s){const n=`${e}:${t}:${i}:${s?s.substring(0,150):""}`;let r=0;for(let e=0;e<n.length;e++){r=(r<<5)-r+n.charCodeAt(e),r|=0}return"err_"+Math.abs(r).toString(16)}function V(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const i=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(i)return!1;const s=e.buffer.errors.slice(-5),n=s.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!n})(e,t)&&(e.buffer.errors.push(t),e.viewManager&&e.viewManager.currentView&&e.viewManager.addError(t),e.buffer.errors.length>=5&&b(e))}function b(e){e.buffer.errors&&0!==e.buffer.errors.length&&(e.viewManager&&e.dataSender?e.buffer.errors=[]:e.unifiedDataModel?(e.unifiedDataModel.errors||(e.unifiedDataModel.errors=[]),e.unifiedDataModel.errors=[...e.unifiedDataModel.errors,...e.buffer.errors],e.buffer.errors=[],e._sendUnifiedData&&e._sendUnifiedData(!1)):e.buffer.errors=[])}const S={sessionId:null,apiKey:null,disabled:!1,version:"2.0.0-view-based",viewManager:null,routeDetector:null,dataSender:null,continuousMetrics:null,resourceCollector:null,webVitalsCollector:null,isInitialized:!1,initializationTime:null,config:{apiKey:null,endpoint:null,sampleRate:100,flushInterval:5e3,webVitalsBatchDelay:2e3,batchBeforeSend:!0,maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,payloadCompressionThreshold:10240,enableRouteChangeTracking:!0,enableContinuousMetrics:!0,batchSize:3,batchTimeout:5e3,continuousMetricsInterval:1e4,debug:!1,disabled:!1},init:function(e={}){if(this.isInitialized)console.warn("[ViewBasedOptima] ‚ö†Ô∏è SDK already initialized");else{if(console.log("1. [ViewBasedOptima] üöÄ Initializing View-Based Optima SDK v"+this.version),this.initializationTime=Date.now(),this.applyConfiguration(e),!this.config.apiKey)return console.error("[ViewBasedOptima] ‚ùå API key is required"),void(this.disabled=!0);if(this.config.disabled)return console.log("[ViewBasedOptima] ‚è∏Ô∏è SDK disabled due to sampling"),void(this.disabled=!0);console.log("2. [ViewBasedOptima] üöÄ Initializing View-Based Optima SDK v"+this.version),this.initializeSession(),this.initializeViewBasedArchitecture(),this.setupErrorMonitoring(),this.setupPageLifecycleEvents(),this.startInitialView(),this.isInitialized=!0,console.log("[ViewBasedOptima] ‚úÖ SDK initialization complete"),this.sendEvent("sdk_initialized",{version:this.version,architecture:"view_based",config:this.config})}},applyConfiguration:function(e){this.config={...this.config,...e},"number"==typeof this.config.sampleRate&&(this.config.sampleRate=Math.min(Math.max(this.config.sampleRate,1),100)),this.apiKey=this.config.apiKey,this.endpoint=this.config.endpoint,this.sampleRate=this.config.sampleRate,this.config.debug&&(console.log("[ViewBasedOptima] üêõ Debug mode enabled"),console.log(`[ViewBasedOptima] üîß SDK Config - Endpoint: ${this.endpoint}, API Key: ${this.apiKey?this.apiKey.substring(0,8)+"...":"NOT SET"}, Sample Rate: ${this.sampleRate}%`)),this.shouldTrackSession(this.config.sampleRate)||(console.log(`[ViewBasedOptima] üé≤ Session not tracked (sample rate: ${this.config.sampleRate}%)`),this.config.disabled=!0)},initializeSession:function(){this.sessionId=t(),console.log(`[ViewBasedOptima] üÜî Session initialized: ${this.sessionId.substring(0,8)}...`)},initializeViewBasedArchitecture:function(){console.log("[ViewBasedOptima] üèóÔ∏è Initializing view-based architecture"),this.viewManager=new i(this),this.config.enableRouteChangeTracking&&(this.routeDetector=new s(this.viewManager),this.routeDetector.setupRouteDetection()),this.dataSender=new n(this),this.dataSender.updateConfig({maxBatchSize:this.config.batchSize,batchTimeout:this.config.batchTimeout,flushInterval:this.config.flushInterval,webVitalsBatchDelay:this.config.webVitalsBatchDelay,batchBeforeSend:this.config.batchBeforeSend,maxEventsPerBatch:this.config.maxEventsPerBatch,maxResourcesPerBatch:this.config.maxResourcesPerBatch,maxWebVitalsPerBatch:this.config.maxWebVitalsPerBatch,maxAjaxCallsPerBatch:this.config.maxAjaxCallsPerBatch,payloadCompressionThreshold:this.config.payloadCompressionThreshold}),this.config.enableContinuousMetrics&&(this.continuousMetrics=new r(this.viewManager,this.dataSender),this.config.continuousMetricsInterval&&this.continuousMetrics.updateInterval&&this.continuousMetrics.updateInterval(this.config.continuousMetricsInterval)),this.resourceCollector=new o(this.viewManager),this.webVitalsCollector=new m(this.viewManager),console.log("[ViewBasedOptima] ‚úÖ View-based architecture initialized")},shouldTrackSession:function(e){return e>=100||(e<=1?Math.random()<.01:100*Math.random()<e)},setupErrorMonitoring:function(){try{v(this)}catch(e){console.error("[ViewBasedOptima] ‚ùå Error setting up error monitoring:",e)}},setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this.handlePageHidden():"visible"===document.visibilityState&&this.handlePageVisible()})),window.addEventListener("beforeunload",(()=>{this.handlePageUnload()})),window.addEventListener("blur",(()=>{this.sendEvent("page_blur",{timestamp:Date.now()})})),window.addEventListener("focus",(()=>{this.sendEvent("page_focus",{timestamp:Date.now()})}))},startInitialView:function(){console.log("[ViewBasedOptima] üé¨ Starting initial view"),this.viewManager.startNewView("initial",window.location.href,"page_load"),this.startCollectorsForView("initial"),this.continuousMetrics&&this.continuousMetrics.startContinuousTracking(),this._onViewCompleted=(e,t)=>{this.handleViewCompleted(e,t)}},startCollectorsForView:function(e){console.log(`[ViewBasedOptima] üîß Starting collectors for ${e} view`),this.resourceCollector.startCollecting(),this.webVitalsCollector.startCollecting(e)},handleViewCompleted:function(e,t){console.log(`[ViewBasedOptima] üèÅ View completed: ${e.id.substring(0,8)}... (${t})`),this.dataSender.sendViewData(e,t),this.dataSender.markViewCompleted(e.id),"new_view_started"===t&&this.viewManager.currentView&&(this.startCollectorsForView(this.viewManager.currentView.type),this.continuousMetrics&&this.continuousMetrics.reset())},handlePageHidden:function(){console.log("[ViewBasedOptima] üëÅÔ∏è Page hidden"),this.sendEvent("page_hidden",{timestamp:Date.now()},{immediate:!0}),this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_hidden"),this.dataSender&&this.dataSender.forceFlush()},handlePageVisible:function(){console.log("[ViewBasedOptima] üëÅÔ∏è Page visible"),this.sendEvent("page_visible",{timestamp:Date.now()})},handlePageUnload:function(){console.log("[ViewBasedOptima] üì§ Page unloading"),this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_unload"),this.dataSender&&this.dataSender.forceFlush(),this.continuousMetrics&&this.continuousMetrics.stopContinuousTracking()},sendEvent:function(e,t={},i={}){if(this.disabled||!this.sessionId)return;const s={name:e,data:t,timestamp:Date.now(),session_id:this.sessionId,url:window.location.href};this.viewManager?.currentView&&this.viewManager.addEvent(s),i.immediate&&this._sendToServer("/api/events",s,{sync:!0})},triggerRouteChange:function(e){this.routeDetector&&this.routeDetector.triggerRouteChange(e,"manual")},getCurrentView:function(){return this.viewManager?.getCurrentViewData()||null},getViewHistory:function(){return this.viewManager?.getViewHistory()||[]},getStatus:function(){return{isInitialized:this.isInitialized,sessionId:this.sessionId,version:this.version,disabled:this.disabled,currentView:this.getCurrentView(),viewHistory:this.getViewHistory(),config:this.config,components:{viewManager:!!this.viewManager,routeDetector:!!this.routeDetector,dataSender:!!this.dataSender,continuousMetrics:!!this.continuousMetrics,resourceCollector:!!this.resourceCollector,webVitalsCollector:!!this.webVitalsCollector}}},updateConfig:function(e){this.config={...this.config,...e},this.dataSender&&(e.batchSize||e.batchTimeout)&&this.dataSender.updateConfig({maxBatchSize:e.batchSize,batchTimeout:e.batchTimeout}),this.continuousMetrics&&e.continuousMetricsInterval&&this.continuousMetrics.updateInterval(e.continuousMetricsInterval),console.log("[ViewBasedOptima] ‚öôÔ∏è Configuration updated:",this.config)},_sendToServer:function(e,t,i={}){if(!this.disabled){t.api_key=this.apiKey,t.timestamp=t.timestamp||Date.now(),t.user_agent=navigator.userAgent;try{const s=`${this.endpoint||this.config.endpoint||"https://api.optima.com"}${e}`;if(i.sync&&navigator.sendBeacon){const n=new URL(s);n.searchParams.set("api_key",this.apiKey);const r=navigator.sendBeacon(n.toString(),JSON.stringify(t));this.config.debug&&console.log(`[ViewBasedOptima] üö® BeaconAPI send ${r?"SUCCESS":"FAILED"} to ${e}`),r||this._sendViaFetch(s,t,{...i,sync:!0})}else this._sendViaFetch(s,t,i)}catch(e){this.config.debug&&console.error("[ViewBasedOptima] ‚ùå Send error:",e)}}},_sendViaFetch:function(e,t,i={}){fetch(e,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),keepalive:i.sync}).then((t=>(this.config.debug&&console.log(`[ViewBasedOptima] ‚úÖ Fetch ${t.ok?"SUCCESS":"ERROR"} to ${e}`),t))).catch((e=>{this.config.debug&&console.error("[ViewBasedOptima] ‚ùå Fetch failed:",e)}))},cleanup:function(){console.log("[ViewBasedOptima] üßπ Cleaning up SDK"),this.viewManager?.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("sdk_cleanup"),this.dataSender&&this.dataSender.cleanup(),this.continuousMetrics&&this.continuousMetrics.cleanup(),this.resourceCollector&&this.resourceCollector.reset(),this.webVitalsCollector&&this.webVitalsCollector.reset(),this.routeDetector&&this.routeDetector.cleanup(),this.isInitialized=!1,this.sessionId=null}};if("undefined"!=typeof window&&window.OptimaConfig&&S.init(window.OptimaConfig),"undefined"!=typeof window){const e=window.optima&&window.optima.q?[...window.optima.q]:[];window.optima=function(){const e=Array.prototype.slice.call(arguments),t=e[0];if(console.log("[ViewBasedOptima] üîß Processing command:",t,e),"init"===t)if("string"==typeof e[1]){const t=e[1],i=e[2]||{};i.apiKey=t,console.log("[ViewBasedOptima] üîß Initializing with old format"),S.init(i)}else console.log("[ViewBasedOptima] üîß Initializing with new format"),S.init(e[1]||{});else if("track"===t)S.sendEvent(e[1],e[2],e[3]);else{if("getStatus"===t)return S.getStatus();"updateConfig"===t?S.updateConfig(e[1]):console.warn("[ViewBasedOptima] Unknown command:",t)}},window.ViewBasedOptima=S,e.length>0?(console.log("[ViewBasedOptima] üîÑ Processing queued calls:",e.length),e.forEach((e=>{try{console.log("[ViewBasedOptima] üîÑ Processing queued call:",e[0]),window.optima.apply(window,e)}catch(t){console.error("[ViewBasedOptima] ‚ùå Error processing queued call:",t,e)}}))):console.log("[ViewBasedOptima] üì≠ No queued calls to process")}return e.ViewBasedOptima=S,e.default=S,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
