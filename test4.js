!function(){"use strict";function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}let t=null,n=null,i=null,s=null,a=null,o=null;function r(e){try{!function(){console.log("[Optima] Disconnecting existing web vitals observers"),t&&(t.disconnect(),t=null);n&&(n.disconnect(),n=null);i&&(i.disconnect(),i=null);s&&(s.disconnect(),s=null);a&&(a.disconnect(),a=null);o&&(o.disconnect(),o=null)}(),console.log("[Optima] Setting up web vitals for path:",window.location.pathname),"PerformanceObserver"in window&&(function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("paint"))return;try{s=new PerformanceObserver((t=>{const n=t.getEntries().find((e=>"first-contentful-paint"===e.name));if(!n)return;window.performance.mark("optima_fcp");const i=n.startTime;e.sendEvent("core_web_vital",{name:"FCP",value:i},{immediate:!0}),e.unifiedDataModel.web_vitals.FCP={value:i,timestamp:performance.timeOrigin+n.startTime},console.log(`[Optima] FCP: ${i}ms for path ${window.location.pathname}`),setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),500)})),s.observe({type:"paint",buffered:!0})}catch(e){console.error("[Optima] Error setting up FCP observer:",e)}}(e),l(e),window.setupLCP=l,window.forceLCPMeasurement=f,function(e){n=new PerformanceObserver((t=>{const n=t.getEntries()[0];window.performance.mark("optima_fid");const i=n.processingStart-n.startTime,s={type:n.name,targetElement:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null,timing:{processingStart:n.processingStart,processingEnd:n.processingEnd,startTime:n.startTime}};e.sendEvent("core_web_vital",{name:"FID",value:i,inputType:n.name,details:s},{immediate:!0}),e.unifiedDataModel.web_vitals.FID={value:i,timestamp:performance.timeOrigin+n.startTime,inputType:n.name,details:s},console.log(`[Optima] FID: ${i}ms (${n.name})`)})),n.observe({type:"first-input",buffered:!0})}(e),function(e){let t=0,n=[],s=[],a=0,o=0,r=window.location.pathname,l={value:0,entry:null,sourceInfo:null,timestamp:0};function c(e){if(!e)return null;try{return{tagName:e.tagName||"unknown",id:e.id||null,className:"string"==typeof e.className?e.className:null,nodeType:e.nodeType||null}}catch(e){return{error:"Failed to get node info"}}}try{i=new PerformanceObserver((i=>{try{const u=i.getEntries(),d=window.location.pathname;d!==r&&(console.log(`[Optima] CLS reset for path change: ${r} → ${d}`),t=0,n=[],a=0,o=0,l={value:0,entry:null,sourceInfo:null,timestamp:0},r=d),u.forEach((i=>{if(!i.hadRecentInput){0===n.length&&(o=i.startTime);const u={value:i.value,startTime:i.startTime,sources:Array.from(i.sources||[]).map((e=>({node:c(e.node),currentRect:e.currentRect?{x:e.currentRect.x,y:e.currentRect.y,width:e.currentRect.width,height:e.currentRect.height}:null,previousRect:e.previousRect?{x:e.previousRect.x,y:e.previousRect.y,width:e.previousRect.width,height:e.previousRect.height}:null})))};n.push(u),s.push(u),t+=i.value,a+=i.value,(n.length%5==0||t>.1)&&console.log(`[Optima] CLS: ${t.toFixed(4)} (${n.length} shifts)`),i.value>l.value&&(l.value=i.value,l.entry=i,l.timestamp=performance.now(),l.sourceInfo=function(e){try{if(!e.sources||!e.sources.length)return console.log("[Optima Debug] No sources in layout shift entry"),{type:"unknown",value:e.value};let t=null,n=0;for(const i of e.sources){const e=i.previousRect?i.previousRect.width*i.previousRect.height:0,s=i.currentRect?i.currentRect.width*i.currentRect.height:0,a=Math.abs(s-e);a>n&&(t=i,n=a)}if(!t)return console.log("[Optima Debug] Couldn't determine largest source in layout shift"),{type:"unknown",value:e.value,sources:e.sources.length};let i=null;return t.node&&(i={tagName:t.node.tagName||"unknown",className:t.node.className||null,id:t.node.id||null,innerText:t.node.innerText?t.node.innerText.substring(0,50)+(t.node.innerText.length>50?"...":""):null}),{type:"element",value:e.value,elementInfo:i,previousRect:t.previousRect?{x:Math.round(t.previousRect.x),y:Math.round(t.previousRect.y),width:Math.round(t.previousRect.width),height:Math.round(t.previousRect.height)}:null,currentRect:t.currentRect?{x:Math.round(t.currentRect.x),y:Math.round(t.currentRect.y),width:Math.round(t.currentRect.width),height:Math.round(t.currentRect.height)}:null}}catch(t){return console.error("[Optima Debug] Error in getLargestShiftSource:",t),{type:"error",value:e.value,error:t.message}}}(i)),e.sendEvent("core_web_vital",{name:"CLS",value:t,entries:n.length,sessionValue:a,sessionEntries:s.length,path:r,largestShift:l.value>0?{value:l.value,timestamp:l.timestamp,source:l.sourceInfo}:null}),e.unifiedDataModel.web_vitals.CLS={value:t,timestamp:performance.now(),entries:n.length,sessionValue:a,sessionEntries:s.length,path:r,largestShiftSource:l.sourceInfo},setTimeout((()=>{e._updateWebVitalsInUnifiedModel&&e._updateWebVitalsInUnifiedModel()}),0)}}))}catch(e){console.warn("[Optima] Error in CLS observer callback:",e)}})),i.observe({type:"layout-shift",buffered:!0})}catch(e){console.error("[Optima] Error setting up CLS observer:",e)}}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("event"))return;let t=[];try{a=new PerformanceObserver((n=>{n.getEntries().forEach((n=>{if(n.interactionId&&n.duration&&(t.push({duration:n.duration,startTime:n.startTime,name:n.name,target:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null}),t.length>=3)){const n=[...t].sort(((e,t)=>t.duration-e.duration)),i=Math.max(0,Math.floor(.98*t.length)),s=n[Math.min(i,n.length-1)].duration,a=t.find((e=>e.duration===s));e.sendEvent("core_web_vital",{name:"INP",value:s,totalInteractions:t.length,interaction:a?a.name:"unknown"}),e.unifiedDataModel.web_vitals.INP={value:s,timestamp:performance.now(),totalInteractions:t.length,interaction:a?a.name:"unknown"},t.length%10==0&&console.log(`[Optima] INP: ${s}ms (${t.length} interactions)`)}}))})),a.observe({type:"event",buffered:!0,durationThreshold:16})}catch(e){console.warn("[Optima] Error setting up INP observer:",e.message)}}(e),function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)})),window.addEventListener("beforeunload",(function(){e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)}))}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;try{o=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{e.sendEvent("performance_issue",{type:"long_task",duration:t.duration,startTime:t.startTime,attribution:t.attribution?t.attribution.map((e=>({name:e.name,containerType:e.containerType,containerName:e.containerName,containerId:e.containerId}))):[]})}))})),o.observe({type:"longtask",buffered:!0})}catch(e){console.warn("[Optima] Error setting up long tasks observer:",e.message)}}(e))}catch(e){console.error("[Optima] Error setting up core web vitals:",e)}}function l(e){let n=0,i=window.location.pathname,s=performance.now(),a=!0;console.log(`[Optima] Setting up LCP observer for path: ${i}`),t&&(console.log("[Optima] Disconnecting existing LCP observer"),t.disconnect(),t=null),t=new PerformanceObserver((t=>{const o=t.getEntries(),r=o[o.length-1];window.performance.mark("optima_lcp"),window.performance.measure("optima_lcp_time","navigationStart","optima_lcp");const l=window.location.pathname,f=performance.now()-s,p=l!==i,m=r.startTime>n;if(m||p||a){n=r.startTime,i=l,a=!1,console.log(`[Optima] LCP measurement: ${r.startTime}ms for path ${l}${p?" (path changed)":""}${m?" (better value)":""}`);const t=function(e){if(e.element){const t=e.element,n=c(t),i=u(t);return{tagName:t.tagName,id:t.id||null,className:t.className||null,cssPath:n,domPath:i,size:e.size,url:e.url||null,dimensions:t.getBoundingClientRect?{width:Math.round(t.getBoundingClientRect().width),height:Math.round(t.getBoundingClientRect().height)}:null,nodeType:t.nodeType,textContent:t.textContent?.slice(0,100)||null}}if(e.url){const t=e.url,n=function(e){try{const t=e.split("?")[0],n=t.split("#")[0].split("/").pop(),i=Array.from(document.querySelectorAll("img[src]"));for(const t of i)if(t.src===e||t.src.includes(n))return t;try{const t=Array.from(document.querySelectorAll("image[href]")),i=Array.from(document.querySelectorAll("image[*|href]")),s=[...t,...i];for(const t of s){const i=t.getAttribute("href")||t.getAttribute("xlink:href");if(i===e||i?.includes(n))return t}}catch(e){console.warn("[Optima] Could not query SVG image elements:",e.message)}const s=Array.from(document.querySelectorAll("*"));for(const t of s){const i=window.getComputedStyle(t).backgroundImage;if(i&&"none"!==i){const s=i.match(/url\(['"]?(.*?)['"]?\)/)?.[1];if(s===e||s?.includes(n))return t}}const a=performance.getEntriesByType("resource").find((t=>t.name===e));if(a&&"img"===a.initiatorType){return Array.from(document.querySelectorAll("div, section, header, main, article")).sort(((e,t)=>{const n=e.getBoundingClientRect(),i=t.getBoundingClientRect();return i.width*i.height-n.width*n.height}))[0]||null}}catch(e){console.error("[Optima] Error finding element by URL:",e)}return null}(t);return n?{tagName:n.tagName,id:n.id||null,className:n.className||null,cssPath:c(n),domPath:u(n),size:e.size,url:t,elementFoundBy:"url-matching",dimensions:n.getBoundingClientRect?{width:Math.round(n.getBoundingClientRect().width),height:Math.round(n.getBoundingClientRect().height)}:null}:{tagName:null,url:t,size:e.size,elementFoundBy:"url-only",imageType:d(t),resourceType:h(t)}}return{detail:"No element or URL available",size:e.size||0,startTime:e.startTime}}(r);e.sendEvent("core_web_vital",{name:"LCP",value:r.startTime,element:t,path:l,timeSinceObserverStarted:f});const s=e.unifiedDataModel.web_vitals.LCP;(!s||s.path!==l||r.startTime>s.value)&&(e.unifiedDataModel.web_vitals.LCP={value:r.startTime,timestamp:performance.timeOrigin+r.startTime,element:t,path:l,timeSinceObserverStarted:f},console.log(`[Optima] LCP updated for path ${l}: ${r.startTime}ms`)),(o.length<=1||p)&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),500)}})),t.observe({type:"largest-contentful-paint",buffered:!0}),s=performance.now(),window.lcpObserver=t}function c(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id){e+=`#${n.id}`,t.unshift(e);break}if(n.className&&"string"==typeof n.className){const t=n.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let i=n,s=1;for(;i=i.previousElementSibling;)s++;if(s>1&&(e+=`:nth-child(${s})`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function u(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id&&(e=`${e}#${n.id}`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function d(e){if(!e)return"unknown";const t=e.split(".").pop().toLowerCase();switch(t){case"jpg":case"jpeg":return"jpeg";case"png":return"png";case"svg":return"svg";case"webp":return"webp";case"gif":return"gif";case"avif":return"avif";default:return t||"unknown"}}function h(e){try{const t=performance.getEntriesByType("resource").find((t=>t.name===e));if(t)return t.initiatorType||"unknown"}catch(e){console.error("[Optima] Error finding resource type:",e)}return"unknown"}function f(e){try{console.log("[Optima LCP] Forcing measurement for path:",window.location.pathname);const e=document.createElement("div");e.id="optima-lcp-forcer",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex="-1000",e.style.opacity="0.01",e.style.pointerEvents="none";const t=document.createElement("h1");t.innerText="Optima LCP Measurement",t.style.fontSize="48px",t.style.fontWeight="bold",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",e.appendChild(t),document.body.appendChild(e);e.offsetHeight;return setTimeout((()=>{document.body.contains(e)&&document.body.removeChild(e)}),500),!0}catch(e){return console.error("[Optima LCP] Error forcing measurement:",e),!1}}function p(e){if(!e.sessionId)return;"complete"===document.readyState?e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e.captureResourceData("load"),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3)):window.addEventListener("load",(()=>{e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e.captureResourceData("load"),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3))}));let t=null;if(document.addEventListener("click",(n=>{let i=n.target,s="";if("A"===i.tagName||i.closest("a")){const t="A"===i.tagName?i:i.closest("a");s="link",e.sendEvent("user_interaction",{type:"click",element_type:s,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null,element_href:t.href||null})}else if("BUTTON"===i.tagName||i.closest("button")){const t="BUTTON"===i.tagName?i:i.closest("button");s="button",e.sendEvent("user_interaction",{type:"click",element_type:s,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null})}t&&clearTimeout(t),t=setTimeout((()=>{e.captureResourceData("interaction"),t=null}),2e3)})),"requestIdleCallback"in window){let t=!1;window.requestIdleCallback((()=>{t||(t=!0,e.captureResourceData("idle"),e.sendEvent("page_ready",{url:window.location.href,title:document.title,time_to_idle:performance.now()}))}),{timeout:3e3})}document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?e.sendEvent("visibility_change",{state:"visible",timestamp:Date.now()}):"hidden"===document.visibilityState&&e.sendEvent("visibility_change",{state:"hidden",timestamp:Date.now()},{immediate:!0})}))}function m(e){return{setupBufferManagement:function(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers:function(){const t=e.batchConfig.maxBufferSize;e.buffer.events.length>t&&(e.buffer.events=e.buffer.events.slice(-t)),e.buffer.resources.length>t&&(e.buffer.resources=e.buffer.resources.slice(-t)),e.buffer.webVitals.length>t&&(e.buffer.webVitals=e.buffer.webVitals.slice(-t))},hashResource:function(e){return`${e.type}|${e.name.split("?")[0]}|${e.duration<50?"fast":"slow"}`},shouldCollectResource:function(t){if(e.batchConfig.resourceDedupingEnabled){const n=this.hashResource(t);if(e.collectionState.resourceHashMap[n])return!1;e.collectionState.resourceHashMap[n]=Date.now()}return!0},startBatchProcessing:function(){if(setInterval((()=>{e.buffer.events.length>0&&e._flushEvents(),e.buffer.webVitals.length>0&&e._flushWebVitals(),e.buffer.resources.length>0&&e._flushResources()}),Math.min(e.batchConfig.flushInterval,1e4)),e.batchConfig.visibilityFlushEnabled){const t=()=>{const t=Date.now();e.collectionState.visibilityState;const n=document.visibilityState;e.collectionState.visibilityState=n,t-e.collectionState.lastVisibilityChange>1e3&&(e.collectionState.lastVisibilityChange=t,"hidden"===n?e._flushBuffers("visibilityHidden",!0):"visible"===n&&setTimeout((()=>{e.captureResourceData("visibilityVisible")}),1e3))};document.addEventListener("visibilitychange",t)}if(window.addEventListener("beforeunload",(()=>{e._flushBuffers("unload",!0)})),e.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const t=()=>{window.requestIdleCallback((()=>{(e.buffer.events.length>=10||e.buffer.resources.length>=10||Date.now()-e.collectionState.lastResourceFlush>3e4)&&e._flushBuffers("idle"),setTimeout((()=>{t()}),2e4)}),{timeout:1e4})};t()}this.setupBufferManagement()}}}function g(t){var n;if(!((n=t.sampleRate)>=100||(n<=1?Math.random()<.01:100*Math.random()<n)))return t.disabled=!0,null;t.sessionId||(t.sessionId=e());const i=window.location.href,s=document.referrer||"";let a=null;window.performance&&window.performance.timing&&(a=window.performance.timing.navigationStart);let o="unknown",r="unknown";const l=window.navigator.userAgent;if(o=/Mobi|Android|iPhone|iPad|iPod/i.test(l)?"mobile":/Tablet|iPad/i.test(l)?"tablet":"desktop",window.navigator.connection){const e=window.navigator.connection;e.effectiveType?r=e.effectiveType:e.type&&(r=e.type)}const c={session_id:t.sessionId,page_url:i,referrer:s,user_agent:l,device_type:o,connection_type:r,timestamp:Date.now(),navigation_start:a||Date.now(),meta:{sdk_version:"1.0.0"}};return function(e){if(!e.buffer.preSessionAjaxCalls||!e.buffer.preSessionAjaxCalls.length)return;const t=e.buffer.preSessionAjaxCalls.sort(((e,t)=>e.startTime-t.startTime));if(window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource");t.forEach((t=>{if(t.resourceTiming)return;const n=t.responseURL||t.url;let i=e.find((e=>e.name===n));if(!i)try{const t=new URL(n).pathname;i=e.find((e=>{try{return new URL(e.name).pathname===t}catch{return!1}}))}catch{}if(!i){const n=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType));if(n.length>0){let e=null,s=1/0;n.forEach((n=>{const i=Math.abs(n.startTime-t.startTime);i<s&&(s=i,e=n)})),e&&s<100&&(i=e)}}i&&(t.resourceTiming={startTime:Math.round(i.startTime),duration:Math.round(i.duration),domainLookupTime:Math.round(i.domainLookupEnd-i.domainLookupStart),connectTime:Math.round(i.connectEnd-i.connectStart),tlsTime:i.secureConnectionStart?Math.round(i.connectEnd-i.secureConnectionStart):0,requestStartTime:Math.round(i.requestStart),ttfb:Math.round(i.responseStart-i.requestStart),downloadTime:Math.round(i.responseEnd-i.responseStart),entryType:i.entryType,initiatorType:i.initiatorType})}))}const n=new Set(e.buffer.ajaxCalls.map((e=>e.url))),i=t.filter((t=>!n.has(t.url)||!e.buffer.ajaxCalls.some((e=>e.url===t.url&&Math.abs(e.startTime-t.startTime)<50))));e.buffer.ajaxCalls=[...i,...e.buffer.ajaxCalls],e.buffer.preSessionAjaxCalls=[]}(t),t._sendToServer("/api/optima/sessions",c).then((e=>{e?(t._setupEventListeners(),t._setupPerformanceObservers(),t._startBatchProcessing(),t.sessionStartTime=Date.now(),t.unifiedDataModel.session_id=t.sessionId,t.unifiedDataModel.timestamp=t.sessionStartTime):console.error("[Optima Debug] Session: Failed to create session, monitoring disabled")})),t.sessionId}!function(t){function n(e){e=e||{},this.apiKey=e.apiKey,this.endpoint=e.endpoint||"http://localhost:3000",this.sampleRate="number"==typeof e.sampleRate?Math.min(Math.max(e.sampleRate,1),100):100,this.debug=!0===e.debug,this.sessionId=null,this.sessionStartTime=null,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null,layoutShiftSource:null},resources:[],ajax_requests:[],errors:[],events:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,flushInterval:e.flushInterval||5e3,webVitalsBatchDelay:e.webVitalsBatchDelay||2e3,batchBeforeSend:e.batchBeforeSend||!0,payloadCompressionThreshold:10240},this.collectionState={isFirstLoad:!0,resourcesCollected:!1,lastResourceFlush:null,lastEventFlush:null,lastAjaxCallFlush:null,isPerformanceObserverSet:!1,isBatchProcessingStarted:!1,unloadSent:!1,visibilityChangeCount:0,sentResourceURLs:new Set},this.bufferManager=m(this),this.flushManager=function(e){return{flushBuffers:function(t,n=!1){e.buffer.events.length>0&&this.flushEvents(n),e.buffer.resources.length>0&&this.flushResources(n),e.buffer.webVitals.length>0&&this.flushWebVitals(n),e.buffer.ajaxCalls&&e.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(n)},flushEvents:function(t=!1){if(0===e.buffer.events.length)return;const n=e.buffer.events.slice(0,e.batchConfig.maxEventsPerBatch);e.buffer.events=e.buffer.events.slice(e.batchConfig.maxEventsPerBatch);const i={session_id:e.sessionId,events:n,timestamp:Date.now(),count:n.length};e.collectionState.lastEventFlush=Date.now(),e._sendToServer("/api/optima/events",i,{sync:t})},flushResources:function(t=!1){if(0===e.buffer.resources.length)return;const n=e.buffer.resources.slice(0,e.batchConfig.maxResourcesPerBatch);e.buffer.resources=e.buffer.resources.slice(e.batchConfig.maxResourcesPerBatch);const i={session_id:e.sessionId,resources:n,timestamp:Date.now(),count:n.length};e.collectionState.lastResourceFlush=Date.now(),e._sendToServer("/api/optima/resources",i,{sync:t})},flushWebVitals:function(t=!1){if(0===e.buffer.webVitals.length)return;const n={LCP:[],FID:[],CLS:[],INP:[],TTFB:[],FCP:[]};e.buffer.webVitals.forEach((e=>{if(e&&e.event_data&&e.event_data.name){const t=e.event_data.name;n[t]&&n[t].push(e)}}));const i=e.buffer.webVitals.slice(0,e.batchConfig.maxWebVitalsPerBatch);e.buffer.webVitals=e.buffer.webVitals.slice(e.batchConfig.maxWebVitalsPerBatch);const s={session_id:e.sessionId,web_vitals:i,processed_vitals:n,timestamp:Date.now(),count:i.length};e._sendToServer("/api/optima/web-vitals",s,{sync:t})},flushAjaxCalls:function(t=!1){if(!e.buffer.ajaxCalls||0===e.buffer.ajaxCalls.length)return;const n=e.buffer.ajaxCalls.slice(0,e.batchConfig.maxAjaxCallsPerBatch);e.buffer.ajaxCalls=e.buffer.ajaxCalls.slice(e.batchConfig.maxAjaxCallsPerBatch);const i={session_id:e.sessionId,ajax_calls:n,timestamp:Date.now(),count:n.length};e.collectionState.lastAjaxCallFlush=Date.now(),e._sendToServer("/api/optima/ajax-calls",i,{sync:t})}}}(this),this._setupBatchedCollection(),this._webVitalsBatchTimer=null,this._init()}t.__optima_early_xhr_queue=t.__optima_early_xhr_queue||[],n.prototype={_init:function(){try{if(this.initialized)return;this.initialized=!0,this._setupSession(),this._setupCoreWebVitals(),this._initPerformanceMetrics(),this._setupErrorTracking(),this._setupConsoleTracking(),this._setupNetworkTracking(),this._setupRouteChangeDetection(),this._setupHistoryListener(),this.captureResourceData("init"),this._startMonitoring(),this.sendEvent("sdk_loaded",{version:this.version}),console.log(`[Optima] SDK v${this.version} initialized successfully`)}catch(e){console.error("[Optima] Error during initialization:",e)}},_initPerformanceMetrics:function(){if(t.performance&&t.performance.mark){t.performance.mark("optima_init");try{t.performance.getEntriesByType("mark").concat(t.performance.getEntriesByType("measure")).filter((e=>e.name.startsWith("optima_"))).forEach((e=>{t.performance.clearMarks(e.name),"measure"===e.entryType&&t.performance.clearMeasures(e.name)}))}catch(e){}this._setupCoreWebVitals(),this._captureNavigationTiming(),setTimeout((()=>{this._checkWebVitalsStatus()}),5e3)}},_captureNavigationTiming:function(){try{console.log("[Optima Debug] Capturing navigation timing for path:",t.location.pathname);const e=performance.getEntriesByType("navigation")[0];e?(this.unifiedDataModel.timings={navigationStart:0,fetchStart:e.fetchStart,domainLookupStart:e.domainLookupStart,domainLookupEnd:e.domainLookupEnd,connectStart:e.connectStart,connectEnd:e.connectEnd,requestStart:e.requestStart,responseStart:e.responseStart,responseEnd:e.responseEnd,domInteractive:e.domInteractive,domContentLoadedEventStart:e.domContentLoadedEventStart,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domComplete:e.domComplete,loadEventStart:e.loadEventStart,loadEventEnd:e.loadEventEnd,duration:e.duration,type:e.type,redirectCount:e.redirectCount,nextHopProtocol:e.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:e.responseStart,timestamp:performance.timeOrigin+e.responseStart},console.log("[Optima Debug] Captured TTFB:",this.unifiedDataModel.web_vitals.TTFB.value),this.sendEvent("core_web_vital",{name:"TTFB",value:e.responseStart},{immediate:!0})):console.warn("[Optima Debug] No navigation timing entries available")}catch(e){console.error("[Optima Debug] Error capturing navigation timing:",e)}},_setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{this.collectionState.visibilityChangeCount++,"hidden"===document.visibilityState?this._prepareFinalDataAndSend(!0):"visible"===document.visibilityState&&this._refreshVisibleState()})),t.addEventListener("beforeunload",(()=>{this.collectionState.unloadSent||(this._prepareFinalDataAndSend(!0),this.collectionState.unloadSent=!0)})),t.addEventListener("popstate",(()=>{this._handleRouteChange("popstate")})),this._patchHistoryMethods(),this._setupPeriodicFlush()},_patchHistoryMethods:function(){const e=this,n=t.history.pushState,i=t.history.replaceState;t.history.pushState=function(){const t=n.apply(this,arguments);return e._handleRouteChange("pushState"),t},t.history.replaceState=function(){const t=i.apply(this,arguments);return e._handleRouteChange("replaceState"),t}},_handleRouteChange:function(e){console.log(`[Optima] Route change from: ${this.unifiedDataModel.meta.path} to: ${t.location.pathname} via ${e}`);const n=this.unifiedDataModel.meta.url||t.location.href,i=this.unifiedDataModel.meta.path||t.location.pathname,s=this.sessionId;setTimeout((()=>{const e=t.location.pathname,a=this.unifiedDataModel.web_vitals.LCP?{...this.unifiedDataModel.web_vitals.LCP}:null;e!==i&&(console.log(`[Optima] Creating new session for path change: ${i} → ${e}`),console.log("[Optima] LCP before reset: "+(a?a.value+"ms":"null")),this._createNewRouteSession(n,s),setTimeout((()=>{const t=this.unifiedDataModel.web_vitals.LCP;console.log(`[Optima] LCP after route change: ${t?t.value+"ms":"null"} for path: ${e}`)}),1e3))}),100)},_scheduleMultipleLCPChecks:function(e,t){setTimeout((()=>{this._checkAndReinitializeLCP(e,t,1)}),1e3),setTimeout((()=>{this._checkAndReinitializeLCP(e,t,2)}),2500),setTimeout((()=>{this._checkAndReinitializeLCP(e,t,3)}),4e3)},_checkAndReinitializeLCP:function(e,t,n){const i=this.unifiedDataModel.web_vitals.LCP;if(!i||i.path!==e||t&&i.value===t.value)if(!i||i.path!==e||t&&i.value===t.value){const t=i?i.path!==e?`Path mismatch (${i.path} vs ${e})`:"LCP unchanged from previous route":"No LCP detected";console.log(`[Optima LCP] Check #${n}: Reinitializing - ${t}`),this._reinitializeLCP()}else console.log(`[Optima LCP] Check #${n}: Value looks good - ${i.value}ms`);else console.log(`[Optima LCP] Check #${n}: Already updated correctly`)},_createNewRouteSession:function(n,i){console.log(`[Optima Route] Creating new session for path: ${t.location.pathname}`),this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP,this._monitoringInterval&&(clearInterval(this._monitoringInterval),this._monitoringInterval=null);const s=n;this.collectionState.sentResourceURLs=new Set,this.sessionId=e(),this.sessionStartTime=Date.now(),this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel.timestamp=this.sessionStartTime,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[],this.unifiedDataModel.errors=[],console.log("[Optima LCP] Resetting all web vitals for new route"),this.unifiedDataModel.web_vitals={LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null,layoutShiftSource:null},this.collectionState.resourcesCollected=!1,this.collectionState.lastResourceFlush=null,this.collectionState.lastEventFlush=null,this.collectionState.lastAjaxCallFlush=null,this._updateMetadata();const a=t.location.href;this._createSession(a,s,{routeChange:!0,trigger:"spa_navigation",previousSessionId:i}),this._clearPerformanceBuffer(),this._initPerformanceMetrics()},_prepareFinalDataAndSend:function(e=!1){this.sessionId&&this.unifiedDataModel.session_id&&(this._consolidateBufferedData(),this._updateWebVitalsInUnifiedModel(),this._consolidateErrors(),this._updateMetadata(),this._sendUnifiedData(e))},_updateWebVitalsInUnifiedModel:function(){console.log("[Optima Debug] Updating web vitals in unified model. Buffer size:",this.buffer.webVitals.length),this.buffer.webVitals.forEach((e=>{if(!e.event_data||!e.event_data.name)return;const{name:n,value:i}=e.event_data,s=e.timestamp;e.event_data.path||t.location.pathname;const a=t.location.pathname;e.event_data.path&&e.event_data.path!==a?console.log(`[Optima Debug] Skipping ${n} for different path: ${e.event_data.path}`):(console.log(`[Optima Debug] Processing web vital: ${n} = ${i}`),"LCP"===n?(!this.unifiedDataModel.web_vitals.LCP||this.unifiedDataModel.web_vitals.LCP.path!==a||i>this.unifiedDataModel.web_vitals.LCP.value)&&(this.unifiedDataModel.web_vitals.LCP={value:i,timestamp:s,element:e.event_data.element||"unknown",path:a}):"FID"===n?this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:i,timestamp:s,inputType:e.event_data.inputType||"unknown",details:e.event_data.details||null},console.log(`[Optima Debug] Set FID to ${i}`)):"CLS"===n?(this.unifiedDataModel.web_vitals.CLS={value:i,timestamp:s,entries:e.event_data.entries||0,sessionValue:e.event_data.sessionValue||i,sessionEntries:e.event_data.sessionEntries||0,path:a},console.log(`[Optima Debug] Updated CLS to ${i}`),e.event_data.largestShift&&e.event_data.largestShift.source&&(this.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:e.event_data.largestShift.value,timestamp:e.event_data.largestShift.timestamp,source:e.event_data.largestShift.source,loadState:document.readyState})):"FCP"===n?this.unifiedDataModel.web_vitals.FCP&&this.unifiedDataModel.web_vitals.FCP.path===a||(this.unifiedDataModel.web_vitals.FCP={value:i,timestamp:s,path:a},console.log(`[Optima Debug] Set FCP to ${i}`)):"INP"===n&&(!this.unifiedDataModel.web_vitals.INP||i>this.unifiedDataModel.web_vitals.INP.value)&&(this.unifiedDataModel.web_vitals.INP={value:i,timestamp:s,totalInteractions:e.event_data.totalInteractions,interaction:e.event_data.interaction||"unknown"}))})),this.buffer.webVitals=[],console.log("[Optima Debug] Web vitals after update:",JSON.stringify(this.unifiedDataModel.web_vitals))},_consolidateBufferedData:function(){return this.buffer.events||(this.buffer.events=[]),this.unifiedDataModel.events||(this.unifiedDataModel.events=[]),this.buffer.events.length>0&&(this.unifiedDataModel.events=[...this.unifiedDataModel.events,...this.buffer.events],this.buffer.events=[]),this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.errors.length>0&&this._consolidateErrors(),this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel},_consolidateErrors:function(){this.buffer.errors&&0!==this.buffer.errors.length&&(this.unifiedDataModel.errors=[...this.unifiedDataModel.errors,...this.buffer.errors],this.buffer.errors=[])},_updateMetadata:function(){const e=t.location.href,n=t.location.pathname;return console.log(`[Optima Debug] Updating metadata with URL: ${e}, path: ${n}`),this.unifiedDataModel.meta={url:e,path:n,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:t.screen.width,screen_height:t.screen.height,viewport_width:t.innerWidth,viewport_height:t.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:performance.getEntriesByType("navigation")[0]?.type||null,sdk_version:this.version,lastUpdated:Date.now()},console.log("[Optima Debug] Updated metadata:",JSON.stringify({url:this.unifiedDataModel.meta.url,path:this.unifiedDataModel.meta.path})),this.unifiedDataModel.meta},_sendUnifiedData:function(e=!1){if(!this.unifiedDataModel.session_id)return void console.warn("[Optima Debug] Not sending data - no session ID");this._updateMetadata(),this.unifiedDataModel.timestamp=Date.now();const t=JSON.parse(JSON.stringify(this.unifiedDataModel));this._sendToServer("/api/optima/collect",t,{sync:e}),this._resetVolatileDataInUnifiedModel()},_resetVolatileDataInUnifiedModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},_setupBatchedCollection:function(){this.disabled||this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this._startBatchedCollection())},_startBatchedCollection:function(){setInterval((()=>{this._collectResources()}),3e3),this._setupPeriodicFlush()},_setupPeriodicFlush:function(){setInterval((()=>{this._hasSignificantData()&&this._prepareFinalDataAndSend(!1)}),this.batchConfig.flushInterval)},_hasSignificantData:function(){return this.unifiedDataModel.resources.length>0||this.unifiedDataModel.ajax_requests.length>0||this.buffer.webVitals.length>0||this.buffer.errors.length>0||this.unifiedDataModel.errors.length>0||this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value||this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value||this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value||this.unifiedDataModel.web_vitals.FCP&&this.unifiedDataModel.web_vitals.FCP.value},_collectResources:function(){try{console.log("[Optima Debug] _collectResources called"),this.collectionState.sentResourceURLs||(this.collectionState.sentResourceURLs=new Set,console.log("[Optima Debug] Initialized sentResourceURLs Set"));const e=performance.getEntriesByType("resource");console.log(`[Optima Debug] Found ${e.length} resources in performance entries`);const n=t.location.pathname,i=t.location.href;console.log(`[Optima Debug] Current path: ${n}`);const s=this.unifiedDataModel.resources.length,a=this.collectionState.sentResourceURLs.size;console.log(`[Optima Debug] Already processed resources: ${s}`),console.log(`[Optima Debug] Tracked URLs in sentResourceURLs: ${a}`);let o=0,r=0;e.forEach((e=>{const t=e.name;if(this.collectionState.sentResourceURLs.has(t)||this.unifiedDataModel.resources.some((e=>e.name===t)))return r++,void this.collectionState.sentResourceURLs.add(t);const s={name:t,type:this._getResourceType(e),startTime:Math.round(e.startTime),duration:Math.round(e.duration),size:e.transferSize||0,protocol:e.nextHopProtocol,encodedSize:e.encodedBodySize||0,decodedSize:e.decodedBodySize||0,initiatorType:e.initiatorType,route:n,routeUrl:i};this.unifiedDataModel.resources.push(s),this.collectionState.sentResourceURLs.add(t),o++})),console.log(`[Optima Debug] New resources added: ${o}`),console.log(`[Optima Debug] Resources skipped (already processed): ${r}`),console.log(`[Optima Debug] Total resources after collection: ${this.unifiedDataModel.resources.length}`),console.log(`[Optima Debug] Total URLs in tracking Set: ${this.collectionState.sentResourceURLs.size}`),this.collectionState.resourcesCollected=!0}catch(e){console.error("[Optima Debug] Error collecting resources:",e)}},_isResourceProcessed:function(e){if(this.collectionState.sentResourceURLs&&this.collectionState.sentResourceURLs.has(e))return!0;const t=this.unifiedDataModel.resources.some((t=>t.name===e));return t&&(this.collectionState.sentResourceURLs||(this.collectionState.sentResourceURLs=new Set),this.collectionState.sentResourceURLs.add(e)),t},_getResourceType:function(e){const t=e.initiatorType,n=e.name;return"img"===t||"image"===t?"image":"script"===t?"script":"css"===t?"stylesheet":"fetch"===t||"xmlhttprequest"===t?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(n)?"image":/\.(?:js)(?:\?|$)/i.test(n)?"script":/\.(?:css)(?:\?|$)/i.test(n)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(n)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(n)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(n)?"audio":"other"},_detectBrowser:function(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("MSIE")>-1||e.indexOf("Trident/")>-1?"IE":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1||e.indexOf("OPR/")>-1?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"},_refreshVisibleState:function(){this.collectionState.visibilityChangeCount>1&&this._collectResources()},_setupCoreWebVitals:function(){this.disabled||(console.log("[Optima] Setting up web vitals for path:",t.location.pathname),r(this))},_setupBufferManagement:function(){this.bufferManager.setupBufferManagement()},_shouldCollectResource:function(e){return this.bufferManager.shouldCollectResource(e)},_startBatchProcessing:function(){this.bufferManager.startBatchProcessing()},_flushBuffers:function(e,t=!1){this._prepareFinalDataAndSend(t)},_flushEvents:function(e=!1){const t=this.buffer.events.slice();if(this.buffer.events=[],0===t.length)return;const n={session_id:this.sessionId,events:t,timestamp:Date.now()};this._sendToServer("/api/optima/events",n,{sync:e})},_flushResources:function(e=!1){const t=this.buffer.resources.slice();if(this.buffer.resources=[],0===t.length)return;const n={session_id:this.sessionId,resources:t,timestamp:Date.now()};this._sendToServer("/api/optima/resources",n,{sync:e})},_flushWebVitals:function(e=!1){const t=this.buffer.webVitals.slice();if(this.buffer.webVitals=[],0===t.length)return;const n={session_id:this.sessionId,web_vitals:t,timestamp:Date.now()};this._sendToServer("/api/optima/web-vitals",n,{sync:e})},_setupEventListeners:function(){this.disabled||p(this)},_setupPerformanceObservers:function(){this.disabled||(this._setupCoreWebVitals(),this.captureResourceData("setup"))},captureResourceData:function(e="auto"){if(console.log(`[Optima Debug] captureResourceData called with source: ${e}`),this.disabled)return console.log("[Optima Debug] SDK is disabled, not capturing resources"),!1;const t=this.unifiedDataModel.resources?this.unifiedDataModel.resources.length:0;console.log(`[Optima Debug] Resources count before collection: ${t}`),this._collectResources();const n=this.unifiedDataModel.resources?this.unifiedDataModel.resources.length:0;return console.log(`[Optima Debug] Resources count after collection: ${n}`),console.log("[Optima Debug] Resources added: "+(n-t)),!0},_sendResourceBatch:function(e){return e&&e.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...e]),!0},createSession:function(){return g(this)},_sendToServer:function(e,t,n={}){if(!this.apiKey)return console.error("Optima SDK: API key not set. Cannot send data to server."),Promise.reject(new Error("API key not set"));const i=this.endpoint+e;if(n.sync&&navigator.sendBeacon){const e=new Blob([JSON.stringify(t)],{type:"application/json"}),n=navigator.sendBeacon(i,e);return Promise.resolve(n)}return e.includes("ajax-calls")&&t.ajax_calls&&t.ajax_calls.length>0&&t.ajax_calls.reduce(((e,t)=>(e[t.type]=(e[t.type]||0)+1,e)),{}),fetch(i,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),credentials:"include"}).then((e=>{if(!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()})).then((e=>!0)).catch((t=>(console.error(`[Optima Debug] Error sending data to ${e}:`,t),!1)))},sendEvent:function(e,t,n={}){if(this.disabled)return!1;if(!this.sessionId)return!1;const i={session_id:this.sessionId,event_type:e,event_data:t||{},timestamp:Date.now()};return"core_web_vital"===e?(this.buffer.webVitals.push(i),!0===n.immediate&&this._updateWebVitalsInUnifiedModel()):this.buffer.events.push(i),!0},collectPerformanceMetrics:function(){return this._collectResources(),this._updateWebVitalsInUnifiedModel(),!0},sendCollectedData:function(e=!1){return!this.disabled&&(this._prepareFinalDataAndSend(e),!0)},debug:function(){const e=t.location.pathname,n=this.unifiedDataModel.web_vitals.LCP;return{sessionId:this.sessionId,apiKey:this.apiKey?`${this.apiKey.substring(0,4)}...`:"None",endpoint:this.endpoint,currentRoute:e,lcpStatus:n?{value:n.value,path:n.path,pathMatch:n.path===e,element:n.element?.tagName||"unknown"}:"Not measured",forceResetLCP:()=>(console.log("[Optima LCP Debug] Forcing LCP reset from debug interface"),this._reinitializeLCP()),bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap||{}).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs?.size||0},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},_captureEarlyAjaxRequests:function(){if(!t.performance||!t.performance.getEntriesByType)return;const e=t.performance.getEntriesByType("resource"),n=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)),i=e.filter((e=>{if(n.includes(e))return!1;const t=e.name;if(t.includes("/api/")||t.includes("/graphql")||t.match(/\/(v1|v2|v3)\//)||t.includes("/rest/")||t.includes("/data/"))return!0;try{const e=new URL(t).pathname.split(".").pop();if(["json","xml","graphql"].includes(e))return!0}catch{}return!1})),s=[...new Set([...n,...i])];if(!s.length)return;const a=s.map((e=>{let t="GET";(e.name.includes("graphql")||e.transferSize>1e3)&&(t="POST");return{type:"fetch"===e.initiatorType?"fetch":"xhr",method:t,url:e.name,status:200,statusText:"OK",startTime:Math.round(e.startTime+performance.timeOrigin),duration:Math.round(e.duration),requestPayloadSize:-1,responseSize:Math.round(e.transferSize)||-1,decodedBodySize:Math.round(e.decodedBodySize)||-1,encodedBodySize:Math.round(e.encodedBodySize)||-1,aborted:!1,errored:!1,timestamp:Math.round(e.startTime+performance.timeOrigin),captureSource:"performance-timeline",resourceTiming:{startTime:Math.round(e.startTime),duration:Math.round(e.duration),domainLookupTime:Math.round(e.domainLookupEnd-e.domainLookupStart),connectTime:Math.round(e.connectEnd-e.connectStart),tlsTime:e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,requestStartTime:Math.round(e.requestStart),ttfb:Math.round(e.responseStart-e.requestStart),downloadTime:Math.round(e.responseEnd-e.responseStart),entryType:e.entryType,initiatorType:e.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transferSize>0?e.transferSize.toString():"unknown","cache-control":"unknown"}}})).filter((e=>!this._isOptimaApiCall(e.url)));0!==a.length&&(this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...a))},_isOptimaApiCall:function(e){return e.includes("/api/optima/sessions")||e.includes("/api/optima/events")||e.includes("/api/optima/resources")||e.includes("/api/optima/web-vitals")||e.includes("/api/optima/ajax-calls")||e.includes("/api/optima/collect")||e.includes("/api/sessions")||e.includes("/api/events")||e.includes("/api/resources")||e.includes("/api/web-vitals")||e.includes("/api/ajax-calls")||e.includes("/api/collect")||e.includes("optima.js")||e.includes("optima.min.js")},_processEarlyInterceptedRequests:function(){if(!t.__optima_early_xhr_queue||!t.__optima_early_xhr_queue.length)return;const e=t.__optima_early_xhr_queue;let n=[];t.performance&&t.performance.getEntriesByType&&(n=t.performance.getEntriesByType("resource"));const i=e.map((e=>{if(this._isOptimaApiCall(e.url)||e.responseURL&&this._isOptimaApiCall(e.responseURL))return null;let t=null;if(n.length>0){const i=e.url||"",s=n.filter((t=>t.name===i||e.responseURL&&t.name===e.responseURL||t.name.includes(new URL(i).pathname)||e.responseURL&&t.name.includes(new URL(e.responseURL).pathname)));if(s.length>0){const n=s.sort(((t,n)=>Math.abs(t.startTime+performance.timeOrigin-e.startTime)-Math.abs(n.startTime+performance.timeOrigin-e.startTime)))[0];n&&(t={startTime:Math.round(n.startTime),duration:Math.round(n.duration),domainLookupTime:Math.round(n.domainLookupEnd-n.domainLookupStart),connectTime:Math.round(n.connectEnd-n.connectStart),tlsTime:n.secureConnectionStart?Math.round(n.connectEnd-n.secureConnectionStart):0,requestStartTime:Math.round(n.requestStart),ttfb:Math.round(n.responseStart-n.requestStart),downloadTime:Math.round(n.responseEnd-n.responseStart),entryType:n.entryType,initiatorType:n.initiatorType,transferSize:n.transferSize||0,decodedBodySize:n.decodedBodySize||0})}}let i=e.responseSize;return(void 0===i||i<0)&&(i=t&&t.transferSize>0?t.transferSize:t&&t.decodedBodySize>0?t.decodedBodySize:-1),{type:e.type||"xhr",method:e.method||"GET",url:e.responseURL||e.url,originalUrl:e.url,status:e.status||0,statusText:e.statusText||"",startTime:e.startTime,endTime:e.endTime||e.startTime+(e.duration||0),duration:e.duration||0,async:!0,requestPayloadSize:e.requestSize||-1,responseSize:i,aborted:!!e.aborted,errored:!!e.error||!!e.errored,timestamp:e.timestamp||e.startTime,resourceTiming:t,captureSource:e.captureMethod||"early-intercept",requestHeaders:e.requestHeaders||{"content-type":"unknown","content-length":"unknown"},responseHeaders:e.responseHeaders||{"content-type":"unknown","content-length":i>0?i.toString():"unknown","cache-control":"unknown"}}})).filter(Boolean);0!==i.length&&(this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...i),t.__optima_early_xhr_queue=[])},_createSession:function(n,i,s={}){if(console.log("[Optima Debug] _createSession called with:",{pageUrl:n,referrer:i,additionalData:JSON.stringify(s)}),!this.apiKey)return void console.error("Optima SDK: API key not set. Cannot create session.");const a=t.navigator.userAgent,o=this._detectDeviceType(),r=this._detectConnectionType(),l=Date.now(),c=performance?.timing?.navigationStart||l;this.sessionId||(this.sessionId=e(),this.sessionStartTime=l),this._updateMetadata();const u={session_id:this.sessionId,page_url:n||t.location.href,referrer:i||document.referrer,user_agent:a,device_type:o,connection_type:r,timestamp:l,navigation_start:c,web_vitals:{},errors:[],resources:[],ajax_requests:[],meta:this.unifiedDataModel.meta};if(Object.keys(s).length>0){for(const e in s)u.meta[e]=s[e];console.log("[Optima Debug] Adding additional data to session meta:",JSON.stringify(s)),console.log("[Optima Debug] Final session meta:",JSON.stringify(u.meta))}s.routeChange?(console.log("[Optima Debug] This is a route change session"),console.log("[Optima Debug] Route change flag in meta:",u.meta.routeChange),console.log("[Optima Debug] Previous session ID in meta:",u.meta.previousSessionId)):console.log("[Optima Debug] This is a regular page load session"),this._sendToServer("/api/optima/sessions",u).then((e=>{e?(console.log("[Optima Debug] Session created successfully:",this.sessionId),this._startMonitoringInterval()):console.error("[Optima Debug] Session: Failed to create session")})).catch((e=>{console.error("[Optima Debug] Session: Error creating session",e)}))},_detectDeviceType:function(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&!t.MSStream||/android/i.test(e)?"mobile":/Tablet|iPad/i.test(e)?"tablet":"desktop"},_detectConnectionType:function(){return navigator.connection?navigator.connection.effectiveType:"unknown"},_startMonitoringInterval:function(){return this._monitoringInterval&&clearInterval(this._monitoringInterval),this._monitoringInterval=setInterval((()=>{this._collectResources(),this._updateWebVitalsInUnifiedModel(),this._hasSignificantData()&&this._prepareFinalDataAndSend(!1)}),1e4),!0},_flushAjaxCalls:function(e=!1){},_clearPerformanceBuffer:function(){console.log("[Optima Debug] Clearing performance buffer");try{t.performance&&"function"==typeof t.performance.clearResourceTimings&&(console.log("[Optima Debug] Clearing resource timings from performance buffer"),t.performance.clearResourceTimings(),console.log("[Optima Debug] Resource timing entries after clearing:",t.performance.getEntriesByType("resource").length)),console.log("[Optima Debug] Performance buffer cleared")}catch(e){console.error("[Optima Debug] Error clearing performance buffer:",e)}},_checkWebVitalsStatus:function(){const e=this.unifiedDataModel.web_vitals,n=t.location.pathname,i=e.LCP&&e.LCP.value,s=e.FCP&&e.FCP.value,a=e.CLS&&void 0!==e.CLS.value,o=e.FID&&e.FID.value,r=e.INP&&e.INP.value,l=e.TTFB&&e.TTFB.value,c=!e.LCP||!e.LCP.path||e.LCP.path===n,u=!e.CLS||!e.CLS.path||e.CLS.path===n,d=!e.FCP||!e.FCP.path||e.FCP.path===n;if(console.log("[Optima Debug] Current Web Vitals Status:"),console.log(`[Optima Debug] - Path: ${n}`),console.log(`[Optima Debug] - LCP: ${i?e.LCP.value+"ms":"Not measured yet"}${c?"":" (path mismatch)"}`),console.log(`[Optima Debug] - FCP: ${s?e.FCP.value+"ms":"Not measured yet"}${d?"":" (path mismatch)"}`),console.log(`[Optima Debug] - CLS: ${a?Number(e.CLS.value).toFixed(4):"Not measured yet"}${u?"":" (path mismatch)"}`),console.log("[Optima Debug] - FID: "+(o?e.FID.value+"ms":"Not measured yet")),console.log("[Optima Debug] - INP: "+(r?e.INP.value+"ms":"Not measured yet")),console.log("[Optima Debug] - TTFB: "+(l?e.TTFB.value+"ms":"Not measured yet")),a)console.log(`[Optima Debug] CLS Details: entries=${e.CLS.entries}, sessionValue=${e.CLS.sessionValue?.toFixed(4)}`);else{console.log("[Optima Debug] CLS ISSUE: No CLS value detected. Checking buffer for pending CLS metrics...");const e=this.buffer.webVitals.filter((e=>e.event_data&&"CLS"===e.event_data.name));if(console.log(`[Optima Debug] CLS events in buffer: ${e.length}`),t.PerformanceObserver&&t.PerformanceObserver.supportedEntryTypes&&t.PerformanceObserver.supportedEntryTypes.includes("layout-shift")){if(console.log("[Optima Debug] Browser supports layout-shift observations"),this.debug){console.log("[Optima Debug] Debug mode enabled: Creating a diagnostic layout shift");try{const e=document.createElement("div");e.id="optima-cls-test",e.style.width="100px",e.style.height="100px",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.background="transparent",e.style.zIndex="-1",document.body.appendChild(e),e.offsetHeight,setTimeout((()=>{e.style.top="20px",e.style.left="20px",setTimeout((()=>{document.getElementById("optima-cls-test")&&document.body.removeChild(e),setTimeout((()=>{const e=this.unifiedDataModel.web_vitals.CLS&&void 0!==this.unifiedDataModel.web_vitals.CLS.value;console.log(`[Optima Debug] After diagnostic shift, CLS detected: ${e}`),e||(console.log("[Optima Debug] CLS observation might be broken. Trying to reinitialize..."),this._setupCoreWebVitals())}),500)}),100)}),10)}catch(e){console.error("[Optima Debug] Error creating diagnostic layout shift:",e)}}}else console.log("[Optima Debug] WARNING: Browser does not support layout-shift observations")}return!0},_reinitializeLCP:function(){console.log("[Optima] Manually reinitializing LCP observer");const e=t.location.pathname,n=this.unifiedDataModel.web_vitals.LCP?{...this.unifiedDataModel.web_vitals.LCP}:null;console.log("[Optima] Current LCP state before reset: "+(n?`${n.value}ms for path: ${n.path}`:"null")),t.lcpObserver&&(t.lcpObserver.disconnect(),t.lcpObserver=null),"function"==typeof t.setupLCP&&(console.log(`[Optima] Calling setupLCP() for path: ${e}`),t.setupLCP(this),"function"==typeof t.forceLCPMeasurement&&setTimeout((()=>{console.log("[Optima] Forcing LCP measurement after reinitialization"),t.forceLCPMeasurement(this),setTimeout((()=>{const e=this.unifiedDataModel.web_vitals.LCP;console.log("[Optima] LCP after forced measurement: "+(e?`${e.value}ms for path: ${e.path}`:"null"))}),1e3)}),500))},_setupRouteChangeDetection:function(){console.log("[Optima] Setting up route change detection");let e=t.location.href,n=t.location.pathname;setInterval((()=>{const i=t.location.href,s=t.location.pathname;i!==e&&(console.log(`[Optima] Detected URL change: ${e} → ${i}`),s!==n?(console.log(`[Optima] Path changed: ${n} → ${s}`),this._handleRouteChange("interval_check")):console.log("[Optima] Only hash/query changed, not a full route change"),e=i,n=s)}),1e3)},_setupSession:function(){this.sessionId||(this.sessionId=this._generateUUID(),this.sessionStartTime=Date.now(),this._updateMetadata(),console.log(`[Optima] New session created: ${this.sessionId}`))},_setupErrorTracking:function(){t.addEventListener("error",(e=>{this._handleJSError(e)})),t.addEventListener("unhandledrejection",(e=>{this._handlePromiseRejection(e)})),console.log("[Optima] Error tracking initialized")},_setupConsoleTracking:function(){if(this.config.trackConsoleErrors){const e=console.error,t=console.warn,n=this;console.error=function(){e.apply(console,arguments),arguments.length>0&&n.sendEvent("console_error",{message:Array.from(arguments).map((e=>String(e))).join(" ")})},this.config.trackConsoleWarnings&&(console.warn=function(){t.apply(console,arguments),arguments.length>0&&n.sendEvent("console_warning",{message:Array.from(arguments).map((e=>String(e))).join(" ")})}),console.log("[Optima] Console tracking initialized")}},_setupNetworkTracking:function(){if(this.config.trackNetworkRequests){const e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send,n=this;XMLHttpRequest.prototype.open=function(t,n,i,s,a){return this._optimaRequestData={method:t,url:n,startTime:performance.now()},e.apply(this,arguments)},XMLHttpRequest.prototype.send=function(e){return this._optimaRequestData&&(this.addEventListener("load",(function(){const e=performance.now()-this._optimaRequestData.startTime;this._optimaRequestData.url.includes(n.apiEndpoint)||n.sendEvent("network_request",{url:this._optimaRequestData.url,method:this._optimaRequestData.method,status:this.status,duration:e,success:this.status>=200&&this.status<300})})),this.addEventListener("error",(function(){const e=performance.now()-this._optimaRequestData.startTime;this._optimaRequestData.url.includes(n.apiEndpoint)||n.sendEvent("network_error",{url:this._optimaRequestData.url,method:this._optimaRequestData.method,duration:e})}))),t.apply(this,arguments)}}if(t.fetch){const e=t.fetch;t.fetch=function(t,n){const i=performance.now(),s=n?.method||"GET",a="string"==typeof t?t:t.url;return e.apply(this,arguments).then((e=>{const t=performance.now()-i;return a.includes(sdk.apiEndpoint)||sdk.sendEvent("network_request",{url:a,method:s,status:e.status,duration:t,success:e.ok}),e})).catch((e=>{const t=performance.now()-i;throw a.includes(sdk.apiEndpoint)||sdk.sendEvent("network_error",{url:a,method:s,duration:t,message:e.message}),e}))}}console.log("[Optima] Network tracking initialized")}};var i=function(){var e=Array.prototype.slice.call(arguments),i=e[0];if("init"===i){var s=e[1]||null,a=e[2]||{};return a.apiKey=s,t.optimaInstance=new n(a),t.optimaInstance}if(!t.optimaInstance)return console.warn("[Optima Debug] Command executed before initialization:",i),!1;switch(i){case"event":return t.optimaInstance.sendEvent(e[1],e[2],e[3]);case"captureResources":return t.optimaInstance.captureResourceData("manual");case"flushBuffers":return t.optimaInstance.sendCollectedData(!0===e[1]);case"debug":return t.optimaInstance.debug();default:return console.warn("[Optima Debug] Unknown command:",i),!1}};t.Optima=n;var s=null;if("function"==typeof t.optima)if((s=t.optima).q&&s.q.length){t.optima=i;for(var a=0;a<s.q.length;a++)i.apply(t,s.q[a])}else t.optima=i;else t.optima=i}(window)}();
