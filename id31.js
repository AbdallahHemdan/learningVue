var optima=function(e){"use strict";function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}const i=["http://localhost:3000/api/optima/sessions","http://localhost:3000/api/optima/events","http://localhost:3000/api/optima/resources","http://localhost:3000/api/optima/web-vitals","http://localhost:3000/api/optima/ajax-calls","http://localhost:3000/api/optima/collect","http://localhost:3000/api/optima/","https://optimajs.com/api/optima/sessions","https://optimajs.com/api/optima/events","https://optimajs.com/api/optima/resources","https://optimajs.com/api/optima/web-vitals","https://optimajs.com/api/optima/ajax-calls","https://optimajs.com/api/optima/collect","https://optimajs.com/api/optima/","https://app.optimajs.com/api/optima/sessions","https://app.optimajs.com/api/optima/events","https://app.optimajs.com/api/optima/resources","https://app.optimajs.com/api/optima/web-vitals","https://app.optimajs.com/api/optima/ajax-calls","https://app.optimajs.com/api/optima/collect","https://app.optimajs.com/api/optima/","/api/optima/sessions","/api/optima/events","/api/optima/resources","/api/optima/web-vitals","/api/optima/ajax-calls","/api/optima/collect","/api/optima/","optima.js","optima.min.js","optima-sdk.js","optima-view-based.js","optima-view-based.min.js"],s=["nr-data.net","newrelic.com","datadoghq.com","browser-intake-datadoghq.com","browser-intake-us5-datadoghq.com","rum-intake-datadoghq.com","rum-intake-us5-datadoghq.com","datadoghq-browser-agent.com","debugbear.com","sentry.io","sentry-cdn.com","browser.sentry-cdn.com","o4504.ingest.sentry.io","segment.com","segment.io","api.segment.io","cdn-settings.segment.com","google-analytics.com","analytics.google.com","googletagmanager.com","stats.g.doubleclick.net","hotjar.com","static.hotjar.com","script.hotjar.com","clarity.ms","c.clarity.ms","www.clarity.ms","fullstory.com","rs.fullstory.com","edge.fullstory.com","logrocket.com","cdn.logrocket.com","cdn.lr-ingest.com","mixpanel.com","cdn.mxpnl.com","amplitude.com","api2.amplitude.com","cdn.amplitude.com","heapanalytics.com","cdn.heapanalytics.com","pendo.io","app.pendo.io","data.pendo.io","cdn.pendo.io","pingdom.net","rum-static.pingdom.net","dynatrace.com","js-cdn.dynatrace.com","speedcurve.com","cdn.speedcurve.com","lux.speedcurve.com"];function o(e,t={}){if(!e||"string"!=typeof e)return!1;const o=t.debug||!1;let n=e,r=null;try{r=new URL(e),n=r.origin+r.pathname,o&&console.log(`[Optima SDK] ğŸ”„ Normalized URL for exclusion check: ${n}`)}catch(t){o&&console.log(`[Optima SDK] âš ï¸ Could not normalize URL: ${e}, using as-is`)}o&&(console.group(`[Optima SDK] ğŸ” Checking URL against exclusion list: ${e}`),console.log(`[Optima SDK] ğŸ“‹ Optima exclusion list has ${i.length} patterns`));let a=null;if(i.some((t=>n===t?(a=`exact match: ${t}`,!0):n.includes(t)?(a=`contains: ${t}`,!0):!(e!==t&&!e.includes(t))&&(a=`original URL match: ${t}`,!0))))return console.log(`[Optima SDK] ğŸš« Optima URL excluded from processing: ${e} (${a})`),o&&console.groupEnd(),!0;const c=t.exclusionList||s;o&&(console.log(`[Optima SDK] ğŸ“‹ Using ${t.exclusionList?"custom":"default"} third-party exclusion list with ${c.length} patterns`),t.exclusionList&&console.log("[Optima SDK] ğŸ“‹ Custom exclusion list:",t.exclusionList));let l=null;return c.some((t=>n===t?(l=`exact match: ${t}`,!0):n.includes(t)?(l=`contains: ${t}`,!0):e===t||e.includes(t)?(l=`original URL match: ${t}`,!0):!(!r||r.hostname!==t&&!r.hostname.includes(t)&&!t.includes(r.hostname))&&(l=`domain match: ${t}`,!0)))?(console.log(`[Optima SDK] ğŸš« Third-party URL excluded from processing: ${e} (${l})`),o&&console.groupEnd(),!0):(o&&(console.log(`[Optima SDK] âœ… URL not in exclusion list: ${e}`),console.groupEnd()),!1)}function n(){const e=[];try{(window.React||document.querySelector("[data-reactroot], [data-reactid]")||Array.from(document.querySelectorAll("*")).some((e=>void 0!==e._reactRootContainer||Object.keys(e).some((e=>e.startsWith("__reactContainer"))))))&&e.push("react"),(document.querySelector("script[id=__NEXT_DATA__]")||window.__NEXT_DATA__||document.querySelector('[id="__next"]'))&&e.push("nextjs"),(document.querySelector("[id=___gatsby]")||window.___gatsby||document.querySelector('meta[name="generator"][content*="Gatsby"]'))&&e.push("gatsby");let t=!1;if((window.Vue||window.__VUE__)&&(t=!0),!t){Array.from(document.querySelectorAll("*")).some((e=>e.__vue_app__||e.__vue__||e._vnode||e.__vueParentComponent))&&(t=!0)}if(!t&&window.__VUE_DEVTOOLS_GLOBAL_HOOK__){const e=window.__VUE_DEVTOOLS_GLOBAL_HOOK__;(e.Vue||e.apps&&e.apps.size>0)&&(t=!0)}if(!t){const e=["[v-if]","[v-for]","[v-show]","[v-model]","[v-bind]","[v-on]","[v-else]","[v-else-if]","[v-cloak]","[v-once]","[v-pre]","[v-html]","[v-text]"];let i=!1;for(const t of e)if(document.querySelector(t)){i=!0;break}if(!i){const e=document.querySelectorAll("*");for(const t of e){if(Array.from(t.attributes).some((e=>e.name.startsWith("@")||e.name.startsWith(":")||e.name.startsWith("v-")))){i=!0;break}}}i&&(t=!0)}t||document.querySelector("[data-v-], [data-server-rendered]")&&(t=!0),t&&e.push("vue"),(window.$nuxt||document.querySelector("[data-n-head], [n-head]")||window.__NUXT__||document.querySelector('script[data-n-head], script[src*="_nuxt/"]')||document.querySelector('meta[name="generator"][content*="Nuxt"]'))&&e.push("nuxt"),(window.angular||document.querySelector(".ng-binding, [ng-app], [data-ng-app], [ng-controller], [data-ng-controller], [ng-repeat], [data-ng-repeat]")||document.querySelector('script[src*="angular.js"], script[src*="angular.min.js"]'))&&e.push("angularjs"),(window.getAllAngularRootElements||window.ng?.coreTokens?.NgZone||document.querySelector("[ng-version]")||document.querySelector("app-root, ng-component"))&&e.push("angular"),(document.querySelector("[data-svelte-h]")||document.querySelector("sveltekit-endpoint, sveltekit-app")||window.__SVELTEKIT__||document.querySelector('meta[name="generator"][content*="SvelteKit"]'))&&e.push("svelte"),window.Backbone&&e.push("backbone"),(window.Ember||document.querySelector("[data-ember-action]")||document.querySelector('meta[name="generator"][content*="Ember"]'))&&e.push("ember")}catch(e){console.warn("[ViewBasedOptima] Framework detection error:",e)}return e}class r{constructor(e={}){this.config={maxEntries:1e3,entryTtl:1e4,debug:e.debug||!1,...e},this.statusMap=new Map,this.originalMethods={},this.isInstrumented=!1,this.cleanupInterval=null,this.config.debug&&console.log("[Optima StatusTracker] ğŸ¯ Initializing status tracker")}start(){if(this.isInstrumented)console.warn("[Optima StatusTracker] âš ï¸ Already instrumented");else try{this.setupXHRInstrumentation(),this.setupFetchInstrumentation(),this.startCleanupTimer(),this.isInstrumented=!0,this.config.debug&&console.log("[Optima StatusTracker] âœ… Status tracking started")}catch(e){console.error("[Optima StatusTracker] âŒ Failed to start instrumentation:",e)}}stop(){if(this.isInstrumented)try{this.restoreXHRMethods(),this.restoreFetchMethod(),this.stopCleanupTimer(),this.statusMap.clear(),this.isInstrumented=!1,this.config.debug&&console.log("[Optima StatusTracker] â¹ï¸ Status tracking stopped")}catch(e){console.error("[Optima StatusTracker] âŒ Error stopping instrumentation:",e)}}setupXHRInstrumentation(){if(!window.XMLHttpRequest)return void(this.config.debug&&console.log("[Optima StatusTracker] âš ï¸ XMLHttpRequest not available"));this.originalMethods.xhrOpen=XMLHttpRequest.prototype.open,this.originalMethods.xhrSend=XMLHttpRequest.prototype.send;const e=this;XMLHttpRequest.prototype.open=function(t,i,s=!0,o,n){return this._optimaStatusData={method:t?t.toUpperCase():"GET",url:i,startTime:Date.now(),async:s},e.config.debug&&console.log(`[Optima StatusTracker] ğŸ“¤ XHR Open: ${t} ${i}`),e.originalMethods.xhrOpen.call(this,t,i,s,o,n)},XMLHttpRequest.prototype.send=function(t){const i=this._optimaStatusData;if(!i)return e.originalMethods.xhrSend.call(this,t);const s=()=>{const t=Date.now(),s=t-i.startTime;e.recordStatus(i.url,{status:0,statusText:"Network Error",method:i.method,duration:s,timestamp:t,error:"XHR request failed",type:"xhr"}),e.config.debug&&console.log(`[Optima StatusTracker] âŒ XHR Error: ${i.url}`)};return this.addEventListener("readystatechange",(()=>{if(this.readyState===XMLHttpRequest.DONE){const t=Date.now(),s=t-i.startTime,o={status:this.status,statusText:this.statusText,method:i.method,duration:s,timestamp:t,error:null,type:"xhr"};0===this.status&&(o.error="Network error or CORS issue"),e.recordStatus(i.url,o),e.config.debug&&console.log(`[Optima StatusTracker] ğŸ“¥ XHR Response: ${this.status} ${i.url} (${s}ms)`)}})),this.addEventListener("error",s),this.addEventListener("abort",s),this.addEventListener("timeout",s),e.originalMethods.xhrSend.call(this,t)}}setupFetchInstrumentation(){if(!window.fetch)return void(this.config.debug&&console.log("[Optima StatusTracker] âš ï¸ Fetch API not available"));this.originalMethods.fetch=window.fetch;const e=this;window.fetch=function(...t){const i=Date.now(),[s,o]=t;let n="",r="GET";return"string"==typeof s?n=s:s&&s.url&&(n=s.url),o&&o.method?r=o.method.toUpperCase():s&&s.method&&(r=s.method.toUpperCase()),e.config.debug&&console.log(`[Optima StatusTracker] ğŸ“¤ Fetch: ${r} ${n}`),e.originalMethods.fetch.apply(this,t).then((t=>{const s=Date.now(),o=s-i,a={status:t.status,statusText:t.statusText,method:r,duration:o,timestamp:s,error:null,type:"fetch"};return e.recordStatus(n,a),e.config.debug&&console.log(`[Optima StatusTracker] ğŸ“¥ Fetch Response: ${t.status} ${n} (${o}ms)`),t})).catch((t=>{const s=Date.now(),o=s-i;throw e.recordStatus(n,{status:0,statusText:"Network Error",method:r,duration:o,timestamp:s,error:t.message||"Fetch request failed",type:"fetch"}),e.config.debug&&console.log(`[Optima StatusTracker] âŒ Fetch Error: ${n} - ${t.message}`),t}))}}recordStatus(e,t){if(e)try{const i=`${e}:${t.timestamp}`;this.statusMap.set(i,{url:e,...t}),this.statusMap.size>this.config.maxEntries&&this.cleanup(!0)}catch(e){console.error("[Optima StatusTracker] âŒ Error recording status:",e)}}getStatus(e,t,i=2e3){if(!e)return null;try{let s=null,o=1/0;for(const[n,r]of this.statusMap.entries())if(r.url===e){const e=Math.abs(r.timestamp-t);e<=i&&e<o&&(s=r,o=e)}return s&&this.config.debug&&console.log(`[Optima StatusTracker] ğŸ¯ Found status for ${e}: ${s.status} (${o}ms diff)`),s}catch(e){return console.error("[Optima StatusTracker] âŒ Error getting status:",e),null}}startCleanupTimer(){this.cleanupInterval=setInterval((()=>{this.cleanup()}),3e4)}stopCleanupTimer(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}cleanup(e=!1){const t=Date.now(),i=this.config.entryTtl;let s=0;for(const[o,n]of this.statusMap.entries()){const r=t-n.timestamp;(e||r>i)&&(this.statusMap.delete(o),s++)}s>0&&this.config.debug&&console.log(`[Optima StatusTracker] ğŸ§¹ Cleaned up ${s} old entries. Map size: ${this.statusMap.size}`)}restoreXHRMethods(){this.originalMethods.xhrOpen&&this.originalMethods.xhrSend&&(XMLHttpRequest.prototype.open=this.originalMethods.xhrOpen,XMLHttpRequest.prototype.send=this.originalMethods.xhrSend)}restoreFetchMethod(){this.originalMethods.fetch&&(window.fetch=this.originalMethods.fetch)}getStats(){const e={totalEntries:this.statusMap.size,isInstrumented:this.isInstrumented,statusCodes:{},requestTypes:{},errors:0};for(const t of this.statusMap.values()){const i=t.status||0;e.statusCodes[i]=(e.statusCodes[i]||0)+1;const s=t.type||"unknown";e.requestTypes[s]=(e.requestTypes[s]||0)+1,t.error&&e.errors++}return e}getAllStatuses(){return Array.from(this.statusMap.values())}}class a{constructor(e){this.sdk=e,this.currentView=null,this.viewHistory=[],this.viewStartTime=null,this.maxViewHistory=10,this.statusTracker=null,this.initializeStatusTracker(),console.log("[Optima ViewManager] ğŸ—ï¸ ViewManager initialized")}initializeStatusTracker(){const e=this.sdk.config||{};if(!0!==e.disableStatusTracking)try{this.statusTracker=new r({debug:e.debug||!1,maxEntries:e.statusTrackerMaxEntries||1e3,entryTtl:e.statusTrackerTtl||1e4}),this.statusTracker.start(),e.debug&&console.log("[Optima ViewManager] âœ… Status tracker initialized and started")}catch(e){console.error("[Optima ViewManager] âŒ Failed to initialize status tracker:",e),this.statusTracker=null}else console.log("[Optima ViewManager] âš ï¸ Status tracking disabled by configuration")}createView(e,i,s,o=null,n=null){const r={id:t(),type:e,url:i,trigger:s,startTime:performance.now(),timestamp:Date.now(),duration:null,routeTriggerTime:n,interactionBaseline:o,webVitals:{LCP:null,FID:null,CLS:null,FCP:null,INP:null,TTFB:null,loading_time:null},resources:[],ajaxRequests:[],errors:[],events:[],isCompleted:!1,isActive:!0,lastActivityTime:Date.now(),completionReason:null,collectorState:{resourcesCollected:!1,webVitalsSetup:!1,errorsSetup:!1,eventsSetup:!1}};return console.log(`[Optima ViewManager] ğŸ“‹ Created ${e} view: ${r.id.substring(0,8)}... for ${i}`),n&&"number"==typeof n&&console.log(`[Optima ViewManager] â° Route trigger time: ${n.toFixed(2)}ms, view creation: ${r.startTime.toFixed(2)}ms (delay: ${(r.startTime-n).toFixed(2)}ms)`),o&&"number"==typeof o&&(console.log(`[Optima ViewManager] ğŸ¯ Interaction baseline: ${o.toFixed(2)}ms (${(r.startTime-o).toFixed(2)}ms before view creation)`),console.log(`[Optima ViewManager] âš¡ Baseline advantage: ${n&&"number"==typeof n?(n-o).toFixed(2):"N/A"}ms earlier filtering`)),r}startNewView(e,t,i=null,s=null){const o="initial"===e?"page_load":"pushstate";return console.log(`[Optima ViewManager] ğŸ”„ Starting new ${e} view: ${t} (trigger: ${o})`),this.sdk&&"function"==typeof this.sdk._resetPerformanceObservers&&this.sdk._resetPerformanceObservers(),this.currentView&&!this.currentView.isCompleted&&this.completeView("new_view_started"),this.currentView=this.createView(e,t,o,i,s),this.viewStartTime=this.currentView.startTime,this.resetCollectors(),this.updateActivity(),console.log(`[Optima ViewManager] âœ… Started new view: ${this.currentView.id.substring(0,8)}... (type: ${e}, url: ${t})`),this.sdk&&"function"==typeof this.sdk.startCollectorsForView?(console.log(`[Optima ViewManager] ğŸ”§ Starting collectors for ${this.currentView.type} view at ${performance.now().toFixed(2)}ms`),this.sdk.startCollectorsForView(this.currentView.type),this.sdk.continuousMetrics&&this.sdk.continuousMetrics.reset(),console.log(`[Optima ViewManager] âœ… Collectors started for ${this.currentView.type} view`)):console.warn("[Optima ViewManager] âš ï¸ No SDK or startCollectorsForView method available"),this.currentView}completeView(e="manual"){this.currentView&&!this.currentView.isCompleted?(console.log(`[Optima ViewManager] ğŸ Completing view: ${this.currentView.id.substring(0,8)}... (reason: ${e})`),this.currentView.isCompleted=!0,this.currentView.isActive=!1,this.currentView.completionReason=e,this.currentView.duration=Date.now()-this.currentView.timestamp,this.logViewSummary(this.currentView),this.archiveView(this.currentView),this.sdk&&"function"==typeof this.sdk._onViewCompleted&&this.sdk._onViewCompleted(this.currentView,e),console.log(`[Optima ViewManager] âœ… View completed: ${this.currentView.id.substring(0,8)}...`)):console.log("[Optima ViewManager] âš ï¸ No active view to complete or already completed")}archiveView(e){this.viewHistory.push({...e,resources:e.resources.length,ajaxRequests:e.ajaxRequests.length,errors:e.errors.length,events:e.events.length}),this.viewHistory.length>this.maxViewHistory&&this.viewHistory.shift(),console.log(`[Optima ViewManager] ğŸ“š Archived view to history. Total views: ${this.viewHistory.length}`)}resetCollectors(){this.currentView&&(console.log("[Optima ViewManager] ğŸ”„ Resetting collectors for new view"),this.currentView.collectorState={resourcesCollected:!1,webVitalsSetup:!1,errorsSetup:!1,eventsSetup:!1},this.sdk&&this.sdk.collectionState&&(this.sdk.collectionState.sentResourceURLs=new Set))}updateActivity(){this.currentView&&this.currentView.isActive&&(this.currentView.lastActivityTime=Date.now())}addResource(e){return this.currentView&&this.currentView.isActive?(e.name&&e.name.includes("releases.bundle.js")&&(console.log("[Optima ViewManager] ğŸ¯ LIFECYCLE - releases.bundle.js being added to view"),console.log("[Optima ViewManager] ğŸ¯ LIFECYCLE - View details:",{viewId:this.currentView.id.substring(0,8),viewType:this.currentView.type,currentResourceCount:this.currentView.resources.length,isActive:this.currentView.isActive}),console.log("[Optima ViewManager] ğŸ¯ LIFECYCLE - Resource details:",{name:e.name,type:e.type,size:e.transfer_size,startTime:e.start_time,duration:e.duration})),e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.resources.push(e),this.updateActivity(),e.name&&e.name.includes("releases.bundle.js")&&(console.log("[Optima ViewManager] ğŸ¯ LIFECYCLE SUCCESS - releases.bundle.js added to view resources"),console.log(`[Optima ViewManager] ğŸ¯ LIFECYCLE - New resource count: ${this.currentView.resources.length}`),console.log("[Optima ViewManager] ğŸ¯ LIFECYCLE - Resource now in view.resources array at index: "+(this.currentView.resources.length-1))),!0):(console.warn("[Optima ViewManager] âš ï¸ No active view to add resource to"),!1)}addAjaxRequest(e){return this.currentView&&this.currentView.isActive?(e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.ajaxRequests.push(e),this.updateActivity(),!0):(console.warn("[Optima ViewManager] âš ï¸ No active view to add AJAX request to"),!1)}addError(e){return this.currentView&&this.currentView.isActive?(e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.errors.push(e),this.updateActivity(),!0):(console.warn("[Optima ViewManager] âš ï¸ No active view to add error to"),!1)}addEvent(e){return this.currentView&&this.currentView.isActive?(e.viewId=this.currentView.id,e.viewType=this.currentView.type,this.currentView.events.push(e),this.updateActivity(),!0):(console.warn("[Optima ViewManager] âš ï¸ No active view to add event to"),!1)}updateWebVital(e,t,i={}){return this.currentView&&this.currentView.isActive?(this.currentView.webVitals[e]={value:t,timestamp:Date.now(),viewRelativeTime:performance.now()-this.currentView.startTime,...i},this.updateActivity(),this.sdk&&this.sdk.continuousMetrics&&this.sdk.continuousMetrics.onWebVitalDetected(e,t),!0):(console.warn("[Optima ViewManager] âš ï¸ No active view to update web vital"),!1)}getCurrentViewData(){return this.currentView?{...this.currentView,resourceCount:this.currentView.resources.length,ajaxCount:this.currentView.ajaxRequests.length,errorCount:this.currentView.errors.length,eventCount:this.currentView.events.length}:null}logViewSummary(e){const t={id:e.id.substring(0,8)+"...",type:e.type,url:e.url,duration:e.duration,resources:e.resources.length,ajaxRequests:e.ajaxRequests.length,errors:e.errors.length,events:e.events.length,webVitals:Object.keys(e.webVitals).filter((t=>e.webVitals[t]?.value)).length};console.log("[Optima ViewManager] ğŸ“Š View Summary:",t)}getViewHistory(){return this.viewHistory}isViewStale(e=3e4){if(!this.currentView||!this.currentView.isActive)return!1;return Date.now()-this.currentView.lastActivityTime>e}completeStaleView(){this.isViewStale()&&(console.log("[Optima ViewManager] â° Completing stale view"),this.completeView("stale_timeout"))}getResourceCollectionDebug(){return this.sdk&&this.sdk.resourceCollector?this.sdk.resourceCollector.getDebugInfo():null}getStatusTrackerStats(){return this.statusTracker?this.statusTracker.getStats():null}cleanup(){if(console.log("[Optima ViewManager] ğŸ§¹ Cleaning up ViewManager"),this.currentView&&this.currentView.isActive&&this.completeView("cleanup"),this.statusTracker)try{this.statusTracker.stop(),this.statusTracker=null,console.log("[Optima ViewManager] âœ… Status tracker cleaned up")}catch(e){console.error("[Optima ViewManager] âŒ Error cleaning up status tracker:",e)}this.viewHistory=[],this.currentView=null,this.viewStartTime=null}}class c{constructor(e){this.viewManager=e,this.currentUrl=window.location.href,this.isSetup=!1,this.lastUserInteractionTime=null,this.lastUserInteractionType=null,this.userInteractionTimeout=5e3,console.log("[Optima RouteDetector] ğŸ›£ï¸ Route detector initialized")}setupRouteDetection(){this.isSetup?console.warn("[Optima RouteDetector] âš ï¸ Route detection already setup"):(console.log("[Optima RouteDetector] ğŸ”§ Setting up route change detection"),this.setupUserInteractionTracking(),this.patchHistoryAPI(),this.setupPopstateListener(),this.setupHashchangeListener(),this.setupMutationObserver(),this.isSetup=!0,console.log("[Optima RouteDetector] âœ… Route detection setup complete"))}setupUserInteractionTracking(){console.log("[Optima RouteDetector] ğŸ‘† Setting up user interaction tracking"),document.addEventListener("click",(e=>{this.recordUserInteraction("click",e)}),{capture:!0,passive:!0}),document.addEventListener("touchstart",(e=>{this.recordUserInteraction("touchstart",e)}),{capture:!0,passive:!0}),document.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||!this.isNavigationElement(e.target)||this.recordUserInteraction("keydown",e)}),{capture:!0,passive:!0}),console.log("[Optima RouteDetector] âœ… User interaction tracking setup complete")}recordUserInteraction(e,t){const i=performance.now();this.isNavigationElement(t.target)&&(this.lastUserInteractionTime=i,this.lastUserInteractionType=e,console.log(`[Optima RouteDetector] ğŸ‘† User interaction recorded: ${e} at ${i.toFixed(2)}ms on`,{tagName:t.target.tagName,className:t.target.className,id:t.target.id,href:t.target.href,textContent:t.target.textContent?.substring(0,50)}))}isNavigationElement(e){if(!e||!e.tagName)return!1;const t=e.tagName.toLowerCase();if("a"===t||"button"===t)return!0;if(e.hasAttribute("href")||e.hasAttribute("onclick")||e.hasAttribute("data-href")||e.hasAttribute("data-route"))return!0;const i=e.className||"";if("string"==typeof i&&(i.includes("nav")||i.includes("link")||i.includes("button")||i.includes("menu")||i.includes("tab")))return!0;let s=e.parentElement,o=0;for(;s&&o<3;){if(this.isNavigationElement(s))return!0;s=s.parentElement,o++}return!1}getRecentUserInteractionTime(e){if(!this.lastUserInteractionTime)return null;return e-this.lastUserInteractionTime<=this.userInteractionTimeout?this.lastUserInteractionTime:null}patchHistoryAPI(){const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{const i=performance.now();e.apply(history,t),this.handleRouteChange("pushstate",window.location.href,i)},history.replaceState=(...e)=>{const i=performance.now();t.apply(history,e),this.handleRouteChange("replacestate",window.location.href,i)},console.log("[Optima RouteDetector] ğŸ”§ History API patched")}setupPopstateListener(){window.addEventListener("popstate",(e=>{const t=performance.now();this.handleRouteChange("popstate",window.location.href,t)})),console.log("[Optima RouteDetector] ğŸ”§ Popstate listener setup")}setupHashchangeListener(){window.addEventListener("hashchange",(e=>{const t=performance.now();this.handleRouteChange("hashchange",window.location.href,t)})),console.log("[Optima RouteDetector] ğŸ”§ Hashchange listener setup")}setupMutationObserver(){if(!("MutationObserver"in window))return void console.warn("[Optima RouteDetector] âš ï¸ MutationObserver not supported");const e=new MutationObserver((e=>{let t=!1;const i=performance.now();e.forEach((e=>{if("childList"===e.type&&e.addedNodes.length>0){Array.from(e.addedNodes).some((e=>e.nodeType===Node.ELEMENT_NODE&&("MAIN"===e.tagName||"SECTION"===e.tagName||"ARTICLE"===e.tagName||e.classList.contains("page")||e.classList.contains("view")||e.classList.contains("route"))))&&(t=!0)}})),t&&window.location.href!==this.currentUrl&&(console.log("[Optima RouteDetector] ğŸ”„ Potential route change detected via DOM mutation"),setTimeout((()=>{this.handleRouteChange("mutation_observer",window.location.href,i)}),50))}));document.body?(e.observe(document.body,{childList:!0,subtree:!0,attributes:!1}),console.log("[Optima RouteDetector] ğŸ”§ Mutation observer setup")):document.addEventListener("DOMContentLoaded",(()=>{e.observe(document.body,{childList:!0,subtree:!0,attributes:!1}),console.log("[Optima RouteDetector] ğŸ”§ Mutation observer setup (after DOMContentLoaded)")}))}handleRouteChange(e,t,i=null){const s=i||performance.now();if(t!==this.currentUrl)if(this.isMeaningfulRouteChange(this.currentUrl,t))try{this.getRecentUserInteractionTime(s);const i=this.canUseInteractionTimeAsBaseline(),o=i?this.lastUserInteractionTime:null;if(console.group(`%cğŸ›£ï¸ Route Change Detected %c${e.toUpperCase()}`,"color: #10b981; font-weight: bold; font-size: 14px;","color: #ffffff; background: #10b981; padding: 2px 6px; border-radius: 4px; font-size: 12px;"),console.log("%cğŸ“Š Route Change Details:","color: #6b7280; font-weight: bold;"),console.table({Method:e,"From URL":this.currentUrl,"To URL":t,"Route Trigger Time":`${s.toFixed(2)}ms`,"Interaction Baseline":o?`${o.toFixed(2)}ms`:"Not available","Using Interaction Baseline":i}),o){const e=s-o;console.log(`âš¡ Baseline advantage: ${e.toFixed(2)}ms earlier filtering (interaction vs route trigger)`),console.log(`ğŸ‘† Last interaction: ${this.lastUserInteractionType} at ${o.toFixed(2)}ms`)}console.groupEnd(),this.currentUrl=t,this.viewManager.startNewView("route_change",t,o,s)}catch(e){console.error("[Optima RouteDetector] âŒ Error processing route change:",e)}else this.currentUrl=t}logInteractionAnalysis(e,t,i){if(console.log(`[Optima RouteDetector] ğŸ” INTERACTION ANALYSIS for ${i} route change:`),t){const i=e-t;console.log("[Optima RouteDetector] âœ… Recent user interaction found!"),console.log(`[Optima RouteDetector] ğŸ‘† Last interaction: ${this.lastUserInteractionType} at ${t.toFixed(2)}ms`),console.log(`[Optima RouteDetector] â±ï¸ Interaction-to-route delay: ${i.toFixed(2)}ms`),console.log("[Optima RouteDetector] ğŸ¯ CAN USE INTERACTION TIME AS BASELINE: YES"),console.log(`[Optima RouteDetector] ğŸ“Š Proposed filter time: ${t.toFixed(2)}ms (interaction time)`),i<100?console.log("[Optima RouteDetector] âš¡ Category: IMMEDIATE (< 100ms) - Very likely user-initiated"):i<500?console.log("[Optima RouteDetector] ğŸš€ Category: FAST (100-500ms) - Likely user-initiated"):i<1e3?console.log("[Optima RouteDetector] ğŸŒ Category: SLOW (500-1000ms) - Possibly user-initiated with framework delay"):console.log("[Optima RouteDetector] ğŸ¦´ Category: VERY SLOW (> 1000ms) - User-initiated but significant framework delay")}else if(console.log("[Optima RouteDetector] âŒ No recent user interaction found"),console.log("[Optima RouteDetector] ğŸ¯ CAN USE INTERACTION TIME AS BASELINE: NO"),this.lastUserInteractionTime){const t=e-this.lastUserInteractionTime;console.log(`[Optima RouteDetector] ğŸ‘† Last interaction: ${this.lastUserInteractionType} at ${this.lastUserInteractionTime.toFixed(2)}ms`),console.log(`[Optima RouteDetector] â±ï¸ Time since last interaction: ${t.toFixed(2)}ms (too old - threshold: ${this.userInteractionTimeout}ms)`),console.log("[Optima RouteDetector] ğŸ“Š Will use fallback: route trigger time - grace period")}else console.log("[Optima RouteDetector] ğŸ‘† No user interactions recorded yet"),console.log("[Optima RouteDetector] ğŸ“Š Will use fallback: route trigger time - grace period")}analyzeInteractionTiming(e,t){console.log(`[Optima RouteDetector] ğŸ” INTERACTION ANALYSIS for ${e} route change:`);const i=this.getRecentUserInteractionTime(t);if(i){const e=t-i;console.log("[Optima RouteDetector] âœ… Recent user interaction found!"),console.log(`[Optima RouteDetector] ğŸ‘† Last interaction: ${this.lastUserInteractionType} at ${i.toFixed(2)}ms`),console.log(`[Optima RouteDetector] â±ï¸ Interaction-to-route delay: ${e.toFixed(2)}ms`);const s=e<=this.userInteractionTimeout;console.log("[Optima RouteDetector] ğŸ¯ CAN USE INTERACTION TIME AS BASELINE: "+(s?"YES":"NO")),s?(console.log(`[Optima RouteDetector] ğŸ“Š Proposed filter time: ${i.toFixed(2)}ms (interaction time)`),e<100?console.log("[Optima RouteDetector] âš¡ Category: IMMEDIATE (< 100ms) - Very likely user-initiated"):e<500?console.log("[Optima RouteDetector] ğŸš€ Category: FAST (100-500ms) - User-initiated with normal framework delay"):e<1e3?console.log("[Optima RouteDetector] ğŸŒ Category: SLOW (500-1000ms) - User-initiated but slow framework"):console.log("[Optima RouteDetector] ğŸ¦´ Category: VERY SLOW (> 1000ms) - User-initiated but significant framework delay")):(console.log(`[Optima RouteDetector] âŒ Interaction too old (${e.toFixed(2)}ms > ${this.userInteractionTimeout}ms)`),console.log(`[Optima RouteDetector] ğŸ“Š Will use route trigger time: ${t.toFixed(2)}ms`))}else console.log("[Optima RouteDetector] âŒ No recent user interaction found"),console.log(`[Optima RouteDetector] ğŸ“Š Will use route trigger time: ${t.toFixed(2)}ms`),console.log("[Optima RouteDetector] ğŸ¤– Likely programmatic navigation")}canUseInteractionTimeAsBaseline(){if(!this.lastUserInteractionTime)return!1;return performance.now()-this.lastUserInteractionTime<=this.userInteractionTimeout}isMeaningfulRouteChange(e,t){try{const i=new URL(e),s=new URL(t);return i.origin!==s.origin?(console.log("[Route detector**]: #1"),!0):i.pathname!==s.pathname?(console.log("[Route detector**]: #2"),!0):i.hash!==s.hash&&(i.hash.length>1||s.hash.length>1)&&(console.log("[Route detector**]: #3"),!0)}catch(e){return console.error("[Optima RouteDetector] âŒ Error parsing URLs for comparison:",e),!0}}triggerRouteChange(e,t="manual"){console.log(`[Optima RouteDetector] ğŸ”§ Manual route change triggered: ${e}`);const i=performance.now();console.log("ğŸ˜ğŸ˜ 5",i),this.handleRouteChange(t,e,i)}getCurrentUrl(){return this.currentUrl}isRouteDetectionSetup(){return this.isSetup}syncUrl(){const e=window.location.href;e!==this.currentUrl&&(console.log("[Optima RouteDetector] ğŸ”„ Syncing URL:",e),this.currentUrl=e)}cleanup(){console.log("[Optima RouteDetector] ğŸ§¹ Cleaning up route detection"),this.isSetup=!1}}class l{constructor(e){this.sdk=e,this.sendQueue=[],this.batchTimer=null,this.maxBatchSize=3,this.batchTimeout=5e3,this.isProcessing=!1,this.createdViewSessions=new Set,console.log("[Optima DataSender] ğŸ“¤ Data sender initialized")}sendViewData(e,t="completed"){if(!e||!this.sdk.sessionId)return void console.warn("[Optima DataSender] âš ï¸ Cannot send view data: missing view or session");console.log(`[Optima DataSender] ğŸ“¦ Preparing to send view data: ${e.id.substring(0,8)}... (trigger: ${t})`),this.createdViewSessions.add(e.id);const i=this.formatViewPayload(e,t);this.shouldSendImmediately(t,e.type)?this.sendImmediate(i):this.queueForBatch(i)}formatViewPayload(e,t){if(console.log(`[Optima DataSender] ğŸ” Formatting payload for view: ${e.id.substring(0,8)}...`),console.log("[Optima DataSender] ğŸ“Š View data summary:",{resources:e.resources?.length||0,ajaxRequests:e.ajaxRequests?.length||0,errors:e.errors?.length||0,events:e.events?.length||0,webVitals:Object.keys(e.webVitals||{}).length}),e.resources&&e.resources.length>0){console.log(`[Optima DataSender] ğŸ“¦ RESOURCES TO SEND (${e.resources.length}):`),e.resources.forEach(((t,i)=>{const s=t.name&&(t.name.endsWith(".js")||t.name.includes(".bundle."))?"ğŸŸ¨ JS/BUNDLE":"ğŸ“„ RESOURCE";console.log(`[Optima DataSender] ${s} ${i+1}: ${t.name||"unknown"} (type: ${t.initiatorType||"unknown"}, size: ${t.transferSize||0})`),t.name&&t.name.includes("releases.bundle.js")&&console.log("[Optima DataSender] ğŸ¯ FOUND releases.bundle.js! Details:",{name:t.name,type:t.initiatorType,size:t.transferSize,startTime:t.startTime,duration:t.duration,viewId:e.id.substring(0,8)})}));const t=e.resources.filter((e=>e.name&&(e.name.endsWith(".js")||e.name.includes(".bundle."))));console.log(`[Optima DataSender] ğŸŸ¨ JS/Bundle files in payload: ${t.length}/${e.resources.length}`)}else console.log(`[Optima DataSender] âš ï¸ NO RESOURCES to send for view ${e.id.substring(0,8)}`);return{session_id:this.sdk.sessionId,session_type:e.type,view_id:e.id,trigger:t,timestamp:e.timestamp,url:e.url,duration:e.duration,completion_reason:e.completionReason,web_vitals:this.formatWebVitals(e.webVitals,e.type),resources:e.resources||[],ajax_requests:e.ajaxRequests||[],errors:e.errors||[],events:e.events||[],meta:this.sdk.generateMetadata(),view_metadata:{start_time:e.startTime,last_activity:e.lastActivityTime,resource_count:e.resources?.length||0,ajax_count:e.ajaxRequests?.length||0,error_count:e.errors?.length||0,event_count:e.events?.length||0,web_vitals_count:Object.keys(e.webVitals).filter((t=>e.webVitals[t]?.value)).length},send_timestamp:Date.now(),send_strategy:this.shouldSendImmediately(t,e.type)?"immediate":"batch"}}formatWebVitals(e,t){const i={},s=["LCP","FCP","FID","TTFB"];return console.log(`[Optima DataSender] ğŸ” Formatting web vitals for ${t} session:`),Object.keys(e).forEach((o=>{if(null!==e[o]?.value&&void 0!==e[o]?.value){if("route_change"===t&&s.includes(o))return void console.log(`[Optima DataSender] ğŸš« Filtering out ${o} for route change session`);console.log(`[Optima DataSender] âœ… Including ${o} = ${e[o].value} for ${t}`),i[o]={value:e[o].value,timestamp:e[o].timestamp,view_relative_time:e[o].viewRelativeTime,...e[o]}}else console.log(`[Optima DataSender] âš ï¸ Skipping ${o} - no valid value (${e[o]?.value})`)})),console.log(`[Optima DataSender] ğŸ“Š Final formatted web vitals count: ${Object.keys(i).length}`),i}shouldSendImmediately(e,t){return"new_view_started"===e&&"route_change"===t||("route_change_trigger"===e||("page_unload"===e||"page_hidden"===e||("error"===e||"critical_error"===e)))}sendImmediate(e){console.log(`[Optima DataSender] ğŸš€ Sending immediately: ${e.view_id.substring(0,8)}...`),this.performSend(e,{immediate:!0,sync:"page_unload"===e.trigger||"page_hidden"===e.trigger})}queueForBatch(e){console.log(`[Optima DataSender] ğŸ“‹ Queuing for batch: ${e.view_id.substring(0,8)}...`),this.sendQueue.push(e),this.sendQueue.length>=this.maxBatchSize?this.processBatchQueue():this.setBatchTimer()}setBatchTimer(){this.batchTimer&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout((()=>{this.processBatchQueue()}),this.batchTimeout)}processBatchQueue(){if(0===this.sendQueue.length||this.isProcessing)return;console.log(`[Optima DataSender] ğŸ“¦ Processing batch queue: ${this.sendQueue.length} items`),this.isProcessing=!0,this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);const e=[...this.sendQueue];this.sendQueue=[],e.forEach(((t,i)=>{setTimeout((()=>{this.performSend(t,{batch:!0,batchIndex:i,batchSize:e.length})}),100*i)})),setTimeout((()=>{this.isProcessing=!1}),100*e.length+500)}performSend(e,t={}){try{e.send_options={immediate:t.immediate||!1,sync:t.sync||!1,batch:t.batch||!1,batch_index:t.batchIndex,batch_size:t.batchSize};const i=e.type||"view_completion",s=e.session_type||"unknown",o=t.immediate?"immediate":"batch";console.log(`[Optima DataSender] ğŸ“¤ SENDING ${i.toUpperCase()}: view=${e.view_id.substring(0,8)}..., session_type=${s}, method=${o}`),e.trigger&&console.log(`[Optima DataSender] ğŸ” Trigger: ${e.trigger}`),this.sdk._sendToServer("/api/optima/collect",e,{sync:t.sync,immediate:t.immediate}),console.log(`[Optima DataSender] âœ… SENT ${i.toUpperCase()}: view=${e.view_id.substring(0,8)}..., session_type=${s}`)}catch(i){if(console.error("[Optima DataSender] âŒ Error sending view data:",i),t.immediate&&!t.sync){console.log("[Optima DataSender] ğŸ”„ Retrying with sync send");try{this.sdk._sendToServer("/api/optima/collect",e,{sync:!0})}catch(e){console.error("[Optima DataSender] âŒ Fallback send also failed:",e)}}}}sendContinuousUpdate(e){if(!e||!this.sdk.sessionId)return void console.warn("[Optima DataSender] âš ï¸ Cannot send continuous update: missing data or session");if(console.log(`[Optima DataSender] ğŸ“Š Preparing continuous update for view: ${e.view_id.substring(0,8)}...`),console.log(`[Optima DataSender] ğŸ“Š Update includes (ALL from view session start): web_vitals=${Object.keys(e.web_vitals||{}).length}, resources=${(e.resources||[]).length}, ajax=${(e.ajax_requests||[]).length}, errors=${(e.errors||[]).length}`),e.resources&&e.resources.length>0){console.log(`[Optima DataSender] ğŸ“¦ CONTINUOUS UPDATE - ALL RESOURCES FROM VIEW SESSION START (${e.resources.length}):`),e.resources.forEach(((t,i)=>{const s=t.name&&(t.name.endsWith(".js")||t.name.includes(".bundle."))?"ğŸŸ¨ JS/BUNDLE":"ğŸ“„ RESOURCE";console.log(`[Optima DataSender] ${s} ${i+1}: ${t.name||"unknown"} (type: ${t.initiatorType||"unknown"}, size: ${t.transferSize||0})`),t.name&&t.name.includes("releases.bundle.js")&&console.log("[Optima DataSender] ğŸ¯ CONTINUOUS UPDATE - FOUND releases.bundle.js! Details:",{name:t.name,type:t.initiatorType,size:t.transferSize,startTime:t.startTime,duration:t.duration,viewId:e.view_id.substring(0,8),updateType:"continuous_all_from_view_start"})}));const t=e.resources.filter((e=>e.name&&(e.name.endsWith(".js")||e.name.includes(".bundle."))));console.log(`[Optima DataSender] ğŸŸ¨ JS/Bundle files in continuous update (ALL from view start): ${t.length}/${e.resources.length}`)}const t=this.sdk.viewManager?.currentView,i=this.createdViewSessions.has(e.view_id),s=t?.type||"initial",o={session_id:this.sdk.sessionId,session_type:s,view_id:e.view_id,type:"continuous_update",web_vitals:this.formatWebVitals(e.web_vitals||{},s),resources:e.resources||[],ajax_requests:e.ajax_requests||[],errors:e.errors||[],timestamp:e.timestamp,send_timestamp:Date.now(),is_update_only:i,meta:this.sdk.generateMetadata()};console.log(`[Optima DataSender] ğŸ” View session exists: ${i}, is_update_only: ${i}`),i||this.createdViewSessions.add(e.view_id),i?(console.log(`[Optima DataSender] â³ Delaying performSend by 3 seconds for existing session view: ${e.view_id.substring(0,8)}...`),setTimeout((()=>{this.performSend(o,{immediate:!0,sync:!1})}),3e3)):this.performSend(o,{immediate:!0,sync:!1})}forceFlush(){console.log("[Optima DataSender] ğŸš¨ Force flushing all queued data"),this.sendQueue.length>0&&(this.sendQueue.forEach((e=>{e.trigger="force_flush",this.performSend(e,{immediate:!0,sync:!0})})),this.sendQueue=[]),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null)}getQueueStatus(){return{queueLength:this.sendQueue.length,isProcessing:this.isProcessing,hasBatchTimer:!!this.batchTimer,maxBatchSize:this.maxBatchSize,batchTimeout:this.batchTimeout}}updateConfig(e){e.maxBatchSize&&(this.maxBatchSize=e.maxBatchSize),e.batchTimeout&&(this.batchTimeout=e.batchTimeout),console.log("[Optima DataSender] âš™ï¸ Configuration updated:",{maxBatchSize:this.maxBatchSize,batchTimeout:this.batchTimeout})}markViewCompleted(e){this.createdViewSessions.has(e)&&(console.log(`[Optima DataSender] âœ… Marking view as completed: ${e.substring(0,8)}...`),setTimeout((()=>{this.createdViewSessions.delete(e),console.log(`[Optima DataSender] ğŸ§¹ Cleaned up view tracking: ${e.substring(0,8)}...`)}),3e4))}cleanup(){console.log("[Optima DataSender] ğŸ§¹ Cleaning up data sender"),this.forceFlush(),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.createdViewSessions.clear(),this.isProcessing=!1}}class u{constructor(e,t){this.viewManager=e,this.dataSender=t,this.updateInterval=null,this.lastSentMetrics={},this.updateIntervalMs=1e4,this.isTracking=!1,this.significantChangeThresholds={CLS:.01,INP:50},console.log("[Optima ContinuousMetrics] ğŸ“Š Continuous metrics manager initialized")}startContinuousTracking(){this.isTracking?console.warn("[Optima ContinuousMetrics] âš ï¸ Continuous tracking already started"):(console.log("[Optima ContinuousMetrics] ğŸš€ Starting continuous metrics tracking"),this.isTracking=!0,this.lastSentMetrics={},this.updateInterval=setInterval((()=>{this.checkAndSendUpdates()}),this.updateIntervalMs),this.setupChangeDetection())}stopContinuousTracking(){this.isTracking&&(console.log("[Optima ContinuousMetrics] ğŸ›‘ Stopping continuous metrics tracking"),this.isTracking=!1,this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this.lastSentMetrics={})}setupChangeDetection(){this.setupCLSChangeDetection(),this.setupINPChangeDetection()}setupCLSChangeDetection(){if("PerformanceObserver"in window)try{new PerformanceObserver((e=>{if(!this.isTracking||!this.viewManager.currentView?.isActive)return;const t=e.getEntries();let i=!1;t.forEach((e=>{e.hadRecentInput||(i=!0)})),i&&setTimeout((()=>{this.checkAndSendUpdates()}),1e3)})).observe({type:"layout-shift",buffered:!1})}catch(e){console.error("[Optima ContinuousMetrics] âŒ Error setting up CLS change detection:",e)}}setupINPChangeDetection(){["click","keydown","pointerdown"].forEach((e=>{document.addEventListener(e,(()=>{this.isTracking&&this.viewManager.currentView?.isActive&&setTimeout((()=>{this.checkForINPUpdate()}),500)}),{passive:!0})}))}checkForINPUpdate(){if(!this.viewManager.currentView?.isActive)return;const e=this.viewManager.currentView.webVitals.INP?.value,t=this.lastSentMetrics.INP;e&&this.hasSignificantINPChange(e,t)&&(console.log("[Optima ContinuousMetrics] ğŸ–±ï¸ Significant INP change detected, sending update"),this.sendContinuousUpdate())}checkAndSendUpdates(){if(!this.isTracking||!this.viewManager.currentView?.isActive)return;const e=this.getCurrentContinuousMetrics();this.hasSignificantChanges(e)&&(console.log("[Optima ContinuousMetrics] ğŸ“Š Significant changes detected, sending update"),this.sendContinuousUpdate())}getCurrentContinuousMetrics(){if(!this.viewManager.currentView)return{};const e=this.viewManager.currentView,t=e.webVitals,i="initial"===e.type,s=["LCP","FCP","FID","TTFB"],o={webVitals:{},resourceCount:e.resources?.length||0,ajaxCount:e.ajaxRequests?.length||0,errorCount:e.errors?.length||0};return["CLS","INP","loading_time"].forEach((e=>{o.webVitals[e]=t[e]?.value||null})),i?s.forEach((e=>{o.webVitals[e]=t[e]?.value||null})):(s.forEach((e=>{o.webVitals[e]=null})),console.log("[Optima ContinuousMetrics] ğŸš« Excluding initial-load-only metrics for route change view")),o}hasSignificantChanges(e){const t=this.lastSentMetrics;return!!this.hasSignificantWebVitalsChange(e.webVitals,t.webVitals)||(!!this.hasSignificantDataChange(e,t)||!(0!==Object.keys(t).length||!this.hasAnyData(e)))}hasSignificantWebVitalsChange(e,t={}){if(this.hasSignificantCLSChange(e.CLS,t.CLS))return!0;if(this.hasSignificantINPChange(e.INP,t.INP))return!0;const i=["LCP","FCP","FID","TTFB","loading_time"];for(const s of i)if(null!==e[s]&&(null===t[s]||void 0===t[s]))return console.log(`[Optima ContinuousMetrics] ğŸ†• New ${s} detected: ${e[s]}`),!0;return!1}hasSignificantDataChange(e,t={}){return e.resourceCount>(t.resourceCount||0)&&e.resourceCount-(t.resourceCount||0)>=5?(console.log(`[Optima ContinuousMetrics] ğŸ“¦ Significant resource increase: ${e.resourceCount} (+${e.resourceCount-(t.resourceCount||0)})`),!0):e.ajaxCount>(t.ajaxCount||0)&&e.ajaxCount-(t.ajaxCount||0)>=3?(console.log(`[Optima ContinuousMetrics] ğŸŒ Significant AJAX increase: ${e.ajaxCount} (+${e.ajaxCount-(t.ajaxCount||0)})`),!0):e.errorCount>(t.errorCount||0)&&(console.log(`[Optima ContinuousMetrics] âŒ New errors detected: ${e.errorCount} (+${e.errorCount-(t.errorCount||0)})`),!0)}hasAnyData(e){const t=Object.values(e.webVitals||{}).some((e=>null!==e)),i=e.resourceCount>0||e.ajaxCount>0||e.errorCount>0;return t||i}hasSignificantCLSChange(e,t){if(null==e)return!1;if(null==t)return e>0;return Math.abs(e-t)>=this.significantChangeThresholds.CLS}hasSignificantINPChange(e,t){if(null==e)return!1;if(null==t)return e>0;return Math.abs(e-t)>=this.significantChangeThresholds.INP}sendContinuousUpdate(){if(!this.viewManager.currentView?.isActive)return;const e=this.getCurrentContinuousMetrics(),t=this.viewManager.currentView,i={view_id:t.id,web_vitals:{},resources:[],ajax_requests:[],errors:[],timestamp:Date.now()},s="initial"===t.type,o=["CLS","INP","loading_time"],n=s?[...o,"LCP","FCP","FID","TTFB"]:o;if(Object.entries({LCP:"LCP",FCP:"FCP",FID:"FID",CLS:"CLS",INP:"INP",TTFB:"TTFB",loading_time:"loading_time"}).forEach((([o,r])=>{n.includes(o)&&null!==e.webVitals[o]&&t.webVitals[o]?(console.log(`[Optima ContinuousMetrics] âœ… Including ${r} = ${e.webVitals[o]} for ${t.type} view`),i.web_vitals[r]={value:e.webVitals[o],timestamp:t.webVitals[o].timestamp,view_relative_time:t.webVitals[o].viewRelativeTime,..."CLS"===o&&{lastShiftTime:t.webVitals[o].lastShiftTime,lastShiftValue:t.webVitals[o].lastShiftValue,shiftSource:t.webVitals[o].shiftSource,hadRecentInput:t.webVitals[o].hadRecentInput},..."INP"===o&&{interaction_type:t.webVitals[o].interactionType,target:t.webVitals[o].target,processing_time:t.webVitals[o].processingTime,input_delay:t.webVitals[o].inputDelay,manual:t.webVitals[o].manual},..."LCP"===o&&{element:t.webVitals[o].element,url:t.webVitals[o].url,absolute_time:t.webVitals[o].absoluteTime,attribution:t.webVitals[o].attribution,entry:t.webVitals[o].entry,source:t.webVitals[o].source},..."FID"===o&&{absolute_time:t.webVitals[o].absoluteTime,processing_time:t.webVitals[o].processingTime,interaction_type:t.webVitals[o].interactionType,target:t.webVitals[o].target,source:t.webVitals[o].source},..."FCP"===o&&{absolute_time:t.webVitals[o].absoluteTime,source:t.webVitals[o].source},..."TTFB"===o&&{domain_lookup:t.webVitals[o].domainLookup,connection:t.webVitals[o].connection,request:t.webVitals[o].request,tls:t.webVitals[o].tls},..."loading_time"===o&&{reason:t.webVitals[o].reason,activity_sources:t.webVitals[o].activitySources,detailed_activities:t.webVitals[o].detailedActivities,view_type:t.webVitals[o].viewType,baseline_time:t.webVitals[o].baselineTime,end_time:t.webVitals[o].endTime}}):n.includes(o)||s?n.includes(o)&&console.log(`[Optima ContinuousMetrics] âš ï¸ ${r} allowed for ${t.type} but no value: currentMetrics=${e.webVitals[o]}, viewVitals=${t.webVitals[o]?"exists":"null"}`):console.log(`[Optima ContinuousMetrics] ğŸš« Skipping ${r} for route change view`)})),t.resources&&t.resources.length>0){i.resources=t.resources,console.log(`[Optima ContinuousMetrics] ğŸ“¦ Including ALL ${i.resources.length} resources from view session start`);const e=i.resources.find((e=>e.name&&e.name.includes("releases.bundle.js")));e&&(console.log("[Optima ContinuousMetrics] ğŸ¯ LIFECYCLE - releases.bundle.js is included in continuous update!"),console.log("[Optima ContinuousMetrics] ğŸ¯ LIFECYCLE - Update details:",{totalResourcesFromViewStart:i.resources.length,currentResourceCount:t.resources.length,releasesBundleIndex:i.resources.findIndex((e=>e.name&&e.name.includes("releases.bundle.js"))),releasesBundleDetails:{name:e.name,type:e.type,size:e.transfer_size,startTime:e.start_time,viewId:e.viewId.substring(0,8)}}))}t.ajaxRequests&&t.ajaxRequests.length>0&&(i.ajax_requests=t.ajaxRequests,console.log(`[Optima ContinuousMetrics] ğŸŒ Including ALL ${i.ajax_requests.length} AJAX requests from view session start`)),t.errors&&t.errors.length>0&&(i.errors=t.errors,console.log(`[Optima ContinuousMetrics] âŒ Including ALL ${i.errors.length} errors from view session start`)),this.dataSender.sendContinuousUpdate(i),this.lastSentMetrics={...e},console.log("[Optima ContinuousMetrics] âœ… Sent comprehensive continuous update:",{webVitals:Object.keys(i.web_vitals),resources:i.resources.length,ajaxRequests:i.ajax_requests.length,errors:i.errors.length})}updateThresholds(e){void 0!==e.CLS&&(this.significantChangeThresholds.CLS=e.CLS),void 0!==e.INP&&(this.significantChangeThresholds.INP=e.INP),console.log("[Optima ContinuousMetrics] âš™ï¸ Updated thresholds:",this.significantChangeThresholds)}updateInterval(e){this.updateIntervalMs=e,this.isTracking&&(this.stopContinuousTracking(),this.startContinuousTracking()),console.log("[Optima ContinuousMetrics] âš™ï¸ Updated interval:",e)}onWebVitalDetected(e,t){if(!this.isTracking||!this.viewManager.currentView?.isActive)return;console.log(`[Optima ContinuousMetrics] ğŸ“Š Web vital detected: ${e} = ${t}`);const i="initial"===this.viewManager.currentView.type;["LCP","FCP","FID","TTFB"].includes(e)?i?(console.log("[Optima ContinuousMetrics] ğŸš€ Initial load vital detected for initial view, sending immediate update"),setTimeout((()=>{this.checkAndSendUpdates()}),100)):console.log(`[Optima ContinuousMetrics] ğŸš« Ignoring ${e} for route change view - not applicable`):["CLS","INP","loading_time"].includes(e)&&(console.log("[Optima ContinuousMetrics] ğŸ“Š Continuous vital detected, sending update"),setTimeout((()=>{this.checkAndSendUpdates()}),100))}forceSendUpdate(){console.log("[Optima ContinuousMetrics] ğŸ”§ Force sending continuous update"),this.sendContinuousUpdate()}getStatus(){return{isTracking:this.isTracking,updateInterval:this.updateIntervalMs,lastSentMetrics:{...this.lastSentMetrics},thresholds:{...this.significantChangeThresholds},hasActiveView:!!this.viewManager.currentView?.isActive}}reset(){console.log("[Optima ContinuousMetrics] ğŸ”„ Resetting continuous metrics tracking"),this.lastSentMetrics={},this.isTracking&&console.log("[Optima ContinuousMetrics] ğŸ”„ Continuing tracking with reset baseline")}cleanup(){console.log("[Optima ContinuousMetrics] ğŸ§¹ Cleaning up continuous metrics manager"),this.stopContinuousTracking()}}class d{constructor(e){this.viewManager=e,this.processedUrls=new Set,this.resourceObserver=null,this.isObserving=!1,this.allDetectedResources=new Set,this.setupGlobalResourceTracking(),console.log("[Optima ViewScopedCollector] ğŸ“¦ Resource collector initialized")}safeToFixed(e,t=2){return"number"!=typeof e||isNaN(e)?"0.00":e.toFixed(t)}setupGlobalResourceTracking(){console.log("[Optima ViewScopedCollector] ğŸŒ Global resource tracking setup")}startCollecting(){this.viewManager.currentView?(console.log(`[Optima ViewScopedCollector] ğŸš€ Starting collection for view: ${this.viewManager.currentView.id}`),this.processedUrls.clear(),this.setupResourceObserver(),this.collectExistingResources()):console.warn("[Optima ViewScopedCollector] âš ï¸ No active view to collect resources for")}stopCollecting(){this.resourceObserver&&this.isObserving&&(this.resourceObserver.disconnect(),this.isObserving=!1,console.log("[Optima ViewScopedCollector] â¹ï¸ Resource collection stopped"))}clearObservers(){this.stopCollecting()}setupResourceObserver(){if("PerformanceObserver"in window){this.resourceObserver&&this.isObserving&&this.resourceObserver.disconnect();try{this.resourceObserver=new PerformanceObserver((e=>{const t=e.getEntries();this.notifyLoadingTimeTracker(t),this.processResourceEntries(t)})),this.resourceObserver.observe({entryTypes:["resource"]}),this.isObserving=!0}catch(e){console.error("[Optima ViewScopedCollector] âŒ Failed to setup resource observer:",e)}}else console.warn("[Optima ViewScopedCollector] âš ï¸ PerformanceObserver not supported")}notifyLoadingTimeTracker(e){const t=this.viewManager.webVitalsCollector;if(!t)return void console.warn("[Optima ViewScopedCollector] âš ï¸ No webVitalsCollector found on viewManager");if(!t.loadingTimeTracker)return void console.warn("[Optima ViewScopedCollector] âš ï¸ No loadingTimeTracker found on webVitalsCollector");const i=t.loadingTimeTracker;i.isTracking&&!i.isComplete?(console.log(`[Optima ViewScopedCollector] ğŸ¯ Notifying loading time tracker about ${e.length} resources`),e.forEach((e=>{if(performance.timeOrigin+e.startTime>=i.baselineTime){i.pendingResources.add(e.name);const t={url:e.name,type:e.initiatorType||"unknown",size:e.transferSize||0,duration:Math.round(e.duration||0),startTime:Math.round(e.startTime),endTime:Math.round(e.startTime+(e.duration||0))};i.recordActivity("resource",t),console.log(`[Optima ViewScopedCollector] ğŸ¯ Notified loading time tracker about resource: ${e.name.substring(e.name.lastIndexOf("/")+1)}`),setTimeout((()=>{i.pendingResources.delete(e.name)}),50)}else console.log(`[Optima ViewScopedCollector] â° Resource filtered out (started before baseline): ${e.name.substring(e.name.lastIndexOf("/")+1)}`)}))):console.log(`[Optima ViewScopedCollector] ğŸ”„ Loading time tracker not active (isTracking: ${i.isTracking}, isComplete: ${i.isComplete})`)}collectExistingResources(){if(!this.viewManager.currentView)return;const e=this.viewManager.currentView,t="initial"===e.type,i=performance.getEntriesByType("resource");this.notifyLoadingTimeTrackerAboutExistingResources(i,t);const s=t?0:this.calculateRouteChangeFilterTime(e);console.group(`%cğŸ“¦ Resource Collection Process %c${e.type.toUpperCase()}`,"color: #8b5cf6; font-weight: bold; font-size: 14px;","color: #3b82f6; font-weight: bold; font-size: 12px; background: #eff6ff; padding: 2px 6px; border-radius: 4px;"),console.log("%cğŸ“Š Collection Configuration:","color: #6b7280; font-weight: bold;"),console.table({"View Type":e.type,"View Start Time":`${e.startTime.toFixed(2)}ms`,"Filter Time":t?"0ms (collect all)":`${s.toFixed(2)}ms`,"Total Resources Available":i.length,"Is Initial Load":t}),t||(console.log("%cğŸ¯ Route Change Filter Details:","color: #6b7280; font-weight: bold;"),e.interactionBaseline&&"number"==typeof e.interactionBaseline&&(console.log(`ğŸ¯ Interaction baseline: ${e.interactionBaseline.toFixed(2)}ms (using for filtering)`),console.log(`âš¡ Baseline advantage: ${e.routeTriggerTime&&"number"==typeof e.routeTriggerTime?(e.routeTriggerTime-e.interactionBaseline).toFixed(2):"N/A"}ms earlier than route trigger`)),e.routeTriggerTime&&"number"==typeof e.routeTriggerTime&&(console.log(`ğŸ¯ Route trigger time: ${e.routeTriggerTime.toFixed(2)}ms`),console.log(`â° View creation delay: ${(e.startTime-e.routeTriggerTime).toFixed(2)}ms`)));let o=0,n=0;const r=[],a=[],c=i.find((e=>e.name.includes("releases.bundle.js")));c&&(console.log("ğŸ¯ LIFECYCLE START - releases.bundle.js detected in existing resources"),console.log("ğŸ¯ LIFECYCLE - Resource timing:",{resourceStartTime:this.safeToFixed(c.startTime),routeTriggerTime:e.routeTriggerTime&&"number"==typeof e.routeTriggerTime?e.routeTriggerTime.toFixed(2):"N/A",viewStartTime:this.safeToFixed(e.startTime),filterTime:this.safeToFixed(s),timeDifference:this.safeToFixed(c.startTime-s),viewType:e.type,isInitialLoad:t})),i.forEach((i=>{if(t||i.startTime>=s){const t=this.processResourceEntry(i,e);t&&this.viewManager.addResource(t)&&(o++,r.push({name:this.truncateUrl(i.name,50),startTime:i.startTime.toFixed(2),type:i.initiatorType||"unknown",size:i.transferSize||0}))}else n++,a.push({name:this.truncateUrl(i.name,50),startTime:i.startTime.toFixed(2),timeDiff:(i.startTime-s).toFixed(2),type:i.initiatorType||"unknown"})})),console.log("%cğŸ“Š Collection Results:","color: #10b981; font-weight: bold;"),console.table({"Total Resources":i.length,Included:o,Excluded:n,"Inclusion Rate":`${(o/i.length*100).toFixed(1)}%`}),r.length>0&&(console.log("%câœ… Sample Included Resources (first 5):","color: #10b981; font-weight: bold;"),console.table(r.slice(0,5))),!t&&a.length>0&&(console.log("%câŒ Sample Excluded Resources (first 5):","color: #ef4444; font-weight: bold;"),console.table(a.slice(0,5))),console.log(`âœ… Resource collection completed: ${o} resources added to ${e.type} view`),console.groupEnd()}notifyLoadingTimeTrackerAboutExistingResources(e,t){const i=this.viewManager.webVitalsCollector;if(!i)return void console.warn("[Optima ViewScopedCollector] âš ï¸ No webVitalsCollector found on viewManager for existing resources");if(!i.loadingTimeTracker)return void console.warn("[Optima ViewScopedCollector] âš ï¸ No loadingTimeTracker found on webVitalsCollector for existing resources");const s=i.loadingTimeTracker;if(!s.isTracking||s.isComplete)return void console.log(`[Optima ViewScopedCollector] ğŸ”„ Loading time tracker not active for existing resources (isTracking: ${s.isTracking}, isComplete: ${s.isComplete})`);console.log(`[Optima ViewScopedCollector] ğŸ¯ Notifying loading time tracker about ${e.length} existing resources (isInitialLoad: ${t})`);let o=0;e.forEach((e=>{if(performance.timeOrigin+e.startTime>=s.baselineTime){s.pendingResources.add(e.name);const t={url:e.name,type:e.initiatorType||"unknown",size:e.transferSize||0,duration:Math.round(e.duration||0),startTime:Math.round(e.startTime),endTime:Math.round(e.startTime+(e.duration||0))};s.recordActivity("resource",t),o++,setTimeout((()=>{s.pendingResources.delete(e.name)}),50)}})),o>0?console.log(`[Optima ViewScopedCollector] ğŸ¯ Notified loading time tracker about ${o} existing resources`):console.log("[Optima ViewScopedCollector] â° No existing resources met baseline criteria for loading time tracking")}truncateUrl(e,t=50){return!e||e.length<=t?e:e.substring(0,t-3)+"..."}calculateRouteChangeFilterTime(e){const t=e.routeTriggerTime,i=e.interactionBaseline;return console.group("ğŸ¯ Resource Filter Time Calculation"),t&&"number"==typeof t?(console.log(`âœ… Using route trigger time: ${t.toFixed(2)}ms`),console.log("ğŸ¯ Filter baseline aligned with loading time baseline"),console.groupEnd(),t):i&&"number"==typeof i?(console.log(`ğŸ”„ Using interaction baseline: ${i.toFixed(2)}ms`),console.log("âš ï¸ Route trigger time not available, using interaction fallback"),console.groupEnd(),i):(console.warn(`âš ï¸ No route trigger or interaction time available, using view start time: ${e.startTime.toFixed(2)}ms`),console.log("ğŸš¨ Filter baseline NOT aligned with loading time baseline"),console.groupEnd(),e.startTime)}processResourceEntry(e,t){try{if(this.processedUrls.has(e.name))return null;if(!this.shouldCollectResource(e))return null;const i="initial"===t.type;let s=0;i||(s=this.calculateRouteChangeFilterTime(t));const o=this.extractFullResourceData(e,s,i);return this.processedUrls.add(e.name),o}catch(t){return console.error("[Optima ViewScopedCollector] âŒ Error processing single resource:",e.name,t),null}}processResourceEntries(e){if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return void console.warn("[Optima ViewScopedCollector] âš ï¸ No active view to process resources for");const t=this.viewManager.currentView,i="initial"===t.type;let s=0;i?console.log("[Optima ViewScopedCollector] ğŸ¯ Initial load: collecting ALL resources from time 0"):t.interactionBaseline?(s=t.interactionBaseline,console.log(`[Optima ViewScopedCollector] ğŸ¯ Using interaction baseline for filtering: ${this.safeToFixed(s)}ms`)):(s=t.routeTriggerTime||t.startTime,console.log(`[Optima ViewScopedCollector] ğŸ¯ Using route trigger time for filtering: ${this.safeToFixed(s)}ms`));let o=0;e.forEach(((n,r)=>{const a=n.name;if(a.toLowerCase().includes(".js"),a.includes("bundle")||a.includes("chunk"),a.includes("releases.bundle.js")&&(console.log(`[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - releases.bundle.js in processResourceEntries - Entry ${r+1}/${e.length}`),console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - Processing checks begin:",{url:a,startTime:this.safeToFixed(n.startTime),filterTime:this.safeToFixed(s),isInitialLoad:i,viewType:t.type})),this.processedUrls.has(n.name))a.includes("releases.bundle.js")&&(console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE END - releases.bundle.js SKIPPED: already processed"),console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - processedUrls contains:",Array.from(this.processedUrls).filter((e=>e.includes("releases.bundle")))));else if(a.includes("releases.bundle.js")&&console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - releases.bundle.js passed alreadyProcessed check"),!i&&n.startTime<s){if(a.includes("releases.bundle.js")){const e=t.routeTriggerTime?"route trigger":"view start";console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE END - releases.bundle.js SKIPPED: timing check failed"),console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - Timing details:",{resourceStartTime:this.safeToFixed(n.startTime),filterTime:this.safeToFixed(s),timeType:e,timeDifference:this.safeToFixed(n.startTime-s),condition:`${this.safeToFixed(n.startTime)} < ${this.safeToFixed(s)}`,result:"FAILED - resource started before filter time"})}}else if(a.includes("releases.bundle.js")&&(console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - releases.bundle.js passed timing check"),console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - Timing validation:",{condition:i?"initial load (no timing check)":`${this.safeToFixed(n.startTime)} >= ${this.safeToFixed(s)}`,result:"PASSED"})),this.shouldCollectResource(n)){a.includes("releases.bundle.js")&&(console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - releases.bundle.js passed shouldCollectResource check"),console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - Proceeding to extract resource data and add to view"));try{const e=this.extractFullResourceData(n,s,i);if(a.includes("releases.bundle.js")&&console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - releases.bundle.js resource data extracted:",{name:e.name,type:e.type,size:e.transfer_size,startTime:e.start_time,duration:e.duration,viewId:e.viewId.substring(0,8)}),this.viewManager.addResource(e),a.includes("releases.bundle.js")&&console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - releases.bundle.js added to ViewManager"),this.isAjaxRequest(n)){const t=this.convertToAjaxData(e,n);this.viewManager.addAjaxRequest(t),a.includes("releases.bundle.js")&&console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - releases.bundle.js also processed as AJAX request")}this.processedUrls.add(n.name),o++,a.includes("releases.bundle.js")&&(console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE SUCCESS - releases.bundle.js processing completed successfully"),console.log(`[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE - Added to processedUrls, total processed: ${o}`))}catch(e){console.error("[Optima ViewScopedCollector] âŒ Error processing resource:",n.name,e),a.includes("releases.bundle.js")&&console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE ERROR - releases.bundle.js processing failed:",e)}}else a.includes("releases.bundle.js")&&console.log("[Optima ViewScopedCollector] ğŸ¯ LIFECYCLE END - releases.bundle.js SKIPPED: shouldCollectResource returned false")}))}extractFullResourceData(e,t,i){let s;this.viewManager.currentView,s=i?e.startTime:e.startTime-t;const o=Math.round(e.domainLookupEnd-e.domainLookupStart),n=e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,r=Math.round(e.connectEnd-e.connectStart),a=Math.round(e.responseStart-e.requestStart),c=Math.round(e.responseEnd-e.responseStart),l=Math.round(e.duration),u=this.getResourceType(e),d=this.getCacheStatus(e);return{name:e.name,size:e.transferSize||0,ttfb:a,type:u,timing:{dns:o,tls:n,request:a,response:c,connection:r},dnsTime:o,tlsTime:n,dns_time:o,tls_time:n,duration:l,downloadTime:c,download_time:c,connectionTime:r,connection_time:r,start_time:Math.round(s),cacheStatus:d,cache_status:d,decoded_size:e.decodedBodySize||0,encoded_size:e.encodedBodySize||0,transfer_size:e.transferSize||0,connect_end:Math.round(e.connectEnd),connect_start:Math.round(e.connectStart),fetch_start:Math.round(e.fetchStart),response_end:Math.round(e.responseEnd),response_start:Math.round(e.responseStart),request_start:Math.round(e.requestStart),domain_lookup_end:Math.round(e.domainLookupEnd),domain_lookup_start:Math.round(e.domainLookupStart),secure_connection_start:Math.round(e.secureConnectionStart||0),next_hop_protocol:e.nextHopProtocol||"unknown",initiator_type:e.initiatorType||"other",viewId:this.viewManager.currentView.id,viewType:this.viewManager.currentView.type,view_relative_timing:!0,debug_info:{original_start_time:e.startTime,filter_time:t,is_initial_load:i,calculation_method:i?"absolute_from_navigation":"relative_from_filter"}}}isAjaxRequest(e){if("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)return!0;if(!0===e.is_ajax)return!0;const t=e.name.toLowerCase();return!(t.endsWith(".js")||t.endsWith(".css")||t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".gif")||t.endsWith(".svg")||t.endsWith(".woff")||t.endsWith(".woff2")||t.endsWith(".ttf")||t.endsWith(".ico"))&&!!(t.includes("/api/")||t.includes("/ajax/")||t.includes("/graphql"))}convertToAjaxData(e,t){const i=performance.timeOrigin+t.responseEnd,s=this.getActualStatusData(e.name,i,t);return{type:"xmlhttprequest"===t.initiatorType?"xhr":"fetch",method:s.method||"GET",method_inferred:!s.method,url:e.name,status:s.status,statusText:s.statusText,startTime:e.start_time,duration:e.duration,async:!0,requestPayloadSize:0,responseSize:e.transfer_size,aborted:s.aborted||!1,errored:s.errored||!1,timedOut:s.timedOut||!1,timestamp:Date.now(),statusSource:s.source,statusConfidence:s.confidence,resourceTiming:{startTime:e.start_time,duration:e.duration,domainLookupTime:e.dnsTime,connectTime:e.connectionTime,tlsTime:e.tlsTime,requestStartTime:e.request_start,ttfb:e.ttfb,downloadTime:e.downloadTime,entryType:"resource",initiatorType:t.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transfer_size.toString(),"cache-control":"unknown"},viewId:this.viewManager.currentView.id,viewType:this.viewManager.currentView.type}}getActualStatusData(e,t,i){const s={status:200,statusText:"OK",method:null,aborted:!1,errored:!1,timedOut:!1,source:"fallback",confidence:"low"};try{if(this.viewManager.statusTracker){const i=this.viewManager.statusTracker.getStatus(e,t,3e3);if(i)return s.status=i.status,s.statusText=i.statusText||this.getStatusText(i.status),s.method=i.method,s.source="tracker",s.confidence="high",i.error&&(s.errored=!0),0===i.status&&(s.errored=!0,s.statusText="Network Error"),this.viewManager.sdk?.config?.debug&&console.log(`[Optima ResourceCollector] ğŸ¯ Got status from tracker: ${i.status} for ${e}`),s}if(void 0!==i.responseStatus&&0!==i.responseStatus)return s.status=i.responseStatus,s.statusText=this.getStatusText(i.responseStatus),s.source="performance_api",s.confidence="medium",this.viewManager.sdk?.config?.debug&&console.log(`[Optima ResourceCollector] ğŸ“Š Got status from Performance API: ${i.responseStatus} for ${e}`),s;const o=this.inferStatusFromMetrics(i);if(o)return s.status=o.status,s.statusText=o.statusText,s.source="inference",s.confidence="low",s.errored=o.errored||!1,this.viewManager.sdk?.config?.debug&&console.log(`[Optima ResourceCollector] ğŸ” Inferred status: ${o.status} for ${e}`),s}catch(e){console.error("[Optima ResourceCollector] âŒ Error getting status data:",e)}return this.viewManager.sdk?.config?.debug&&console.log(`[Optima ResourceCollector] ğŸ”„ Using fallback status 200 for ${e}`),s}inferStatusFromMetrics(e){try{if(0===e.transferSize&&e.duration>0)return{status:0,statusText:"Network Error",errored:!0};if(0===e.transferSize&&e.encodedBodySize>0)return{status:304,statusText:"Not Modified"};if(e.duration<1&&0===e.transferSize)return{status:0,statusText:"Aborted",errored:!0};if(e.duration>3e4)return{status:0,statusText:"Timeout",errored:!0,timedOut:!0};if(e.transferSize>0)return{status:200,statusText:"OK"}}catch(e){console.error("[Optima ResourceCollector] âŒ Error inferring status:",e)}return null}getStatusText(e){return{0:"Network Error",200:"OK",201:"Created",202:"Accepted",204:"No Content",301:"Moved Permanently",302:"Found",304:"Not Modified",400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",408:"Request Timeout",409:"Conflict",410:"Gone",422:"Unprocessable Entity",429:"Too Many Requests",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout"}[e]||`HTTP ${e}`}getResourceType(e){const t=e.name.toLowerCase();return t.endsWith(".js")?"script":t.endsWith(".css")?"stylesheet":t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".gif")||t.endsWith(".svg")||t.endsWith(".webp")?"image":t.endsWith(".woff")||t.endsWith(".woff2")||t.endsWith(".ttf")?"font":t.endsWith(".mp4")||t.endsWith(".webm")||t.endsWith(".ogg")?"media":"img"===e.initiatorType?"image":"script"===e.initiatorType?"script":"link"===e.initiatorType?"stylesheet":"xmlhttprequest"===e.initiatorType?"xhr":"fetch"===e.initiatorType?"fetch":"other"}getCacheStatus(e){return 0===e.transferSize&&e.encodedBodySize>0?"cache":e.transferSize>0?"network":0===e.transferSize&&0===e.encodedBodySize?"unknown":"network"}shouldCollectResource(e){const t=e.name;return!o(t,this.viewManager.sdk?.config||{})&&(!t.startsWith("data:")&&!t.startsWith("blob:"))}getProcessedCount(){return this.processedUrls.size}reset(){this.processedUrls.clear(),this.resourceObserver&&this.isObserving&&(this.resourceObserver.disconnect(),this.isObserving=!1)}getDebugInfo(){const e=performance.getEntriesByType("resource");return{totalDetected:e.length,totalProcessed:this.processedUrls.size,jsFiles:e.filter((e=>e.name.toLowerCase().includes(".js"))).length,bundleFiles:e.filter((e=>e.name.includes("bundle")||e.name.includes("chunk"))).length,processedUrls:Array.from(this.processedUrls)}}}function m(e){if(!e||!e.previousRect||!e.currentRect)return 0;const t=e.previousRect,i=e.currentRect,s=Math.abs(t.x-i.x),o=Math.abs(t.y-i.y);return Math.sqrt(s*s+o*o)*(Math.max(t.width*t.height,i.width*i.height)/(window.innerWidth*window.innerHeight))}function h(e){return e?{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(e.width),height:Math.round(e.height),top:Math.round(e.top),right:Math.round(e.right),bottom:Math.round(e.bottom),left:Math.round(e.left)}:null}function p(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id){e+=`#${i.id}`,t.unshift(e);break}if(i.className&&"string"==typeof i.className){const t=i.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let s=i,o=1;for(;s=s.previousElementSibling;)o++;if(o>1&&(e+=`:nth-child(${o})`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function g(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id&&(e=`${e}#${i.id}`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function w(e){if(!e||!e.textContent)return null;const t=e.textContent.trim().replace(/\s+/g," ");return t.length>60?t.substring(0,60)+"...":t}function f(e){if(!e||!e.attributes)return{};const t={},i=["src","href","alt","title","aria-label","role","data-testid"];i.forEach((i=>{e.hasAttribute(i)&&(t[i]=e.getAttribute(i))}));for(let s=0;s<e.attributes.length;s++){const o=e.attributes[s];o.name.startsWith("data-")&&!i.includes(o.name)&&(t[o.name]=o.value)}return t}function T(e){if(!e||!e.previousRect||!e.currentRect)return"unknown";const t=e.previousRect,i=e.currentRect;if(0===t.width&&0===t.height&&(i.width>0||i.height>0))return"appeared";if(0===i.width&&0===i.height&&(t.width>0||t.height>0))return"disappeared";const s=Math.abs(t.width-i.width)>1||Math.abs(t.height-i.height)>1,o=Math.abs(t.x-i.x)>1||Math.abs(t.y-i.y)>1;return s&&o?"resize-and-move":s?"resize":o?"move":"unknown"}function v(e){if(!e||!window.getComputedStyle)return!1;try{const t=window.getComputedStyle(e);return"0s"!==t.transitionDuration||"none"!==t.animationName||e.classList.contains("animate")||e.classList.contains("fade")||e.classList.contains("slide")}catch(e){return!1}}class b{constructor(e){this.viewManager=e,this.observers=new Map,this.continuousMetrics=["CLS","INP"],this.initialOnlyMetrics=["LCP","FID","FCP","TTFB"],this.isSetup=!1,this.loadingTimeTracker=null,console.log("[Optima ViewScopedWebVitals] ğŸ“Š Web vitals collector initialized")}startCollecting(e){this.viewManager.currentView?(console.log(`[Optima ViewScopedWebVitals] ğŸš€ Starting web vitals collection for ${e} view`),this.clearObservers(),"initial"===e?this.setupAllMetrics():this.setupRouteChangeMetrics(),this.isSetup=!0):console.warn("[Optima ViewScopedWebVitals] âš ï¸ No active view to collect web vitals for")}setupAllMetrics(){console.log("[Optima ViewScopedWebVitals] ğŸ”§ Setting up all metrics for initial load"),this.setupLCP(),this.setupFID(),this.setupFCP(),this.setupTTFB(),this.setupCLS(),this.setupINP(),this.setupLoadingTime()}setupRouteChangeMetrics(){console.log("[Optima ViewScopedWebVitals] ğŸ”§ Setting up continuous metrics for route change"),this.setupCLS(),this.setupINP(),this.setupLoadingTime()}setupLCP(){if(!("PerformanceObserver"in window))return void console.warn("[Optima ViewScopedWebVitals] âš ï¸ PerformanceObserver not supported - skipping LCP");if("initial"===this.viewManager.currentView.type){console.log("[Optima ViewScopedWebVitals] ğŸ¯ Setting up LCP tracking for initial page load");try{const e=this.viewManager.currentView.startTime,t=this.viewManager.currentView;let i=0;console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP setup - viewStartTime: ${e}, viewType: ${t.type}`);const s=new PerformanceObserver((s=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return void console.log("[Optima ViewScopedWebVitals] ğŸ¯ LCP observer fired but no active view");const o=s.getEntries();if(console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP observer fired with ${o.length} entries`),0===o.length)return;const n=o[o.length-1];console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP entry - startTime: ${n.startTime}, size: ${n.size}`);const r="initial"===t.type;if(!r&&n.startTime<e)return void console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP entry filtered out - occurred before view start (${n.startTime} < ${e})`);let a;if(r&&console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP entry accepted for initial load - startTime: ${n.startTime}`),a=r?n.startTime:n.startTime-e,n.startTime>i){i=n.startTime;const t=this.extractLCPElementInfo(n),s=this.calculateLCPAttribution(n,e);this.viewManager.updateWebVital("LCP",a,{absoluteTime:n.startTime,element:t,attribution:s,entry:{id:n.id,size:n.size,loadTime:n.loadTime,renderTime:n.renderTime}}),console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP updated: ${a}ms (absolute: ${n.startTime}ms)`)}else console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP entry ignored - not larger than previous (${n.startTime} <= ${i})`)})),o="initial"===t.type;console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP observer buffered: ${o} (viewType: ${t.type})`),s.observe({type:"largest-contentful-paint",buffered:o}),this.observers.set("LCP",s),setTimeout((()=>{if(0===i){console.log("[Optima ViewScopedWebVitals] ğŸ¯ No LCP detected via observer, checking performance entries directly");const i=performance.getEntriesByType("largest-contentful-paint");if(console.log(`[Optima ViewScopedWebVitals] ğŸ¯ Found ${i.length} LCP entries in performance buffer`),i.length>0){const s=i[i.length-1];console.log(`[Optima ViewScopedWebVitals] ğŸ¯ Latest LCP from buffer: ${s.startTime}ms, size: ${s.size}`);let o;if(o="initial"===t.type?s.startTime:Math.max(0,s.startTime-e),o>=0){const t=this.extractLCPElementInfo(s),i=this.calculateLCPAttribution(s,e);this.viewManager.updateWebVital("LCP",o,{absoluteTime:s.startTime,element:t,attribution:i,entry:{id:s.id,size:s.size,loadTime:s.loadTime,renderTime:s.renderTime},source:"fallback"}),console.log(`[Optima ViewScopedWebVitals] ğŸ¯ LCP recorded via fallback: ${o}ms`)}}}}),100)}catch(e){console.error("[Optima ViewScopedWebVitals] âŒ Error setting up LCP:",e)}}else console.log("[Optima ViewScopedWebVitals] ğŸ¯ Skipping LCP setup - only applicable for initial page load")}setupFID(){if(!("PerformanceObserver"in window))return;const e=this.viewManager.currentView;if("initial"===e.type){console.log("[Optima ViewScopedWebVitals] âš¡ Setting up FID tracking for initial page load");try{const t=this.viewManager.currentView.startTime;let i=!1;console.log(`[Optima ViewScopedWebVitals] âš¡ FID setup - viewStartTime: ${t}, viewType: ${e.type}`);const s=new PerformanceObserver((e=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;e.getEntries().forEach((e=>{if(i)return;console.log(`[Optima ViewScopedWebVitals] âš¡ FID entry found - startTime: ${e.startTime}`);const t=e.startTime,s=e.processingEnd-e.processingStart,o=e.processingStart-e.startTime;this.viewManager.updateWebVital("FID",o,{absoluteTime:e.startTime,viewRelativeTime:t,processingTime:s,interactionType:e.name,target:e.target?this.getElementInfo(e.target):null}),i=!0,console.log(`[Optima ViewScopedWebVitals] âš¡ FID recorded: ${o}ms (absolute: ${e.startTime}ms)`)}))})),o="initial"===e.type;console.log(`[Optima ViewScopedWebVitals] âš¡ FID observer buffered: ${o} (viewType: ${e.type})`),s.observe({type:"first-input",buffered:o}),this.observers.set("FID",s),setTimeout((()=>{if(!i){console.log("[Optima ViewScopedWebVitals] âš¡ No FID detected via observer, checking performance entries directly");const e=performance.getEntriesByType("first-input");if(e.length>0){const t=e[0];console.log(`[Optima ViewScopedWebVitals] âš¡ FID found in buffer: ${t.startTime}ms`);const s=t.startTime,o=t.processingEnd-t.processingStart,n=t.processingStart-t.startTime;this.viewManager.updateWebVital("FID",n,{absoluteTime:t.startTime,viewRelativeTime:s,processingTime:o,interactionType:t.name,target:t.target?this.getElementInfo(t.target):null,source:"fallback"}),i=!0,console.log(`[Optima ViewScopedWebVitals] âš¡ FID recorded via fallback: ${n}ms`)}else console.log("[Optima ViewScopedWebVitals] âš¡ No FID entry found in performance buffer")}}),1e3)}catch(e){console.error("[Optima ViewScopedWebVitals] âŒ Error setting up FID:",e)}}else console.log("[Optima ViewScopedWebVitals] âš¡ Skipping FID setup - only applicable for initial page load")}setupFCP(){if(!("PerformanceObserver"in window))return;const e=this.viewManager.currentView;if("initial"===e.type){console.log("[Optima ViewScopedWebVitals] ğŸ¨ Setting up FCP tracking for initial page load");try{const t=this.viewManager.currentView.startTime;let i=!1;console.log(`[Optima ViewScopedWebVitals] ğŸ¨ FCP setup - viewStartTime: ${t}, viewType: ${e.type}`);const s=new PerformanceObserver((e=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const t=e.getEntries().find((e=>"first-contentful-paint"===e.name));if(t&&!i){console.log(`[Optima ViewScopedWebVitals] ğŸ¨ FCP entry found - startTime: ${t.startTime}`);const e=t.startTime;this.viewManager.updateWebVital("FCP",e,{absoluteTime:t.startTime}),i=!0,console.log(`[Optima ViewScopedWebVitals] ğŸ¨ FCP recorded: ${e}ms (absolute: ${t.startTime}ms)`)}})),o="initial"===e.type;console.log(`[Optima ViewScopedWebVitals] ğŸ¨ FCP observer buffered: ${o} (viewType: ${e.type})`),s.observe({type:"paint",buffered:o}),this.observers.set("FCP",s),setTimeout((()=>{if(!i){console.log("[Optima ViewScopedWebVitals] ğŸ¨ No FCP detected via observer, checking performance entries directly");const e=performance.getEntriesByType("paint").find((e=>"first-contentful-paint"===e.name));if(e){console.log(`[Optima ViewScopedWebVitals] ğŸ¨ FCP found in buffer: ${e.startTime}ms`);const t=e.startTime;this.viewManager.updateWebVital("FCP",t,{absoluteTime:e.startTime,source:"fallback"}),i=!0,console.log(`[Optima ViewScopedWebVitals] ğŸ¨ FCP recorded via fallback: ${t}ms`)}else console.log("[Optima ViewScopedWebVitals] ğŸ¨ No FCP entry found in performance buffer")}}),1e3)}catch(e){console.error("[Optima ViewScopedWebVitals] âŒ Error setting up FCP:",e)}}else console.log("[Optima ViewScopedWebVitals] ğŸ¨ Skipping FCP setup - only applicable for initial page load")}setupTTFB(){if("initial"===this.viewManager.currentView.type){console.log("[Optima ViewScopedWebVitals] ğŸŒ Setting up TTFB tracking for initial page load");try{const e=performance.getEntriesByType("navigation")[0];if(!e)return;const t=e.responseStart-e.requestStart;this.viewManager.updateWebVital("TTFB",t,{domainLookup:e.domainLookupEnd-e.domainLookupStart,connection:e.connectEnd-e.connectStart,request:e.responseStart-e.requestStart,tls:e.secureConnectionStart?e.connectEnd-e.secureConnectionStart:0}),console.log(`[Optima ViewScopedWebVitals] ğŸŒ TTFB recorded: ${t}ms`)}catch(e){console.error("[Optima ViewScopedWebVitals] âŒ Error setting up TTFB:",e)}}else console.log("[Optima ViewScopedWebVitals] ğŸŒ Skipping TTFB setup - only applicable for initial page load")}setupCLS(){if("PerformanceObserver"in window){console.log("[Optima ViewScopedWebVitals] ğŸ“ Setting up CLS tracking");try{const e=this.viewManager.currentView.startTime;let t=0;const i=new PerformanceObserver((i=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;i.getEntries().forEach((i=>{if(i.startTime>=e&&!i.hadRecentInput){t+=i.value;const s=function(e){if(!e||!e.sources||0===e.sources.length)return null;try{const t=e.sources.reduce(((e,t)=>{try{return(t.impactValue||m(t))>(e.impactValue||m(e))?t:e}catch(t){return e}}),e.sources[0]);if(!t)return null;const i=t.node;return i?{tagName:i.tagName||"UNKNOWN",id:i.id||null,className:"string"==typeof i.className?i.className:null,cssPath:p(i),domPath:g(i),textContent:w(i),attributes:f(i),previousRect:h(t.previousRect),currentRect:h(t.currentRect),impactValue:t.impactValue||m(t),shiftType:T(t),isAnimating:v(i),isImage:"IMG"===i.tagName,isIframe:"IFRAME"===i.tagName,isVideo:"VIDEO"===i.tagName}:{previousRect:h(t.previousRect),currentRect:h(t.currentRect),impactValue:t.impactValue||m(t),nodeLost:!0,shiftType:T(t)}}catch(e){return null}}(i);this.viewManager.updateWebVital("CLS",t,{lastShiftTime:i.startTime-e,lastShiftValue:i.value,shiftSource:s,hadRecentInput:i.hadRecentInput})}}))})),s=this.viewManager.currentView,o="initial"===s.type;console.log(`[Optima ViewScopedWebVitals] ğŸ“ CLS observer buffered: ${o} (viewType: ${s.type})`),i.observe({type:"layout-shift",buffered:o}),this.observers.set("CLS",i)}catch(e){console.error("[Optima ViewScopedWebVitals] âŒ Error setting up CLS:",e)}}}setupINP(){console.log("[Optima ViewScopedWebVitals] ğŸ–±ï¸ Setting up INP tracking");try{const e=this.viewManager.currentView.startTime;let t=0;if(["click","keydown","pointerdown"].forEach((t=>{document.addEventListener(t,(t=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;const i=performance.now();i<e||this.measureInteraction(t,i-e)}),{passive:!0,capture:!0})})),"PerformanceObserver"in window&&PerformanceObserver.supportedEntryTypes?.includes("event")){const i=new PerformanceObserver((i=>{if(!this.viewManager.currentView||!this.viewManager.currentView.isActive)return;i.getEntries().forEach((i=>{if(i.startTime>=e){const s=i.processingEnd-i.startTime,o=i.target?this.getElementInfo(i.target):null;console.log("[Optima ViewScopedWebVitals] ğŸ–±ï¸ INP entry detected:",{duration:s,interactionType:i.name,startTime:i.startTime,processingStart:i.processingStart,processingEnd:i.processingEnd,elementInfo:o,currentMaxINP:t}),s>t?(t=s,this.viewManager.updateWebVital("INP",s,{viewRelativeTime:i.startTime-e,interactionType:i.name,target:o,processingTime:i.processingEnd-i.processingStart,inputDelay:i.processingStart-i.startTime}),console.log(`[Optima ViewScopedWebVitals] ğŸ–±ï¸ INP updated: ${s}ms (element: ${o?.tagName}#${o?.id||"no-id"})`)):console.log(`[Optima ViewScopedWebVitals] ğŸ–±ï¸ INP entry ignored (${s}ms <= ${t}ms)`)}else console.log(`[Optima ViewScopedWebVitals] ğŸ–±ï¸ INP entry ignored (before view start: ${i.startTime} < ${e})`)}))})),s=this.viewManager.currentView,o="initial"===s.type;console.log(`[Optima ViewScopedWebVitals] ğŸ–±ï¸ INP observer buffered: ${o} (viewType: ${s.type})`),i.observe({type:"event",buffered:o}),this.observers.set("INP",i)}}catch(e){console.error("[Optima ViewScopedWebVitals] âŒ Error setting up INP:",e)}}setupLoadingTime(){console.log("[Optima ViewScopedWebVitals] â±ï¸ Setting up loading time tracking");try{this.loadingTimeTracker&&this.loadingTimeTracker.cleanup(),this.loadingTimeTracker=new y(this.viewManager),this.loadingTimeTracker.start()}catch(e){console.error("[Optima ViewScopedWebVitals] âŒ Error setting up loading time:",e)}}measureInteraction(e,t){const i=performance.now(),s=this.getElementInfo(e.target);console.log("[Optima ViewScopedWebVitals] ğŸ–±ï¸ Manual interaction detected:",{eventType:e.type,elementInfo:s,viewRelativeTime:t,startTime:i}),requestAnimationFrame((()=>{const o=performance.now()-i,n=this.viewManager.currentView?.webVitals?.INP?.value||0;console.log("[Optima ViewScopedWebVitals] ğŸ–±ï¸ Manual interaction measured:",{duration:o,currentINP:n,willUpdate:o>n,elementInfo:s}),o>n?(this.viewManager.updateWebVital("INP",o,{viewRelativeTime:t,interactionType:e.type,target:s,manual:!0}),console.log(`[Optima ViewScopedWebVitals] ğŸ–±ï¸ Manual INP recorded: ${o}ms (element: ${s?.tagName}#${s?.id||"no-id"})`)):console.log(`[Optima ViewScopedWebVitals] ğŸ–±ï¸ Manual interaction ignored (${o}ms <= ${n}ms)`)}))}extractLCPElementInfo(e){try{return e.element?{tagName:e.element.tagName,id:e.element.id||null,className:e.element.className||null,src:e.element.src||e.element.currentSrc||null,url:e.url||null,size:e.size||0}:null}catch(e){return null}}calculateLCPAttribution(e,t){try{const i=performance.getEntriesByType("navigation")[0];return i?{ttfb:Math.round(i.responseStart-i.requestStart),resourceLoadDelay:Math.round(Math.max(0,e.loadTime-i.responseStart)),resourceLoadDuration:Math.round(Math.max(0,e.loadTime-e.startTime)),elementRenderDelay:Math.round(e.startTime-t)}:null}catch(e){return null}}getElementInfo(e){if(!e)return null;try{const t={tagName:e.tagName,id:e.id||null,className:e.className||null,textContent:e.textContent?.substring(0,100)||null,type:e.type||null,name:e.name||null,href:e.href||null,role:e.getAttribute("role")||null};if(e.closest){const i=e.closest("button"),s=e.closest("a"),o=e.closest("form");i&&i!==e&&(t.parentButton={id:i.id||null,className:i.className||null,textContent:i.textContent?.substring(0,50)||null}),s&&s!==e&&(t.parentLink={href:s.href||null,textContent:s.textContent?.substring(0,50)||null}),o&&o!==e&&(t.parentForm={id:o.id||null,name:o.name||null,action:o.action||null})}return t}catch(e){return console.warn("[Optima ViewScopedWebVitals] âš ï¸ Error getting element info:",e),{error:e.message}}}clearObservers(){console.log("[Optima ViewScopedWebVitals] ğŸ§¹ Clearing web vitals observers"),this.observers.forEach(((e,t)=>{try{e.disconnect()}catch(e){console.error(`[Optima ViewScopedWebVitals] âŒ Error disconnecting ${t} observer:`,e)}})),this.observers.clear()}stopCollecting(){console.log("[Optima ViewScopedWebVitals] ğŸ›‘ Stopping web vitals collection"),this.clearObservers(),this.loadingTimeTracker&&(this.loadingTimeTracker.cleanup(),this.loadingTimeTracker=null),this.isSetup=!1}reset(){console.log("[Optima ViewScopedWebVitals] ğŸ”„ Resetting web vitals collector"),this.stopCollecting()}}class y{constructor(e){this.viewManager=e,this.startTime=null,this.lastActivityTime=null,this.isComplete=!1,this.isTracking=!1,this.activitySources=new Set,this.detailedActivities=[];const t=this.viewManager.sdk?.config||{};this.quietPeriod=t.loadingTimeQuietPeriod||1e3,this.maxWaitTime=2e4,this.checkInterval=null,this.observers=[],this.pendingRequests=new Set,this.pendingResources=new Set,this.viewType=null,this.baselineTime=null,this.originalXHROpen=null,this.originalXHRSend=null,this.originalFetch=null}start(){if(!this.viewManager.currentView)return;const e=this.viewManager.currentView;if(this.viewType=e.type,this.isTracking=!0,console.group(`ğŸ¯ Loading Time Baseline Calculation - ${this.viewType.toUpperCase()} VIEW`),"initial"===this.viewType)try{const e=performance.getEntriesByType("navigation")[0];e?(this.baselineTime=performance.timeOrigin+e.fetchStart,console.log("ğŸ“Š Navigation Timing Details:"),console.table({"Navigation Start":`${e.startTime}ms (always 0)`,"Fetch Start":`${e.fetchStart}ms âœ… USING THIS`,"DOM Content Loaded":`${e.domContentLoadedEventEnd}ms`,"Load Event End":`${e.loadEventEnd}ms`,"Performance Origin":new Date(performance.timeOrigin).toISOString()}),console.log(`âœ… Initial load baseline: ${this.baselineTime} (performance.timeOrigin + ${e.fetchStart}ms)`)):(this.baselineTime=performance.timeOrigin,console.warn("âš ï¸ No navigation entry found, using performance.timeOrigin as fallback"))}catch(e){this.baselineTime=performance.timeOrigin,console.error("âŒ Error getting navigation timing, using performance.timeOrigin as fallback:",e)}else{const t=e.routeTriggerTime,i=e.interactionBaseline;console.log("ğŸ“Š Route Change Timing Details:"),console.table({"View Start Time":`${e.startTime.toFixed(2)}ms`,"Route Trigger Time":t?`${t.toFixed(2)}ms âœ… USING THIS`:"Not available","Interaction Baseline":i?`${i.toFixed(2)}ms (alternative)`:"Not available","Current Time":`${performance.now().toFixed(2)}ms`,"View Creation Delay":t?`${(e.startTime-t).toFixed(2)}ms`:"N/A"}),t&&"number"==typeof t?(this.baselineTime=performance.timeOrigin+t,console.log(`âœ… Route change baseline: ${this.baselineTime} (performance.timeOrigin + ${t.toFixed(2)}ms)`),console.log(`âš¡ Precision advantage: ${(performance.timeOrigin+performance.now()-this.baselineTime).toFixed(2)}ms earlier than current time`)):(this.baselineTime=performance.timeOrigin+performance.now(),console.warn("âš ï¸ No route trigger time available, using current time as fallback"),console.log(`ğŸ”„ Fallback baseline: ${this.baselineTime} (performance.timeOrigin + ${performance.now().toFixed(2)}ms)`))}this.startTime=this.baselineTime,this.lastActivityTime=this.baselineTime,console.log(`ğŸ¯ FINAL BASELINE: ${this.baselineTime}`),console.log(`ğŸ“… Baseline Date: ${new Date(this.baselineTime).toISOString()}`),console.log(`â±ï¸ Time since baseline: ${(performance.timeOrigin+performance.now()-this.baselineTime).toFixed(2)}ms`),console.groupEnd(),console.group(`%cğŸš€ Loading Time Tracking Started %c${this.viewType.toUpperCase()}`,"color: #10b981; font-weight: bold; font-size: 14px;","color: #3b82f6; font-weight: bold; font-size: 12px; background: #eff6ff; padding: 2px 6px; border-radius: 4px;"),console.log("%cğŸ“Š Tracking Configuration:","color: #6b7280; font-weight: bold;"),console.table({"View Type":this.viewType,"Baseline Time":new Date(this.baselineTime).toISOString(),"Quiet Period":`${this.quietPeriod}ms${this.viewManager.sdk?.config?.loadingTimeQuietPeriod?" (custom)":" (default)"}`,"Max Wait Time":`${"initial"===this.viewType?this.maxWaitTime:2e4}ms`,"Activity Sources":"resource, xhr, fetch, dom_mutation"}),console.groupEnd(),console.group("ğŸ”¬ DIAGNOSTIC: Existing requests before monitoring setup"),this.logAllCurrentRequests(),console.groupEnd(),console.time("ğŸ” DIAGNOSTIC: Setup monitoring time"),this.setupResourceObserver(),this.setupXHRMonitoring(),this.setupFetchMonitoring(),this.setupMutationObserver(),console.timeEnd("ğŸ” DIAGNOSTIC: Setup monitoring time"),console.group("ğŸ”¬ DIAGNOSTIC: Monitoring setup complete"),console.log(`XHR prototype patched: ${XMLHttpRequest.prototype.open!==this.originalXHROpen}`),console.log(`Fetch patched: ${window.fetch!==this.originalFetch}`),console.log(`Pending requests: ${this.pendingRequests.size}`),console.log(`Pending resources: ${this.pendingResources.size}`),console.groupEnd(),this.startCompletionCheck();const t="initial"===this.viewType?this.maxWaitTime:2e4;setTimeout((()=>{this.isComplete||this.complete("timeout")}),t)}recordActivity(e,t=null){if(this.isComplete||!this.isTracking)return;if(t&&t.url){const e=this.viewManager.sdk?.config||{};if(o(t.url,e))return void console.log(`[Optima LoadingTimeTracker] ğŸš« Activity excluded from loading time tracking: ${t.url}`)}const i=performance.timeOrigin+performance.now(),s=i-this.baselineTime,n=i-this.lastActivityTime;if(this.lastActivityTime=i,this.activitySources.add(e),t){const o={type:e,timestamp:i,timeSinceBaseline:Math.round(s),...t};this.detailedActivities.push(o),this.detailedActivities.length>50&&(this.detailedActivities=this.detailedActivities.slice(-50))}console.log(`%cğŸ“Š Activity Detected %c${e.toUpperCase()}`,"color: #f59e0b; font-weight: bold;","color: #ffffff; background: #f59e0b; padding: 1px 4px; border-radius: 3px; font-size: 11px;"),console.log(`â±ï¸ Time since baseline: ${s.toFixed(2)}ms`),console.log(`â° Time since last activity: ${n.toFixed(2)}ms`),t&&console.log("ğŸ” Activity details:",t),console.log(`ğŸ“ˆ Active sources: [${Array.from(this.activitySources).join(", ")}]`),console.log(`ğŸ”„ Pending: ${this.pendingRequests.size} requests, ${this.pendingResources.size} resources`),this.checkInterval&&clearTimeout(this.checkInterval),this.startCompletionCheck()}setupResourceObserver(){if(window.PerformanceObserver&&window.PerformanceObserver.supportedEntryTypes&&window.PerformanceObserver.supportedEntryTypes.includes("resource")){this._seenResources||(this._seenResources=new Set);try{const e=new PerformanceObserver((e=>{if(this.isComplete||!this.isTracking)return;e.getEntries().forEach((e=>{if(performance.timeOrigin+e.startTime>=this.baselineTime){const t=`${e.name}_${e.initiatorType}_${Math.round(e.startTime)}`;if(this._seenResources.has(t))return;this._seenResources.add(t),"xmlhttprequest"!==e.initiatorType&&"fetch"!==e.initiatorType||this.handlePerformanceResourceTiming(e);const i=this.viewManager.sdk?.config||{};if(o(e.name,i))return void console.log(`[Optima LoadingTimeTracker] ğŸš« Resource excluded from loading time tracking: ${e.name}`);this.pendingResources.add(e.name);const s={url:e.name,type:e.initiatorType||"unknown",size:e.transferSize||0,duration:Math.round(e.duration||0),startTime:Math.round(e.startTime),endTime:Math.round(e.startTime+(e.duration||0))};this.recordActivity("resource",s),setTimeout((()=>{this.pendingResources.delete(e.name)}),50)}}))}));e.observe({type:"resource",buffered:!1}),this.observers.push(e)}catch(e){console.error("[Optima LoadingTimeTracker] âŒ Resource observer failed:",e)}}else console.log("[Optima LoadingTimeTracker] âš ï¸ PerformanceObserver for resources not supported")}setupXHRMonitoring(){if(!window.XMLHttpRequest)return;if(console.log("ğŸ” DIAGNOSTIC: Setting up XHR monitoring"),console.log("ğŸ” DIAGNOSTIC: Current XMLHttpRequest prototype:",XMLHttpRequest.prototype),this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.originalXHRSetRequestHeader=XMLHttpRequest.prototype.setRequestHeader,XMLHttpRequest.prototype._optimaPatched)return void console.log("ğŸ” DIAGNOSTIC: XHR already patched, skipping setup");if(XMLHttpRequest.prototype._optimaPatched=!0,window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource").filter((e=>"xmlhttprequest"===e.initiatorType));console.log(`ğŸ” DIAGNOSTIC: Found ${e.length} existing XHR resources in Performance API at setup time`),e.length>0&&e.forEach((e=>{console.log(`  â€¢ ${e.name} (started at ${Math.round(e.startTime)}ms, duration: ${Math.round(e.duration)}ms)`)}))}const e=this;this._activeXhrRequests||(this._activeXhrRequests=new Map),this._xhrInstanceMap||(this._xhrInstanceMap=new WeakMap),XMLHttpRequest.prototype.open=function(t,i,s=!0,n,r){try{if(!i)return console.error("[Optima LoadingTimeTracker] âŒ XHR open called with invalid URL"),e.originalXHROpen.apply(this,arguments);this._optimaUrl=i,this._optimaMethod=t,this._optimaStartTime=performance.now();const n=encodeURIComponent(i).substring(0,100);if(this._optimaRequestId=`xhr_${n}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,this._optimaAsyncRequest=!1!==s,e._xhrInstanceMap.set(this,{requestId:this._optimaRequestId,url:i,method:t,startTime:this._optimaStartTime,status:"opened"}),console.log(`[Optima LoadingTimeTracker] ğŸ” XHR OPEN: ${t} ${i} (ID: ${this._optimaRequestId}, async: ${this._optimaAsyncRequest})`),!e.isComplete&&e.isTracking){o(i,e.viewManager.sdk?.config||{})?console.log(`[Optima LoadingTimeTracker] ğŸš« XHR EXCLUDED AT OPEN: ${t} ${i} (ID: ${this._optimaRequestId})`):(e.pendingRequests.add(this._optimaRequestId),e._activeXhrRequests.set(this._optimaRequestId,{xhr:this,url:i,method:t,startTime:this._optimaStartTime,status:"opened",async:this._optimaAsyncRequest}),console.log(`[Optima LoadingTimeTracker] â• XHR TRACKING STARTED AT OPEN: ${t} ${i} (ID: ${this._optimaRequestId})`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count: ${e.pendingRequests.size}`))}return e.originalXHROpen.apply(this,arguments)}catch(t){return console.error("[Optima LoadingTimeTracker] âŒ Error in XHR open override:",t),e.originalXHROpen.apply(this,arguments)}},XMLHttpRequest.prototype.setRequestHeader=function(t,i){try{if(this._optimaHeaders||(this._optimaHeaders={}),this._optimaHeaders[t]=i,this._optimaRequestId&&e._activeXhrRequests.has(this._optimaRequestId)){const s=e._activeXhrRequests.get(this._optimaRequestId);s.headers||(s.headers={}),s.headers[t]=i}}catch(e){console.error("[Optima LoadingTimeTracker] âŒ Error in XHR setRequestHeader override:",e)}return e.originalXHRSetRequestHeader.apply(this,arguments)},XMLHttpRequest.prototype.send=function(t){try{if(e.isComplete||!e.isTracking)return console.log(`[Optima LoadingTimeTracker] âš ï¸ XHR SEND IGNORED (tracking stopped): ${this._optimaMethod} ${this._optimaUrl} (ID: ${this._optimaRequestId})`),e.originalXHRSend.apply(this,arguments);const i=e.viewManager.sdk?.config||{};if(o(this._optimaUrl,i))return console.log(`[Optima LoadingTimeTracker] ğŸš« XHR EXCLUDED AT SEND: ${this._optimaMethod} ${this._optimaUrl} (ID: ${this._optimaRequestId})`),this._optimaRequestId&&(e.pendingRequests.delete(this._optimaRequestId),e._activeXhrRequests.delete(this._optimaRequestId)),e.originalXHRSend.apply(this,arguments);const s=this._optimaRequestId;if(this._optimaRequestDetails={id:s,url:this._optimaUrl,method:this._optimaMethod||"GET",startTime:this._optimaStartTime,startedAt:(new Date).toISOString(),data:t?"string"==typeof t?t.length:"binary data":null},e._activeXhrRequests.has(s)){const t=e._activeXhrRequests.get(s);t.status="sent",t.sendTime=performance.now()}e.pendingRequests.has(s)?console.log(`[Optima LoadingTimeTracker] â¬†ï¸ XHR SEND (already tracked): ${this._optimaMethod} ${this._optimaUrl} (ID: ${s})`):(e.pendingRequests.add(s),console.log(`[Optima LoadingTimeTracker] â• XHR TRACKING STARTED AT SEND: ${this._optimaMethod} ${this._optimaUrl} (ID: ${s})`)),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count: ${e.pendingRequests.size}`);const n={url:this._optimaUrl,method:this._optimaMethod||"GET",startTime:Math.round(this._optimaStartTime),requestId:s,requestType:"XMLHttpRequest",async:this._optimaAsyncRequest};e.recordActivity("xhr",n);const r=t=>{try{if(this._optimaCleanedUp)return;this._optimaCleanedUp=!0;const i=performance.now()-this._optimaStartTime;console.log(`[Optima LoadingTimeTracker] â¬‡ï¸ XHR TRACKED END (${t}): ${this._optimaMethod} ${this._optimaUrl} (ID: ${s}, duration: ${Math.round(i)}ms, status: ${this.status||"unknown"})`);let o=0;try{""===this.responseType||"text"===this.responseType?o=this.responseText?.length||0:"arraybuffer"===this.responseType||"blob"===this.responseType?o=this.response?.byteLength||this.response?.size||0:this.getResponseHeader&&this.getResponseHeader("content-length")&&(o=parseInt(this.getResponseHeader("content-length"),10)||0)}catch(e){console.log(`[Optima LoadingTimeTracker] âš ï¸ Error getting response size: ${e.message}`)}const n={url:this._optimaUrl,method:this._optimaMethod||"GET",size:o,type:"xmlhttprequest",endTime:Math.round(this._optimaStartTime+i),duration:Math.round(i),startTime:Math.round(this._optimaStartTime),requestId:s,status:this.status||0,statusText:this.statusText||"",eventType:t};e.recordActivity("xhr_complete",n);const r=e.pendingRequests.delete(s);e._activeXhrRequests.delete(s),console.log(`[Optima LoadingTimeTracker] â– XHR TRACKING ENDED (${t}): ${this._optimaMethod} ${this._optimaUrl} (ID: ${s})`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Request ${r?"removed from":"not found in"} pending list: ${s}`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count After Cleanup: ${e.pendingRequests.size}`)}catch(t){console.error("[Optima LoadingTimeTracker] âŒ Error in XHR cleanup:",t),e.pendingRequests.delete(s),e._activeXhrRequests.delete(s)}};if(!this._optimaAsyncRequest){const t=e.originalXHRSend;try{return t.apply(this,arguments),void r("sync_complete")}catch(e){throw r("sync_error"),e}}return this.addEventListener("readystatechange",(()=>{4===this.readyState&&r("readystatechange")})),this.addEventListener("loadend",(()=>r("loadend")),{once:!0}),this.addEventListener("error",(()=>r("error")),{once:!0}),this.addEventListener("abort",(()=>r("abort")),{once:!0}),this.addEventListener("timeout",(()=>r("timeout")),{once:!0}),e.originalXHRSend.apply(this,arguments)}catch(t){return console.error("[Optima LoadingTimeTracker] âŒ Error in XHR send override:",t),e.originalXHRSend.apply(this,arguments)}},this._xhrCleanupInterval||(this._xhrCleanupInterval=setInterval((()=>{try{const t=performance.now(),i=3e4;e._activeXhrRequests.forEach(((s,o)=>{const n=t-s.startTime;n>i&&(console.log(`[Optima LoadingTimeTracker] âš ï¸ Found stale XHR request: ${s.method} ${s.url} (ID: ${o}, duration: ${Math.round(n)}ms)`),e.pendingRequests.delete(o),e._activeXhrRequests.delete(o),console.log(`[Optima LoadingTimeTracker] ğŸ§¹ Cleaned up stale XHR request (ID: ${o})`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count After Cleanup: ${e.pendingRequests.size}`))}))}catch(e){console.error("[Optima LoadingTimeTracker] âŒ Error in XHR cleanup interval:",e)}}),1e4))}setupFetchMonitoring(){if(!window.fetch)return;if(console.log("ğŸ” DIAGNOSTIC: Setting up fetch monitoring"),console.log("ğŸ” DIAGNOSTIC: Current fetch function:",window.fetch),window.fetch._optimaPatched)return void console.log("ğŸ” DIAGNOSTIC: Fetch already patched, skipping setup");if(window.fetch._optimaPatched=!0,window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource").filter((e=>"fetch"===e.initiatorType));console.log(`ğŸ” DIAGNOSTIC: Found ${e.length} existing fetch resources in Performance API at setup time`),e.length>0&&e.forEach((e=>{console.log(`  â€¢ ${e.name} (started at ${Math.round(e.startTime)}ms, duration: ${Math.round(e.duration)}ms)`)}))}this._activeFetchRequests||(this._activeFetchRequests=new Map),this._trackedUrls||(this._trackedUrls=new Set),this.originalFetch=window.fetch;const e=this;window.fetch=function(t,i){try{const s=performance.now();let n,r;if("string"==typeof t){n=t;try{r=new Request(t,i)}catch(e){console.log(`[Optima LoadingTimeTracker] âš ï¸ Could not create Request object: ${e.message}`)}}else{if(!(t instanceof Request))return console.log("[Optima LoadingTimeTracker] âš ï¸ Unknown fetch input type:",typeof t),e.originalFetch.apply(this,arguments);n=t.url,r=t.clone()}const a=r&&r.method||i&&i.method||"GET",c=`fetch_${encodeURIComponent(n).substring(0,100)}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;if(console.log(`[Optima LoadingTimeTracker] ğŸ” FETCH REQUEST: ${a} ${n} (ID: ${c})`),e.isComplete||!e.isTracking)return console.log(`[Optima LoadingTimeTracker] âš ï¸ FETCH IGNORED (tracking stopped): ${a} ${n} (ID: ${c})`),e.originalFetch.apply(this,arguments);const l=e.viewManager.sdk?.config||{};if(o(n,l))return console.log(`[Optima LoadingTimeTracker] ğŸš« FETCH EXCLUDED: ${a} ${n} (ID: ${c})`),e.originalFetch.apply(this,arguments);e.pendingRequests.add(c),e._trackedUrls.add(n),e._activeFetchRequests.set(c,{url:n,method:a,startTime:s,status:"started",headers:r?Array.from(r.headers.entries()).reduce(((e,[t,i])=>(e[t]=i,e)),{}):{}}),console.log(`[Optima LoadingTimeTracker] â• FETCH TRACKING STARTED: ${a} ${n} (ID: ${c})`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count: ${e.pendingRequests.size}`);const u={url:n,method:a,startTime:Math.round(s),requestId:c,requestType:"fetch"};let d;e.recordActivity("fetch",u);try{d=e.originalFetch.apply(this,arguments)}catch(t){console.error(`[Optima LoadingTimeTracker] âŒ FETCH SYNC ERROR: ${t.message}`);const i=performance.now()-s,o={url:n,method:a,type:"fetch",endTime:Math.round(s+i),duration:Math.round(i),startTime:Math.round(s),requestId:c,error:t.message||"Unknown error"};throw e.recordActivity("fetch_error",o),e.pendingRequests.delete(c),e._activeFetchRequests.delete(c),t}e._activeFetchRequests.has(c)&&(e._activeFetchRequests.get(c).status="pending",e._activeFetchRequests.get(c).promiseCreatedAt=performance.now());const m=d.then((t=>{try{e._activeFetchRequests.has(c)&&(e._activeFetchRequests.get(c).status="responded",e._activeFetchRequests.get(c).responseReceivedAt=performance.now());const i=t.clone(),o=performance.now()-s;console.log(`[Optima LoadingTimeTracker] â¬‡ï¸ FETCH TRACKED END: ${a} ${n} (ID: ${c}, duration: ${Math.round(o)}ms, status: ${i.status})`);let r=0;i.headers&&(r=parseInt(i.headers.get("content-length")||"0",10));const l={url:n,method:a,size:r,type:"fetch",endTime:Math.round(s+o),duration:Math.round(o),startTime:Math.round(s),requestId:c,status:i.status,statusText:i.statusText};return e.recordActivity("fetch_complete",l),e.pendingRequests.delete(c),e._activeFetchRequests.delete(c),console.log(`[Optima LoadingTimeTracker] â– FETCH TRACKING ENDED: ${a} ${n} (ID: ${c})`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count After Cleanup: ${e.pendingRequests.size}`),i.redirected&&i.url!==n&&console.log(`[Optima LoadingTimeTracker] â†ªï¸ FETCH REDIRECTED: ${n} -> ${i.url}`),t}catch(i){return console.error("[Optima LoadingTimeTracker] âŒ Error processing fetch response:",i),e.pendingRequests.delete(c),e._activeFetchRequests.delete(c),t}})).catch((t=>{try{const i=performance.now()-s;console.log(`[Optima LoadingTimeTracker] âŒ FETCH ERROR: ${a} ${n} (ID: ${c}, duration: ${Math.round(i)}ms)`);const o={url:n,method:a,size:0,type:"fetch",endTime:Math.round(s+i),duration:Math.round(i),startTime:Math.round(s),requestId:c,status:0,statusText:"Failed",error:t.message};e.recordActivity("fetch_error",o),e.pendingRequests.delete(c),e._activeFetchRequests.delete(c),console.log(`[Optima LoadingTimeTracker] â– FETCH TRACKING ENDED (error): ${a} ${n} (ID: ${c})`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count After Cleanup: ${e.pendingRequests.size}`)}catch(t){console.error("[Optima LoadingTimeTracker] âŒ Error processing fetch error:",t),e.pendingRequests.delete(c),e._activeFetchRequests.delete(c)}throw t}));try{m.finally((()=>{try{e.pendingRequests.has(c)&&(console.log(`[Optima LoadingTimeTracker] ğŸ§¹ Cleanup: removing fetch request in finally handler (ID: ${c})`),e.pendingRequests.delete(c)),e._activeFetchRequests.has(c)&&e._activeFetchRequests.delete(c)}catch(e){console.error("[Optima LoadingTimeTracker] âŒ Error in fetch finally handler:",e)}}))}catch(e){console.error("[Optima LoadingTimeTracker] âŒ Error adding finally handler:",e)}return m}catch(t){return console.error("[Optima LoadingTimeTracker] âŒ Fatal error in fetch override:",t),e.originalFetch.apply(this,arguments)}},this._fetchCleanupInterval||(this._fetchCleanupInterval=setInterval((()=>{try{const t=performance.now(),i=3e4;e._activeFetchRequests.forEach(((s,o)=>{const n=t-s.startTime;n>i&&(console.log(`[Optima LoadingTimeTracker] âš ï¸ Found stale fetch request: ${s.method} ${s.url} (ID: ${o}, duration: ${Math.round(n)}ms)`),e.pendingRequests.delete(o),e._activeFetchRequests.delete(o),console.log(`[Optima LoadingTimeTracker] ğŸ§¹ Cleaned up stale fetch request (ID: ${o})`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count After Cleanup: ${e.pendingRequests.size}`))}))}catch(e){console.error("[Optima LoadingTimeTracker] âŒ Error in fetch cleanup interval:",e)}}),1e4))}setupMutationObserver(){if(window.MutationObserver)try{const e=new MutationObserver((e=>{if(this.isComplete||!this.isTracking)return;const t=e.filter((e=>("attributes"!==e.type||!["style","class"].includes(e.attributeName))&&("childList"===e.type&&(e.addedNodes.length>0||e.removedNodes.length>0))));if(t.length>0){const e={mutationCount:t.length,addedNodes:t.reduce(((e,t)=>e+t.addedNodes.length),0),removedNodes:t.reduce(((e,t)=>e+t.removedNodes.length),0),attributeChanges:t.filter((e=>"attributes"===e.type)).length,targets:t.map((e=>e.target.tagName||"unknown")).slice(0,5)};this.recordActivity("dom_mutation",e)}}));e.observe(document.body||document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href","data-src"]}),this.observers.push(e)}catch(e){console.error("[Optima LoadingTimeTracker] âŒ Mutation observer failed:",e)}}setupLoadEventFallback(){"initial"===this.viewType&&("complete"===document.readyState?setTimeout((()=>{this.isComplete||this.complete("load_event_already_complete")}),100):window.addEventListener("load",(()=>{setTimeout((()=>{this.isComplete||this.complete("load_event")}),200)})))}startCompletionCheck(){this.checkInterval&&clearTimeout(this.checkInterval),this.checkInterval=setTimeout((()=>{this.checkForCompletion()}),this.quietPeriod),console.log(`[Optima LoadingTimeTracker] ğŸ”„ Starting completion check with quiet period: ${this.quietPeriod}ms`)}checkForCompletion(){if(this.isComplete||!this.isTracking)return;const e=performance.timeOrigin+performance.now(),t=e-this.lastActivityTime,i=e-this.baselineTime;this.logAllCurrentRequests(),this.scanForUntrackedRequests();const s=this.pendingRequests.size>0||this.pendingResources.size>0;if(console.group(`ğŸ” Loading Time Completion Check - ${this.viewType.toUpperCase()}`),console.log("%cğŸ“Š Current Status:","color: #6b7280; font-weight: bold;"),console.table({"Time Since Last Activity":`${Math.round(t)}ms`,"Total Time Since Baseline":`${Math.round(i)}ms`,"Quiet Period Threshold":`${this.quietPeriod}ms`,"Pending Requests":this.pendingRequests.size,"Pending Resources":this.pendingResources.size,"Has Pending Activity":s,"Activity Sources":Array.from(this.activitySources).join(", ")||"none"}),this.pendingRequests.size>0){console.log("%cğŸ” PENDING REQUESTS DETAIL:","color: #ef4444; font-weight: bold;");Array.from(this.pendingRequests).forEach((e=>{const t=e.match(/(?:xhr|fetch)_([^_]+)/),i=t?t[1]:e;console.log(`  - ${i} (ID: ${e})`)}))}if(this.pendingResources.size>0){console.log("%cğŸ” PENDING RESOURCES DETAIL:","color: #f59e0b; font-weight: bold;");Array.from(this.pendingResources).forEach((e=>{console.log(`  - ${e}`)}))}let n=0,r=!1;if(window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("resource").filter((e=>("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)&&performance.timeOrigin+e.startTime>=this.baselineTime)).filter((t=>{const i=0===t.responseEnd,s=t.responseEnd>0&&e-(performance.timeOrigin+t.responseEnd)<2e3;return i||s}));t.length>0&&(console.log("%câš ï¸ ACTIVE XHR/FETCH RESOURCES FROM PERFORMANCE API:","color: #f97316; font-weight: bold;"),t.forEach((t=>{const i=t.responseEnd>0,s=performance.timeOrigin+t.startTime,o=e-s,n=this.isPendingRequest(t.name);console.log(`  - ${t.name}\n    â€¢ Status: ${i?"COMPLETE":"IN_PROGRESS"}\n    â€¢ Started: ${Math.round(o)}ms ago\n    â€¢ Duration: ${Math.round(t.duration)}ms\n    â€¢ Initiator: ${t.initiatorType}\n    â€¢ In pendingRequests: ${n}`)})));const i=new Set(Array.from(this.pendingRequests).map((e=>{const t=e.match(/(?:xhr|fetch)_([^_]+)/);return t?t[1]:""})).filter(Boolean)),a=new Set(t.map((e=>e.name))),c=[...a].filter((e=>!o(e,this.viewManager.sdk?.config||{})&&(!i.has(e)&&!this.isPendingRequest(e)))),l=[...i].filter((e=>!a.has(e)));n=c.filter((e=>{const i=t.find((t=>t.name===e));return i&&0===i.responseEnd})).length,c.length>0&&(console.log("%câš ï¸ UNTRACKED REQUESTS (in Performance API but not in pendingRequests):","color: #dc2626; font-weight: bold;"),c.forEach((e=>console.log(`  - ${e}`))),console.group("ğŸ”¬ DIAGNOSTIC: Detailed analysis of untracked requests"),c.forEach((e=>{const i=t.find((t=>t.name===e));if(!i)return;console.group(`Analysis for: ${e}`);const s=this.viewManager.sdk?.config||{},n=o(e,s);console.log(`Is in exclusion list: ${n}`);const a=performance.timeOrigin+i.startTime,c=a<this.baselineTime;console.log(`Started before baseline: ${c} (${Math.round(a-this.baselineTime)}ms relative to baseline)`);const l=i.redirectStart>0;console.log(`Is redirect: ${l}`),console.log(`In pendingRequests: ${this.isPendingRequest(e)}`),console.log(`In pendingResources: ${this.pendingResources.has(e)}`);const u=0===i.responseEnd;console.log(`Is in progress: ${u}`),!u||n||c||(r=!0,console.log("âœ… Will add to tracked requests")),console.groupEnd()})),r&&c.forEach((e=>{const i=t.find((t=>t.name===e));if(!i||i.responseEnd>0)return;const n=this.viewManager.sdk?.config||{};if(o(e,n))return;const r=`recovery_${i.initiatorType}_${e}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;this.pendingRequests.add(r),console.log(`[Optima LoadingTimeTracker] â• RECOVERED UNTRACKED REQUEST: ${e} (ID: ${r})`),s=!0})),console.groupEnd()),l.length>0&&(console.log("%câš ï¸ STALE REQUESTS (in pendingRequests but not active in Performance API):","color: #9333ea; font-weight: bold;"),l.forEach((e=>console.log(`  - ${e}`))),l.forEach((e=>{Array.from(this.pendingRequests).filter((t=>{const i=t.match(/(?:xhr|fetch)_([^_]+)/);return i&&i[1]===e})).forEach((t=>{this.pendingRequests.delete(t),console.log(`[Optima LoadingTimeTracker] ğŸ§¹ Cleaned up stale request: ${e} (ID: ${t})`)}))})),s=this.pendingRequests.size>0||this.pendingResources.size>0)}if("initial"===this.viewType){const e=i>=2e4,o=t>=this.quietPeriod&&!s,a=n>0&&r;if(console.log("%cğŸ¯ Initial Load Completion Logic:","color: #3b82f6; font-weight: bold;"),console.table({"Time Since Last Activity":`${Math.round(t)}ms`,"Quiet Period Threshold":`${this.quietPeriod}ms`,"Quiet Period Met":o,"Max Time Reached (20s)":e,"Untracked Active Requests":n,"Delay For Untracked":a,"Will Complete":(o||e)&&!a,"Completion Reason":e?"max_time_reached":o?"activity_quiet":"continue_tracking"}),(o||e)&&!a){const t=e?"max_time_reached":"activity_quiet";return console.log(`âœ… Completing initial load: ${t}`),console.groupEnd(),void this.complete(t)}}else{const e=t>=this.quietPeriod&&!s,o=i>=2e4,a=n>0&&r;if(console.log("%cğŸ¯ Route Change Completion Logic:","color: #8b5cf6; font-weight: bold;"),console.table({"Time Since Last Activity":`${Math.round(t)}ms`,"Quiet Period Threshold":`${this.quietPeriod}ms`,"Quiet Period Met":e,"Max Time Reached (20s)":o,"Untracked Active Requests":n,"Delay For Untracked":a,"Will Complete":(e||o)&&!a,"Completion Reason":o?"route_change_timeout":e?"activity_quiet":"continue_tracking"}),e&&!a)return console.log("âœ… Completing route change: activity_quiet"),console.groupEnd(),void this.complete("activity_quiet");if(o)return console.log("âœ… Completing route change: route_change_timeout"),console.groupEnd(),void this.complete("route_change_timeout")}const a=n>0?Math.min(this.quietPeriod,500):this.quietPeriod;console.log(`ğŸ”„ Continuing tracking - next check in ${a}ms`),console.groupEnd(),this.checkInterval=setTimeout((()=>{this.checkForCompletion()}),a)}complete(e){if(this.isComplete)return;if(console.group(`[Optima LoadingTimeTracker] ğŸ LOADING TIME COMPLETION - ${e.toUpperCase()}`),console.log(`[Optima LoadingTimeTracker] ğŸ•’ Completion Timestamp: ${(new Date).toISOString()}`),window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource"),t=performance.timeOrigin+performance.now(),i=e.filter((e=>("xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)&&t-(performance.timeOrigin+e.startTime)<1e4));console.log(`[Optima LoadingTimeTracker] ğŸ“Š RESOURCE ENTRIES: Found ${i.length} recent XHR/fetch resources`),i.length>0&&(console.log("[Optima LoadingTimeTracker] âš ï¸ RECENT XHR/FETCH RESOURCES AT COMPLETION:"),i.forEach((e=>{const t=e.responseEnd>0,i=performance.timeOrigin+e.startTime,s=t?performance.timeOrigin+e.responseEnd:"PENDING";console.log(`  - ${e.name}`),console.log("    â€¢ Status: "+(t?"COMPLETE":"PENDING")),console.log(`    â€¢ Start: ${new Date(i).toISOString()} (${Math.round(e.startTime)}ms relative)`),console.log(`    â€¢ End: ${t?new Date(s).toISOString():"PENDING"}`),console.log(`    â€¢ Duration: ${t?Math.round(e.duration):"PENDING"}ms`),console.log(`    â€¢ Initiator: ${e.initiatorType}`)})))}this.isComplete=!0,this.isTracking=!1;const t=this.lastActivityTime,i=Math.round(t-this.baselineTime);console.log(`[Optima LoadingTimeTracker] â±ï¸ Loading Time: ${i}ms`),console.log(`[Optima LoadingTimeTracker] ğŸ Baseline Time: ${new Date(this.baselineTime).toISOString()}`),console.log(`[Optima LoadingTimeTracker] ğŸ End Time: ${new Date(t).toISOString()}`);const s=Array.from(this.activitySources).join(", ")||"none",o=Array.from(this.activitySources),n=[...this.detailedActivities];console.log(`[Optima LoadingTimeTracker] ğŸ“Š Activity Sources: ${s}`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Detailed Activities Count: ${n.length}`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Last Activity Time: ${new Date(this.lastActivityTime).toISOString()}`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Requests Count: ${this.pendingRequests.size}`),console.log(`[Optima LoadingTimeTracker] ğŸ“Š Pending Resources Count: ${this.pendingResources.size}`),this.pendingRequests.size>0&&(console.log("[Optima LoadingTimeTracker] âš ï¸ WARNING: Completing with pending requests!"),console.log("Pending Requests:"),Array.from(this.pendingRequests).forEach((e=>{console.log(`  - ${e}`)}))),this.cleanup(),console.groupEnd(),this.viewManager.updateWebVital("loading_time",i,{reason:e,activitySources:o,detailedActivities:n,viewType:this.viewType,baselineTime:this.baselineTime,endTime:t,pendingRequestsCount:this.pendingRequests.size,pendingResourcesCount:this.pendingResources.size}),console.group(`%cğŸš€ View Loading Time Complete! %c${i}ms`,"color: #10b981; font-weight: bold; font-size: 14px;","color: #3b82f6; font-weight: bold; font-size: 16px; background: #eff6ff; padding: 2px 6px; border-radius: 4px;"),console.log("%cğŸ“Š Performance Details:","color: #6b7280; font-weight: bold;"),console.table({"Loading Time":`${i}ms`,"View Type":this.viewType,"Completion Reason":e,"Activity Sources":s,"Baseline Time":new Date(this.baselineTime).toISOString(),"Completion Time":new Date(t).toISOString()}),o.length>0&&console.log("%cğŸ” Detected Activities:","color: #6b7280; font-weight: bold;",o),console.log("%câš¡ Ready for analysis in Optima Dashboard","color: #8b5cf6; font-style: italic;"),console.groupEnd()}scanForUntrackedRequests(){if(!window.performance||!window.performance.getEntriesByType)return;console.log("[Optima LoadingTimeTracker] ğŸ” Scanning for untracked requests...");const e=window.performance.getEntriesByType("resource"),t=performance.now(),i=e.filter((e=>{const i=performance.timeOrigin+e.startTime>=this.baselineTime,s="xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType,o=0===e.responseEnd||t-e.startTime<5e3;return i&&s&&o}));i.length>0&&(console.log(`[Optima LoadingTimeTracker] ğŸ” Found ${i.length} active XHR/fetch resources`),i.forEach((e=>{const t=this.viewManager.sdk?.config||{};if(o(e.name,t))return;this._trackedUrls?.has(e.name)||this.isPendingRequest(e.name)||(console.log(`[Optima LoadingTimeTracker] âš ï¸ Found untracked request: ${e.name}`),this.handlePerformanceResourceTiming(e))})))}logAllCurrentRequests(){if(!window.performance||!window.performance.getEntriesByType)return;console.group("ğŸ”¬ DIAGNOSTIC: ALL CURRENT XHR/FETCH REQUESTS");const e=window.performance.getEntriesByType("resource").filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType));console.log(`Found ${e.length} XHR/fetch resources in Performance API`),e.length>0&&(e.sort(((e,t)=>t.startTime-e.startTime)),e.forEach(((e,t)=>{const i=performance.now(),s=performance.timeOrigin+e.startTime,n=i-s,r=s>=this.baselineTime,a=e.responseEnd>0,c=this.isPendingRequest(e.name);if(console.log(`ğŸ“¡ XHR/FETCH #${t+1}: ${e.name}\n  â€¢ Started: ${Math.round(n)}ms ago (${new Date(s).toISOString()})\n  â€¢ Duration: ${Math.round(e.duration)}ms\n  â€¢ Status: ${a?"COMPLETE":"IN_PROGRESS"}\n  â€¢ Initiator: ${e.initiatorType}\n  â€¢ In baseline: ${r?"YES":"NO"}\n  â€¢ In pendingRequests: ${c?"YES":"NO"}\n  â€¢ Raw entry: `,e),r&&!c){console.warn(`âš ï¸ UNTRACKED REQUEST: ${e.name} should be tracked but isn't in pendingRequests`);const t=this.viewManager.sdk?.config||{};o(e.name,t)?console.log("  â€¢ Reason: In exclusion list"):(console.log("  â€¢ Reason: Unknown - this is a bug!"),s<this.baselineTime+100&&console.log(`  â€¢ Possible reason: Started too early (${Math.round(s-this.baselineTime)}ms after baseline)`),e.redirectStart>0&&console.log("  â€¢ Possible reason: This is a redirect"))}}))),console.log(`Current pendingRequests (${this.pendingRequests.size}):`),Array.from(this.pendingRequests).forEach((e=>{console.log(`  â€¢ ${e}`)})),console.groupEnd()}handlePerformanceResourceTiming(e){if(!e||!e.name)return;if(this._trackedUrls&&this._trackedUrls.has(e.name))return void console.log(`[Optima LoadingTimeTracker] â„¹ï¸ Resource already tracked: ${e.name}`);const t=this.viewManager.sdk?.config||{};if(o(e.name,t))return void console.log(`[Optima LoadingTimeTracker] ğŸš« Resource excluded from loading time tracking: ${e.name}`);const i=performance.timeOrigin+e.startTime>=this.baselineTime,s="xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType;if(i&&s){console.log(`[Optima LoadingTimeTracker] ğŸ”„ Adding untracked request from Performance API: ${e.name}`);const t=encodeURIComponent(e.name).substring(0,100),i=`perf_${e.initiatorType}_${t}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;this.pendingRequests.add(i),this._trackedUrls&&this._trackedUrls.add(e.name);const s={url:e.name,type:e.initiatorType,size:e.transferSize||0,duration:Math.round(e.duration||0),startTime:Math.round(e.startTime),endTime:Math.round(e.startTime+(e.duration||0)),requestId:i,source:"performance_api"};if(this.recordActivity(e.initiatorType,s),e.responseEnd>0)setTimeout((()=>{this.pendingRequests.delete(i),console.log(`[Optima LoadingTimeTracker] â– Performance API request completed: ${e.name}`)}),50);else{const t=setInterval((()=>{const s=performance.getEntriesByName(e.name,"resource").find((t=>t.startTime===e.startTime));s&&s.responseEnd>0&&(clearInterval(t),this.pendingRequests.delete(i),console.log(`[Optima LoadingTimeTracker] â– Performance API request completed: ${e.name}`))}),500);setTimeout((()=>{clearInterval(t),this.pendingRequests.has(i)&&(this.pendingRequests.delete(i),console.log(`[Optima LoadingTimeTracker] âš ï¸ Performance API request timeout: ${e.name}`))}),3e4)}}}isPendingRequest(e){if(!e)return!1;console.group(`ğŸ”¬ DIAGNOSTIC: isPendingRequest check for ${e}`),console.log(`Checking against ${this.pendingRequests.size} pending requests`);let t,i,s=e;try{const t=new URL(e);s=t.origin+t.pathname,console.log(`URL normalized to: ${s}`)}catch(e){console.log(`Could not normalize URL: ${e.message}, using original`)}for(const t of this.pendingRequests){if(t.includes(e))return console.log(`âœ… Direct match found with requestId: ${t}`),console.groupEnd(),!0;if(s!==e&&t.includes(s))return console.log(`âœ… Normalized URL match found with requestId: ${t}`),console.groupEnd(),!0}try{const s=new URL(e);t=s.hostname,i=s.pathname,console.log(`URL parsed successfully: domain=${t}, path=${i}`)}catch(t){console.log(`Failed to parse URL: ${t.message}, falling back to string matching only`);const i=Array.from(this.pendingRequests).some((t=>{const i=t.split("_").slice(1).join("_"),s=i.includes(e)||e.includes(i);return s&&console.log(`âœ… String match found between "${e}" and "${i}" in requestId: ${t}`),s}));return console.log("Result: "+(i?"FOUND":"NOT FOUND")),console.groupEnd(),i}const o=Array.from(this.pendingRequests).some((s=>{const o=s.split("_");if(o.length<2)return!1;let n="";if(o.length>=3){let e=-1;for(let t=2;t<o.length;t++)if(/^\d+$/.test(o[t])){e=t;break}n=e>0?o.slice(1,e).join("_"):o[1]}else n=o[1];if(console.log(`Extracted URL part from requestId: ${n}`),n.includes(e)||e.includes(n))return console.log(`âœ… String match found between "${e}" and "${n}"`),!0;try{const e=new URL(n),s=e.hostname===t,o=e.pathname===i||i.startsWith(e.pathname)||e.pathname.startsWith(i);if(console.log(`Domain match: ${s}, Path match: ${o}`),s&&o)return console.log("âœ… Domain and path match found"),!0;const r=e.pathname.replace(/\/+$/,""),a=i.replace(/\/+$/,"");if(s&&(r===a||a.includes(r)||r.includes(a)))return console.log("âœ… Domain and normalized path match found"),!0}catch(e){if(n.includes(t)){if("/"===i||n.includes(i)||i.split("/").filter(Boolean).some((e=>n.includes(e)&&e.length>3)))return console.log("âœ… Domain and partial path match found through string comparison"),!0}}return!1}));return console.log("Final result: "+(o?"FOUND":"NOT FOUND")),console.groupEnd(),o}cleanup(){this.checkInterval&&(clearTimeout(this.checkInterval),this.checkInterval=null),this._xhrCleanupInterval&&(clearInterval(this._xhrCleanupInterval),this._xhrCleanupInterval=null),this._fetchCleanupInterval&&(clearInterval(this._fetchCleanupInterval),this._fetchCleanupInterval=null),this.observers.forEach((e=>{e.disconnect&&e.disconnect()})),this.observers=[],this.originalXHROpen&&(XMLHttpRequest.prototype.open=this.originalXHROpen),this.originalXHRSend&&(XMLHttpRequest.prototype.send=this.originalXHRSend),this.originalFetch&&(window.fetch=this.originalFetch),this.pendingRequests.clear(),this.pendingResources.clear(),this.activitySources.clear()}}function S(e){e.buffer||(e.buffer={}),e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t)return;try{const i=t.error||new Error(t.message||"Unknown error"),s=i.message||t.message||"Unknown error",o=t.filename||t.srcElement?.src||window.location.href,n=i.stack||null,r="error",a={type:r,message:s,source:o,lineno:t.lineno||0,colno:t.colno||0,stack:n,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:C(r,s,o,n)};O(e,a),V(e),e.sendEvent("error",{error_type:"uncaught_error",message:a.message,source:a.source,lineno:a.lineno,colno:a.colno})}catch(e){}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const i=t.reason,s=i instanceof Error?i.message:String(i),o=i instanceof Error?i.stack:null,n="unhandled_rejection",r="Promise",a={type:n,message:s,source:r,stack:o,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:C(n,s,r,o)};O(e,a),V(e),e.sendEvent("error",{error_type:"unhandled_rejection",message:a.message})}catch(e){}}(e,t)})),function(e){const t=console.error;console.error=function(...i){const s="console.error";try{const t=(new Error).stack||"",o=i.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),n="console_error",r={type:n,message:o,source:s,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:C(n,o,s,t)};O(e,r)}catch(e){}t.apply(console,i)}}(e)}function C(e,t,i,s){const o=`${e}:${t}:${i}:${s?s.substring(0,150):""}`;let n=0;for(let e=0;e<o.length;e++){n=(n<<5)-n+o.charCodeAt(e),n|=0}return"err_"+Math.abs(n).toString(16)}function O(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const i=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(i)return!1;const s=e.buffer.errors.slice(-5),o=s.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!o})(e,t)&&(e.buffer.errors.push(t),e.viewManager&&e.viewManager.currentView&&e.viewManager.addError(t),e.buffer.errors.length>=5&&V(e))}function V(e){e.buffer.errors&&0!==e.buffer.errors.length&&(e.viewManager&&e.dataSender?e.buffer.errors=[]:e.unifiedDataModel?(e.unifiedDataModel.errors||(e.unifiedDataModel.errors=[]),e.unifiedDataModel.errors=[...e.unifiedDataModel.errors,...e.buffer.errors],e.buffer.errors=[],e._sendUnifiedData&&e._sendUnifiedData(!1)):e.buffer.errors=[])}const R={sessionId:null,apiKey:null,disabled:!1,version:"2.0.0-view-based",viewManager:null,routeDetector:null,dataSender:null,continuousMetrics:null,resourceCollector:null,webVitalsCollector:null,isInitialized:!1,initializationTime:null,visibilityChangeCount:0,userIdentity:null,config:{apiKey:null,endpoint:null,sampleRate:100,flushInterval:5e3,webVitalsBatchDelay:2e3,batchBeforeSend:!0,maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,payloadCompressionThreshold:10240,enableRouteChangeTracking:!0,enableContinuousMetrics:!0,batchSize:3,batchTimeout:5e3,continuousMetricsInterval:1e4,exclusionList:null,disableStatusTracking:!1,statusTrackerMaxEntries:1e3,statusTrackerTtl:1e4,statusTrackerTolerance:3e3,loadingTimeQuietPeriod:1e3,debug:!1,disabled:!1},init:function(e={}){if(this.isInitialized)return void console.warn("[ViewBasedOptima] âš ï¸ SDK already initialized");if(console.log("1. [ViewBasedOptima] ğŸš€ Initializing View-Based Optima SDK v"+this.version),this.initializationTime=Date.now(),this.applyConfiguration(e),!this.config.apiKey)return console.error("[ViewBasedOptima] âŒ API key is required"),void(this.disabled=!0);if(this.config.disabled)return console.log("[ViewBasedOptima] â¸ï¸ SDK disabled due to sampling"),void(this.disabled=!0);const t=()=>{console.log("2. [ViewBasedOptima] ğŸš€ Initializing View-Based Optima SDK v"+this.version),this.initializeSession(),this.initializeViewBasedArchitecture(),this.setupErrorMonitoring(),this.setupPageLifecycleEvents(),this.startInitialView(),this.isInitialized=!0,console.log("[ViewBasedOptima] âœ… SDK initialization complete"),this.sendEvent("sdk_initialized",{version:this.version,architecture:"view_based",config:this.config})};"loading"===document.readyState?(document.addEventListener("DOMContentLoaded",t),console.log("[ViewBasedOptima] ğŸ”„ Waiting for DOMContentLoaded before completing initialization")):t()},applyConfiguration:function(e){this.config={...this.config,...e},"number"==typeof this.config.sampleRate&&(this.config.sampleRate=Math.min(Math.max(this.config.sampleRate,1),100)),this.apiKey=this.config.apiKey,this.endpoint=this.config.endpoint,this.sampleRate=this.config.sampleRate,this.config.debug&&(console.log("[ViewBasedOptima] ğŸ› Debug mode enabled"),console.log(`[ViewBasedOptima] ğŸ”§ SDK Config - Endpoint: ${this.endpoint}, API Key: ${this.apiKey?this.apiKey.substring(0,8)+"...":"NOT SET"}, Sample Rate: ${this.sampleRate}%`)),this.shouldTrackSession(this.config.sampleRate)||(console.log(`[ViewBasedOptima] ğŸ² Session not tracked (sample rate: ${this.config.sampleRate}%)`),this.config.disabled=!0)},initializeSession:function(){this.sessionId=t(),this.usageLimitExceeded=!1,this.usageLimitCheckedAt=null,console.log(`[ViewBasedOptima] ğŸ†” Session initialized: ${this.sessionId.substring(0,8)}...`)},initializeViewBasedArchitecture:function(){console.log("[ViewBasedOptima] ğŸ—ï¸ Initializing view-based architecture"),this.viewManager=new a(this),this.config.enableRouteChangeTracking&&(this.routeDetector=new c(this.viewManager),this.routeDetector.setupRouteDetection()),this.dataSender=new l(this),this.dataSender.updateConfig({maxBatchSize:this.config.batchSize,batchTimeout:this.config.batchTimeout,flushInterval:this.config.flushInterval,webVitalsBatchDelay:this.config.webVitalsBatchDelay,batchBeforeSend:this.config.batchBeforeSend,maxEventsPerBatch:this.config.maxEventsPerBatch,maxResourcesPerBatch:this.config.maxResourcesPerBatch,maxWebVitalsPerBatch:this.config.maxWebVitalsPerBatch,maxAjaxCallsPerBatch:this.config.maxAjaxCallsPerBatch,payloadCompressionThreshold:this.config.payloadCompressionThreshold}),this.config.enableContinuousMetrics&&(this.continuousMetrics=new u(this.viewManager,this.dataSender),this.config.continuousMetricsInterval&&this.continuousMetrics.updateInterval&&this.continuousMetrics.updateInterval(this.config.continuousMetricsInterval)),this.resourceCollector=new d(this.viewManager),this.webVitalsCollector=new b(this.viewManager),this.viewManager.webVitalsCollector=this.webVitalsCollector,console.log("[ViewBasedOptima] âœ… View-based architecture initialized")},shouldTrackSession:function(e){return e>=100||(e<=1?Math.random()<.01:100*Math.random()<e)},setupErrorMonitoring:function(){try{S(this)}catch(e){console.error("[ViewBasedOptima] âŒ Error setting up error monitoring:",e)}},setupPageLifecycleEvents:function(){document.addEventListener("visibilitychange",(()=>{this.visibilityChangeCount++,"hidden"===document.visibilityState?this.handlePageHidden():"visible"===document.visibilityState&&this.handlePageVisible()})),window.addEventListener("beforeunload",(()=>{this.handlePageUnload()})),window.addEventListener("blur",(()=>{this.sendEvent("page_blur",{timestamp:Date.now()})})),window.addEventListener("focus",(()=>{this.sendEvent("page_focus",{timestamp:Date.now()})}))},startInitialView:function(){console.log("[ViewBasedOptima] ğŸ¬ Starting initial view"),this.viewManager.startNewView("initial",window.location.href),this.continuousMetrics&&this.continuousMetrics.startContinuousTracking(),this._onViewCompleted=(e,t)=>{this.handleViewCompleted(e,t)}},startCollectorsForView:function(e){console.log(`[ViewBasedOptima] ğŸ”§ Starting collectors for ${e} view`),this.resourceCollector.startCollecting(),this.webVitalsCollector.startCollecting(e)},handleViewCompleted:function(e,t){console.log(`[ViewBasedOptima] ğŸ View completed: ${e.id.substring(0,8)}... (${t})`),this.dataSender.sendViewData(e,t),this.dataSender.markViewCompleted(e.id)},handlePageHidden:function(){console.log("[ViewBasedOptima] ğŸ‘ï¸ Page hidden"),this.sendEvent("page_hidden",{timestamp:Date.now()},{immediate:!0}),this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_hidden"),this.dataSender&&this.dataSender.forceFlush()},handlePageVisible:function(){console.log("[ViewBasedOptima] ğŸ‘ï¸ Page visible"),this.sendEvent("page_visible",{timestamp:Date.now()})},handlePageUnload:function(){console.log("[ViewBasedOptima] ğŸ“¤ Page unloading"),this.viewManager.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("page_unload"),this.dataSender&&this.dataSender.forceFlush(),this.continuousMetrics&&this.continuousMetrics.stopContinuousTracking()},sendEvent:function(e,t={},i={}){if(this.disabled||!this.sessionId)return;const s={name:e,data:t,timestamp:Date.now(),session_id:this.sessionId,url:window.location.href};this.viewManager?.currentView&&this.viewManager.addEvent(s),i.immediate&&this._sendToServer("/api/optima/events",s,{sync:!0})},track:function(e,t={}){return new Promise(((i,s)=>this.disabled?(console.warn("[ViewBasedOptima] âš ï¸ SDK is disabled, custom data not stored"),void s(new Error("SDK is disabled"))):this.sessionId?!t||"object"!=typeof t||Array.isArray(t)?(console.error("[ViewBasedOptima] âŒ Custom data must be a valid object"),void s(new Error("Custom data must be a valid object"))):0===Object.keys(t).length?(console.warn("[ViewBasedOptima] âš ï¸ Custom data object is empty"),void s(new Error("Custom data object cannot be empty"))):(console.log("[ViewBasedOptima] ğŸ“Š Storing custom data for session:",this.sessionId.substring(0,8)+"..."),this.customData=this.customData||{},this.customData[e]={...t,tracked_at:(new Date).toISOString(),tracked_url:window.location.href,tracked_timestamp:Date.now()},console.log("[ViewBasedOptima] âœ… Custom data stored successfully and will be included in all collect requests"),console.log("[ViewBasedOptima] ğŸ” Custom data:",this.customData),void i()):(console.warn("[ViewBasedOptima] âš ï¸ No active session, custom data not stored"),void s(new Error("No active session")))))},identify:function(e){return new Promise(((t,i)=>this.disabled?(console.warn("[ViewBasedOptima] âš ï¸ SDK is disabled, identity not stored"),void i(new Error("SDK is disabled"))):this.sessionId?!e||"object"!=typeof e||Array.isArray(e)?(console.error("[ViewBasedOptima] âŒ Identity must be a valid object"),void i(new Error("Identity must be a valid object"))):0===Object.keys(e).length?(console.warn("[ViewBasedOptima] âš ï¸ Identity object is empty"),void i(new Error("Identity object cannot be empty"))):(console.log("[ViewBasedOptima] ğŸ†” Storing user identity for session:",this.sessionId.substring(0,8)+"..."),this.userIdentity={...e,identified_at:(new Date).toISOString(),identified_url:window.location.href,identified_timestamp:Date.now()},console.log("[ViewBasedOptima] âœ… User identity stored successfully and will be included in all collect requests"),console.log("[ViewBasedOptima] ğŸ” Identity data:",this.userIdentity),void t()):(console.warn("[ViewBasedOptima] âš ï¸ No active session, identity not stored"),void i(new Error("No active session")))))},triggerRouteChange:function(e){this.routeDetector&&this.routeDetector.triggerRouteChange(e,"manual")},getCurrentView:function(){return this.viewManager?.getCurrentViewData()||null},getViewHistory:function(){return this.viewManager?.getViewHistory()||[]},getStatus:function(){return{isInitialized:this.isInitialized,sessionId:this.sessionId,version:this.version,disabled:this.disabled,currentView:this.getCurrentView(),viewHistory:this.getViewHistory(),config:this.config,components:{viewManager:!!this.viewManager,routeDetector:!!this.routeDetector,dataSender:!!this.dataSender,continuousMetrics:!!this.continuousMetrics,resourceCollector:!!this.resourceCollector,webVitalsCollector:!!this.webVitalsCollector}}},updateConfig:function(e){this.config={...this.config,...e},this.dataSender&&(e.batchSize||e.batchTimeout)&&this.dataSender.updateConfig({maxBatchSize:e.batchSize,batchTimeout:e.batchTimeout}),this.continuousMetrics&&e.continuousMetricsInterval&&this.continuousMetrics.updateInterval(e.continuousMetricsInterval),console.log("[ViewBasedOptima] âš™ï¸ Configuration updated:",this.config)},debugResources:function(){if(console.log("[ViewBasedOptima] ğŸ” RESOURCE COLLECTION DEBUG"),console.log("====================================="),this.viewManager){const e=this.viewManager.getResourceCollectionDebug();e&&console.log("[ViewBasedOptima] ğŸ“Š Resource Collection Stats:",e);const t=this.viewManager.getCurrentViewData();t&&console.log("[ViewBasedOptima] ğŸ“‹ Current View:",{id:t.id.substring(0,8),type:t.type,url:t.url,resourceCount:t.resources.length,ajaxCount:t.ajaxRequests.length})}else console.log("[ViewBasedOptima] âŒ ViewManager not available");const e=performance.getEntriesByType("resource"),t=e.filter((e=>e.name.toLowerCase().includes(".js"))),i=e.filter((e=>e.name.includes("bundle")||e.name.includes("chunk")));console.log("[ViewBasedOptima] ğŸŒ Browser Resource Summary:",{total:e.length,jsFiles:t.length,bundleFiles:i.length}),i.length>0&&console.log("[ViewBasedOptima] ğŸ“¦ Bundle Files in Browser:",i.map((e=>({url:e.name,startTime:e.startTime.toFixed(2),initiatorType:e.initiatorType,transferSize:e.transferSize}))))},_resetPerformanceObservers:function(){console.log("[ViewBasedOptima] ğŸ§¹ Resetting performance observers for view transition"),this.webVitalsCollector&&this.webVitalsCollector.clearObservers(),this.resourceCollector&&"function"==typeof this.resourceCollector.clearObservers&&this.resourceCollector.clearObservers(),console.log("[ViewBasedOptima] âœ… Performance observers cleared")},_sendToServer:function(e,t,i={}){if(!this.disabled)if(this.usageLimitExceeded)this.config.debug&&console.warn("[ViewBasedOptima] ğŸš« Skipping request - usage limit exceeded");else{t.api_key=this.apiKey,t.timestamp=t.timestamp||Date.now(),t.user_agent=navigator.userAgent;try{const s=`${this.endpoint||this.config.endpoint||"https://api.optimajs.com"}${e}`;if(i.sync&&navigator.sendBeacon){const o=new URL(s);o.searchParams.set("api_key",this.apiKey);const n=navigator.sendBeacon(o.toString(),JSON.stringify(t));this.config.debug&&console.log(`[ViewBasedOptima] ğŸš¨ BeaconAPI send ${n?"SUCCESS":"FAILED"} to ${e}`),n||this._sendViaFetch(s,t,{...i,sync:!0})}else this._sendViaFetch(s,t,i)}catch(e){this.config.debug&&console.error("[ViewBasedOptima] âŒ Send error:",e)}}},_sendViaFetch:function(e,t,i={}){fetch(e,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),keepalive:i.sync}).then((t=>(this.config.debug&&console.log(`[ViewBasedOptima] âœ… Fetch ${t.ok?"SUCCESS":"ERROR"} to ${e} (Status: ${t.status})`),429===t.status&&(this.usageLimitExceeded=!0,this.usageLimitCheckedAt=Date.now(),console.warn("[ViewBasedOptima] ğŸš« Usage limit exceeded (HTTP 429). SDK will stop sending requests."),t.json().then((e=>{e&&e.current&&e.limit&&console.warn(`[ViewBasedOptima] ğŸ“Š Usage: ${e.current}/${e.limit} sessions`)})).catch((()=>{}))),t))).catch((e=>{this.config.debug&&console.error("[ViewBasedOptima] âŒ Fetch failed:",e)}))},resetUsageLimit:function(){this.usageLimitExceeded=!1,this.usageLimitCheckedAt=null,console.log("[ViewBasedOptima] âœ… Usage limit state reset - SDK will resume sending requests")},isUsageLimitExceeded:function(){return this.usageLimitExceeded},cleanup:function(){console.log("[ViewBasedOptima] ğŸ§¹ Cleaning up SDK"),this.viewManager?.currentView&&!this.viewManager.currentView.isCompleted&&this.viewManager.completeView("sdk_cleanup"),this.dataSender&&this.dataSender.cleanup(),this.continuousMetrics&&this.continuousMetrics.cleanup(),this.resourceCollector&&this.resourceCollector.reset(),this.webVitalsCollector&&this.webVitalsCollector.reset(),this.routeDetector&&this.routeDetector.cleanup(),this.isInitialized=!1,this.sessionId=null,this.usageLimitExceeded=!1,this.usageLimitCheckedAt=null},generateMetadata:function(){const e=performance.getEntriesByType("navigation")[0],t={url:window.location.href,path:window.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:window.screen.width,screen_height:window.screen.height,viewport_width:window.innerWidth,viewport_height:window.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,device_type:this._detectDeviceType(),page_visibility:document.visibilityState,visibility_changes:this.visibilityChangeCount||0,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:e?.type||null,http_version:e?.nextHopProtocol||null,sdk_version:this.version,lastUpdated:Date.now(),frameworks:n(),city:"Unknown",region:"Unknown",country:"Unknown",countryCode:"XX",clientIP:null,isLocalIP:null};return this.userIdentity&&(t.user_identity=this.userIdentity),this.customData&&(t.custom_data=this.customData),t},_detectBrowser:function(){const e=navigator.userAgent;return e.includes("Chrome")&&!e.includes("Edg")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")&&!e.includes("Chrome")?"Safari":e.includes("Edg")?"Edge":e.includes("Opera")||e.includes("OPR")?"Opera":"Unknown"},_detectDeviceType:function(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&!window.MSStream||/android/i.test(e)?"mobile":/Tablet|iPad/i.test(e)?"tablet":"desktop"},_detectOS:function(){const e=navigator.userAgent;return e.includes("Windows")?"Windows":e.includes("Mac OS")||e.includes("Macintosh")?"Mac OS":e.includes("Linux")?"Linux":e.includes("Android")?"Android":e.includes("iOS")||e.includes("iPhone")||e.includes("iPad")?"iOS":"Unknown"},cleanup:function(){console.log("[ViewBasedOptima] ğŸ§¹ Cleaning up SDK");try{this.viewManager&&this.viewManager.cleanup(),this.continuousMetrics&&this.continuousMetrics.stop(),this.routeDetector&&this.routeDetector.stop(),this.resourceCollector&&this.resourceCollector.clearObservers(),this.webVitalsCollector&&this.webVitalsCollector.cleanup(),this.isInitialized=!1,this.sessionId=null,this.userIdentity=null,this.customData=null,console.log("[ViewBasedOptima] âœ… SDK cleanup complete")}catch(e){console.error("[ViewBasedOptima] âŒ Error during cleanup:",e)}},getStatus:function(){return{isInitialized:this.isInitialized,version:this.version,sessionId:this.sessionId,disabled:this.disabled,config:{...this.config},statusTracker:this.viewManager?.getStatusTrackerStats()||null,viewHistory:this.viewManager?.getViewHistory()||[],currentView:this.viewManager?.currentView||null}},getExclusionListInfo:function(){const e=function(e={}){return{optima:[...i],thirdParty:e.exclusionList||[...s],isUsingCustomExclusionList:!!e.exclusionList}}(this.config);return{isUsingCustomList:e.isUsingCustomExclusionList,optimaExclusionList:e.optima,thirdPartyExclusionList:e.thirdParty,totalPatterns:e.optima.length+e.thirdParty.length}}};if("undefined"!=typeof window&&window.OptimaConfig&&R.init(window.OptimaConfig),"undefined"!=typeof window){const e=window.optima&&window.optima.q?[...window.optima.q]:[];window.optima=function(){const e=Array.prototype.slice.call(arguments),t=e[0];if(console.log("[ViewBasedOptima] ğŸ”§ Processing command:",t,e),"init"===t)if("string"==typeof e[1]){const t=e[1],i=e[2]||{};i.apiKey=t,console.log("[ViewBasedOptima] ğŸ”§ Initializing with old format"),R.init(i)}else console.log("[ViewBasedOptima] ğŸ”§ Initializing with new format"),R.init(e[1]||{});else{if("track"===t)return R.track(e[1],e[2]);if("identify"===t)return R.identify(e[1]);if("getStatus"===t)return R.getStatus();"updateConfig"===t?R.updateConfig(e[1]):console.warn("[ViewBasedOptima] Unknown command:",t)}},window.ViewBasedOptima=R,e.length>0?(console.log("[ViewBasedOptima] ğŸ”„ Processing queued calls:",e.length),e.forEach((e=>{try{console.log("[ViewBasedOptima] ğŸ”„ Processing queued call:",e[0]),window.optima.apply(window,e)}catch(t){console.error("[ViewBasedOptima] âŒ Error processing queued call:",t,e)}}))):console.log("[ViewBasedOptima] ğŸ“­ No queued calls to process")}return e.ViewBasedOptima=R,e.default=R,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
