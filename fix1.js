!function(){"use strict";function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function t(e){if(!e||!e.previousRect||!e.currentRect)return 0;const t=e.previousRect,n=e.currentRect,s=Math.abs(t.x-n.x),i=Math.abs(t.y-n.y);return Math.sqrt(s*s+i*i)*(Math.max(t.width*t.height,n.width*n.height)/(window.innerWidth*window.innerHeight))}function n(e){return e?{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(e.width),height:Math.round(e.height),top:Math.round(e.top),right:Math.round(e.right),bottom:Math.round(e.bottom),left:Math.round(e.left)}:null}function s(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id){e+=`#${n.id}`,t.unshift(e);break}if(n.className&&"string"==typeof n.className){const t=n.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let s=n,i=1;for(;s=s.previousElementSibling;)i++;if(i>1&&(e+=`:nth-child(${i})`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function i(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id&&(e=`${e}#${n.id}`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function a(e){if(!e||!e.textContent)return null;const t=e.textContent.trim().replace(/\s+/g," ");return t.length>60?t.substring(0,60)+"...":t}function r(e){if(!e||!e.attributes)return{};const t={},n=["src","href","alt","title","aria-label","role","data-testid"];n.forEach((n=>{e.hasAttribute(n)&&(t[n]=e.getAttribute(n))}));for(let s=0;s<e.attributes.length;s++){const i=e.attributes[s];i.name.startsWith("data-")&&!n.includes(i.name)&&(t[i.name]=i.value)}return t}function o(e){if(!e||!e.previousRect||!e.currentRect)return"unknown";const t=e.previousRect,n=e.currentRect;if(0===t.width&&0===t.height&&(n.width>0||n.height>0))return"appeared";if(0===n.width&&0===n.height&&(t.width>0||t.height>0))return"disappeared";const s=Math.abs(t.width-n.width)>1||Math.abs(t.height-n.height)>1,i=Math.abs(t.x-n.x)>1||Math.abs(t.y-n.y)>1;return s&&i?"resize-and-move":s?"resize":i?"move":"unknown"}function u(e){if(!e||!window.getComputedStyle)return!1;try{const t=window.getComputedStyle(e);return"0s"!==t.transitionDuration||"none"!==t.animationName||e.classList.contains("animate")||e.classList.contains("fade")||e.classList.contains("slide")}catch(e){return!1}}function l(e){try{"PerformanceObserver"in window&&(function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("paint"))return;try{new PerformanceObserver((t=>{const n=t.getEntries().find((e=>"first-contentful-paint"===e.name));if(!n)return;window.performance.mark("optima_fcp");const s=n.startTime;e.sendEvent("core_web_vital",{name:"FCP",value:s},{immediate:!0}),e.unifiedDataModel.web_vitals.FCP={value:s,timestamp:performance.timeOrigin+n.startTime},setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),500)})).observe({type:"paint",buffered:!0}),setTimeout((()=>{if(!e.unifiedDataModel.web_vitals.FCP){const t=performance.getEntriesByType("paint").find((e=>"first-contentful-paint"===e.name));t&&(e.unifiedDataModel.web_vitals.FCP={value:t.startTime,timestamp:performance.timeOrigin+t.startTime},e.sendEvent("core_web_vital",{name:"FCP",value:t.startTime},{immediate:!0}))}}),3e3)}catch(e){console.error("[Optima Debug] Error setting up FCP observer:",e)}}(e),function(e){let t=0;const n=new PerformanceObserver((n=>{const s=n.getEntries(),i=s[s.length-1];if(window.performance.mark("optima_lcp"),window.performance.measure("optima_lcp_time","navigationStart","optima_lcp"),i.startTime>t){t=i.startTime;const n=function(e){if(e.element){const t=e.element,n=c(t),s=d(t);return{tagName:t.tagName,id:t.id||null,className:t.className||null,cssPath:n,domPath:s,size:e.size,url:e.url||null,dimensions:t.getBoundingClientRect?{width:Math.round(t.getBoundingClientRect().width),height:Math.round(t.getBoundingClientRect().height)}:null,nodeType:t.nodeType,textContent:t.textContent?.slice(0,100)||null}}if(e.url){const t=e.url,n=function(e){try{const t=e.split("?")[0],n=t.split("#")[0].split("/").pop(),s=Array.from(document.querySelectorAll("img[src]"));for(const t of s)if(t.src===e||t.src.includes(n))return t;try{const t=Array.from(document.querySelectorAll("image[href]")),s=Array.from(document.querySelectorAll("image[*|href]")),i=[...t,...s];for(const t of i){const s=t.getAttribute("href")||t.getAttribute("xlink:href");if(s===e||s?.includes(n))return t}}catch(e){console.warn("[Optima] Could not query SVG image elements:",e.message)}const i=Array.from(document.querySelectorAll("*"));for(const t of i){const s=window.getComputedStyle(t).backgroundImage;if(s&&"none"!==s){const i=s.match(/url\(['"]?(.*?)['"]?\)/)?.[1];if(i===e||i?.includes(n))return t}}const a=performance.getEntriesByType("resource").find((t=>t.name===e));if(a&&"img"===a.initiatorType){return Array.from(document.querySelectorAll("div, section, header, main, article")).sort(((e,t)=>{const n=e.getBoundingClientRect(),s=t.getBoundingClientRect();return s.width*s.height-n.width*n.height}))[0]||null}}catch(e){console.error("[Optima] Error finding element by URL:",e)}return null}(t);return n?{tagName:n.tagName,id:n.id||null,className:n.className||null,cssPath:c(n),domPath:d(n),size:e.size,url:t,elementFoundBy:"url-matching",dimensions:n.getBoundingClientRect?{width:Math.round(n.getBoundingClientRect().width),height:Math.round(n.getBoundingClientRect().height)}:null}:{tagName:null,url:t,size:e.size,elementFoundBy:"url-only",imageType:f(t),resourceType:m(t)}}return{detail:"No element or URL available",size:e.size||0,startTime:e.startTime}}(i);e.sendEvent("core_web_vital",{name:"LCP",value:i.startTime,element:n}),e.unifiedDataModel.web_vitals.LCP={value:i.startTime,timestamp:performance.timeOrigin+i.startTime,element:n},s.length<=1&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3)}}));n.observe({type:"largest-contentful-paint",buffered:!0})}(e),function(e){const t=new PerformanceObserver((t=>{const n=t.getEntries()[0];window.performance.mark("optima_fid");const s={type:n.name,targetElement:n.target?{tagName:n.target.tagName,id:n.target.id||null,className:n.target.className||null}:null,timing:{processingStart:n.processingStart,processingEnd:n.processingEnd,startTime:n.startTime}},i=n.processingStart-n.startTime;e.sendEvent("core_web_vital",{name:"FID",value:i,inputType:n.name,details:s},{immediate:!0}),e.unifiedDataModel.web_vitals.FID={value:i,timestamp:performance.timeOrigin+n.startTime,inputType:n.name,details:s}}));t.observe({type:"first-input",buffered:!0})}(e),function(e){let l=0,c=[],d=[],f=performance.now(),m=0,h=0,p={value:0,entry:null,sourceInfo:null};document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?m>0&&(e.unifiedDataModel.web_vitals.CLS={value:m,timestamp:Date.now(),entries:d.length,largestShiftSource:p.sourceInfo}):"visible"===document.visibilityState&&performance.now()-f>1e3&&(f=performance.now(),m=0,d=[])}));const g=new PerformanceObserver((f=>{try{f.getEntries().forEach((f=>{try{if(!f.hadRecentInput&&(l+=f.value,c.push(f),m+=f.value,d.push({value:f.value,startTime:f.startTime}),f.value>p.value)){let l=null;try{l=function(e){if(!e||!e.sources||0===e.sources.length)return null;try{const l=e.sources.reduce(((e,n)=>{try{return(n.impactValue||t(n))>(e.impactValue||t(e))?n:e}catch(t){return console.warn("[Optima] Error comparing layout shift sources:",t.message),e}}),e.sources[0]);if(!l)return null;const c=l.node;return c?{tagName:c.tagName||"UNKNOWN",id:c.id||null,className:"string"==typeof c.className?c.className:null,cssPath:s(c),domPath:i(c),textContent:a(c),attributes:r(c),previousRect:n(l.previousRect),currentRect:n(l.currentRect),impactValue:l.impactValue||t(l),shiftType:o(l),isAnimating:u(c),isImage:"IMG"===c.tagName,isIframe:"IFRAME"===c.tagName,isVideo:"VIDEO"===c.tagName}:{previousRect:n(l.previousRect),currentRect:n(l.currentRect),impactValue:l.impactValue||t(l),nodeLost:!0,shiftType:o(l)}}catch(e){return console.warn("[Optima] Error analyzing layout shift source:",e.message),null}}(f)}catch(e){console.warn("[Optima] Error getting layout shift source:",e.message)}l&&(p={value:f.value,entry:f,sourceInfo:l,timestamp:performance.timeOrigin+f.startTime},e.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:f.value,timestamp:performance.timeOrigin+f.startTime,source:l,loadState:document.readyState})}}catch(e){console.warn("[Optima] Error processing layout shift entry:",e.message)}}));const g=Date.now();(g-h>5e3||c.length%10==0)&&c.length>0&&(h=g,e.sendEvent("core_web_vital",{name:"CLS",value:l,entries:c.length,sessionValue:m,sessionEntries:d.length,largestShift:p.value>0?{value:p.value,timestamp:p.timestamp,source:p.sourceInfo}:null}),e.unifiedDataModel.web_vitals.CLS={value:l,timestamp:g,entries:c.length,sessionValue:m,sessionEntries:d.length,largestShiftSource:p.sourceInfo},c.length%30==0&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3))}catch(e){console.warn("[Optima] Error in CLS observer:",e.message)}}));try{g.observe({type:"layout-shift",buffered:!0})}catch(e){console.warn("[Optima] Error setting up CLS observer:",e.message)}}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("event"))return;let t=0,n=[];const s=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{n.push({startTime:e.startTime,duration:e.duration,endTime:e.startTime+e.duration,culprits:e.attribution&&e.attribution.map((e=>({sourceFile:e.source||"unknown",type:e.type||"script",duration:e.duration||0})))}),n.length>20&&n.shift()}))}));try{window.PerformanceObserver.supportedEntryTypes.includes("long-animation-frame")&&s.observe({type:"long-animation-frame",buffered:!0})}catch(e){}const i=new PerformanceObserver((s=>{s.getEntries().forEach((s=>{if(!["pointerdown","keydown","click","mousedown","touchstart"].includes(s.name))return;const i=s.processingStart-s.startTime,a=s.processingEnd-s.processingStart,r=s.processingEnd,o=s.startTime;let u;if(s.renderTime)u=s.renderTime-s.processingEnd;else{const e=s.duration?s.duration-(r-o):0;u=e>0?e:Math.max(.5*a,8)}const l=i+a+u,f=function(e){if(!e.target)return{tagName:"unknown",interactionType:e.name};const t=e.target;let n=t.textContent;n&&(n=n.trim().replace(/\s+/g," "),n.length>60&&(n=n.substring(0,57)+"..."));const s={};if(t.attributes)for(let e=0;e<t.attributes.length;e++){const n=t.attributes[e];n.name.startsWith("data-")||n.name.startsWith("on")||"style"===n.name||"class"===n.name||(s[n.name]=n.value)}return{tagName:t.tagName||"unknown",id:t.id||null,className:t.className||null,textContent:n||null,attributes:Object.keys(s).length>0?s:null,cssPath:c(t),domPath:d(t),isButton:"BUTTON"===t.tagName||"button"===t.getAttribute("role")||"INPUT"===t.tagName&&["button","submit"].includes(t.type),isInput:"INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName,isLink:"A"===t.tagName,interactionType:e.name}}(s),m=function(e,t){if(!t||0===t.length)return[];return t.filter((t=>t.startTime<=e.processingEnd&&t.endTime>=e.processingStart)).map((e=>({duration:e.duration,startTime:e.startTime,culprits:e.culprits||[]})))}(s,n),h={name:s.name,startTime:s.startTime,processingStart:s.processingStart,processingEnd:s.processingEnd,duration:l,renderTime:s.renderTime||null,interactionId:s.interactionId||null,timing:{inputDelay:i,processingDuration:a,presentationDelay:u,totalDuration:l},target:f,longAnimationFrames:m};l>t&&(t=l,e.sendEvent("core_web_vital",{name:"INP",value:l,interaction:h}),e.unifiedDataModel.web_vitals.INP={value:l,timestamp:performance.timeOrigin+s.startTime,interaction:h})}))}));try{i.observe({type:"event",buffered:!0,durationThreshold:16})}catch(e){}}(e),function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)})),window.addEventListener("beforeunload",(function(){e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)}))}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;let t=[];const n=new PerformanceObserver((n=>{n.getEntries().forEach((e=>{t.push({startTime:e.startTime,duration:e.duration,attribution:e.attribution?.length?{name:e.attribution[0].name,containerType:e.attribution[0].containerType,containerName:e.attribution[0].containerName,containerId:e.attribution[0].containerId}:null})})),t.length>=5&&(e.unifiedDataModel.metrics.longTasks=t,t=[])}));try{n.observe({type:"longtask",buffered:!0})}catch(e){}}(e))}catch(e){}}function c(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id){e+=`#${n.id}`,t.unshift(e);break}if(n.className&&"string"==typeof n.className){const t=n.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let s=n,i=1;for(;s=s.previousElementSibling;)i++;if(i>1&&(e+=`:nth-child(${i})`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function d(e){if(!e)return null;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=n.tagName.toLowerCase();if(n.id&&(e=`${e}#${n.id}`),t.unshift(e),"body"===n.tagName.toLowerCase()||t.length>=5)break;n=n.parentNode}return t.join(" > ")}function f(e){if(!e)return"unknown";const t=e.split(".").pop().toLowerCase();switch(t){case"jpg":case"jpeg":return"jpeg";case"png":return"png";case"svg":return"svg";case"webp":return"webp";case"gif":return"gif";case"avif":return"avif";default:return t||"unknown"}}function m(e){try{const t=performance.getEntriesByType("resource").find((t=>t.name===e));if(t)return t.initiatorType||"unknown"}catch(e){console.error("[Optima] Error finding resource type:",e)}return"unknown"}const h="Maximum send attempts reached",p="Rate limited (too soon since last send)",g="Excluded by sample rate",b="Route change detected";function v(t,n=!1){t.sessionState||(t.sessionState={sendAttempts:0,lastSendTime:0,isActive:!0,pageLoads:0,routeChanges:0,lastStopReason:null,stopTimestamp:null});var s;if(!((s=t.sampleRate)>=100||(s<=1?Math.random()<.01:100*Math.random()<s)))return t.disabled=!0,t.sessionState.lastStopReason=g,t.sessionState.stopTimestamp=Date.now(),console.log("[Optima Debug] Session: Not tracking due to sample rate",{sampleRate:t.sampleRate,reason:t.sessionState.lastStopReason,timestamp:new Date(t.sessionState.stopTimestamp).toISOString()}),null;!n&&t.sessionId||(t.sessionId=e(),console.log("[Optima Debug] Session: Generated new session ID",{sessionId:t.sessionId,isRouteChange:n,timestamp:(new Date).toISOString()}));const i=window.location.href,a=document.referrer||"";let r=null;window.performance&&window.performance.timing&&(r=window.performance.timing.navigationStart);let o="unknown",u="unknown";const l=window.navigator.userAgent;if(o=/Mobi|Android|iPhone|iPad|iPod/i.test(l)?"mobile":/Tablet|iPad/i.test(l)?"tablet":"desktop",window.navigator.connection){const e=window.navigator.connection;e.effectiveType?u=e.effectiveType:e.type&&(u=e.type)}const c={session_id:t.sessionId,page_url:i,referrer:a,user_agent:l,device_type:o,connection_type:u,timestamp:Date.now(),navigation_start:r||Date.now(),meta:{sdk_version:"1.0.0",page_loads:t.sessionState.pageLoads,route_changes:t.sessionState.routeChanges,is_route_change:n}};return function(e){if(!e.buffer.preSessionAjaxCalls||!e.buffer.preSessionAjaxCalls.length)return;const t=e.buffer.preSessionAjaxCalls.sort(((e,t)=>e.startTime-t.startTime));if(window.performance&&window.performance.getEntriesByType){const e=window.performance.getEntriesByType("resource");t.forEach((t=>{if(t.resourceTiming)return;const n=t.responseURL||t.url;let s=e.find((e=>e.name===n));if(!s)try{const t=new URL(n).pathname;s=e.find((e=>{try{return new URL(e.name).pathname===t}catch{return!1}}))}catch{}if(!s){const n=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType));if(n.length>0){let e=null,i=1/0;n.forEach((n=>{const s=Math.abs(n.startTime-t.startTime);s<i&&(i=s,e=n)})),e&&i<100&&(s=e)}}s&&(t.resourceTiming={startTime:Math.round(s.startTime),duration:Math.round(s.duration),domainLookupTime:Math.round(s.domainLookupEnd-s.domainLookupStart),connectTime:Math.round(s.connectEnd-s.connectStart),tlsTime:s.secureConnectionStart?Math.round(s.connectEnd-s.secureConnectionStart):0,requestStartTime:Math.round(s.requestStart),ttfb:Math.round(s.responseStart-s.requestStart),downloadTime:Math.round(s.responseEnd-s.responseStart),entryType:s.entryType,initiatorType:s.initiatorType})}))}const n=new Set(e.buffer.ajaxCalls.map((e=>e.url))),s=t.filter((t=>!n.has(t.url)||!e.buffer.ajaxCalls.some((e=>e.url===t.url&&Math.abs(e.startTime-t.startTime)<50))));e.buffer.ajaxCalls=[...s,...e.buffer.ajaxCalls],e.buffer.preSessionAjaxCalls=[]}(t),t._sendToServer("/api/optima/sessions",c).then((e=>{e?(console.log("[Optima Debug] Session: Created successfully",{sessionId:t.sessionId,timestamp:(new Date).toISOString(),pageLoads:t.sessionState.pageLoads,routeChanges:t.sessionState.routeChanges,isRouteChange:n}),t._setupEventListeners(),t._setupPerformanceObservers(),t._startBatchProcessing(),t.sessionStartTime=Date.now(),t.unifiedDataModel.session_id=t.sessionId,t.unifiedDataModel.timestamp=t.sessionStartTime):(console.error("[Optima Debug] Session: Failed to create session, monitoring disabled"),t.sessionState.lastStopReason="Failed to create session",t.sessionState.stopTimestamp=Date.now())})),t.sessionId}function S(e){if(!e.sessionState)return console.error("[Optima Debug] Session: Cannot check send state - no session state"),!1;if(!e.sessionState.isActive)return console.log("[Optima Debug] Session: Not sending data - session inactive",{reason:e.sessionState.lastStopReason,stopTime:new Date(e.sessionState.stopTimestamp).toISOString(),sendAttempts:e.sessionState.sendAttempts}),!1;if(e.sessionState.sendAttempts>=10)return console.log("[Optima Debug] Session: Not sending data - max attempts reached",{attempts:e.sessionState.sendAttempts,maxAttempts:10}),e.sessionState.lastStopReason=h,e.sessionState.stopTimestamp=Date.now(),!1;const t=Date.now()-e.sessionState.lastSendTime;return t<80?(console.log("[Optima Debug] Session: Not sending data - rate limited",{timeSinceLastSend:t,minInterval:80}),e.sessionState.lastStopReason=p,e.sessionState.stopTimestamp=Date.now(),!1):(e.sessionState.sendAttempts++,e.sessionState.lastSendTime=Date.now(),!0)}function w(e){e.sessionState&&(e.sessionState.pageLoads++,console.log("[Optima Debug] Session: Page load detected",{sessionId:e.sessionId,pageLoads:e.sessionState.pageLoads,timestamp:(new Date).toISOString()}))}let y=null,_=null;function T(e){if(!e.sessionId)return;y&&(y.disconnect(),y=null),"complete"===document.readyState?e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,w(e),setTimeout((()=>{e.captureResourceData("load"),S(e)&&e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3)):window.addEventListener("load",(()=>{e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,w(e),setTimeout((()=>{e.captureResourceData("load"),S(e)&&e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3))}));let t=window.location.href;y=new MutationObserver((()=>{const n=window.location.href;n!==t&&(_&&clearTimeout(_),console.log("[Optima Debug] Debounce: Route change detected, waiting to confirm..."),_=setTimeout((()=>{console.log("[Optima Debug] Debounce: Route change confirmed, handling session update."),function(e){document.removeEventListener("visibilitychange",e._visibilityChangeHandler),window.removeEventListener("beforeunload",e._beforeUnloadHandler),e._batchInterval&&clearInterval(e._batchInterval);e._flushTimeout&&clearTimeout(e._flushTimeout);e.collectionState={pageLoaded:!1,isBatchProcessingStarted:!1,lastResourceFlush:0,lastEventFlush:0,resourceHashMap:{},unloadSent:!1}}(e),function(e){if(e.sessionState){console.log("[Optima Debug] Flushing web vitals before ending session for route change."),"function"==typeof e._updateWebVitalsInUnifiedModel&&e._updateWebVitalsInUnifiedModel(),"function"==typeof e._prepareFinalDataAndSend&&e._prepareFinalDataAndSend(!0),e.sessionState.routeChanges++,console.log("[Optima Debug] Session: Route change detected",{sessionId:e.sessionId,routeChanges:e.sessionState.routeChanges,timestamp:(new Date).toISOString()}),console.log("[Optima Debug] Marking session as inactive for route change."),e.sessionState.isActive=!1,e.sessionState.lastStopReason=b,e.sessionState.stopTimestamp=Date.now(),e.sessionState.lastSendTime=Date.now(),e.sessionState.sendAttempts=0;try{v(e,!0)||(console.error("[Optima Debug] Session: Failed to create new session for route change"),e.sessionState.lastStopReason="Failed to create new session",e.sessionState.stopTimestamp=Date.now())}catch(t){console.error("[Optima Debug] Session: Error creating new session:",t),e.sessionState.lastStopReason="Error creating new session",e.sessionState.stopTimestamp=Date.now()}}else console.error("[Optima Debug] Session: Cannot update route - no session state")}(e),S(e)&&e.sendEvent("route_change",{from:t,to:n,timestamp:Date.now()}),t=n}),150))})),y.observe(document,{subtree:!0,childList:!0})}function D(e){e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t)return;try{const n=t.error||new Error(t.message||"Unknown error"),s=n.message||t.message||"Unknown error",i=t.filename||t.srcElement?.src||window.location.href,a=n.stack||null,r="error",o={type:r,message:s,source:i,lineno:t.lineno||0,colno:t.colno||0,stack:a,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:C(r,s,i,a)};console.log("[Optima Debug] Captured error:",o.message),E(e,o),M(e),e.sendEvent("error",{error_type:"uncaught_error",message:o.message,source:o.source,lineno:o.lineno,colno:o.colno})}catch(e){console.warn("Optima SDK: Failed to process error",e)}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const n=t.reason,s=n instanceof Error?n.message:String(n),i=n instanceof Error?n.stack:null,a="unhandled_rejection",r="Promise",o={type:a,message:s,source:r,stack:i,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:C(a,s,r,i)};console.log("[Optima Debug] Captured promise rejection:",o.message),E(e,o),M(e),e.sendEvent("error",{error_type:"unhandled_rejection",message:o.message})}catch(e){console.warn("Optima SDK: Failed to process promise rejection",e)}}(e,t)})),function(e){const t=console.error;console.error=(...n)=>{try{const t=(new Error).stack||"",s=n.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),i="console_error",a="console.error",r={type:i,message:s,source:a,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:C(i,s,a,t)};E(e,r)}catch(e){}t.apply(console,n)}}(e),console.log("[Optima Debug] Error monitoring has been set up")}function C(e,t,n,s){const i=`${e}:${t}:${n}:${s?s.substring(0,150):""}`;let a=0;for(let e=0;e<i.length;e++){a=(a<<5)-a+i.charCodeAt(e),a|=0}return"err_"+Math.abs(a).toString(16)}function E(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const n=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(n)return!1;const s=e.buffer.errors.slice(-5),i=s.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!i})(e,t)&&(e.buffer.errors.push(t),e.buffer.errors.length>=5&&M(e))}function M(e){e.buffer.errors&&0!==e.buffer.errors.length&&(e.unifiedDataModel.errors||(e.unifiedDataModel.errors=[]),e.unifiedDataModel.errors=[...e.unifiedDataModel.errors,...e.buffer.errors],e.buffer.errors=[],e._sendUnifiedData(!1),console.log("[Optima Debug] Flushed errors to server"))}function x(e){return{setupBufferManagement:function(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers:function(){const t=e.batchConfig.maxBufferSize;e.buffer.events.length>t&&(e.buffer.events=e.buffer.events.slice(-t)),e.buffer.resources.length>t&&(e.buffer.resources=e.buffer.resources.slice(-t)),e.buffer.webVitals.length>t&&(e.buffer.webVitals=e.buffer.webVitals.slice(-t))},hashResource:function(e){return`${e.type}|${e.name.split("?")[0]}|${e.duration<50?"fast":"slow"}`},shouldCollectResource:function(t){if(e.batchConfig.resourceDedupingEnabled){const n=this.hashResource(t);if(e.collectionState.resourceHashMap[n])return!1;e.collectionState.resourceHashMap[n]=Date.now()}return!0},startBatchProcessing:function(){if(setInterval((()=>{e.buffer.events.length>0&&e._flushEvents(),e.buffer.webVitals.length>0&&e._flushWebVitals(),e.buffer.resources.length>0&&e._flushResources()}),Math.min(e.batchConfig.flushInterval,1e4)),e.batchConfig.visibilityFlushEnabled){const t=()=>{const t=Date.now();e.collectionState.visibilityState;const n=document.visibilityState;e.collectionState.visibilityState=n,t-e.collectionState.lastVisibilityChange>1e3&&(e.collectionState.lastVisibilityChange=t,"hidden"===n?e._flushBuffers("visibilityHidden",!0):"visible"===n&&setTimeout((()=>{e.captureResourceData("visibilityVisible")}),1e3))};document.addEventListener("visibilitychange",t)}if(window.addEventListener("beforeunload",(()=>{e._flushBuffers("unload",!0)})),e.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const t=()=>{window.requestIdleCallback((()=>{(e.buffer.events.length>=10||e.buffer.resources.length>=10||Date.now()-e.collectionState.lastResourceFlush>3e4)&&e._flushBuffers("idle"),setTimeout((()=>{t()}),2e4)}),{timeout:1e4})};t()}this.setupBufferManagement()}}}!function(t){function n(e){var t;e=e||{},this.apiKey=e.apiKey,this.endpoint=e.endpoint||"http://localhost:3000",this.sampleRate="number"==typeof e.sampleRate?Math.min(Math.max(e.sampleRate,1),100):100,this.sessionId=null,this.sessionStartTime=null,this.sessionState={sendAttempts:0,lastSendTime:0,isActive:!0,pageLoads:0,routeChanges:0},this.collectionState={pageLoaded:!1,isBatchProcessingStarted:!1,lastResourceFlush:0,lastEventFlush:0,resourceHashMap:{},unloadSent:!1},this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null,layoutShiftSource:null},resources:[],ajax_requests:[],errors:[],events:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxAjaxCallsPerBatch:50,maxBufferSize:1e3,resourceDedupingEnabled:!0,flushAtIdle:!0,flushInterval:3e4},this.bufferManager=x(this),this.flushManager=(t=this,{flushBuffers:function(e,n=!1){t.buffer.events.length>0&&this.flushEvents(n),t.buffer.resources.length>0&&this.flushResources(n),t.buffer.webVitals.length>0&&this.flushWebVitals(n),t.buffer.ajaxCalls&&t.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(n)},flushEvents:function(e=!1){if(0===t.buffer.events.length)return;const n=t.buffer.events.slice(0,t.batchConfig.maxEventsPerBatch);t.buffer.events=t.buffer.events.slice(t.batchConfig.maxEventsPerBatch);const s={session_id:t.sessionId,events:n,timestamp:Date.now(),count:n.length};t.collectionState.lastEventFlush=Date.now(),t._sendToServer("/api/optima/events",s,{sync:e})},flushResources:function(e=!1){if(0===t.buffer.resources.length)return;const n=t.buffer.resources.slice(0,t.batchConfig.maxResourcesPerBatch);t.buffer.resources=t.buffer.resources.slice(t.batchConfig.maxResourcesPerBatch);const s={session_id:t.sessionId,resources:n,timestamp:Date.now(),count:n.length};t.collectionState.lastResourceFlush=Date.now(),t._sendToServer("/api/optima/resources",s,{sync:e})},flushWebVitals:function(e=!1){if(0===t.buffer.webVitals.length)return;const n={LCP:[],FID:[],CLS:[],INP:[],TTFB:[],FCP:[]};t.buffer.webVitals.forEach((e=>{if(e&&e.event_data&&e.event_data.name){const t=e.event_data.name;n[t]&&n[t].push(e)}}));const s=t.buffer.webVitals.slice(0,t.batchConfig.maxWebVitalsPerBatch);t.buffer.webVitals=t.buffer.webVitals.slice(t.batchConfig.maxWebVitalsPerBatch);const i={session_id:t.sessionId,web_vitals:s,processed_vitals:n,timestamp:Date.now(),count:s.length};t._sendToServer("/api/optima/web-vitals",i,{sync:e})},flushAjaxCalls:function(e=!1){if(!t.buffer.ajaxCalls||0===t.buffer.ajaxCalls.length)return;const n=t.buffer.ajaxCalls.slice(0,t.batchConfig.maxAjaxCallsPerBatch);t.buffer.ajaxCalls=t.buffer.ajaxCalls.slice(t.batchConfig.maxAjaxCallsPerBatch);const s={session_id:t.sessionId,ajax_calls:n,timestamp:Date.now(),count:n.length};t.collectionState.lastAjaxCallFlush=Date.now(),t._sendToServer("/api/optima/ajax-calls",s,{sync:e})}}),this._setupBatchedCollection(),this._webVitalsBatchTimer=null,this._init()}t.__optima_early_xhr_queue=t.__optima_early_xhr_queue||[],n.prototype={_init:function(){this.apiKey?(this._initPerformanceMetrics(),D(this),this.createSession(),this._setupPageLifecycleEvents()):console.warn("[Optima Debug] No API key not provided, SDK will not be fully initialized")},_initPerformanceMetrics:function(){if(t.performance&&t.performance.mark){t.performance.mark("optima_init");try{t.performance.getEntriesByType("mark").concat(t.performance.getEntriesByType("measure")).filter((e=>e.name.startsWith("optima_"))).forEach((e=>{t.performance.clearMarks(e.name),"measure"===e.entryType&&t.performance.clearMeasures(e.name)}))}catch(e){}this._setupCoreWebVitals(),this._captureNavigationTiming()}},_captureNavigationTiming:function(){try{const e=performance.getEntriesByType("navigation")[0];e?(this.unifiedDataModel.timings={navigationStart:0,fetchStart:e.fetchStart,domainLookupStart:e.domainLookupStart,domainLookupEnd:e.domainLookupEnd,connectStart:e.connectStart,connectEnd:e.connectEnd,requestStart:e.requestStart,responseStart:e.responseStart,responseEnd:e.responseEnd,domInteractive:e.domInteractive,domContentLoadedEventStart:e.domContentLoadedEventStart,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domComplete:e.domComplete,loadEventStart:e.loadEventStart,loadEventEnd:e.loadEventEnd,duration:e.duration,type:e.type,redirectCount:e.redirectCount,nextHopProtocol:e.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:e.responseStart,timestamp:performance.timeOrigin+e.responseStart},this.sendEvent("core_web_vital",{name:"TTFB",value:e.responseStart},{immediate:!0})):console.warn("[Optima Debug] No navigation timing entries available")}catch(e){console.error("[Optima Debug] Error capturing navigation timing:",e)}},_setupPageLifecycleEvents:function(){this._beforeUnloadHandler=()=>{this.collectionState.unloadSent||(this._prepareFinalDataAndSend(!0),this.collectionState.unloadSent=!0)},this._visibilityChangeHandler=()=>{"hidden"===document.visibilityState&&this._prepareFinalDataAndSend(!0)},document.addEventListener("visibilitychange",this._visibilityChangeHandler),t.addEventListener("beforeunload",this._beforeUnloadHandler),this._setupPeriodicFlush()},_prepareFinalDataAndSend:function(e=!1){this.sessionId&&this.unifiedDataModel.session_id&&(this._consolidateBufferedData(),this._updateWebVitalsInUnifiedModel(),this._consolidateErrors(),this._updateMetadata(),this._sendUnifiedData(e))},_updateWebVitalsInUnifiedModel:function(){this.buffer.webVitals.forEach((e=>{if(!e.event_data||!e.event_data.name)return;const{name:t,value:n}=e.event_data,s=e.timestamp;if("LCP"===t)(!this.unifiedDataModel.web_vitals.LCP||n>this.unifiedDataModel.web_vitals.LCP.value)&&(this.unifiedDataModel.web_vitals.LCP={value:n,timestamp:s,element:e.event_data.element||"unknown"});else if("FID"===t)this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:n,timestamp:s,inputType:e.event_data.inputType||"unknown"});else if("CLS"===t){if(this.unifiedDataModel.web_vitals.CLS={value:n,timestamp:s,entries:e.event_data.entries||0,sessionValue:e.event_data.sessionValue||n,sessionEntries:e.event_data.sessionEntries||0},e.event_data.largestShift&&e.event_data.largestShift.source)try{const t=e.event_data.largestShift.source;t&&(this.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:e.event_data.largestShift.value,timestamp:e.event_data.largestShift.timestamp,source:t,loadState:document.readyState})}catch(e){console.warn("[Optima Debug] Error updating layout shift source:",e.message)}}else"FCP"===t?this.unifiedDataModel.web_vitals.FCP||(this.unifiedDataModel.web_vitals.FCP={value:n,timestamp:s}):"INP"===t&&(!this.unifiedDataModel.web_vitals.INP||n>this.unifiedDataModel.web_vitals.INP.value)&&(this.unifiedDataModel.web_vitals.INP={value:n,timestamp:s,interaction:e.event_data.interaction||"unknown"})})),this.buffer.webVitals=[]},_consolidateBufferedData:function(){return this.buffer.events||(this.buffer.events=[]),this.unifiedDataModel.events||(this.unifiedDataModel.events=[]),this.buffer.events.length>0&&(this.unifiedDataModel.events=[...this.unifiedDataModel.events,...this.buffer.events],this.buffer.events=[]),this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.errors.length>0&&this._consolidateErrors(),this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel},_consolidateErrors:function(){this.buffer.errors&&0!==this.buffer.errors.length&&(this.unifiedDataModel.errors=[...this.unifiedDataModel.errors,...this.buffer.errors],this.buffer.errors=[])},_updateMetadata:function(){this.unifiedDataModel.meta={url:t.location.href,path:t.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:t.screen.width,screen_height:t.screen.height,viewport_width:t.innerWidth,viewport_height:t.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:performance.getEntriesByType("navigation")[0]?.type||null,sdk_version:this.version,lastUpdated:Date.now()}},_sendUnifiedData:function(e=!1){if(!this.unifiedDataModel.session_id)return void console.warn("[Optima Debug] Not sending data - no session ID");this._updateMetadata(),this.unifiedDataModel.timestamp=Date.now();const t=JSON.parse(JSON.stringify(this.unifiedDataModel));this._sendToServer("/api/optima/collect",t,{sync:e}),this._resetVolatileDataInUnifiedModel()},_resetVolatileDataInUnifiedModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},_setupBatchedCollection:function(){this.disabled||this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this._startBatchedCollection())},_startBatchedCollection:function(){setInterval((()=>{this._collectResources()}),3e3),this._setupPeriodicFlush()},_setupPeriodicFlush:function(){setInterval((()=>{this._hasSignificantData()&&this._prepareFinalDataAndSend(!1)}),this.batchConfig.flushInterval)},_hasSignificantData:function(){return this.unifiedDataModel.resources.length>0||this.unifiedDataModel.ajax_requests.length>0||this.buffer.webVitals.length>0||this.buffer.errors.length>0||this.unifiedDataModel.errors.length>0||this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value||this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value||this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value||this.unifiedDataModel.web_vitals.FCP&&this.unifiedDataModel.web_vitals.FCP.value},_collectResources:function(){try{performance.getEntriesByType("resource").forEach((e=>{if(this._isResourceProcessed(e.name))return;const t={name:e.name,type:this._getResourceType(e),startTime:Math.round(e.startTime),duration:Math.round(e.duration),size:e.transferSize||0,protocol:e.nextHopProtocol,encodedSize:e.encodedBodySize||0,decodedSize:e.decodedBodySize||0,initiatorType:e.initiatorType};this.unifiedDataModel.resources.push(t)})),this.collectionState.resourcesCollected=!0}catch(e){}},_isResourceProcessed:function(e){return this.unifiedDataModel.resources.some((t=>t.name===e))},_getResourceType:function(e){const t=e.initiatorType,n=e.name;return"img"===t||"image"===t?"image":"script"===t?"script":"css"===t?"stylesheet":"fetch"===t||"xmlhttprequest"===t?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(n)?"image":/\.(?:js)(?:\?|$)/i.test(n)?"script":/\.(?:css)(?:\?|$)/i.test(n)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(n)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(n)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(n)?"audio":"other"},_detectBrowser:function(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("MSIE")>-1||e.indexOf("Trident/")>-1?"IE":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1||e.indexOf("OPR/")>-1?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"},_refreshVisibleState:function(){this.collectionState.visibilityChangeCount>1&&this._collectResources()},_setupCoreWebVitals:function(){this.disabled||l(this)},_setupBufferManagement:function(){this.bufferManager.setupBufferManagement()},_shouldCollectResource:function(e){return this.bufferManager.shouldCollectResource(e)},_startBatchProcessing:function(){this.bufferManager.startBatchProcessing()},_flushBuffers:function(e,t=!1){this._prepareFinalDataAndSend(t)},_flushEvents:function(e=!1){const t=this.buffer.events.slice();if(this.buffer.events=[],0===t.length)return;const n={session_id:this.sessionId,events:t,timestamp:Date.now()};this._sendToServer("/api/optima/events",n,{sync:e})},_flushResources:function(e=!1){const t=this.buffer.resources.slice();if(this.buffer.resources=[],0===t.length)return;const n={session_id:this.sessionId,resources:t,timestamp:Date.now()};this._sendToServer("/api/optima/resources",n,{sync:e})},_flushWebVitals:function(e=!1){const t=this.buffer.webVitals.slice();if(this.buffer.webVitals=[],0===t.length)return;const n={session_id:this.sessionId,web_vitals:t,timestamp:Date.now()};this._sendToServer("/api/optima/web-vitals",n,{sync:e})},_setupEventListeners:function(){this.disabled||T(this)},_setupPerformanceObservers:function(){this.disabled||(this._setupCoreWebVitals(),this.captureResourceData("setup"))},captureResourceData:function(e="auto"){return!this.disabled&&(this._collectResources(),!0)},_sendResourceBatch:function(e){return e&&e.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...e]),!0},createSession:function(){return v(this)},_sendToServer:function(e,t,n={}){if(!this.apiKey)return console.error("Optima SDK: API key not set. Cannot send data to server."),Promise.reject(new Error("API key not set"));const s=this.endpoint+e;if(n.sync&&navigator.sendBeacon){const e=new Blob([JSON.stringify(t)],{type:"application/json"}),n=navigator.sendBeacon(s,e);return Promise.resolve(n)}return e.includes("ajax-calls")&&t.ajax_calls&&t.ajax_calls.length>0&&t.ajax_calls.reduce(((e,t)=>(e[t.type]=(e[t.type]||0)+1,e)),{}),fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),credentials:"include"}).then((e=>{if(!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()})).then((e=>!0)).catch((t=>(console.error(`[Optima Debug] Error sending data to ${e}:`,t),!1)))},sendEvent:function(e,t,n={}){if(this.disabled)return!1;if(!this.sessionId)return!1;const s={session_id:this.sessionId,event_type:e,event_data:t||{},timestamp:Date.now()};return"core_web_vital"===e?(this.buffer.webVitals.push(s),!0===n.immediate&&this._updateWebVitalsInUnifiedModel()):this.buffer.events.push(s),!0},collectPerformanceMetrics:function(){return this._collectResources(),this._updateWebVitalsInUnifiedModel(),!0},sendCollectedData:function(e=!1){return!this.disabled&&(this._prepareFinalDataAndSend(e),!0)},debug:function(){return{sessionId:this.sessionId,apiKey:this.apiKey?`${this.apiKey.substring(0,4)}...`:"None",endpoint:this.endpoint,bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs.size},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},_captureEarlyAjaxRequests:function(){if(!t.performance||!t.performance.getEntriesByType)return;const e=t.performance.getEntriesByType("resource"),n=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)),s=e.filter((e=>{if(n.includes(e))return!1;const t=e.name;if(t.includes("/api/")||t.includes("/graphql")||t.match(/\/(v1|v2|v3)\//)||t.includes("/rest/")||t.includes("/data/"))return!0;try{const e=new URL(t).pathname.split(".").pop();if(["json","xml","graphql"].includes(e))return!0}catch{}return!1})),i=[...new Set([...n,...s])];if(!i.length)return;const a=i.map((e=>{let t="GET";(e.name.includes("graphql")||e.transferSize>1e3)&&(t="POST");return{type:"fetch"===e.initiatorType?"fetch":"xhr",method:t,url:e.name,status:200,statusText:"OK",startTime:Math.round(e.startTime+performance.timeOrigin),duration:Math.round(e.duration),requestPayloadSize:-1,responseSize:Math.round(e.transferSize)||-1,decodedBodySize:Math.round(e.decodedBodySize)||-1,encodedBodySize:Math.round(e.encodedBodySize)||-1,aborted:!1,errored:!1,timestamp:Math.round(e.startTime+performance.timeOrigin),captureSource:"performance-timeline",resourceTiming:{startTime:Math.round(e.startTime),duration:Math.round(e.duration),domainLookupTime:Math.round(e.domainLookupEnd-e.domainLookupStart),connectTime:Math.round(e.connectEnd-e.connectStart),tlsTime:e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,requestStartTime:Math.round(e.requestStart),ttfb:Math.round(e.responseStart-e.requestStart),downloadTime:Math.round(e.responseEnd-e.responseStart),entryType:e.entryType,initiatorType:e.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transferSize>0?e.transferSize.toString():"unknown","cache-control":"unknown"}}})).filter((e=>!this._isOptimaApiCall(e.url)));0!==a.length&&(this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...a))},_isOptimaApiCall:function(e){return e.includes("/api/optima/sessions")||e.includes("/api/optima/events")||e.includes("/api/optima/resources")||e.includes("/api/optima/web-vitals")||e.includes("/api/optima/ajax-calls")||e.includes("/api/optima/collect")||e.includes("/api/sessions")||e.includes("/api/events")||e.includes("/api/resources")||e.includes("/api/web-vitals")||e.includes("/api/ajax-calls")||e.includes("/api/collect")||e.includes("optima.js")||e.includes("optima.min.js")},_processEarlyInterceptedRequests:function(){if(!t.__optima_early_xhr_queue||!t.__optima_early_xhr_queue.length)return;const e=t.__optima_early_xhr_queue;let n=[];t.performance&&t.performance.getEntriesByType&&(n=t.performance.getEntriesByType("resource"));const s=e.map((e=>{if(this._isOptimaApiCall(e.url)||e.responseURL&&this._isOptimaApiCall(e.responseURL))return null;let t=null;if(n.length>0){const s=e.url||"",i=n.filter((t=>t.name===s||e.responseURL&&t.name===e.responseURL||t.name.includes(new URL(s).pathname)||e.responseURL&&t.name.includes(new URL(e.responseURL).pathname)));if(i.length>0){const n=i.sort(((t,n)=>Math.abs(t.startTime+performance.timeOrigin-e.startTime)-Math.abs(n.startTime+performance.timeOrigin-e.startTime)))[0];n&&(t={startTime:Math.round(n.startTime),duration:Math.round(n.duration),domainLookupTime:Math.round(n.domainLookupEnd-n.domainLookupStart),connectTime:Math.round(n.connectEnd-n.connectStart),tlsTime:n.secureConnectionStart?Math.round(n.connectEnd-n.secureConnectionStart):0,requestStartTime:Math.round(n.requestStart),ttfb:Math.round(n.responseStart-n.requestStart),downloadTime:Math.round(n.responseEnd-n.responseStart),entryType:n.entryType,initiatorType:n.initiatorType,transferSize:n.transferSize||0,decodedBodySize:n.decodedBodySize||0})}}let s=e.responseSize;return(void 0===s||s<0)&&(s=t&&t.transferSize>0?t.transferSize:t&&t.decodedBodySize>0?t.decodedBodySize:-1),{type:e.type||"xhr",method:e.method||"GET",url:e.responseURL||e.url,originalUrl:e.url,status:e.status||0,statusText:e.statusText||"",startTime:e.startTime,endTime:e.endTime||e.startTime+(e.duration||0),duration:e.duration||0,async:!0,requestPayloadSize:e.requestSize||-1,responseSize:s,aborted:!!e.aborted,errored:!!e.error||!!e.errored,timestamp:e.timestamp||e.startTime,resourceTiming:t,captureSource:e.captureMethod||"early-intercept",requestHeaders:e.requestHeaders||{"content-type":"unknown","content-length":"unknown"},responseHeaders:e.responseHeaders||{"content-type":"unknown","content-length":s>0?s.toString():"unknown","cache-control":"unknown"}}})).filter(Boolean);0!==s.length&&(s.sort(((e,t)=>e.startTime-t.startTime)),this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...s),t.__optima_early_xhr_queue=[])},_createSession:function(n,s,i={}){if(!this.apiKey)return void console.error("Optima SDK: API key not set. Cannot create session.");const a=t.navigator.userAgent,r=this._detectDeviceType(),o=this._detectConnectionType(),u=Date.now(),l=performance?.timing?.navigationStart||u;this.sessionId||(this.sessionId=e(),this.sessionStartTime=u),this._updateMetadata();const c={session_id:this.sessionId,page_url:n||t.location.href,referrer:s||document.referrer,user_agent:a,device_type:r,connection_type:o,timestamp:u,navigation_start:l,web_vitals:{},errors:[],resources:[],ajax_requests:[],meta:this.unifiedDataModel.meta};this._sendToServer("/api/optima/sessions",c).then((e=>{e?this._startMonitoringInterval():console.error("[Optima Debug] Session: Failed to create session")})).catch((e=>{console.error("[Optima Debug] Session: Error creating session",e)}))},_detectDeviceType:function(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&!t.MSStream||/android/i.test(e)?"mobile":/Tablet|iPad/i.test(e)?"tablet":"desktop"},_detectConnectionType:function(){return navigator.connection?navigator.connection.effectiveType:"unknown"},_flushAjaxCalls:function(e=!1){},cleanup:function(){this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.sessionState={sendAttempts:0,lastSendTime:0,isActive:!1,pageLoads:0,routeChanges:0},this.collectionState={pageLoaded:!1,isBatchProcessingStarted:!1,lastResourceFlush:0,lastEventFlush:0,resourceHashMap:{},unloadSent:!1},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null,layoutShiftSource:null},resources:[],ajax_requests:[],errors:[],events:[],timings:null,metrics:{},meta:{}},this._batchInterval&&clearInterval(this._batchInterval),this._flushTimeout&&clearTimeout(this._flushTimeout),t.removeEventListener("beforeunload",this._beforeUnloadHandler),document.removeEventListener("visibilitychange",this._visibilityChangeHandler),"function"==typeof clearProcessedResourcesCache&&clearProcessedResourcesCache(),this.disabled=!0}};var s=function(){var e=Array.prototype.slice.call(arguments),s=e[0];if("init"===s){var i=e[1]||null,a=e[2]||{};return a.apiKey=i,t.optimaInstance=new n(a),t.optimaInstance}if(!t.optimaInstance)return console.warn("[Optima Debug] Command executed before initialization:",s),!1;switch(s){case"event":return t.optimaInstance.sendEvent(e[1],e[2],e[3]);case"captureResources":return t.optimaInstance.captureResourceData("manual");case"flushBuffers":return t.optimaInstance.sendCollectedData(!0===e[1]);case"debug":return t.optimaInstance.debug();default:return console.warn("[Optima Debug] Unknown command:",s),!1}};t.Optima=n;var i=null;if("function"==typeof t.optima)if((i=t.optima).q&&i.q.length){t.optima=s;for(var a=0;a<i.q.length;a++)s.apply(t,i.q[a])}else t.optima=s;else t.optima=s}(window)}();
