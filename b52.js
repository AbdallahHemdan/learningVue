!function(){"use strict";function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function t(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"mobile":"desktop"}function i(){return navigator.connection&&navigator.connection.effectiveType||"unknown"}const n=["google-analytics.com","googletagmanager.com","doubleclick.net","segment.io","analytics.google.com","googleadservices.com","datadoghq.com","getkoala.com","analytics.twitter.com","api.cr-relay.com","api.getkoala.com","api.segment.io","api.vector.co","app.clearbit.com","bam-cell.nr-data.net","browser-intake-us5-datadoghq.com","browser.sentry-cdn.com","c.6sc.co","cdn.cr-relay.com","cdn.debugbear.com","cdn.getkoala.com","cdn.heapanalytics.com","cdn.segment.com","cdn.vector.co","googleads.g.doubleclick.net","heapanalytics.com","ipv6.6sc.co","j.6sc.co","js-agent.newrelic.com","pro.ip-api.com","px.ads.linkedin.com","secure.gravatar.com","snap.licdn.com","tag.clearbitscripts.com","unpkg.com","widget.intercom.io","www.datadoghq-browser-agent.com","www.google-analytics.com","www.google.com","www.googleadservices.com","www.googletagmanager.com","x.clearbitjs.com","idx.liadm.com","d-code.liadm.com","rp.liadm.com","i.liadm.com","data.debugbear.com","b.6sc.co"];function o(e){return n.some((t=>e.includes(t)))}function s(){if(!(window.performance&&window.performance.getEntriesByType&&Array.isArray(window.performance.getEntriesByType("resource"))))return console.log("[DEBUG] getResourceTimings: Performance API not available"),[];try{const e=window.performance.getEntriesByType("resource");console.log(`[DEBUG] getResourceTimings: Found ${e.length} total resources from Performance API`),console.log(`[DEBUG] getResourceTimings: Current time since navigation: ${performance.now()}ms`),e.forEach(((e,t)=>{const i=r(e);console.log(`[DEBUG] Raw resource ${t}: ${e.name}`),console.log(`  - Start: ${Math.round(e.startTime)}ms`),console.log(`  - End: ${Math.round(e.responseEnd||e.loadEventEnd||e.startTime+e.duration)}ms`),console.log(`  - Duration: ${Math.round(e.duration)}ms`),console.log(`  - Type: ${e.initiatorType}`),console.log(`  - Transfer size: ${e.transferSize||0}`),console.log(`  - Should process: ${i}`),i||console.log(`  - Exclusion reason: ${a(e)}`)}));const t=e.filter((e=>r(e)));return console.log(`[DEBUG] getResourceTimings: ${t.length} resources passed filtering (excluded: ${e.length-t.length})`),t.map((e=>{const t={name:e.name,initiator_type:e.initiatorType,start_time:Math.round(e.startTime),duration:Math.round(e.duration),transfer_size:e.transferSize||0,encoded_size:e.encodedBodySize||0,decoded_size:e.decodedBodySize||0,next_hop_protocol:e.nextHopProtocol,fetch_start:Math.round(e.fetchStart),domain_lookup_start:Math.round(e.domainLookupStart),domain_lookup_end:Math.round(e.domainLookupEnd),connect_start:Math.round(e.connectStart),connect_end:Math.round(e.connectEnd),secure_connection_start:e.secureConnectionStart?Math.round(e.secureConnectionStart):0,request_start:Math.round(e.requestStart),response_start:Math.round(e.responseStart),response_end:Math.round(e.responseEnd),type:c(e),size:e.transferSize||e.decodedBodySize||0,timing:{dns:Math.round(e.domainLookupEnd-e.domainLookupStart),connection:Math.round(e.connectEnd-e.connectStart),tls:e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,request:Math.round(e.responseStart-e.requestStart),response:Math.round(e.responseEnd-e.responseStart)}};return t.dnsTime=Math.round(e.domainLookupEnd-e.domainLookupStart),t.connectionTime=Math.round(e.connectEnd-e.connectStart),t.tlsTime=e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,t.ttfb=Math.round(e.responseStart-e.requestStart),t.downloadTime=Math.round(e.responseEnd-e.responseStart),t.dns_time=t.dnsTime,t.connection_time=t.connectionTime,t.tls_time=t.tlsTime,t.download_time=t.downloadTime,t.cacheStatus=function(e){const t=e.transferSize||0,i=e.decodedBodySize||0;return 0===t?i>0?"cache":"cross-origin":"network"}(e),t.cache_status=t.cacheStatus,"xmlhttprequest"!==e.initiatorType&&"fetch"!==e.initiatorType&&"xhr"!==t.type||(t.is_ajax=!0,t.url=e.name,t.method="GET",t.method_inferred=!0,t.status=200,t.responseSize=e.transferSize||e.decodedBodySize||0,t.startTime=Math.round(e.startTime)),t}))}catch(e){return[]}}function a(e){return e.name.startsWith("data:")?"data URL":e.name.includes("optima.min.js")||e.name.includes("/api/sessions")||e.name.includes("/api/events")||e.name.includes("/api/resources")||e.name.includes("/api/web-vitals")?"SDK-related":o(e.name)?"analytics/tracking":e.name===document.location.href||"navigation"===e.initiatorType?"main document/navigation":"none"}function r(e){return"none"===a(e)}function c(e){const t=e.initiatorType,i=e.name;if("img"===t||"image"===t)return"image";if("script"===t)return"script";if("link"===t&&e.nextHopProtocol)return"stylesheet";if("css"===t)return"stylesheet";if("xmlhttprequest"===t)return"xhr";if("fetch"===t)return"fetch";if(!t||"other"===t){if(/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(i))return"image";if(/\.(?:js)(?:\?|$)/i.test(i))return"script";if(/\.(?:css)(?:\?|$)/i.test(i))return"stylesheet";if(/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(i))return"font";if(/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(i))return"video";if(/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(i))return"audio";if(/\/api\/|\/graphql|\/v[0-9]\//.test(i)&&!i.endsWith(".js")&&!i.endsWith(".css"))return"xhr"}return"other"}function l(e){if(!e||!e.previousRect||!e.currentRect)return 0;const t=e.previousRect,i=e.currentRect,n=Math.abs(t.x-i.x),o=Math.abs(t.y-i.y);return Math.sqrt(n*n+o*o)*(Math.max(t.width*t.height,i.width*i.height)/(window.innerWidth*window.innerHeight))}function u(e){return e?{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(e.width),height:Math.round(e.height),top:Math.round(e.top),right:Math.round(e.right),bottom:Math.round(e.bottom),left:Math.round(e.left)}:null}function d(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id){e+=`#${i.id}`,t.unshift(e);break}if(i.className&&"string"==typeof i.className){const t=i.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let n=i,o=1;for(;n=n.previousElementSibling;)o++;if(o>1&&(e+=`:nth-child(${o})`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function h(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id&&(e=`${e}#${i.id}`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function m(e){if(!e||!e.textContent)return null;const t=e.textContent.trim().replace(/\s+/g," ");return t.length>60?t.substring(0,60)+"...":t}function p(e){if(!e||!e.attributes)return{};const t={},i=["src","href","alt","title","aria-label","role","data-testid"];i.forEach((i=>{e.hasAttribute(i)&&(t[i]=e.getAttribute(i))}));for(let n=0;n<e.attributes.length;n++){const o=e.attributes[n];o.name.startsWith("data-")&&!i.includes(o.name)&&(t[o.name]=o.value)}return t}function f(e){if(!e||!e.previousRect||!e.currentRect)return"unknown";const t=e.previousRect,i=e.currentRect;if(0===t.width&&0===t.height&&(i.width>0||i.height>0))return"appeared";if(0===i.width&&0===i.height&&(t.width>0||t.height>0))return"disappeared";const n=Math.abs(t.width-i.width)>1||Math.abs(t.height-i.height)>1,o=Math.abs(t.x-i.x)>1||Math.abs(t.y-i.y)>1;return n&&o?"resize-and-move":n?"resize":o?"move":"unknown"}function g(e){if(!e||!window.getComputedStyle)return!1;try{const t=window.getComputedStyle(e);return"0s"!==t.transitionDuration||"none"!==t.animationName||e.classList.contains("animate")||e.classList.contains("fade")||e.classList.contains("slide")}catch(e){return!1}}function v(e){try{"PerformanceObserver"in window&&(function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("paint"))return;try{new PerformanceObserver((t=>{const i=t.getEntries().find((e=>"first-contentful-paint"===e.name));if(!i)return;window.performance.mark("optima_fcp");const n=i.startTime;e.sendEvent("core_web_vital",{name:"FCP",value:n},{immediate:!0}),e.unifiedDataModel.web_vitals.FCP={value:n,timestamp:performance.timeOrigin+i.startTime},setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),500)})).observe({type:"paint",buffered:!0}),setTimeout((()=>{if(!e.unifiedDataModel.web_vitals.FCP){const t=performance.getEntriesByType("paint").find((e=>"first-contentful-paint"===e.name));t&&(e.unifiedDataModel.web_vitals.FCP={value:t.startTime,timestamp:performance.timeOrigin+t.startTime},e.sendEvent("core_web_vital",{name:"FCP",value:t.startTime},{immediate:!0}))}}),3e3)}catch(e){}}(e),function(e){let t=0;const i=new PerformanceObserver((i=>{const n=i.getEntries(),o=n[n.length-1];if(window.performance.mark("optima_lcp"),window.performance.measure("optima_lcp_time","navigationStart","optima_lcp"),o.startTime>t){t=o.startTime;const i=function(e){if(e.element){const t=e.element,i=_(t),n=y(t);return{tagName:t.tagName,id:t.id||null,className:t.className||null,cssPath:i,domPath:n,size:e.size,url:e.url||null,dimensions:t.getBoundingClientRect?{width:Math.round(t.getBoundingClientRect().width),height:Math.round(t.getBoundingClientRect().height)}:null,nodeType:t.nodeType,textContent:t.textContent?.slice(0,100)||null}}if(e.url){const t=e.url,i=function(e){try{const t=e.split("?")[0],i=t.split("#")[0].split("/").pop(),n=Array.from(document.querySelectorAll("img[src]"));for(const t of n)if(t.src===e||t.src.includes(i))return t;try{const t=Array.from(document.querySelectorAll("image[href]")),n=Array.from(document.querySelectorAll("image[*|href]")),o=[...t,...n];for(const t of o){const n=t.getAttribute("href")||t.getAttribute("xlink:href");if(n===e||n?.includes(i))return t}}catch(e){}const o=Array.from(document.querySelectorAll("*"));for(const t of o){const n=window.getComputedStyle(t).backgroundImage;if(n&&"none"!==n){const o=n.match(/url\(['"]?(.*?)['"]?\)/)?.[1];if(o===e||o?.includes(i))return t}}const s=performance.getEntriesByType("resource").find((t=>t.name===e));if(s&&"img"===s.initiatorType){return Array.from(document.querySelectorAll("div, section, header, main, article")).sort(((e,t)=>{const i=e.getBoundingClientRect(),n=t.getBoundingClientRect();return n.width*n.height-i.width*i.height}))[0]||null}}catch(e){}return null}(t);return i?{tagName:i.tagName,id:i.id||null,className:i.className||null,cssPath:_(i),domPath:y(i),size:e.size,url:t,elementFoundBy:"url-matching",dimensions:i.getBoundingClientRect?{width:Math.round(i.getBoundingClientRect().width),height:Math.round(i.getBoundingClientRect().height)}:null}:{tagName:null,url:t,size:e.size,elementFoundBy:"url-only",imageType:b(t),resourceType:S(t)}}return{detail:"No element or URL available",size:e.size||0,startTime:e.startTime}}(o),s=function(e){try{const t=performance.getEntriesByType("navigation")[0];if(!t)return null;const i=t.activationStart||0,n={ttfb:0,resourceLoadDelay:0,resourceLoadDuration:0,elementRenderDelay:e.startTime},o=Math.max(0,t.responseStart-i);n.ttfb=Math.round(o);let s=null;if(e.url){s=performance.getEntriesByType("resource").find((t=>t.name===e.url))}if(s){const t=Math.max(o,(s.requestStart||s.startTime)-i),a=Math.max(t,s.responseEnd-i),r=Math.max(a,e.startTime-i);n.resourceLoadDelay=Math.round(Math.max(0,t-o)),n.resourceLoadDuration=Math.round(Math.max(0,a-t)),n.elementRenderDelay=Math.round(Math.max(0,r-a))}else n.elementRenderDelay=Math.round(Math.max(0,e.startTime-o));return n.navigationEntry={responseStart:t.responseStart,activationStart:i},s&&(n.lcpResourceEntry={name:s.name,startTime:s.startTime,requestStart:s.requestStart,responseEnd:s.responseEnd,transferSize:s.transferSize,decodedBodySize:s.decodedBodySize}),n}catch(e){return null}}(o);e.sendEvent("core_web_vital",{name:"LCP",value:o.startTime,element:i,attribution:s}),e.unifiedDataModel.web_vitals.LCP={value:o.startTime,timestamp:performance.timeOrigin+o.startTime,element:i,attribution:s},n.length<=1&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3)}}));i.observe({type:"largest-contentful-paint",buffered:!0})}(e),function(e){const t=new PerformanceObserver((t=>{const i=t.getEntries()[0];window.performance.mark("optima_fid");const n={type:i.name,targetElement:i.target?{tagName:i.target.tagName,id:i.target.id||null,className:i.target.className||null}:null,timing:{processingStart:i.processingStart,processingEnd:i.processingEnd,startTime:i.startTime}},o=i.processingStart-i.startTime;e.sendEvent("core_web_vital",{name:"FID",value:o,inputType:i.name,details:n},{immediate:!0}),e.unifiedDataModel.web_vitals.FID={value:o,timestamp:performance.timeOrigin+i.startTime,inputType:i.name,details:n}}));t.observe({type:"first-input",buffered:!0})}(e),function(e){let t=0,i=[],n=[],o=performance.now(),s=0,a=0,r={value:0,entry:null,sourceInfo:null};if(document.addEventListener("visibilitychange",(()=>{if("hidden"===document.visibilityState)s>0&&(e.unifiedDataModel.web_vitals.CLS={value:s,timestamp:Date.now(),entries:n.length,largestShiftSource:r.sourceInfo});else if("visible"===document.visibilityState){performance.now()-o>1e3&&(o=performance.now(),s=0,n=[])}})),!window.PerformanceObserver)return;if(!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("layout-shift"))return;const c=new PerformanceObserver((o=>{try{const c=o.getEntries();if(0===c.length)return;c.forEach(((o,a)=>{try{if(!o.hadRecentInput&&(t+=o.value,i.push(o),s+=o.value,n.push({value:o.value,startTime:o.startTime}),o.value>r.value)){let t=null;try{t=function(e){if(!e||!e.sources||0===e.sources.length)return null;try{const t=e.sources.reduce(((e,t)=>{try{return(t.impactValue||l(t))>(e.impactValue||l(e))?t:e}catch(t){return e}}),e.sources[0]);if(!t)return null;const i=t.node;return i?{tagName:i.tagName||"UNKNOWN",id:i.id||null,className:"string"==typeof i.className?i.className:null,cssPath:d(i),domPath:h(i),textContent:m(i),attributes:p(i),previousRect:u(t.previousRect),currentRect:u(t.currentRect),impactValue:t.impactValue||l(t),shiftType:f(t),isAnimating:g(i),isImage:"IMG"===i.tagName,isIframe:"IFRAME"===i.tagName,isVideo:"VIDEO"===i.tagName}:{previousRect:u(t.previousRect),currentRect:u(t.currentRect),impactValue:t.impactValue||l(t),nodeLost:!0,shiftType:f(t)}}catch(e){return null}}(o)}catch(e){}t&&(r={value:o.value,entry:o,sourceInfo:t,timestamp:performance.timeOrigin+o.startTime},e.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:o.value,timestamp:performance.timeOrigin+o.startTime,source:t,loadState:document.readyState})}}catch(e){}}));const v=Date.now();if((v-a>5e3||i.length%10==0)&&i.length>0){a=v;const o={name:"CLS",value:t,entries:i.length,sessionValue:s,sessionEntries:n.length,largestShift:r.value>0?{value:r.value,timestamp:r.timestamp,source:r.sourceInfo}:null};e.sendEvent("core_web_vital",o),e.unifiedDataModel.web_vitals.CLS={value:t,timestamp:v,entries:i.length,sessionValue:s,sessionEntries:n.length,largestShiftSource:r.sourceInfo},i.length%30==0&&setTimeout((()=>{e.buffer.webVitals.length>0&&e._updateWebVitalsInUnifiedModel()}),1e3)}}catch(e){}}));try{c.observe({type:"layout-shift",buffered:!0})}catch(e){}}(e),function(e){if(!window.PerformanceObserver)return;if(!window.PerformanceObserver.supportedEntryTypes)return;if(!window.PerformanceObserver.supportedEntryTypes.includes("event"))return;let t=0,i=[];const n=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{i.push({startTime:e.startTime,duration:e.duration,endTime:e.startTime+e.duration,culprits:e.attribution&&e.attribution.map((e=>({sourceFile:e.source||"unknown",type:e.type||"script",duration:e.duration||0})))}),i.length>20&&i.shift()}))}));try{window.PerformanceObserver.supportedEntryTypes.includes("long-animation-frame")&&n.observe({type:"long-animation-frame",buffered:!0})}catch(e){}const o=new PerformanceObserver((n=>{const o=n.getEntries();0!==o.length&&o.forEach(((n,o)=>{if(!["pointerdown","keydown","click","mousedown","touchstart"].includes(n.name))return;const s=n.processingStart-n.startTime,a=n.processingEnd-n.processingStart,r=n.processingEnd,c=n.startTime;let l;if(n.renderTime)l=n.renderTime-n.processingEnd;else{const e=n.duration?n.duration-(r-c):0;l=e>0?e:Math.max(.5*a,8)}const u=s+a+l,d=function(e){if(!e.target)return{tagName:"unknown",interactionType:e.name};const t=e.target;let i=t.textContent;i&&(i=i.trim().replace(/\s+/g," "),i.length>60&&(i=i.substring(0,57)+"..."));const n={};if(t.attributes)for(let e=0;e<t.attributes.length;e++){const i=t.attributes[e];i.name.startsWith("data-")||i.name.startsWith("on")||"style"===i.name||"class"===i.name||(n[i.name]=i.value)}return{tagName:t.tagName||"unknown",id:t.id||null,className:t.className||null,textContent:i||null,attributes:Object.keys(n).length>0?n:null,cssPath:_(t),domPath:y(t),isButton:"BUTTON"===t.tagName||"button"===t.getAttribute("role")||"INPUT"===t.tagName&&["button","submit"].includes(t.type),isInput:"INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName,isLink:"A"===t.tagName,interactionType:e.name}}(n),h=function(e,t){if(!t||0===t.length)return[];return t.filter((t=>t.startTime<=e.processingEnd&&t.endTime>=e.processingStart)).map((e=>({duration:e.duration,startTime:e.startTime,culprits:e.culprits||[]})))}(n,i),m={name:n.name,startTime:n.startTime,processingStart:n.processingStart,processingEnd:n.processingEnd,duration:u,renderTime:n.renderTime||null,interactionId:n.interactionId||null,timing:{inputDelay:s,processingDuration:a,presentationDelay:l,totalDuration:u},target:d,longAnimationFrames:h};if(u>t){t=u;const i={name:"INP",value:u,interaction:m};e.sendEvent("core_web_vital",i),e.unifiedDataModel.web_vitals.INP={value:u,timestamp:performance.timeOrigin+n.startTime,interaction:m}}}))}));try{o.observe({type:"event",buffered:!0,durationThreshold:16})}catch(e){}}(e),function(e){e.collectionState&&e.collectionState.isFirstLoad&&(e.loadingTimeTracker=new w(e,"initial_load"),e.loadingTimeTracker.start())}(e),function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)})),window.addEventListener("beforeunload",(function(){e.buffer.webVitals.length>0&&e._prepareFinalDataAndSend(!0)}))}(e),function(e){if(!window.PerformanceObserver||!window.PerformanceObserver.supportedEntryTypes||!window.PerformanceObserver.supportedEntryTypes.includes("longtask"))return;let t=[];const i=new PerformanceObserver((i=>{i.getEntries().forEach((e=>{t.push({startTime:e.startTime,duration:e.duration,attribution:e.attribution?.length?{name:e.attribution[0].name,containerType:e.attribution[0].containerType,containerName:e.attribution[0].containerName,containerId:e.attribution[0].containerId}:null})})),t.length>=5&&(e.unifiedDataModel.metrics.longTasks=t,t=[])}));try{i.observe({type:"longtask",buffered:!0})}catch(e){}}(e))}catch(e){}}function _(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id){e+=`#${i.id}`,t.unshift(e);break}if(i.className&&"string"==typeof i.className){const t=i.className.trim().split(/\s+/);t.length>0&&""!==t[0]&&(e+=`.${t.join(".")}`)}let n=i,o=1;for(;n=n.previousElementSibling;)o++;if(o>1&&(e+=`:nth-child(${o})`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function y(e){if(!e)return null;const t=[];let i=e;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let e=i.tagName.toLowerCase();if(i.id&&(e=`${e}#${i.id}`),t.unshift(e),"body"===i.tagName.toLowerCase()||t.length>=5)break;i=i.parentNode}return t.join(" > ")}function b(e){if(!e)return"unknown";const t=e.split(".").pop().toLowerCase();switch(t){case"jpg":case"jpeg":return"jpeg";case"png":return"png";case"svg":return"svg";case"webp":return"webp";case"gif":return"gif";case"avif":return"avif";default:return t||"unknown"}}function S(e){try{const t=performance.getEntriesByType("resource").find((t=>t.name===e));if(t)return t.initiatorType||"unknown"}catch(e){}return"unknown"}class w{constructor(e,t="initial_load"){this.sdk=e,this.loadingType=t,this.startTime=performance.timeOrigin+performance.now(),this.lastActivityTime=this.startTime,this.isComplete=!1,this.completionValue=null,this.activitySources=new Set,this.quietPeriod=100,this.maxWaitTime=1e4,this.checkInterval=null,this.observers=[],this.pendingRequests=new Set,this.pendingResources=new Set,this.navigationStartTime=null;try{const e=performance.getEntriesByType("navigation")[0];this.navigationStartTime=e?performance.timeOrigin+e.fetchStart:performance.timeOrigin}catch(e){this.navigationStartTime=performance.timeOrigin}}start(){this.setupResourceObserver(),this.setupXHRMonitoring(),this.setupFetchMonitoring(),this.setupMutationObserver(),this.startCompletionCheck(),this.setupLoadEventFallback(),setTimeout((()=>{this.isComplete||this.complete("timeout")}),this.maxWaitTime)}recordActivity(e){this.isComplete||(this.lastActivityTime=performance.timeOrigin+performance.now(),this.activitySources.add(e),this.checkInterval&&clearTimeout(this.checkInterval),this.startCompletionCheck())}setupResourceObserver(){if(window.PerformanceObserver&&window.PerformanceObserver.supportedEntryTypes&&window.PerformanceObserver.supportedEntryTypes.includes("resource"))try{const e=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{performance.timeOrigin+e.startTime>=this.navigationStartTime&&(this.pendingResources.add(e.name),this.recordActivity("resource"),setTimeout((()=>{this.pendingResources.delete(e.name)}),50))}))}));e.observe({type:"resource",buffered:!1}),this.observers.push(e)}catch(e){}}setupXHRMonitoring(){const e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send,i=this;XMLHttpRequest.prototype.open=function(t,i,n){return this._optimaUrl=i,this._optimaStartTime=performance.now(),e.apply(this,arguments)},XMLHttpRequest.prototype.send=function(e){if(i.isComplete)return t.apply(this,arguments);const n=`xhr_${this._optimaUrl}_${this._optimaStartTime}`;i.pendingRequests.add(n),i.recordActivity("xhr");const o=()=>{i.pendingRequests.delete(n)};return this.addEventListener("loadend",o),this.addEventListener("error",o),this.addEventListener("abort",o),t.apply(this,arguments)}}setupFetchMonitoring(){if(!window.fetch)return;const e=window.fetch,t=this;window.fetch=function(i,n){if(t.isComplete)return e.apply(this,arguments);const o=`fetch_${"string"==typeof i?i:i.url}_${performance.now()}`;return t.pendingRequests.add(o),t.recordActivity("fetch"),e.apply(this,arguments).finally((()=>{t.pendingRequests.delete(o)}))}}setupMutationObserver(){if(window.MutationObserver)try{const e=new MutationObserver((e=>{if(this.isComplete)return;e.filter((e=>("attributes"!==e.type||!["style","class"].includes(e.attributeName))&&("childList"===e.type&&(e.addedNodes.length>0||e.removedNodes.length>0)))).length>0&&this.recordActivity("dom_mutation")}));e.observe(document.body||document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href","data-src"]}),this.observers.push(e)}catch(e){}}setupLoadEventFallback(){"complete"===document.readyState?setTimeout((()=>{this.isComplete||this.complete("load_event_already_complete")}),500):window.addEventListener("load",(()=>{setTimeout((()=>{this.isComplete||this.complete("load_event")}),1e3)}))}startCompletionCheck(){this.checkInterval=setTimeout((()=>{this.checkForCompletion()}),this.quietPeriod)}checkForCompletion(){if(this.isComplete)return;const e=performance.timeOrigin+performance.now()-this.lastActivityTime,t=this.pendingRequests.size>0||this.pendingResources.size>0;e>=this.quietPeriod&&!t?this.complete("activity_quiet"):this.startCompletionCheck()}complete(e){if(this.isComplete)return;this.isComplete=!0;const t=this.lastActivityTime,i=Math.round(t-this.navigationStartTime);this.cleanup();const n=this.sdk.unifiedDataModel.web_vitals.loading_time;if(n&&"load_event_already_complete"===n.reason&&"load_event_already_complete"!==e)return void console.log(`[Optima] üîí Loading time already finalized with load_event_already_complete (${n.value}ms), ignoring ${i}ms (${e})`);!n||i>=n.value||"load_event_already_complete"===e?(this.sdk.unifiedDataModel.web_vitals.loading_time={value:i,timestamp:t,reason:e,activitySources:Array.from(this.activitySources),loadingType:this.loadingType,finalized:!0},console.log(`[Optima] üéØ Loading time updated: ${i}ms (reason: ${e})`)):console.log(`[Optima] üö´ Loading time NOT updated: ${i}ms < ${n.value}ms (keeping higher value)`),this.sdk.sendEvent("core_web_vital",{name:"LOADING_TIME",value:i,reason:e,activitySources:Array.from(this.activitySources),loadingType:this.loadingType});const o=Array.from(this.activitySources).join(", ")||"none",s={"Loading Time":`${i}ms`,"Loading Type":this.loadingType,"Completion Reason":e,"Activity Sources":o,"Navigation Start":new Date(this.navigationStartTime).toISOString(),"Completion Time":new Date(t).toISOString()};console.group(`%cüöÄ Optima Loading Time Complete! %c${i}ms %c(${this.loadingType})`,"color: #10b981; font-weight: bold; font-size: 14px;","color: #3b82f6; font-weight: bold; font-size: 16px; background: #eff6ff; padding: 2px 6px; border-radius: 4px;","color: #8b5cf6; font-weight: bold; font-size: 12px;"),console.log("%cüìä Performance Details:","color: #6b7280; font-weight: bold;"),console.table(s),this.activitySources.size>0&&console.log("%cüîç Detected Activities:","color: #6b7280; font-weight: bold;",Array.from(this.activitySources)),console.log("%c‚ö° Ready for analysis in Optima Dashboard","color: #8b5cf6; font-style: italic;"),console.groupEnd()}cleanup(){this.checkInterval&&(clearTimeout(this.checkInterval),this.checkInterval=null),this.observers.forEach((e=>{e.disconnect&&e.disconnect()})),this.observers=[]}}class T{constructor(e,t,i){this.sdk=e,this.loadingType="route_change",this.previousUrl=t,this.newUrl=i,this.routeChangeStartTime=performance.timeOrigin+performance.now(),this.lastActivityTime=this.routeChangeStartTime,this.isComplete=!1,this.activitySources=new Set,this.quietPeriod=100,this.maxWaitTime=1e4,this.checkInterval=null,this.observers=[],this.pendingRequests=new Set,this.pendingResources=new Set,this.excludedActivityUrls=[]}start(){console.log("[Optima] üéØ Route change loading time tracker started"),console.log(`[Optima] üìç From: ${this.previousUrl}`),console.log(`[Optima] üìç To: ${this.newUrl}`),this.setupResourceObserver(),this.setupXHRMonitoring(),this.setupFetchMonitoring(),this.setupMutationObserver(),this.startCompletionCheck(),setTimeout((()=>{this.isComplete||this.complete("timeout")}),this.maxWaitTime)}recordActivity(e,t=null){this.isComplete||t&&this.shouldExcludeUrl(t)||(this.lastActivityTime=performance.timeOrigin+performance.now(),this.activitySources.add(e),this.checkInterval&&clearTimeout(this.checkInterval),this.startCompletionCheck())}shouldExcludeUrl(e){return this.excludedActivityUrls.some((t=>"string"==typeof t?e===t:t instanceof RegExp&&t.test(e)))}setupResourceObserver(){if(window.PerformanceObserver&&window.PerformanceObserver.supportedEntryTypes&&window.PerformanceObserver.supportedEntryTypes.includes("resource"))try{const e=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{performance.timeOrigin+e.startTime>=this.routeChangeStartTime&&(this.pendingResources.add(e.name),this.recordActivity("resource",e.name),setTimeout((()=>{this.pendingResources.delete(e.name)}),50))}))}));e.observe({type:"resource",buffered:!1}),this.observers.push(e)}catch(e){console.log("[Optima] ‚ö†Ô∏è Resource observer setup failed for route change:",e)}}setupXHRMonitoring(){window._optimaOriginalXHR||(window._optimaOriginalXHR={open:XMLHttpRequest.prototype.open,send:XMLHttpRequest.prototype.send});const e=this,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(i){if(e.isComplete)return t.apply(this,arguments);const n=this._optimaUrl||"unknown",o=`xhr_${n}_${performance.now()}`;if(performance.timeOrigin+performance.now()>=e.routeChangeStartTime){e.pendingRequests.add(o),e.recordActivity("xhr",n);const t=()=>{e.pendingRequests.delete(o)};this.addEventListener("loadend",t),this.addEventListener("error",t),this.addEventListener("abort",t)}return t.apply(this,arguments)}}setupFetchMonitoring(){if(!window.fetch)return;window._optimaOriginalFetch||(window._optimaOriginalFetch=window.fetch);const e=window.fetch,t=this;window.fetch=function(i,n){const o="string"==typeof i?i:i.url,s=performance.timeOrigin+performance.now();if(!t.isComplete&&s>=t.routeChangeStartTime){const i=`fetch_${o}_${performance.now()}`;return t.pendingRequests.add(i),t.recordActivity("fetch",o),e.apply(this,arguments).finally((()=>{t.pendingRequests.delete(i)}))}return e.apply(this,arguments)}}setupMutationObserver(){if(window.MutationObserver)try{const e=new MutationObserver((e=>{if(this.isComplete)return;e.filter((e=>("attributes"!==e.type||!["style","class"].includes(e.attributeName))&&("childList"===e.type&&(e.addedNodes.length>0||e.removedNodes.length>0)))).length>0&&this.recordActivity("dom_mutation")}));e.observe(document.body||document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href","data-src"]}),this.observers.push(e)}catch(e){console.log("[Optima] ‚ö†Ô∏è Mutation observer setup failed for route change:",e)}}startCompletionCheck(){this.checkInterval=setTimeout((()=>{this.checkForCompletion()}),this.quietPeriod)}checkForCompletion(){if(this.isComplete)return;const e=performance.timeOrigin+performance.now()-this.lastActivityTime,t=this.pendingRequests.size>0||this.pendingResources.size>0;e>=this.quietPeriod&&!t?this.complete("activity_quiet"):this.startCompletionCheck()}complete(e){if(this.isComplete)return;this.isComplete=!0;const t=this.lastActivityTime,i=Math.round(t-this.routeChangeStartTime);this.cleanup();const n=this.sdk.unifiedDataModel.web_vitals.loading_time;if(n&&"load_event_already_complete"===n.reason)return void console.log(`[Optima] üîí Loading time already finalized with load_event_already_complete (${n.value}ms), ignoring route change ${i}ms`);!n||i>=n.value?(this.sdk.unifiedDataModel.web_vitals.loading_time={value:i,timestamp:t,reason:e,activitySources:Array.from(this.activitySources),loadingType:this.loadingType,routeChangeDetails:{fromUrl:this.previousUrl,toUrl:this.newUrl,startTime:this.routeChangeStartTime,endTime:t}},console.log(`[Optima] üéØ Route change loading time updated: ${i}ms`)):console.log(`[Optima] üö´ Route change loading time NOT updated: ${i}ms < ${n.value}ms (keeping higher value)`);const o={loading_time:{value:i,timestamp:t,reason:e,activitySources:Array.from(this.activitySources),loadingType:this.loadingType},route_change:{previousUrl:this.previousUrl,newUrl:this.newUrl,startTime:this.routeChangeStartTime,endTime:t,duration:i}};this.sdk._sendRouteChangeData(o);const s={"Route Change Loading Time":`${i}ms`,"Completion Reason":e,"Activity Sources":Array.from(this.activitySources).join(", ")||"none","Previous URL":this.previousUrl,"New URL":this.newUrl,"Start Time":new Date(this.routeChangeStartTime).toISOString(),"Completion Time":new Date(t).toISOString()};console.group(`%cüöÄ Route Change Loading Time Complete! %c${i}ms`,"color: #f59e0b; font-weight: bold; font-size: 14px;","color: #3b82f6; font-weight: bold; font-size: 16px; background: #eff6ff; padding: 2px 6px; border-radius: 4px;"),console.log("%cüìä Route Change Details:","color: #6b7280; font-weight: bold;"),console.table(s),this.activitySources.size>0&&console.log("%cüîç Detected Activities:","color: #6b7280; font-weight: bold;",Array.from(this.activitySources)),console.log("%c‚ö° Route change data sent to Optima Dashboard","color: #8b5cf6; font-style: italic;"),console.groupEnd()}cleanup(){this.checkInterval&&(clearTimeout(this.checkInterval),this.checkInterval=null),this.observers.forEach((e=>{e.disconnect&&e.disconnect()})),this.observers=[]}}function C(e){if(!e.sessionId)return;"complete"===document.readyState?e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e._collectResources(),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3)):window.addEventListener("load",(()=>{e.collectionState.pageLoaded||(e.collectionState.pageLoaded=!0,setTimeout((()=>{e._collectResources(),e.sendEvent("page_view",{url:window.location.href,title:document.title,referrer:document.referrer})}),1e3))}));let t=null;if(document.addEventListener("click",(i=>{let n=i.target,o="";if("A"===n.tagName||n.closest("a")){const t="A"===n.tagName?n:n.closest("a");o="link",e.sendEvent("user_interaction",{type:"click",element_type:o,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null,element_href:t.href||null})}else if("BUTTON"===n.tagName||n.closest("button")){const t="BUTTON"===n.tagName?n:n.closest("button");o="button",e.sendEvent("user_interaction",{type:"click",element_type:o,element_id:t.id||null,element_class:t.className||null,element_text:t.textContent?.trim()||null})}t&&clearTimeout(t),t=setTimeout((()=>{e._collectResources(),t=null}),2e3)})),"requestIdleCallback"in window){let t=!1;window.requestIdleCallback((()=>{t||(t=!0,e._collectResources(),e.sendEvent("page_ready",{url:window.location.href,title:document.title,time_to_idle:performance.now()}))}),{timeout:3e3})}document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?e.sendEvent("visibility_change",{state:"visible",timestamp:Date.now()}):"hidden"===document.visibilityState&&e.sendEvent("visibility_change",{state:"hidden",timestamp:Date.now()},{immediate:!0})}))}function E(e){e.buffer.errors||(e.buffer.errors=[]),window.addEventListener("error",(t=>{!function(e,t){if(!t)return;try{const i=t.error||new Error(t.message||"Unknown error"),n=i.message||t.message||"Unknown error",o=t.filename||t.srcElement?.src||window.location.href,s=i.stack||null,a="error",r={type:a,message:n,source:o,lineno:t.lineno||0,colno:t.colno||0,stack:s,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:M(a,n,o,s)};D(e,r),O(e),e.sendEvent("error",{error_type:"uncaught_error",message:r.message,source:r.source,lineno:r.lineno,colno:r.colno})}catch(e){}}(e,t)}),!0),window.addEventListener("unhandledrejection",(t=>{!function(e,t){if(!t||!t.reason)return;try{const i=t.reason,n=i instanceof Error?i.message:String(i),o=i instanceof Error?i.stack:null,s="unhandled_rejection",a="Promise",r={type:s,message:n,source:a,stack:o,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:M(s,n,a,o)};D(e,r),O(e),e.sendEvent("error",{error_type:"unhandled_rejection",message:r.message})}catch(e){}}(e,t)})),function(e){const t=console.error;console.error=function(...i){const n="console.error";try{const t=(new Error).stack||"",o=i.map((e=>{if(e instanceof Error)return e.message;if("object"!=typeof e)return String(e);try{return JSON.stringify(e)}catch(t){return String(e)}})).join(" "),s="console_error",a={type:s,message:o,source:n,stack:t,timestamp:Date.now(),url:window.location.href,user_agent:navigator.userAgent,error_id:M(s,o,n,t)};D(e,a)}catch(e){}t.apply(console,i)}}(e)}function M(e,t,i,n){const o=`${e}:${t}:${i}:${n?n.substring(0,150):""}`;let s=0;for(let e=0;e<o.length;e++){s=(s<<5)-s+o.charCodeAt(e),s|=0}return"err_"+Math.abs(s).toString(16)}function D(e,t){(function(e,t){if(e.buffer.errors.length<5)return!0;const i=e.buffer.errors.some((e=>e.error_id&&t.error_id?e.error_id===t.error_id:e.type===t.type&&e.message===t.message&&e.source===t.source&&e.stack===t.stack));if(i)return!1;const n=e.buffer.errors.slice(-5),o=n.some((e=>e.message===t.message&&e.source===t.source&&t.timestamp-e.timestamp<100));return!o})(e,t)&&(e.buffer.errors.push(t),e.buffer.errors.length>=5&&O(e))}function O(e){e.buffer.errors&&0!==e.buffer.errors.length&&(e.unifiedDataModel.errors||(e.unifiedDataModel.errors=[]),e.unifiedDataModel.errors=[...e.unifiedDataModel.errors,...e.buffer.errors],e.buffer.errors=[],e._sendUnifiedData(!1))}function x(e){return{setupBufferManagement:function(){setInterval((()=>{this.trimBuffers()}),3e4)},trimBuffers:function(){const t=e.batchConfig.maxBufferSize;e.buffer.events.length>t&&(e.buffer.events=e.buffer.events.slice(-t)),e.buffer.resources.length>t&&(e.buffer.resources=e.buffer.resources.slice(-t)),e.buffer.webVitals.length>t&&(e.buffer.webVitals=e.buffer.webVitals.slice(-t))},hashResource:function(e){return`${e.type}|${e.name.split("?")[0]}|${e.duration<50?"fast":"slow"}`},shouldCollectResource:function(t){if(e.batchConfig.resourceDedupingEnabled){const i=this.hashResource(t);if(e.collectionState.resourceHashMap[i])return!1;e.collectionState.resourceHashMap[i]=Date.now()}return!0},startBatchProcessing:function(){if(setInterval((()=>{e.buffer.events.length>0&&e._flushEvents(),e.buffer.webVitals.length>0&&e._flushWebVitals(),e.buffer.resources.length>0&&e._flushResources()}),Math.min(e.batchConfig.flushInterval,1e4)),e.batchConfig.visibilityFlushEnabled){const t=()=>{const t=Date.now();e.collectionState.visibilityState;const i=document.visibilityState;e.collectionState.visibilityState=i,t-e.collectionState.lastVisibilityChange>1e3&&(e.collectionState.lastVisibilityChange=t,"hidden"===i?e._flushBuffers("visibilityHidden",!0):"visible"===i&&setTimeout((()=>{e._collectResources()}),1e3))};document.addEventListener("visibilitychange",t)}if(window.addEventListener("beforeunload",(()=>{e._flushBuffers("unload",!0)})),e.batchConfig.flushAtIdle&&"requestIdleCallback"in window){const t=()=>{window.requestIdleCallback((()=>{(e.buffer.events.length>=10||e.buffer.resources.length>=10||Date.now()-e.collectionState.lastResourceFlush>3e4)&&e._flushBuffers("idle"),setTimeout((()=>{t()}),2e4)}),{timeout:1e4})};t()}this.setupBufferManagement()}}}!function(n){function a(e){var t;e=e||{},this.apiKey=e.apiKey,this.endpoint=e.endpoint,this.sampleRate="number"==typeof e.sampleRate?Math.min(Math.max(e.sampleRate,1),100):100,this.debugMode=e.debug||!1,this.debugMode||console.log(`[Optima] üîß SDK Config - Endpoint: ${this.endpoint}, API Key: ${this.apiKey?this.apiKey.substring(0,8)+"...":"NOT SET"}`),this.sessionId=null,this.sessionStartTime=null,this.buffer={events:[],resources:[],webVitals:[],ajaxCalls:[],errors:[],preSessionAjaxCalls:[]},this.unifiedDataModel={session_id:null,timestamp:null,web_vitals:{LCP:null,FID:null,CLS:null,FCP:null,TTFB:null,INP:null,loading_time:null,layoutShiftSource:null},resources:[],ajax_requests:[],errors:[],events:[],timings:null,metrics:{},meta:{}},this.batchConfig={maxEventsPerBatch:50,maxResourcesPerBatch:50,maxWebVitalsPerBatch:20,maxAjaxCallsPerBatch:50,flushInterval:e.flushInterval||5e3,webVitalsBatchDelay:e.webVitalsBatchDelay||2e3,batchBeforeSend:e.batchBeforeSend||!0,payloadCompressionThreshold:10240},this.collectionState={isFirstLoad:!0,resourcesCollected:!1,lastResourceFlush:null,lastEventFlush:null,lastAjaxCallFlush:null,isPerformanceObserverSet:!1,isBatchProcessingStarted:!1,unloadSent:!1,visibilityChangeCount:0,sendIndex:0,maxSends:12,sendInterval:8e3,lastSendData:null,sessionStartTime:Date.now(),isSessionActive:!0,maxSessionDuration:18e5,inactivityTimeout:3e5,lastActivityTime:Date.now(),immediateSendsSent:{LCP:!1,FID:!1,CLS:!1},activeRouteChangeSessions:new Set,routeChangeSessionIds:[]},this.bufferManager=x(this),this.flushManager=(t=this,{flushBuffers:function(e,i=!1){t.buffer.events.length>0&&this.flushEvents(i),t.buffer.resources.length>0&&this.flushResources(i),t.buffer.webVitals.length>0&&this.flushWebVitals(i),t.buffer.ajaxCalls&&t.buffer.ajaxCalls.length>0&&this.flushAjaxCalls(i)},flushEvents:function(e=!1){if(0===t.buffer.events.length)return;const i=t.buffer.events.slice(0,t.batchConfig.maxEventsPerBatch);t.buffer.events=t.buffer.events.slice(t.batchConfig.maxEventsPerBatch);const n={session_id:t.sessionId,events:i,timestamp:Date.now(),count:i.length};t.collectionState.lastEventFlush=Date.now(),t._sendToServer("/api/optima/events",n,{sync:e})},flushResources:function(e=!1){if(0===t.buffer.resources.length)return;const i=t.buffer.resources.slice(0,t.batchConfig.maxResourcesPerBatch);t.buffer.resources=t.buffer.resources.slice(t.batchConfig.maxResourcesPerBatch);const n={session_id:t.sessionId,resources:i,timestamp:Date.now(),count:i.length};t.collectionState.lastResourceFlush=Date.now(),t._sendToServer("/api/optima/resources",n,{sync:e})},flushWebVitals:function(e=!1){if(0===t.buffer.webVitals.length)return;const i={LCP:[],FID:[],CLS:[],INP:[],TTFB:[],FCP:[]};t.buffer.webVitals.forEach((e=>{if(e&&e.event_data&&e.event_data.name){const t=e.event_data.name;i[t]&&i[t].push(e)}}));const n=t.buffer.webVitals.slice(0,t.batchConfig.maxWebVitalsPerBatch);t.buffer.webVitals=t.buffer.webVitals.slice(t.batchConfig.maxWebVitalsPerBatch);const o={session_id:t.sessionId,web_vitals:n,processed_vitals:i,timestamp:Date.now(),count:n.length};t._sendToServer("/api/optima/web-vitals",o,{sync:e})},flushAjaxCalls:function(e=!1){if(!t.buffer.ajaxCalls||0===t.buffer.ajaxCalls.length)return;const i=t.buffer.ajaxCalls.slice(0,t.batchConfig.maxAjaxCallsPerBatch);t.buffer.ajaxCalls=t.buffer.ajaxCalls.slice(t.batchConfig.maxAjaxCallsPerBatch);const n={session_id:t.sessionId,ajax_calls:i,timestamp:Date.now(),count:i.length};t.collectionState.lastAjaxCallFlush=Date.now(),t._sendToServer("/api/optima/ajax-calls",n,{sync:e})}}),this._webVitalsBatchTimer=null,this._init()}n.__optima_early_xhr_queue=n.__optima_early_xhr_queue||[],a.prototype={_init:function(){this.apiKey?(console.log("[Optima] üöÄ Initializing SDK"),this._initPerformanceMetrics(),E(this),this.createSession()):console.log("[Optima] ‚ùå Init failed - no API key provided")},_initPerformanceMetrics:function(){if(n.performance&&n.performance.mark){n.performance.mark("optima_init");try{n.performance.getEntriesByType("mark").concat(n.performance.getEntriesByType("measure")).filter((e=>e.name.startsWith("optima_"))).forEach((e=>{n.performance.clearMarks(e.name),"measure"===e.entryType&&n.performance.clearMeasures(e.name)}))}catch(e){}this._setupCoreWebVitals(),this._captureNavigationTiming()}},_captureNavigationTiming:function(){try{const e=performance.getEntriesByType("navigation")[0];e&&(this.unifiedDataModel.timings={navigationStart:0,fetchStart:e.fetchStart,domainLookupStart:e.domainLookupStart,domainLookupEnd:e.domainLookupEnd,connectStart:e.connectStart,connectEnd:e.connectEnd,requestStart:e.requestStart,responseStart:e.responseStart,responseEnd:e.responseEnd,domInteractive:e.domInteractive,domContentLoadedEventStart:e.domContentLoadedEventStart,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domComplete:e.domComplete,loadEventStart:e.loadEventStart,loadEventEnd:e.loadEventEnd,duration:e.duration,type:e.type,redirectCount:e.redirectCount,nextHopProtocol:e.nextHopProtocol},this.unifiedDataModel.web_vitals.TTFB={value:e.responseStart,timestamp:performance.timeOrigin+e.responseStart},this.sendEvent("core_web_vital",{name:"TTFB",value:e.responseStart},{immediate:!0}))}catch(e){}},_setupPageLifecycleEvents:function(){console.log("[Optima] üëÅÔ∏è Setting up page lifecycle monitoring"),document.addEventListener("visibilitychange",(()=>{this.collectionState.visibilityChangeCount++,"hidden"===document.visibilityState?(console.log("[Optima] üôà Page hidden - sending final data"),this._sendUnifiedData(!0,"visibilitychange")):"visible"===document.visibilityState&&(console.log("[Optima] üëÄ Page visible - tracking activity"),this._trackActivity(),this._refreshVisibleState())})),n.addEventListener("beforeunload",(()=>{console.log("[Optima] üö™ Page unloading - sending final data"),this.collectionState.unloadSent||(this._sendUnifiedData(!0,"beforeunload"),this.collectionState.unloadSent=!0)})),n.addEventListener("pagehide",(()=>{console.log("[Optima] üì± Page hiding - sending final data (mobile-friendly)"),this.collectionState.unloadSent||(this._sendUnifiedData(!0,"pagehide"),this.collectionState.unloadSent=!0)})),n.addEventListener("unload",(()=>{console.log("[Optima] üí• Page unload - final attempt to send data"),this.collectionState.unloadSent||(this._sendUnifiedData(!0,"unload"),this.collectionState.unloadSent=!0)})),this._setupActivityTracking(),this._setupPeriodicFlush(),this._setupImmediateDataSending()},_setupImmediateDataSending:function(){console.log("[Optima] ‚ö° Setting up immediate data sending triggers");const e=this.sendEvent.bind(this);this.sendEvent=function(t,i,n={}){const o=e(t,i,n);if("core_web_vital"===t&&i&&i.name){const e=["LCP","FID","CLS"],t=i.name;e.includes(t)&&!this.collectionState.immediateSendsSent[t]?(console.log(`[Optima] ‚ö° Critical web vital ${t} captured - sending immediately (first occurrence)`),this.collectionState.immediateSendsSent[t]=!0,setTimeout((()=>{this._sendUnifiedData(!1,`immediate_${t}`)}),100)):e.includes(t)&&console.log(`[Optima] üìù Critical web vital ${t} captured - updating data (already sent immediate)`)}return o}.bind(this),n.addEventListener("error",(()=>{setTimeout((()=>{this._hasSignificantData()&&(console.log("[Optima] ‚ö° Error detected - sending data immediately"),this._sendUnifiedData(!1,"error_triggered"))}),500)}));let t=!1;document.addEventListener("click",(()=>{t||(t=!0,setTimeout((()=>{this._hasSignificantData()&&(console.log("[Optima] ‚ö° First user interaction - sending data immediately"),this._sendUnifiedData(!1,"first_interaction"))}),1e3))}),{once:!0})},_setupActivityTracking:function(){const e=["click","scroll","keydown","mousemove","touchstart"];console.log(`[Optima] üéØ Setting up activity tracking for: ${e.join(", ")}`),e.forEach((e=>{document.addEventListener(e,(()=>{this._trackActivity()}),{passive:!0})})),this._setupRouteChangeDetection()},_setupRouteChangeDetection:function(){console.log("[Optima] üõ§Ô∏è Setting up route change detection"),this.initialUrl=n.location.href,this.initialPath=n.location.pathname,this._interceptHistoryAPI(),n.addEventListener("hashchange",(()=>{this._handleRouteChange("hashchange")})),n.addEventListener("popstate",(()=>{this._handleRouteChange("popstate")})),n.navigation&&n.navigation.addEventListener("navigate",(e=>{e.destination&&e.destination.url!==n.location.href&&this._handleRouteChange("navigation-api")}))},_interceptHistoryAPI:function(){const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),setTimeout((()=>this._handleRouteChange("pushState")),0)},history.replaceState=(...e)=>{t.apply(history,e),setTimeout((()=>this._handleRouteChange("replaceState")),0)}},_handleRouteChange:function(e){const t=n.location.href,i=n.location.pathname;if(i!==this.initialPath){console.log(`[Optima] üõ§Ô∏è Route change detected (${e}): ${this.initialPath} ‚Üí ${i}`),console.log("[Optima] üîÑ Creating new session for route change - Datadog approach");const n=this.initialUrl,o=t;this.initialPath=i,this.initialUrl=t,this._createRouteChangeSession(n,o,e),function(e,t,i){console.log(`[Optima] üöÄ Starting route change loading time tracking: ${t} ‚Üí ${i}`),new T(e,t,i).start()}(this,n,o)}else t!==this.initialUrl&&(console.log(`[Optima] üîó URL change detected but path unchanged (${e}) - continuing collection`),this.initialUrl=t)},_createRouteChangeSession:function(o,s,a){console.log(`[Optima] üìù Creating route change session: ${o} ‚Üí ${s}`),this.loadingTimeTracker&&(console.log("[Optima] üõë Stopping initial loading time tracker due to route change"),this.loadingTimeTracker.cleanup(),this.loadingTimeTracker=null);const r=e(),c=t(),l=i(),u={sdk_version:"1.0.0",loading_type:"route_change",session_type:"route_change",parent_session_id:this.sessionId,previous_url:o,route_change_trigger:a,browser:this._detectBrowser(),os:this._detectOS(),screen_width:n.screen.width,screen_height:n.screen.height,viewport_width:n.innerWidth,viewport_height:n.innerHeight,device_speed:this._detectConnectionSpeed(),connection_rtt:this._detectConnectionRTT(),connection_downlink:this._detectConnectionDownlink(),http_version:"http/1.1",navigation_type:"spa_navigation",page_visibility:document.visibilityState,timestamp:Date.now(),lastUpdated:Date.now()},d={session_id:r,page_url:s,referrer:o,user_agent:n.navigator.userAgent,device_type:c,connection_type:l,timestamp:Date.now(),navigation_start:null,web_vitals:{},errors:[],resources:[],ajax_requests:[],filmstrip:[],meta:u};this._sendToServer("/api/optima/sessions",d).then((e=>{e?(console.log(`[Optima] ‚úÖ Route change session created: ${r}`),this.parentSessionId=this.sessionId,this.sessionId=r,this.routeChangeSessionId=r,this._resetCollectionStateForRouteChange(),this._startRouteChangeDataCollection(),console.log(`[Optima] üîÑ Switched active session from ${this.parentSessionId} to ${this.sessionId}`)):console.log("[Optima] ‚ùå Failed to create route change session")}))},_resetCollectionStateForRouteChange:function(){this._stopPeriodicCollection(),this.collectionState.resourcesCollected=!1,this.collectionState.lastResourceFlush=null,this.collectionState.sendIndex=0,this.collectionState.lastSendData=null,this.collectionState.sessionActive=!0,this.collectionState.sessionStartTime=Date.now(),this.unifiedDataModel={session_id:this.sessionId,page_url:n.location.href,referrer:document.referrer,user_agent:navigator.userAgent,device_type:t(),connection_type:i(),timestamp:Date.now(),navigation_start:null,web_vitals:{},errors:[],resources:[],ajax_requests:[],filmstrip:[],events:[],meta:{}},this._setupPeriodicFlush(),console.log(`[Optima] üîÑ Collection state reset for new session: ${this.sessionId}`)},_stopPeriodicCollection:function(){this._periodicFlushInterval&&(clearInterval(this._periodicFlushInterval),this._periodicFlushInterval=null),this._activityCheckInterval&&(clearInterval(this._activityCheckInterval),this._activityCheckInterval=null),console.log("[Optima] ‚èπÔ∏è Stopped periodic collection for session")},_startRouteChangeDataCollection:function(){this.routeChangeStartTime=performance.timeOrigin+performance.now(),console.log(`[Optima] üîÑ Route change data collection started at: ${this.routeChangeStartTime}`)},_detectConnectionSpeed:function(){return navigator.connection&&navigator.connection.downlink?navigator.connection.downlink:8},_detectConnectionRTT:function(){return navigator.connection&&navigator.connection.rtt?navigator.connection.rtt:100},_detectConnectionDownlink:function(){return navigator.connection&&navigator.connection.downlink?navigator.connection.downlink:10},_detectBrowser:function(){const e=navigator.userAgent;return e.includes("Chrome")&&!e.includes("Edg")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")&&!e.includes("Chrome")?"Safari":e.includes("Edg")?"Edge":e.includes("Opera")||e.includes("OPR")?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent,t=navigator.platform;return t.includes("Win")?"Windows":t.includes("Mac")?"macOS":t.includes("Linux")?"Linux":e.includes("Android")?"Android":e.includes("iPhone")||e.includes("iPad")?"iOS":"Unknown"},_sendRouteChangeData:function(e){if(!this.routeChangeSessionId)return void console.log("[DEBUG] Route change data: No route change session ID available");console.log(`[DEBUG] Route change data: Starting collection for session ${this.routeChangeSessionId}`);const t=this._getRouteChangeResources(),i=this._getRouteChangeWebVitals(),n=t.filter((e=>"fetch"===e.initiator_type||"xmlhttprequest"===e.initiator_type)).length;console.log(`[DEBUG] Route change data: Final summary - ${t.length} resources (${n} AJAX from resources)`);const o={session_id:this.routeChangeSessionId,timestamp:Date.now(),loading_time:e.loading_time.value,loading_time_breakdown:{value:e.loading_time.value,timestamp:e.loading_time.timestamp,reason:e.loading_time.reason,activity_sources:e.loading_time.activitySources,loading_type:e.loading_time.loadingType},route_change_details:e.route_change,web_vitals:{loading_time:e.loading_time,...i},resources:t,meta:{sdk_version:"1.0.0",collection_method:"activity_based",resources_count:t.length,ajax_count:n}};this._sendToServer("/api/optima/route-change-data",o).then((e=>{e?console.log("[Optima] ‚úÖ Route change data sent successfully"):console.log("[Optima] ‚ùå Failed to send route change data")}))},_getRouteChangeResources:function(){if(!this.routeChangeStartTime)return console.log("[DEBUG] Route change resources: No routeChangeStartTime set"),[];try{const e=performance.getEntriesByType("resource"),t=this.routeChangeStartTime-performance.timeOrigin;console.log(`[DEBUG] Route change resources: Checking ${e.length} total resources`),console.log(`[DEBUG] Route change start time: ${this.routeChangeStartTime} (relative: ${t})`),e.forEach(((e,i)=>{const n=e.startTime,s=e.responseEnd||e.loadEventEnd||e.startTime+e.duration,a=n>=t,r=o(e.name),c=n-t;console.log(`[DEBUG] Resource ${i}: ${e.name}`),console.log(`  - Raw start: ${n}ms`),console.log(`  - Route change relative: ${t}ms`),console.log(`  - Adjusted start: ${c}ms`),console.log(`  - End: ${s}ms`),console.log(`  - Type: ${e.initiatorType}`),console.log(`  - Excluded: ${r}`),console.log(`  - After route change: ${a}`),console.log(`  - Will include: ${a&&!r}`)}));const i=e.filter((e=>{const i=e.startTime,n=e.responseEnd||e.loadEventEnd||e.startTime+e.duration,s=o(e.name),a=i>=t||n>=t;return this.debugMode&&a&&!s&&console.log(`[DEBUG] Including resource: ${e.name} (start: ${i>=t?"AFTER":"BEFORE"} route change)`),a&&!s}));console.log(`[DEBUG] Route change resources: ${i.length} resources passed filter`);const n=i.map((e=>{const i=e.startTime,n=e.responseEnd||e.loadEventEnd||e.startTime+e.duration,o=i>=t?Math.round(i-t):0,s=Math.round(n-t),a=s-o;return{name:e.name,type:this._getResourceType(e),size:e.transferSize||0,decoded_body_size:e.decodedBodySize||0,encoded_body_size:e.encodedBodySize||0,duration:Math.max(a,0),start_time:o,end_time:s,response_end:Math.round(e.responseEnd-t),initiator_type:e.initiatorType,cache_status:0===e.transferSize?"cache":"network",dns_lookup:Math.round(e.domainLookupEnd-e.domainLookupStart)||0,tcp_connect:Math.round(e.connectEnd-e.connectStart)||0,request_start:Math.max(0,Math.round(e.requestStart-t)),response_start:Math.max(0,Math.round(e.responseStart-t)),is_ajax:"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType,started_before_route_change:i<t}}));return n.sort(((e,t)=>e.start_time-t.start_time)),console.log(`[DEBUG] Route change resources: Final ${n.length} resources after processing and sorting`),n.forEach(((e,t)=>{console.log(`[DEBUG] Final resource ${t}: ${e.name}`),console.log(`  - Start: ${e.start_time}ms (${e.started_before_route_change?"started before route change":"started after route change"})`),console.log(`  - End: ${e.end_time}ms`),console.log(`  - Duration: ${e.duration}ms`),console.log(`  - Type: ${e.initiator_type}`),console.log(`  - Is AJAX: ${e.is_ajax}`)})),n}catch(e){return console.log("[DEBUG] Error collecting route change resources:",e),[]}},_getRouteChangeWebVitals:function(){const e={};return this.unifiedDataModel.web_vitals.CLS&&(e.CLS={value:this.unifiedDataModel.web_vitals.CLS.value,timestamp:this.unifiedDataModel.web_vitals.CLS.timestamp,sessionValue:this.unifiedDataModel.web_vitals.CLS.sessionValue||this.unifiedDataModel.web_vitals.CLS.value}),this.unifiedDataModel.web_vitals.INP&&(e.INP={value:this.unifiedDataModel.web_vitals.INP.value,timestamp:this.unifiedDataModel.web_vitals.INP.timestamp,interaction:this.unifiedDataModel.web_vitals.INP.interaction}),console.log(`[Optima] üìä Route change web vitals: CLS=${e.CLS?.value||"none"}, INP=${e.INP?.value||"none"}`),e},_prepareFinalDataAndSend:function(e=!1){this.sessionId&&this.unifiedDataModel.session_id&&(this._consolidateBufferedData(),this._updateWebVitalsInUnifiedModel(),this._consolidateErrors(),this._updateMetadata(),this._sendUnifiedData(e))},_updateWebVitalsInUnifiedModel:function(){this.buffer.webVitals.forEach(((e,t)=>{if(!e.event_data||!e.event_data.name)return;const{name:i,value:n}=e.event_data,o=e.timestamp;if("LCP"===i)(!this.unifiedDataModel.web_vitals.LCP||n>this.unifiedDataModel.web_vitals.LCP.value)&&(this.unifiedDataModel.web_vitals.LCP={value:n,timestamp:o,element:e.event_data.element||"unknown"});else if("FID"===i)this.unifiedDataModel.web_vitals.FID||(this.unifiedDataModel.web_vitals.FID={value:n,timestamp:o,inputType:e.event_data.inputType||"unknown"});else if("CLS"===i){if(this.unifiedDataModel.web_vitals.CLS={value:n,timestamp:o,entries:e.event_data.entries||0,sessionValue:e.event_data.sessionValue||n,sessionEntries:e.event_data.sessionEntries||0},e.event_data.largestShift&&e.event_data.largestShift.source)try{const t=e.event_data.largestShift.source;t&&(this.unifiedDataModel.web_vitals.layoutShiftSource={shiftValue:e.event_data.largestShift.value,timestamp:e.event_data.largestShift.timestamp,source:t,loadState:document.readyState})}catch(e){}}else"FCP"===i?this.unifiedDataModel.web_vitals.FCP||(this.unifiedDataModel.web_vitals.FCP={value:n,timestamp:o}):"INP"===i&&(!this.unifiedDataModel.web_vitals.INP||n>this.unifiedDataModel.web_vitals.INP.value)&&(this.unifiedDataModel.web_vitals.INP={value:n,timestamp:o,interaction:e.event_data.interaction||"unknown"})})),this.buffer.webVitals=[]},_consolidateBufferedData:function(){return this.buffer.events||(this.buffer.events=[]),this.unifiedDataModel.events||(this.unifiedDataModel.events=[]),this.buffer.events.length>0&&(this.unifiedDataModel.events=[...this.unifiedDataModel.events,...this.buffer.events],this.buffer.events=[]),this.buffer.resources.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...this.buffer.resources],this.buffer.resources=[]),this.buffer.errors.length>0&&this._consolidateErrors(),this.unifiedDataModel.session_id=this.sessionId,this.unifiedDataModel},_consolidateErrors:function(){this.buffer.errors&&0!==this.buffer.errors.length&&(this.unifiedDataModel.errors=[...this.unifiedDataModel.errors,...this.buffer.errors],this.buffer.errors=[])},_updateMetadata:function(){const e=performance.getEntriesByType("navigation")[0];this.unifiedDataModel.meta={url:n.location.href,path:n.location.pathname,referrer:document.referrer,title:document.title,user_agent:navigator.userAgent,screen_width:n.screen.width,screen_height:n.screen.height,viewport_width:n.innerWidth,viewport_height:n.innerHeight,connection_type:navigator.connection?navigator.connection.effectiveType:null,connection_downlink:navigator.connection?navigator.connection.downlink:null,connection_rtt:navigator.connection?navigator.connection.rtt:null,device_memory:navigator.deviceMemory,device_speed:navigator.hardwareConcurrency,page_visibility:document.visibilityState,visibility_changes:this.collectionState.visibilityChangeCount,timestamp:Date.now(),browser:this._detectBrowser(),os:this._detectOS(),navigation_type:e?.type||null,http_version:e?.nextHopProtocol||null,sdk_version:this.version,lastUpdated:Date.now()}},_sendUnifiedData:function(e=!1,t="periodic"){if(!this._isSessionActive())return void console.log("[Optima] üö´ Send blocked - session inactive");if(this.collectionState.sendIndex>=this.collectionState.maxSends)return void console.log(`[Optima] üö´ Send blocked - limit reached (${this.collectionState.sendIndex}/${this.collectionState.maxSends})`);if(!this.unifiedDataModel.session_id)return void console.log("[Optima] üö´ Send blocked - no session ID");if(!this.sessionId)return void console.log("[Optima] üö´ Send blocked - no sessionId");this._consolidateBufferedData(),this._updateWebVitalsInUnifiedModel(),this._consolidateErrors(),this._updateMetadata(),this.unifiedDataModel.timestamp=Date.now();const i=this._generateDataHash(this.unifiedDataModel);if(i===this.collectionState.lastSendData&&"beforeunload"!==t&&"visibilitychange"!==t)return void console.log(`[Optima] üö´ Send skipped - no data changes (trigger: ${t})`);const n=Math.round((Date.now()-this.collectionState.sessionStartTime)/1e3);console.log(`[Optima] üì§ Sending data (${this.collectionState.sendIndex+1}/${this.collectionState.maxSends}) - Trigger: ${t} - Session: ${n}s`);const o=JSON.parse(JSON.stringify(this.unifiedDataModel));o.sendIndex=this.collectionState.sendIndex,o.sendTrigger=t,o.sessionDuration=Date.now()-this.collectionState.sessionStartTime;const s={webVitals:Object.keys(o.web_vitals).filter((e=>o.web_vitals[e]?.value)).length,resources:o.resources?.length||0,errors:o.errors?.length||0,events:o.events?.length||0};console.log("[Optima] üìä Data summary:",s),this._sendToServer("/api/optima/collect",o,{sync:e}),this.collectionState.sendIndex++,this.collectionState.lastSendData=i,this._resetVolatileDataInUnifiedModel()},_resetVolatileDataInUnifiedModel:function(){this.unifiedDataModel.resources=[],this.unifiedDataModel.ajax_requests=[]},_setupBatchedCollection:function(){this.disabled||this.collectionState.isBatchProcessingStarted||(this.collectionState.isBatchProcessingStarted=!0,this._startBatchedCollection())},_startBatchedCollection:function(){setInterval((()=>{this._collectResources()}),3e3),this._setupPerformanceObservers(),this._setupEventListeners()},_setupPeriodicFlush:function(){this._periodicFlushInterval||this._activityCheckInterval?console.log("[Optima] ‚ö†Ô∏è Periodic flush already set up - skipping duplicate setup"):(console.log(`[Optima] ‚è±Ô∏è Setting up periodic flush (${this.collectionState.sendInterval/1e3}s intervals)`),this._periodicFlushInterval=setInterval((()=>{if(!this._isSessionActive())return void this._stopCollection("inactivity_timeout");const e=this._hasSignificantData();e&&this.collectionState.sendIndex<this.collectionState.maxSends?this._sendUnifiedData(!1,"periodic"):e||console.log("[Optima] üì≠ Periodic flush - no significant data to send")}),this.collectionState.sendInterval),this._activityCheckInterval=setInterval((()=>{this._isSessionActive()||this._stopCollection("session_timeout")}),3e4))},_hasSignificantData:function(){const e={resources:this.unifiedDataModel.resources.length>0,ajax_requests:this.unifiedDataModel.ajax_requests.length>0,webVitals_buffer:this.buffer.webVitals.length>0,errors_buffer:this.buffer.errors.length>0,errors_unified:this.unifiedDataModel.errors.length>0,LCP:this.unifiedDataModel.web_vitals.LCP&&this.unifiedDataModel.web_vitals.LCP.value,FID:this.unifiedDataModel.web_vitals.FID&&this.unifiedDataModel.web_vitals.FID.value,CLS:this.unifiedDataModel.web_vitals.CLS&&this.unifiedDataModel.web_vitals.CLS.value,FCP:this.unifiedDataModel.web_vitals.FCP&&this.unifiedDataModel.web_vitals.FCP.value};return e.resources||e.ajax_requests||e.webVitals_buffer||e.errors_buffer||e.errors_unified||e.LCP||e.FID||e.CLS||e.FCP},_collectResources:function(){if(!this.disabled&&this.sessionId)try{console.log("[DEBUG] Initial resources: Starting collection");const e=s();if(console.log(`[DEBUG] Initial resources: getResourceTimings() returned ${e?.length||0} resources`),!e||0===e.length)return void console.log("[DEBUG] Initial resources: No resources to process");e.forEach(((e,t)=>{console.log(`[DEBUG] Initial resource ${t}: ${e.name}`),console.log(`  - Start: ${e.start_time}ms`),console.log(`  - Type: ${e.initiator_type}`),console.log(`  - Is AJAX: ${e.is_ajax}`),console.log(`  - Size: ${e.size}`)}));const t=e.filter((e=>{const t=this._isResourceProcessed(e.name);return t&&console.log(`[DEBUG] Initial resources: Skipping already processed: ${e.name}`),!t}));console.log(`[DEBUG] Initial resources: ${t.length} new resources after deduplication`),t.sort(((e,t)=>e.start_time-t.start_time)),console.log("[DEBUG] Initial resources: Final resources after sorting:"),t.forEach(((e,t)=>{console.log(`[DEBUG] Final initial resource ${t}: ${e.name} (start: ${e.start_time}ms, type: ${e.initiator_type}, is_ajax: ${e.is_ajax})`)})),this.unifiedDataModel.resources.push(...t),console.log(`[DEBUG] Initial resources: Added ${t.length} resources to unified model (total: ${this.unifiedDataModel.resources.length})`),this.collectionState.resourcesCollected=!0}catch(e){console.log("[DEBUG] Initial resources: Error during collection:",e)}else console.log(`[DEBUG] Initial resources: Skipped - disabled: ${this.disabled}, sessionId: ${!!this.sessionId}`)},_isResourceProcessed:function(e){const t=this.unifiedDataModel.resources.some((t=>t.name===e));return this.debugMode&&t&&console.log(`[DEBUG] Resource already processed: ${e}`),t},_getResourceType:function(e){const t=e.initiatorType,i=e.name;return"img"===t||"image"===t?"image":"script"===t?"script":"css"===t?"stylesheet":"fetch"===t||"xmlhttprequest"===t?"xhr":/\.(?:png|jpg|jpeg|gif|webp|svg|ico)(?:\?|$)/i.test(i)?"image":/\.(?:js)(?:\?|$)/i.test(i)?"script":/\.(?:css)(?:\?|$)/i.test(i)?"stylesheet":/\.(?:woff2?|ttf|otf|eot)(?:\?|$)/i.test(i)?"font":/\.(?:mp4|webm|ogv)(?:\?|$)/i.test(i)?"video":/\.(?:mp3|ogg|wav)(?:\?|$)/i.test(i)?"audio":"other"},_detectBrowser:function(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("MSIE")>-1||e.indexOf("Trident/")>-1?"IE":e.indexOf("Edge")>-1?"Edge":e.indexOf("Opera")>-1||e.indexOf("OPR/")>-1?"Opera":"Unknown"},_detectOS:function(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"Mac OS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"},_refreshVisibleState:function(){this.collectionState.visibilityChangeCount>1&&this._collectResources()},_setupCoreWebVitals:function(){this.disabled||v(this)},_setupBufferManagement:function(){this.bufferManager.setupBufferManagement()},_shouldCollectResource:function(e){return this.bufferManager.shouldCollectResource(e)},_startBatchProcessing:function(){this.bufferManager.startBatchProcessing()},_flushBuffers:function(e,t=!1){this._prepareFinalDataAndSend(t)},_flushEvents:function(e=!1){const t=this.buffer.events.slice();if(this.buffer.events=[],0===t.length)return;const i={session_id:this.sessionId,events:t,timestamp:Date.now()};this._sendToServer("/api/optima/events",i,{sync:e})},_flushResources:function(e=!1){const t=this.buffer.resources.slice();if(this.buffer.resources=[],0===t.length)return;const i={session_id:this.sessionId,resources:t,timestamp:Date.now()};this._sendToServer("/api/optima/resources",i,{sync:e})},_flushWebVitals:function(e=!1){const t=this.buffer.webVitals.slice();if(this.buffer.webVitals=[],0===t.length)return;const i={session_id:this.sessionId,web_vitals:t,timestamp:Date.now()};this._sendToServer("/api/optima/web-vitals",i,{sync:e})},_setupEventListeners:function(){this.disabled||C(this)},_setupPerformanceObservers:function(){this.disabled||(this._setupCoreWebVitals(),this._collectResources())},captureResourceData:function(e="auto"){return!this.disabled&&(this._collectResources(),!0)},_sendResourceBatch:function(e){return e&&e.length>0&&(this.unifiedDataModel.resources=[...this.unifiedDataModel.resources,...e]),!0},createSession:function(){const e=n.location.href,t=document.referrer||"";return this._createSession(e,t)},_sendToServer:function(e,t,i={}){if(!this.apiKey)return Promise.reject(new Error("API key not set"));const n=this.endpoint+e;if(console.log(`[Optima] üåê Attempting to send to: ${n} (sync: ${i.sync||!1})`),i.sync&&navigator.sendBeacon){const i=new URL(n);i.searchParams.set("api_key",this.apiKey),i.searchParams.set("beacon","true"),console.log(`[Optima] üö® BeaconAPI URL: ${i.toString()}`);const o=new Blob([JSON.stringify(t)],{type:"application/json"});try{return navigator.sendBeacon(i.toString(),o)?(console.log(`[Optima] üö® BeaconAPI send SUCCESS to ${e}`),Promise.resolve(!0)):(console.log(`[Optima] üö® BeaconAPI send FAILED to ${e} - falling back to fetch`),this._sendSynchronousFetch(n,t))}catch(e){return console.log("[Optima] üö® BeaconAPI error:",e),this._sendSynchronousFetch(n,t)}}return e.includes("ajax-calls")&&t.ajax_calls&&t.ajax_calls.length>0&&t.ajax_calls.reduce(((e,t)=>(e[t.type]=(e[t.type]||0)+1,e)),{}),console.log(`[Optima] üåê Using regular fetch to: ${n}`),fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t),credentials:"include"}).then((e=>{if(console.log(`[Optima] ‚úÖ Fetch response: ${e.status} ${e.statusText}`),!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()})).then((t=>(console.log(`[Optima] ‚úÖ Fetch SUCCESS to ${e}`),!0))).catch((t=>(console.log(`[Optima] ‚ùå Fetch ERROR to ${e}:`,t),!1)))},_sendSynchronousFetch:function(e,t){try{console.log(`[Optima] üîÑ Using fetch fallback with keepalive to: ${e}`);const i=`${e}?api_key=${encodeURIComponent(this.apiKey)}&beacon=true`;return fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0}).then((i=>i.ok?(console.log(`[Optima] ‚úÖ Keepalive fetch SUCCESS: ${i.status}`),!0):(console.log(`[Optima] ‚ö†Ô∏è Keepalive fetch failed: ${i.status}, trying regular fetch`),this._sendRegularFetch(e,t)))).catch((i=>(console.log("[Optima] ‚ö†Ô∏è Keepalive fetch error, trying regular fetch:",i.message),this._sendRegularFetch(e,t))))}catch(e){return console.log("[Optima] üö® Synchronous fetch fallback failed:",e),Promise.resolve(!1)}},_sendRegularFetch:function(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t)}).then((e=>e.ok?(console.log(`[Optima] ‚úÖ Regular fetch SUCCESS: ${e.status}`),!0):(console.log(`[Optima] ‚ùå Regular fetch failed: ${e.status} ${e.statusText}`),!1))).catch((e=>(console.log("[Optima] ‚ùå Regular fetch error:",e.message),!1)))},sendEvent:function(e,t,i={}){if(this.disabled)return!1;if(!this.sessionId)return!1;const n={session_id:this.sessionId,event_type:e,event_data:t||{},timestamp:Date.now()};return"core_web_vital"===e?(this.buffer.webVitals.push(n),!0===i.immediate&&this._updateWebVitalsInUnifiedModel()):this.buffer.events.push(n),!0},collectPerformanceMetrics:function(){return this._collectResources(),this._updateWebVitalsInUnifiedModel(),!0},sendCollectedData:function(e=!1){return!this.disabled&&(this._prepareFinalDataAndSend(e),!0)},debug:function(){return{sessionId:this.sessionId,apiKey:this.apiKey?`${this.apiKey.substring(0,4)}...`:"None",endpoint:this.endpoint,bufferState:{events:this.buffer.events.length,resources:this.buffer.resources.length,webVitals:this.buffer.webVitals.length},collectionState:{pageLoaded:this.collectionState.pageLoaded,interactionCount:this.collectionState.interactionCount,lastResourceFlush:new Date(this.collectionState.lastResourceFlush).toISOString(),lastEventFlush:new Date(this.collectionState.lastEventFlush).toISOString(),resourceHashMapSize:Object.keys(this.collectionState.resourceHashMap).length,lastVisibilityChange:new Date(this.collectionState.lastVisibilityChange).toISOString(),visibilityState:this.collectionState.visibilityState,sentResourceURLsCount:this.collectionState.sentResourceURLs.size},configuration:this.batchConfig,resourceCaptureResult:this.captureResourceData("debug")}},_captureEarlyAjaxRequests:function(){if(!n.performance||!n.performance.getEntriesByType)return;const e=n.performance.getEntriesByType("resource"),t=e.filter((e=>"xmlhttprequest"===e.initiatorType||"fetch"===e.initiatorType)),i=e.filter((e=>{if(t.includes(e))return!1;const i=e.name;if(i.includes("/api/")||i.includes("/graphql")||i.match(/\/(v1|v2|v3)\//)||i.includes("/rest/")||i.includes("/data/"))return!0;try{const e=new URL(i).pathname.split(".").pop();if(["json","xml","graphql"].includes(e))return!0}catch{}return!1})),o=[...new Set([...t,...i])];if(!o.length)return;const s=o.map((e=>{let t="GET";(e.name.includes("graphql")||e.transferSize>1e3)&&(t="POST");return{type:"fetch"===e.initiatorType?"fetch":"xhr",method:t,url:e.name,status:200,statusText:"OK",startTime:Math.round(e.startTime+performance.timeOrigin),duration:Math.round(e.duration),requestPayloadSize:-1,responseSize:Math.round(e.transferSize)||-1,decodedBodySize:Math.round(e.decodedBodySize)||-1,encodedBodySize:Math.round(e.encodedBodySize)||-1,aborted:!1,errored:!1,timestamp:Math.round(e.startTime+performance.timeOrigin),captureSource:"performance-timeline",resourceTiming:{startTime:Math.round(e.startTime),duration:Math.round(e.duration),domainLookupTime:Math.round(e.domainLookupEnd-e.domainLookupStart),connectTime:Math.round(e.connectEnd-e.connectStart),tlsTime:e.secureConnectionStart?Math.round(e.connectEnd-e.secureConnectionStart):0,requestStartTime:Math.round(e.requestStart),ttfb:Math.round(e.responseStart-e.requestStart),downloadTime:Math.round(e.responseEnd-e.responseStart),entryType:e.entryType,initiatorType:e.initiatorType},requestHeaders:{"content-type":"unknown","content-length":"unknown"},responseHeaders:{"content-type":"unknown","content-length":e.transferSize>0?e.transferSize.toString():"unknown","cache-control":"unknown"}}})).filter((e=>!this._isOptimaApiCall(e.url)));0!==s.length&&(this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...s))},_isOptimaApiCall:function(e){return e.includes("/api/optima/sessions")||e.includes("/api/optima/events")||e.includes("/api/optima/resources")||e.includes("/api/optima/web-vitals")||e.includes("/api/optima/ajax-calls")||e.includes("/api/optima/collect")||e.includes("/api/sessions")||e.includes("/api/events")||e.includes("/api/resources")||e.includes("/api/web-vitals")||e.includes("/api/ajax-calls")||e.includes("/api/collect")||e.includes("optima.js")||e.includes("optima.min.js")},_processEarlyInterceptedRequests:function(){if(!n.__optima_early_xhr_queue||!n.__optima_early_xhr_queue.length)return;const e=n.__optima_early_xhr_queue;let t=[];n.performance&&n.performance.getEntriesByType&&(t=n.performance.getEntriesByType("resource"));const i=e.map((e=>{if(this._isOptimaApiCall(e.url)||e.responseURL&&this._isOptimaApiCall(e.responseURL))return null;let i=null;if(t.length>0){const n=e.url||"",o=t.filter((t=>t.name===n||e.responseURL&&t.name===e.responseURL||t.name.includes(new URL(n).pathname)||e.responseURL&&t.name.includes(new URL(e.responseURL).pathname)));if(o.length>0){const t=o.sort(((t,i)=>Math.abs(t.startTime+performance.timeOrigin-e.startTime)-Math.abs(i.startTime+performance.timeOrigin-e.startTime)))[0];t&&(i={startTime:Math.round(t.startTime),duration:Math.round(t.duration),domainLookupTime:Math.round(t.domainLookupEnd-t.domainLookupStart),connectTime:Math.round(t.connectEnd-t.connectStart),tlsTime:t.secureConnectionStart?Math.round(t.connectEnd-t.secureConnectionStart):0,requestStartTime:Math.round(t.requestStart),ttfb:Math.round(t.responseStart-t.requestStart),downloadTime:Math.round(t.responseEnd-t.responseStart),entryType:t.entryType,initiatorType:t.initiatorType,transferSize:t.transferSize||0,decodedBodySize:t.decodedBodySize||0})}}let n=e.responseSize;return(void 0===n||n<0)&&(n=i&&i.transferSize>0?i.transferSize:i&&i.decodedBodySize>0?i.decodedBodySize:-1),{type:e.type||"xhr",method:e.method||"GET",url:e.responseURL||e.url,originalUrl:e.url,status:e.status||0,statusText:e.statusText||"",startTime:e.startTime,endTime:e.endTime||e.startTime+(e.duration||0),duration:e.duration||0,async:!0,requestPayloadSize:e.requestSize||-1,responseSize:n,aborted:!!e.aborted,errored:!!e.error||!!e.errored,timestamp:e.timestamp||e.startTime,resourceTiming:i,captureSource:e.captureMethod||"early-intercept",requestHeaders:e.requestHeaders||{"content-type":"unknown","content-length":"unknown"},responseHeaders:e.responseHeaders||{"content-type":"unknown","content-length":n>0?n.toString():"unknown","cache-control":"unknown"}}})).filter(Boolean);0!==i.length&&(this.buffer.preSessionAjaxCalls||(this.buffer.preSessionAjaxCalls=[]),this.buffer.preSessionAjaxCalls.push(...i),n.__optima_early_xhr_queue=[])},_createSession:function(t,i,o={}){if(!this.apiKey)return void console.log("[Optima] ‚ùå Session creation failed - no API key");if(this.sessionId&&this.unifiedDataModel.session_id)return console.log(`[Optima] ‚ö†Ô∏è Session already exists: ${this.sessionId}`),Promise.resolve(!0);const s=n.navigator.userAgent,a=this._detectDeviceType(),r=this._detectConnectionType(),c=Date.now(),l=performance?.timing?.navigationStart||c;this.sessionId||(this.sessionId=e(),this.sessionStartTime=c,console.log(`[Optima] üÜî Created new session: ${this.sessionId}`)),this.unifiedDataModel.session_id=this.sessionId,this._updateMetadata();const u={session_id:this.sessionId,page_url:t||n.location.href,referrer:i||document.referrer,user_agent:s,device_type:a,connection_type:r,timestamp:c,navigation_start:l,web_vitals:{},errors:[],resources:[],ajax_requests:[],meta:this.unifiedDataModel.meta};console.log("[Optima] üì° Sending session data to server..."),this._sendToServer("/api/optima/sessions",u).then((e=>{e?(console.log("[Optima] ‚úÖ Session created successfully - starting monitoring"),"function"==typeof this._setupBatchedCollection&&this._setupBatchedCollection(),"function"==typeof this._setupPageLifecycleEvents&&this._setupPageLifecycleEvents()):console.log("[Optima] ‚ùå Session creation failed")})).catch((e=>{console.log("[Optima] ‚ùå Session creation error:",e)}))},_detectDeviceType:function(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&!n.MSStream||/android/i.test(e)?"mobile":/Tablet|iPad/i.test(e)?"tablet":"desktop"},_detectConnectionType:function(){return navigator.connection?navigator.connection.effectiveType:"unknown"},_flushAjaxCalls:function(e=!1){},_generateDataHash:function(e){const t={webVitals:{LCP:e.web_vitals.LCP?.value,FID:e.web_vitals.FID?.value,CLS:e.web_vitals.CLS?.value,FCP:e.web_vitals.FCP?.value,INP:e.web_vitals.INP?.value,TTFB:e.web_vitals.TTFB?.value,loading_time:e.web_vitals.loading_time?.value},resourceCount:e.resources?.length||0,errorCount:e.errors?.length||0,eventsCount:e.events?.length||0,ajaxCount:e.ajax_requests?.length||0};return JSON.stringify(t)},_isSessionActive:function(){const e=Date.now(),t=e-this.collectionState.sessionStartTime;if(t>this.collectionState.maxSessionDuration)return console.log(`[Optima] ‚è∞ Session expired - max duration reached (${Math.round(t/6e4)}min)`),this.collectionState.isSessionActive=!1,!1;const i=e-this.collectionState.lastActivityTime;return i>this.collectionState.inactivityTimeout?(console.log(`[Optima] üò¥ Session inactive - no activity for ${Math.round(i/6e4)}min`),this.collectionState.isSessionActive=!1,!1):this.collectionState.isSessionActive},_trackActivity:function(){const e=!this.collectionState.isSessionActive;this.collectionState.lastActivityTime=Date.now(),!this.collectionState.isSessionActive&&this.collectionState.sendIndex<this.collectionState.maxSends?(this.collectionState.isSessionActive=!0,console.log("[Optima] üîÑ Session reactivated - user activity detected")):e&&console.log("[Optima] üö´ Activity detected but session cannot be reactivated (send limit reached)")},_stopCollection:function(e="session_ended"){console.log(`[Optima] üõë Stopping collection - Reason: ${e}`),this.collectionState.sendIndex<this.collectionState.maxSends&&this.collectionState.isSessionActive?(console.log("[Optima] üì§ Sending final data before stopping"),this._sendUnifiedData(!0,e)):console.log("[Optima] üö´ Final send skipped - "+(this.collectionState.isSessionActive?"limit reached":"session already inactive")),this.collectionState.isSessionActive=!1,this._cleanupObservers()},_cleanupObservers:function(){this.performanceObserver&&this.performanceObserver.disconnect(),this._periodicFlushInterval&&clearInterval(this._periodicFlushInterval),this._activityCheckInterval&&clearInterval(this._activityCheckInterval)}};var r=function(){var e=Array.prototype.slice.call(arguments),t=e[0];if("init"===t){var i=e[1]||null,o=e[2]||{};return o.apiKey=i,n.optimaInstance=new a(o),n.optimaInstance}if(!n.optimaInstance)return!1;switch(t){case"event":return n.optimaInstance.sendEvent(e[1],e[2],e[3]);case"captureResources":return n.optimaInstance.captureResourceData("manual");case"flushBuffers":return n.optimaInstance.sendCollectedData(!0===e[1]);case"debug":return n.optimaInstance.debug();default:return!1}};n.Optima=a;var c=null;if("function"==typeof n.optima)if((c=n.optima).q&&c.q.length){n.optima=r;for(var l=0;l<c.q.length;l++)r.apply(n,c.q[l])}else n.optima=r;else n.optima=r}(window)}();
